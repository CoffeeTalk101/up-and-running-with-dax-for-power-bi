<html><head><meta http-equiv="Content-Type" content="text/html;charset=utf-8" /><link href="style.css" rel="stylesheet" type="text/css" /><title>Up and Running with DAX for Power BI (for pre sume): A Concise Guide for Non-Technical Users</title></head><body><div class="calibre1" id="calibre_link-138">
<div id="calibre_link-459" class="calibre2">
<div id="calibre_link-460" class="calibre3"><div type="frontmatter" class="calibre4"><div class="calibre4"><div class="calibre4" type="titlepage"><div class="calibre4"><div class="bookauthors"><span><span>Alison&nbsp;Box</span></span></div></div><div class="maintitlesection" type="fulltitle"><h1 class="booktitle" type="title" lang="en">Up and Running with DAX for Power BI</h1><h2 class="booksubtitle" type="subtitle" lang="en" role="doc-subtitle">A Concise Guide for Non-Technical Users</h2></div><div class="calibre4"><figure class="figure" id="calibre_link-461"><div class="mediaobject" id="calibre_link-462"><img alt="" aria-describedby="d64e12" src="images/000218.png" class="calibre5" /><div class="textobject" id="calibre_link-463">Logo of the publisher</div></div></figure></div></div><div class="copyrightpage" type="copyright-page"><div class="calibre4"><div class="calibre4"><div class="calibre4"><span>Alison&nbsp;Box</span><div class="calibre4" id="calibre_link-464"><div class="calibre4">Billingshurst, West Sussex, UK</div></div></div></div></div><div class="calibre4"><span class="copyrightpageprintisbn">
				ISBN 978-1-4842-8187-1</span><span class="copyrightpageelectronicisbn">e-ISBN 978-1-4842-8188-8</span></div><div class="calibre4"><a href="https://doi.org/10.1007/978-1-4842-8188-8" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8</a></div><div class="calibre4">© Alison Box 2022</div><div class="calibre4" lang="en">This work is subject to copyright. All rights are solely and exclusively licensed by the Publisher, whether the whole or part of the material is concerned, specifically the rights of translation, reprinting, reuse of illustrations, recitation, broadcasting, reproduction on microfilms or in any other physical way, and transmission or information storage and retrieval, electronic adaptation, computer software, or by similar or dissimilar methodology now known or hereafter developed.</div><div class="calibre4" lang="en">The use of general descriptive names, registered names, trademarks, service marks, etc. in this publication does not imply, even in the absence of a specific statement, that such names are exempt from the relevant protective laws and regulations and therefore free for general use.</div><div class="calibre4" lang="en">The publisher, the authors and the editors are safe to assume that the advice and information in this book are believed to be true and accurate at the date of publication. Neither the publisher nor the authors or the editors give a warranty, expressed or implied, with respect to the material contained herein or for any errors or omissions that may have been made. The publisher remains neutral with regard to jurisdictional claims in published maps and institutional affiliations.</div><div class="calibre4" lang="en"><p class="simplepara">This Apress imprint is published by the registered company APress Media, LLC, part of Springer Nature.</p><p class="simplepara">The registered company address is: 1 New York Plaza, New York, NY 10004, U.S.A.</p></div></div><div class="copyrightpage" type="dedication" role="doc-dedication"><p class="simplepara"><em class="emphasistypeitalic">To Madeleine, John, and Alan</em></p></div><div class="copyrightpage" type="preface" role="doc-preface"><div class="prefacetitle" lang="en">Introduction</div><div class="calibre4"><p class="simplepara" id="calibre_link-465"><em class="emphasistypeitalic">Up and Running with DAX for Power BI</em> is a condensed self-teaching resource for learning DAX inside Power BI Desktop. DAX (Data Analysis Expressions) is the formula language of Microsoft Power BI and was first introduced in 2009 as the programming language of the Excel add-in, Power Pivot, from which Power BI was born. With the ever-increasing adoption of Power BI as the preferred data analytics platform, the ability to use DAX is fast becoming a necessary requirement to find and share the important insights into your data. This book is a concise guide for non-technical users that focuses on the core concepts that underpin this language, taking you from zero knowledge to being able to use DAX to write the challenging calculations that are often necessary for reporting on your data.</p><p class="simplepara" id="calibre_link-466">If you need to use DAX, there is quite a lot of help out there: books, videos, and experts with a lot of opinions and copious examples of mind-boggling DAX code that, to use, you can simply copy and paste without ever understanding how it works. Yet even with the help of these resources, the DAX mantra continues: “DAX is difficult”! But this is a misconception, and it’s the first barrier to learning DAX that you will encounter. Although there is no doubt that DAX can often be challenging to understand, labelling it “difficult” might appear as an excuse for those people who haven’t made the effort to understand what goes on under the hood.</p><p class="simplepara" id="calibre_link-467">When you have shaken off the misconception that DAX is difficult and decided you want to understand how DAX works, currently, there are two hurdles you will face, both of which this book tackles. Firstly, many resources have been written specifically with the DAX developer or other highly skilled technicians in mind. However, the intended audience for this book is either Excel users or people with no technical or coding background. In fact, it’s aimed at someone probably just like you who simply wants to get on with their day job while still becoming a competent user of DAX. In this book, little technical knowledge is assumed. Difficult concepts are explained with easy-to-follow examples that everyone can understand, and the content is structured to gradually build up confidence in working with DAX. The second obstacle you will encounter is that most books on DAX can be considered as “reference works.” For example, <em class="emphasistypeitalic">The Definitive Guide to DAX</em><sup class="calibre7"><a type="noteref" href="#calibre_link-139" id="calibre_link-257" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup> comprises over 700 pages covering every aspect of DAX in meticulous detail. You may feel that using such works as “teach yourself” resources is a daunting prospect because the abundance of information fast becomes overwhelming. To get up and running with DAX, it’s not necessary to wade through copious pages on rarefied DAX functions and the technical aspects of the language. There are just a few mandatory concepts that must be fully understood before DAX can be mastered, and it’s on these concepts that this book focuses. You will also probably want to learn DAX from something more easily consumable and less of an investment in your time. This is why I felt there was a need for a more concise approach to explaining the DAX language.</p><p class="simplepara" id="calibre_link-468">To get the most from the information contained in this book, being a competent user of Power BI Desktop will be an advantage. This includes the ability to create data models and generate reports using Power BI’s data visualizations. However, where specific knowledge of these areas is required, I have provided links to the relevant information for you to self-explore. You will find that within each successive chapter, the book builds on the knowledge gained and the skills learned, and by the final chapters, you will have acquired the necessary understanding of DAX to author complex calculations.</p><p class="simplepara" id="calibre_link-469">In Chapters <span><a href="#calibre_link-59" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>1</span></a></span> to <span><a href="#calibre_link-85" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>3</span></a></span>, we cover the precursor knowledge that’s required before you can begin to author DAX expressions, such as understanding the structure of your data model and using DAX syntax. You will then be able to create some basic calculated columns and measures. You will find that up to this point, DAX is definitely easy! It’s then in Chapter <span><a href="#calibre_link-140" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>4</span></a></span> that we broach the first major DAX concept, which is the evaluation context. Here, we look at the distinct ways in which calculated columns and measures are calculated. We then move you on in Chapter <span><a href="#calibre_link-95" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>5</span></a></span> to the second important concept, understanding iterators, where calculations are performed on each row of a table, just as you would copy down on Excel formulas.</p><p class="simplepara" id="calibre_link-470">You will take a big leap forward in your understanding of DAX in Chapter <span><a href="#calibre_link-6" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>6</span></a></span>, where you meet the most important of all DAX functions, CALCULATE. It’s at this juncture that you will start to use DAX as a programming language, where the outcomes of your expressions happen in memory. At this point too, DAX veers well away from Excel conceptionally, and you will begin to author more powerful calculations than the simple sums and averages of basic measures.</p><p class="simplepara" id="calibre_link-471">In Chapter <span><a href="#calibre_link-4" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>7</span></a></span>, we explore the idea of table expressions that are used to generate in-memory virtual tables. As you move into more advanced areas of DAX, you will start to appreciate that most DAX expressions involve generating these virtual tables. These are typically subsets of real tables and are used to programmatically filter the data in preparation for aggregations via the DAX measure. At this point, you may feel that DAX is definitely getting a little more challenging. This is because you can’t see virtual tables, you just have to imagine them, and the inner workings of expressions are mostly hidden from us. Once you have completed Chapter <span><a href="#calibre_link-8" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>8</span></a></span> where we take a detailed look at the ALL function that, along with CALCULATE, comprises most DAX expressions, you are now ready to use DAX to solve a wide variety of data analysis scenarios. For example, in Chapter <span><a href="#calibre_link-125" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>9</span></a></span>, you will learn to compare data over time periods, and in Chapter <span><a href="#calibre_link-109" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>12</span></a></span>, you are taken through the creation of user-driven calculations using parameter tables. In Chapter <span><a href="#calibre_link-141" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>14</span></a></span>, you will discover how to make dynamic comparisons across categories of data, such as finding which customers who bought product “X” also bought product “Y”.</p><p class="simplepara" id="calibre_link-472">Chapter <span><a href="#calibre_link-87" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>15</span></a></span> will bring you to the most challenging of all DAX concepts to understand. This is the concept of context transition where you will learn to perform aggregations at higher granularities. Once you have mastered the use of this concept, the list of data insights you can now uncover greatly increases. You will be able to rank customers or products by sales, bin totals into numeric ranges, dynamically find top or bottom percent by value, and find the average total sales over years, quarters, and months. In fact, most DAX calculations you author will use context transition in some way.</p><p class="simplepara" id="calibre_link-473">It may seem odd that it’s not until you are almost at the end of your journey through DAX that we tell you at last how DAX really works and how it all fits together. The reason for this is that it’s not until you reach Chapter <span><a href="#calibre_link-0" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>18</span></a></span> that you will have the skills to understand the last DAX concept, that of table expansion. Although this concept is mostly theoretical, once you know how the data model functions behind the scenes when your expressions are evaluated, the knowledge you have gained throughout this book will now all fall into place. In Chapter <span><a href="#calibre_link-0" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>18</span></a></span>, finally, all the pieces of the DAX jigsaw fit together, and you are now a fully fledged DAX expert.</p><p class="simplepara" id="calibre_link-474">Finally, on a personal note, I’ve written the book that I wish had been around when I was first learning DAX, which was back in the days when Power Pivot was first launched. There was very little to help me, and I’ve never forgotten the many hours of deciphering DAX code that it took me to get to the position of thinking “yes, I can do this!” I’m hoping that, with the help of this book, it will be an easier journey for you and that this book will be a useful resource as DAX becomes as mainstream as Excel formulas.</p><div class="para" id="calibre_link-475">Let’s not lose sight either of the objective of learning DAX, which is not an end in its own right. It’s not so you can impress your colleagues by showing off your skills in writing copious lines of DAX code. No, the objective of learning DAX is as a means to an end. It is to enable you to analyze your data in ways that give you those insights that up to now you’ve been struggling to find.<blockquote class="blockquote"><p class="para1" id="calibre_link-476"><em class="emphasistypeitalic">“The goal is to turn data into information, and information into insight.”</em><sup class="calibre7"><a type="noteref" href="#calibre_link-142" id="calibre_link-258" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">2</a></sup></p></blockquote></div><div class="para" id="calibre_link-477">If you want to follow along with the examples we’ve used in this book, these are the files you will need:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-478">Chapters <span><a href="#calibre_link-59" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>1</span></a></span> to <span><a href="#calibre_link-125" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>9</span></a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 DAX Sample Data.pbix</p></li><li class="calibre9"><p class="para2" id="calibre_link-479">Chapter <span><a href="#calibre_link-33" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>10</span></a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2 DAX Blanks &amp; Zeros.pbix</p></li><li class="calibre9"><p class="para2" id="calibre_link-480">Chapters <span><a href="#calibre_link-79" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>11</span></a></span> to <span><a href="#calibre_link-21" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>13</span></a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 DAX Sample Data.pbix</p></li><li class="calibre9"><p class="para2" id="calibre_link-481">Chapter <span><a href="#calibre_link-141" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>14</span></a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3 DAX USERELATIONSHIP.pbix</p></li><li class="calibre9"><p class="para2" id="calibre_link-482">Chapters <span><a href="#calibre_link-87" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>15</span></a></span> and <span><a href="#calibre_link-143" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>16</span></a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1 DAX Sample Data.pbix</p></li><li class="calibre9"><p class="para2" id="calibre_link-483">Chapter <span><a href="#calibre_link-144" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>17</span></a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4 DAX LOOKUPVALUE.pbix</p></li><li class="calibre9"><p class="para2" id="calibre_link-484">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5 DAX TREATAS.pbix</p></li><li class="calibre9"><p class="para2" id="calibre_link-485">Chapters <span><a href="#calibre_link-0" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>18</span></a></span> and <span><a href="#calibre_link-44" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>19</span></a></span>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6 Expanded Tables.pbix</p></li></ul></div></div></div></div><aside aria-label="Article Note 1" class="articlenote"><p class="simplepara">Any source code or other supplementary material referenced by the author in this book is available to readers on GitHub.</p></aside><div class="copyrightpage" type="acknowledgments" role="doc-acknowledgments"><div class="prefacetitle" lang="en">Acknowledgments</div><div class="calibre4"><p class="simplepara" id="calibre_link-486">Writing a book can often be a lonely experience, but a book can only come to fruition with help from outside. I would like to acknowledge and thank those people around me, both professional and personal, that have been instrumental in assisting me in writing this book. Firstly, many thanks to Jake Halsey, my technical reviewer, for his invaluable and encouraging comments and his thorough review of the many DAX examples and listings. I would also like to thank Joan Murray, the Acquisitions Editor at Apress, who, on receiving the original manuscript of the entire book, agreed on the benefit of publishing a book on DAX that had a non-technical focus. I’m also grateful to my Coordinating Editor, Jill Balzano, for her professional approach that makes working with Apress a pleasurable experience. Last but not least, my heartfelt and enduring thanks to my family for their consistent support and encouragement, without whom I would have found it hard to see this book through.</p></div></div><div class="copyrightpage" type="toc" id="calibre_link-487" role="doc-toc"><div class="calibre4"><div class="heading">Table of Contents</div></div><div class="calibre4"><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-59" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 1:​ Show Me the Data</span></a></span></span><span class="tocpagenumber">1</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-145" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Stars and Snowflakes</span></a></span></span><span class="tocpagenumber">4</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-146" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Fact Tables</span></a></span></span><span class="tocpagenumber">4</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-147" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Dimensions</span></a></span></span><span class="tocpagenumber">5</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-148" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The Star Schema</span></a></span></span><span class="tocpagenumber">5</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-149" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Finding Nonmatching Values</span></a></span></span><span class="tocpagenumber">7</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-72" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 2:​ DAX Objects, Syntax, and Formatting</span></a></span></span><span class="tocpagenumber">15</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-150" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>DAX Syntax</span></a></span></span><span class="tocpagenumber">16</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-151" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>DAX Formatting</span></a></span></span><span class="tocpagenumber">19</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-85" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 3:​ Calculated Columns and Measures</span></a></span></span><span class="tocpagenumber">23</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-152" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Calculated Columns</span></a></span></span><span class="tocpagenumber">23</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-153" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Creating Simple Calculated Columns</span></a></span></span><span class="tocpagenumber">24</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-154" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Looking at the RELATED Function</span></a></span></span><span class="tocpagenumber">26</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-155" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>DAX Measures</span></a></span></span><span class="tocpagenumber">32</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-156" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Implicit Measures</span></a></span></span><span class="tocpagenumber">32</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-157" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Explicit Measures</span></a></span></span><span class="tocpagenumber">34</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-158" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Creating a Measures Table</span></a></span></span><span class="tocpagenumber">35</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-159" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Creating Simple DAX Measures</span></a></span></span><span class="tocpagenumber">35</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-160" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>What Exactly Is a Measure?​</span></a></span></span><span class="tocpagenumber">41</span></div></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-140" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 4:​ Evaluation Context</span></a></span></span><span class="tocpagenumber">47</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-161" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The Filter Context</span></a></span></span><span class="tocpagenumber">47</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-162" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Evaluations Using a Single Filter</span></a></span></span><span class="tocpagenumber">49</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-163" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Calculation in the Total Row</span></a></span></span><span class="tocpagenumber">52</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-164" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Evaluations Using Multiple Filters</span></a></span></span><span class="tocpagenumber">53</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-165" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The Row Context</span></a></span></span><span class="tocpagenumber">56</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-95" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 5:​ Iterators</span></a></span></span><span class="tocpagenumber">59</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-166" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The SUMX Function (and Other “X” Functions)</span></a></span></span><span class="tocpagenumber">61</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-167" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Total Row Grief</span></a></span></span><span class="tocpagenumber">66</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-6" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 6:​ The CALCULATE Function</span></a></span></span><span class="tocpagenumber">71</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-168" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Why You Need CALCULATE</span></a></span></span><span class="tocpagenumber">71</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-169" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Using Single Filters</span></a></span></span><span class="tocpagenumber">77</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-170" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Using Multiple Filters</span></a></span></span><span class="tocpagenumber">78</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-171" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>AND and OR Filters</span></a></span></span><span class="tocpagenumber">79</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-172" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Complex Filters</span></a></span></span><span class="tocpagenumber">81</span></div></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-4" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 7:​ DAX Table Functions</span></a></span></span><span class="tocpagenumber">85</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-173" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Types of DAX Functions</span></a></span></span><span class="tocpagenumber">85</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-174" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Table Functions</span></a></span></span><span class="tocpagenumber">87</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-175" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Examples of Table Expressions</span></a></span></span><span class="tocpagenumber">88</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-176" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Why Do We Need Table Expressions?​</span></a></span></span><span class="tocpagenumber">89</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-177" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The FILTER Function</span></a></span></span><span class="tocpagenumber">89</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-178" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>FILTER Used to Reduce Rows</span></a></span></span><span class="tocpagenumber">90</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-179" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>FILTER as the Filter Argument of CALCULATE</span></a></span></span><span class="tocpagenumber">91</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-180" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Column Filters vs.​ Table Filters</span></a></span></span><span class="tocpagenumber">99</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-181" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Table Filters Are Less Efficient</span></a></span></span><span class="tocpagenumber">100</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-182" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Table Filters Return Different Results</span></a></span></span><span class="tocpagenumber">104</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-183" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Using the KEEPFILTERS Function</span></a></span></span><span class="tocpagenumber">108</span></div></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-8" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 8:​ The ALL Function and All Its Variations</span></a></span></span><span class="tocpagenumber">109</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-184" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The ALL Function</span></a></span></span><span class="tocpagenumber">110</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-185" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Applied to the Fact Table</span></a></span></span><span class="tocpagenumber">111</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-186" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Using ALL on Dimension Tables</span></a></span></span><span class="tocpagenumber">117</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-187" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Using ALL on a Column</span></a></span></span><span class="tocpagenumber">120</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-188" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The ALLEXCEPT Function</span></a></span></span><span class="tocpagenumber">127</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-189" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The ALLSELECTED Function</span></a></span></span><span class="tocpagenumber">129</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-190" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>ALL as a Modifier to CALCULATE</span></a></span></span><span class="tocpagenumber">131</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-125" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 9:​ Calculations on Dates:​ Using DAX Time Intelligence</span></a></span></span><span class="tocpagenumber">143</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-191" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Power BI Date Hierarchies</span></a></span></span><span class="tocpagenumber">144</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-192" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Creating a Date Table</span></a></span></span><span class="tocpagenumber">146</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-193" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Using Time Intelligence Functions</span></a></span></span><span class="tocpagenumber">149</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-194" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Previous Month/​Year &ndash; PREVIOUSMONTH/​YEAR</span></a></span></span><span class="tocpagenumber">153</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-195" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Same Period Last Year &ndash; SAMEPERIODLASTYE​AR</span></a></span></span><span class="tocpagenumber">153</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-196" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Values for Any Time Ago &ndash; DATEADD</span></a></span></span><span class="tocpagenumber">154</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-197" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Year to Date &ndash; DATESYTD</span></a></span></span><span class="tocpagenumber">154</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-198" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Total to Date or Cumulative Totals</span></a></span></span><span class="tocpagenumber">155</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-199" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Rolling Annual Totals and Averages</span></a></span></span><span class="tocpagenumber">156</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-200" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Calculating the Last Transaction Date and the Last Transaction Value</span></a></span></span><span class="tocpagenumber">158</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-201" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Finding the Difference Between Two Dates</span></a></span></span><span class="tocpagenumber">162</span></div></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-33" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 10:​ Empty Values vs.​ Zero</span></a></span></span><span class="tocpagenumber">165</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-202" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The BLANK( ) Function</span></a></span></span><span class="tocpagenumber">165</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-203" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The ISBLANK Function</span></a></span></span><span class="tocpagenumber">168</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-204" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Testing for Zero</span></a></span></span><span class="tocpagenumber">168</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-205" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Using Measures to Find Blanks and Zero</span></a></span></span><span class="tocpagenumber">169</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-206" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Using the COALESCE Function</span></a></span></span><span class="tocpagenumber">171</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-79" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 11:​ Using Variables:​ Making Our Code More Readable</span></a></span></span><span class="tocpagenumber">173</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-207" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Improved Performance</span></a></span></span><span class="tocpagenumber">174</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-208" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Improved Readability</span></a></span></span><span class="tocpagenumber">176</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-209" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Reduced Complexity</span></a></span></span><span class="tocpagenumber">177</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-210" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Variables As Constants</span></a></span></span><span class="tocpagenumber">178</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-109" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 12:​ Returning Values in the Current Filter</span></a></span></span><span class="tocpagenumber">183</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-211" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The SELECTEDVALUE Function</span></a></span></span><span class="tocpagenumber">184</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-212" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The CONCATENATEX Function</span></a></span></span><span class="tocpagenumber">189</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-213" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Using Parameter Tables</span></a></span></span><span class="tocpagenumber">195</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-214" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The Values Function</span></a></span></span><span class="tocpagenumber">199</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-215" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>A Table or a Scalar Function?​</span></a></span></span><span class="tocpagenumber">200</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-216" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Replacing “Lost Filters”</span></a></span></span><span class="tocpagenumber">205</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-217" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Converting Columns to Tables</span></a></span></span><span class="tocpagenumber">207</span></div></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-21" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 13:​ Controlling the Direction of Filter Propagation</span></a></span></span><span class="tocpagenumber">209</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-218" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Programming Bidirectional Filters</span></a></span></span><span class="tocpagenumber">210</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-219" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Why You Should Never Use Bidirectional Relationships</span></a></span></span><span class="tocpagenumber">213</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-141" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 14:​ Working with Multiple Relationships Between Tables</span></a></span></span><span class="tocpagenumber">217</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-220" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Activating Inactive Relationships</span></a></span></span><span class="tocpagenumber">219</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-221" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Comparing Values in the Same Column</span></a></span></span><span class="tocpagenumber">221</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-87" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 15:​ Understanding Context Transition</span></a></span></span><span class="tocpagenumber">227</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-222" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Overview of DAX Evaluations Contexts</span></a></span></span><span class="tocpagenumber">228</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-223" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Row Context Revisited</span></a></span></span><span class="tocpagenumber">228</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-224" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Filter Context Revisited</span></a></span></span><span class="tocpagenumber">229</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-225" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>How Row Context Becomes Filter Context</span></a></span></span><span class="tocpagenumber">229</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-226" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>How Context Transition Can Return “Surprising Results”</span></a></span></span><span class="tocpagenumber">237</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-227" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Filters Using AVERAGE</span></a></span></span><span class="tocpagenumber">238</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-228" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Filters Using MAX</span></a></span></span><span class="tocpagenumber">242</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-229" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Filters Using Measures</span></a></span></span><span class="tocpagenumber">247</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-230" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Aggregating Totals Using Context Transition</span></a></span></span><span class="tocpagenumber">251</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-231" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Aggregating in Dimensions</span></a></span></span><span class="tocpagenumber">252</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-232" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Aggregating in Virtual Tables</span></a></span></span><span class="tocpagenumber">259</span></div></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-143" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 16:​ Leveraging Context Transition</span></a></span></span><span class="tocpagenumber">271</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-233" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Ranking Data:​ Looking at RANKX</span></a></span></span><span class="tocpagenumber">272</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-234" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Binning Measures into Numeric Ranges</span></a></span></span><span class="tocpagenumber">275</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-235" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Calculating TopN Percent</span></a></span></span><span class="tocpagenumber">279</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-236" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Create the Slicers</span></a></span></span><span class="tocpagenumber">280</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-237" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Create the Measure to Find the Top or Bottom Percent Selected in Slicers</span></a></span></span><span class="tocpagenumber">281</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-238" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Calculating “Like for Like” Yearly Sales Using SUMMARIZE</span></a></span></span><span class="tocpagenumber">285</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-239" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Using Context Transition in Calculated Columns</span></a></span></span><span class="tocpagenumber">293</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-240" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Calculating Running Totals</span></a></span></span><span class="tocpagenumber">293</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-241" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Calculating the Difference from the Value in the Previous Row</span></a></span></span><span class="tocpagenumber">294</span></div></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-144" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 17:​ Virtual Relationships:​ The LOOKUPVALUE and TREATAS Functions</span></a></span></span><span class="tocpagenumber">297</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-242" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>LOOKUPVALUE Function</span></a></span></span><span class="tocpagenumber">298</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-243" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The TREATAS Function</span></a></span></span><span class="tocpagenumber">302</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-0" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 18:​ Table Expansion</span></a></span></span><span class="tocpagenumber">311</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-244" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Revisiting Filters</span></a></span></span><span class="tocpagenumber">313</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-245" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Column Filters Revisited</span></a></span></span><span class="tocpagenumber">313</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-246" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>The ALL Function Revisited</span></a></span></span><span class="tocpagenumber">317</span></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-247" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Expanded Tables Explained</span></a></span></span><span class="tocpagenumber">318</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-248" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Leveraging Expanded Tables</span></a></span></span><span class="tocpagenumber">323</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-249" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>“Reaching” Dimensions</span></a></span></span><span class="tocpagenumber">324</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-250" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Table Expansion vs.​ CROSSFILTER</span></a></span></span><span class="tocpagenumber">333</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-251" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Using Snowflake Schemas</span></a></span></span><span class="tocpagenumber">337</span></div></div></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-44" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Chapter 19:​ The CALCULATETABLE Function</span></a></span></span><span class="tocpagenumber">343</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-252" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>CALCULATETABLE vs.​ FILTER</span></a></span></span><span class="tocpagenumber">344</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-253" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>CALCULATETABLE and Table Expansion</span></a></span></span><span class="tocpagenumber">349</span></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-254" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Calculating “New” Entities</span></a></span></span><span class="tocpagenumber">350</span></div></div><div class="calibre4"><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-255" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Calculating “Returning” Entities</span></a></span></span><span class="tocpagenumber">356</span></div></div></div></div><div class="bookauthors"><span class="tocitem"><span><a href="#calibre_link-256" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>Index</span></a></span></span><span class="tocpagenumber">361</span></div></div></div><div class="calibre4" type="contributors"><div class="calibre4"><div class="copyrightpage"><div class="calibre4"><div class="heading">About the Author</div></div><div class="calibre4"><span class="tocitem"><span>Alison&nbsp;Box</span></span><div class="biography"><div class="biographyfigure"><figure class="figure1" id="calibre_link-488"><div class="mediaobject" id="calibre_link-489"><img alt="" src="images/000166.jpg" class="calibre5" /></div></figure></div><div class="calibre4" id="calibre_link-490">is a Director of Burningsuit Ltd (<span><a href="http://www.burningsuit.co.uk" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">www.burningsuit.co.uk</span></span></a></span>) and an IT trainer and consultant with over 30 years experience of delivering computer applications training to all skill levels, from basic users to advanced technical experts. Currently, she specializes in delivering training in Microsoft Power BI Service and Desktop, Data Modeling, DAX (Data Analysis Expressions), and Excel. Alison also works with organizations as a DAX and Data Analysis consultant. She was one of the first Excel trainers to move into delivering courses in Power Pivot and DAX, from where Power BI was born. Part of her job entails promoting Burningsuit as a knowledge base for Power BI and includes writing regular blog posts on all aspects of Power BI that are published on her website.</div></div><div class="clearboth">&nbsp;</div></div></div><div class="copyrightpage"><div class="calibre4"><div class="heading">About the Technical Reviewer</div></div><div class="calibre4"><span class="tocitem"><span>Jake&nbsp;Halsey</span></span><div class="biography"><div class="biographyfigure"><figure class="figure1" id="calibre_link-491"><div class="mediaobject" id="calibre_link-492"><img alt="" src="images/000142.jpg" class="calibre5" /></div></figure></div><div class="calibre4" id="calibre_link-493">A native to Northern Indiana, <strong class="emphasistypebold">Jake Halsey</strong> has over a decade of experience working with various products, services, and development tools in the IT industry. Working in the Fort Wayne and Chicago areas as a senior-level software developer and application administrator, he regularly performs complex data analysis and prepares professional reports. He’s particularly excited about his work on this book as it has enabled him to add Power BI and DAX to his own list of tools to prepare effective data visualizations and has personally found the examples created by Alison Box to be realistic, practical, and accessible to readers getting started in their journey with Power BI.</div></div><div class="clearboth">&nbsp;</div></div></div></div></div><aside aria-label="Footnotes" class="articlenote" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-257" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-139" role="doc-footnote"><p class="para3" id="calibre_link-494">Marco Russo and Alberto Ferrari (2020), <em class="emphasistypeitalic">The Definitive Guide to DAX</em>, 2nd ed, [Microsoft Press]</p></div><div class="clearboth1">&nbsp;</div></div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-258" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2</a></span><div class="calibre4" type="footnote" id="calibre_link-142" role="doc-footnote"><p class="para3" id="calibre_link-495">Carly Fiorina, former president and chair of Hewlett-Packard Co, <strong class="emphasistypebold">”</strong>Information: the currency of the digital age,” Oracle OpenWorld, San Francisco, December 6, 2004</p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-59">
<div id="calibre_link-496" class="calibre2">
<div id="calibre_link-497" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-498"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_1" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_1</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">1.&nbsp;Show Me the Data</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-60" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-60"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><div class="para4" id="calibre_link-499">The key to understanding DAX is getting to grips with the challenging concepts that underpin the expressions. Most DAX expressions you’ll write will amount to only a few lines of code, but it’s what goes on under the hood that is the secret to understanding their evaluation. For example, take this <span id="calibre_link-500">DAX</span> expression:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-501">=MAXX ( Customers, [Total Sales] )</p></li></ul></div></div><p class="para5" id="calibre_link-502">It comprises a function, a table name, and a measure name. It should be simple to understand. However, to unravel the calculation behind this expression, you would need to have a firm grasp of the following <span id="calibre_link-503">concepts</span>: row context, filter context, iterators, and context transition. With DAX, the devil is definitely in the detail. This is why you can’t just copy and paste other people’s expressions, hack them around, and hope for the best that they’ll work. You’ll find it difficult to learn DAX using this approach. You must concentrate on the core principles of the function language. You’ll find that DAX becomes less difficult to understand if you simply pay attention to the detail.</p><p class="simplepara" id="calibre_link-504">However, before we can start writing code, we must begin our journey into the language of DAX with the mandatory preparatory work.</p><div class="formalpara" id="calibre_link-505"><div class="heading1">Note</div><p class="para6" id="calibre_link-506">If you would like a detailed explanation of the DAX language and when it first appeared, its history is here: <span><a href="https://en.wikipedia.org/wiki/Data_analysis_expressions" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre"><span><em class="emphasistypeitalic1">https://en.wikipedia.org/wiki/Data_analysis_expressions</em></span></a></span>.</p></div><p class="simplepara" id="calibre_link-507">It would, for instance, be impossible to create the correct DAX expressions without understanding the structure and shape of the data that lies beneath. This is because the construct of your expressions will depend directly on the arrangement of the tables in your data model. This is why any DAX expert will say to you “show me the data” before they attempt to write the relevant DAX code.</p><p class="simplepara" id="calibre_link-508">Therefore, in this chapter, you will familiarize yourself with the data we will be using in our DAX examples throughout this book, and we will pay particular attention to the structure of this data. You will learn the various terms that are used to describe the constituent parts and the major precepts that underpin the structure. Only when you understand these principles can you move on to author DAX code.</p><p class="simplepara" id="calibre_link-509">Our sample data<sup class="calibre7"><a type="noteref" href="#calibre_link-61" id="calibre_link-70" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup> comprises a fictitious sales scenario and what better product to sell than wine (perhaps a more attractive prospect than selling cycles or electrical equipment).<sup class="calibre7"><a type="noteref" href="#calibre_link-62" id="calibre_link-71" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">2</a></sup> In everything that follows in this book, you must imagine that you’re engaged in selling this product, and by using DAX to analyze your sales through the metrics that matter to you, you’ll gain insights into your data that can help drive successful business results and profitability.</p><div class="formalpara" id="calibre_link-510"><div class="heading1">Note</div><p class="para6" id="calibre_link-511">I appreciate that your data may not be sales related. However, our wine sales data is generic data. It comprises the names of entities, numbers, and dates, and your data will be no different from this.</p></div><div class="calibre4" id="calibre_link-512">We’ve imported six tables into <span id="calibre_link-513">Power BI Desktop</span> as follows:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-514"><strong class="emphasistypebold">Winesales</strong> &ndash; Records our sales transactions.</p></li><li class="calibre9"><p class="para2" id="calibre_link-515"><strong class="emphasistypebold">Wines</strong> &ndash; Records the names and details of the wines we sell.</p></li><li class="calibre9"><p class="para2" id="calibre_link-516"><strong class="emphasistypebold">Customers</strong> &ndash; Who we sell our wines to.</p></li><li class="calibre9"><p class="para2" id="calibre_link-517"><strong class="emphasistypebold">SalesPeople</strong> &ndash; The people making the sales.</p></li><li class="calibre9"><p class="para2" id="calibre_link-518"><strong class="emphasistypebold">Regions</strong> &ndash; Our customers are grouped into these regions.</p></li><li class="calibre9"><p class="para2" id="calibre_link-519"><strong class="emphasistypebold">DateTable</strong> &ndash; Records every date, starting from the first day of the month when sales start and ending with the last date in the current financial year, categorizing these dates into year, quarter, and month.</p></li></ul></div></div><div class="formalpara" id="calibre_link-520"><div class="heading1">Note</div><p class="para6" id="calibre_link-521">As we’ll discover later, it’s simpler to have single-word table names, and that’s why we’ve named the tables “Winesales”, “SalesPeople”, and “DateTable”.</p></div><div class="calibre4" id="calibre_link-522">Our tables are related in <span id="calibre_link-523">many-to-one relationships</span> as shown in Figure <span><a href="#calibre_link-63" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1-1</a></span>.<figure class="figure1" id="calibre_link-63"><div class="mediaobject" id="calibre_link-524"><img alt="" src="images/000066.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-1</span><p class="simplepara1">The <span id="calibre_link-525" class="calibre11">data model</span> that is used throughout this book</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-526">To view these relationships, click on the <strong class="emphasistypebold">Model</strong> button on the top left of the report canvas. This view shows the relationships between the tables, and this structure is known as the <em class="emphasistypeitalic">data model</em><strong class="emphasistypebold">.</strong></p><p class="simplepara" id="calibre_link-527">You will observe that the DateTable, SalesPeople, Customers, and Wines tables are all related to the Winesales table. Notice the “1” and “*” to denote the one side and the many side, respectively. The columns used to create the relationships have the same column names in both tables; for example, WINE ID in the Wines table is related to WINE ID in the Winesales table. The Regions table is the odd one out in that it’s not directly related to the Winesales table but <em class="emphasistypeitalic">indirectly</em> via the Customers table.</p><p class="simplepara" id="calibre_link-528">If you would like more information on creating relationships between tables in Power BI Desktop, follow this link:</p><p class="simplepara" id="calibre_link-529"><span><a href="https://docs.microsoft.com/en-us/power-bi/desktop-create-and-manage-relationships" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><em class="emphasistypeitalic1">https://docs.microsoft.com/en-us/power-bi/desktop-create-and-manage-relationships</em></span></a></span></p><section class="section" id="calibre_link-145"><h2 class="booksubtitle">Stars and Snowflakes</h2><p class="simplepara" id="calibre_link-530">One thing you may notice about our <span id="calibre_link-531">data model</span> is that its structure is simple. As has already been mentioned, one of the key aspects of DAX, and what newbies to DAX often overlook, is that the details of your DAX expressions will be inextricably tied to the structure of the model. The simpler the model, the more straightforward the calculations. There is nothing more worrying to a DAX expert than coming across an ill-contrived data model because it probably means they will need to author more complex DAX expressions. We look later at examples of using DAX to overcome anomalies in the data model, but why make it difficult for yourself? Perhaps then, we should take a closer look at the structure of our model and see why I’ve described it as “simple.”</p><p class="simplepara" id="calibre_link-532">Let’s start by considering the tables that comprise the model. In a Power BI data model, a table should be either one of two types, either a <em class="emphasistypeitalic">fact table</em> or a <em class="emphasistypeitalic">dimension</em> as described in the following sections.</p><section class="section" id="calibre_link-146"><h3 class="booksubtitle">Fact Tables</h3><div class="calibre4" id="calibre_link-533">This type of table stores <span id="calibre_link-534">“events</span>.” The term “event” is used loosely here to describe activities such as sales, orders, or survey results. Fact tables answer the question <em class="emphasistypeitalic">what</em>? That is, what are you analyzing in your report? You can identify the fact table by asking yourself these three questions:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-535">Which table holds the data that you want to analyze in your report?</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-536">If you delete this table, will the remaining tables still be related to other tables in the data model?</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-537">Which table sits on the many side of all the other relationships?</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-538">Let’s answer these questions using our data. We want to report on our sales that are recorded in the Winesales table. If we delete the Winesales table, we’ll just have unrelated tables floating around in Model view. The Winesales table sits on the many side of all the other relationships. Clearly, the Winesales table is our fact table. By definition, fact tables sit on the many side of a many-to-one relationship. Another attribute of the fact table is that its data will change frequently and it’ll probably have many more rows than a dimension.</p></section><section class="section" id="calibre_link-147"><h3 class="booksubtitle">Dimensions</h3><p class="simplepara" id="calibre_link-539">These tables store the <span id="calibre_link-540">descriptions</span> of the entities in your model. Dimensions answer the question <em class="emphasistypeitalic">how</em>? That is, how do you want to analyze your data? In our data model, we can analyze our sales by wines, salespeople, customers, regions, and dates using the data in the columns within these tables. The data in dimensions does not necessarily change regularly, and dimensions tend to have fewer rows than fact tables.</p><p class="simplepara" id="calibre_link-541">There’s no table property that you set to configure the table type as a dimension or a fact table. It’s determined by which side of the relationship the table sits on. Tables that sit on the “one” side are always dimension-type tables, while tables that are <em class="emphasistypeitalic">only</em> related on the “many” side are fact tables.</p><div class="para" id="calibre_link-542">The reason it’s so important to distinguish between these two different types of tables is that they support two different types of behavior in the data model, as follows:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-543">Dimension tables support <em class="emphasistypeitalic">grouping</em> and <em class="emphasistypeitalic">filtering.</em></p></li><li class="calibre9"><p class="para2" id="calibre_link-544">Fact tables support <em class="emphasistypeitalic">summarization.</em></p></li></ul></div></div><p class="simplepara" id="calibre_link-545">As we’ll learn later, DAX <em class="emphasistypeitalic">measures</em> are usually designed to summarize data from the fact table that’s been grouped and filtered by a dimension table.</p></section><section class="section" id="calibre_link-148"><h3 class="booksubtitle">The Star Schema</h3><p class="simplepara" id="calibre_link-546">You’ll notice in Model view that we’ve placed the fact table in the middle of the view and arranged our dimensions around the fact table. This arrangement can be described as a star shape, giving a name to the structure, <em class="emphasistypeitalic">star schema</em>. In a perfect <span id="calibre_link-547">star schema</span>, all dimensions are directly related to the fact table. There is an imperfection in our data model because the Regions table is a dimension related to another dimension. Dimensions that are not directly related to a fact table but are indirectly related via dimension tables are described as <em class="emphasistypeitalic">snowflake</em> dimensions. You can imagine that if we had a number of dimensions related to other dimensions in chains outward from the fact table, the schema would more resemble a snowflake.</p><p class="simplepara" id="calibre_link-548">Because data is infinitely variable, the tables in your data model may not be arranged obediently in a perfect star schema. Having multiple fact tables, for instance, isn’t necessarily a problem. The thing to bear in mind, however, is that the more your model diverges from a star schema, the more you will need DAX to manage it. We will be resolving problems inherent in the structure of the data model later in this book when we explore the CROSSFILTER and TREATAS functions where we will create “virtual” relationships.</p><p class="simplepara" id="calibre_link-549">As we’ll discover when we learn to control filters and more specifically calculate distinct counts, it can be difficult to work with dimensions that are not related directly to the fact table. Therefore, it sometimes makes sense to integrate a snowflake dimension into its parent table and therefore tidy up the schema back to a star, a process known as denormalization. You can find more information on this and star schemas generally here: <span><a href="https://docs.microsoft.com/en-us/power-bi/guidance/star-schema" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://docs.microsoft.com/en-us/power-bi/guidance/star-schema</span>.</span></a></span></p><div class="para" id="calibre_link-550">One thing that Power BI prevents is <em class="emphasistypeitalic">ambiguity</em> in the data model, where there are multiple paths through which filters can propagate. Therefore, if you attempt to relate a dimension to two or more other dimensions, this will result in an <em class="emphasistypeitalic">inactive</em> relationship being created, indicated by a dotted line. For example, in Figure <span><a href="#calibre_link-64" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1-2</a></span>, we’ve related the SalesPeople dimension to both the Customers dimension <em class="emphasistypeitalic">and</em> the Regions dimension, and this results in an inactive relationship between SalesPeople and Regions.<figure class="figure1" id="calibre_link-64"><div class="mediaobject" id="calibre_link-551"><img alt="" src="images/000158.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-2</span><p class="simplepara1">An <span id="calibre_link-552" class="calibre11">inactive relationship</span> is created to avoid ambiguity</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-553">We look at the concept of ambiguity and working with inactive relationships in later chapters, but for the moment, let’s just be thankful that we aren’t allowed to do anything that impedes the normal mechanism of the model.</p></section></section><section class="section" id="calibre_link-149"><h2 class="booksubtitle">Finding Nonmatching Values</h2><div class="calibre4" id="calibre_link-554">A question that is often asked is what happens when there are missing values in the linking columns used to create relationships. There are two different <span id="calibre_link-555">scenarios</span> here, taking the Wines dimension as our example:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-556">You have values in the WINE ID column in the Wines dimension that don’t exist in the WINE ID column in the Winesales fact table.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-557">You have values in the WINE ID column in the Winesales fact table that don’t exist in the WINE ID column of the Wines dimension.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-558">Let’s take scenario #1 first. Understanding this situation allows us to answer the following question: Which wines haven’t we sold? When you build a visual that takes a column from a dimension and summarizes a column from the fact table, you will only see items where there’s a match for values in the linking columns. By default, all visuals remove items where there is no value to show.</p><div class="formalpara" id="calibre_link-559"><div class="heading1">Note</div><p class="para6" id="calibre_link-560">For information on building Power BI visuals, including the Table visual shown in Figure <span><a href="#calibre_link-65" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre">1-3</a></span>, visit</p><p class="simplepara" id="calibre_link-561"><span><a href="https://docs.microsoft.com/en-us/power-bi/visuals/power-bi-report-add-visualizations-i" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://docs.microsoft.com/en-us/power-bi/visuals/power-bi-report-add-visualizations-i</span></span></a></span></p></div><div class="calibre4" id="calibre_link-562">For example, in Figure <span><a href="#calibre_link-65" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1-3</a></span>, which uses the WINE column from the Wines dimension and summarizes <span id="calibre_link-563"></span>CASES SOLD from the Winesales table, we only see the wines where there’s a match for the values in the WINE ID column in both tables. In other words, we’re only seeing the wines we’ve sold.<figure class="figure1" id="calibre_link-65"><div class="mediaobject" id="calibre_link-564"><img alt="" src="images/000111.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-3</span><p class="simplepara1">By default, you only see items where there are matching values in the <span id="calibre_link-565" class="calibre11">linking columns</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-566">How can we see the wines we haven’t sold in this visual? To do this is straightforward and requires no DAX. In the <span id="calibre_link-567">Visualisations pane</span>, in the Values bucket, click on the drop-down of the column from the dimension, for example, the WINE column, and select <strong class="emphasistypebold">Show items with no data</strong>. You’ll now see a blank value beside items that have no match in the fact table, in our case, “Lambrusco” wine. This tells us that we haven’t sold this wine; see Figure <span><a href="#calibre_link-66" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1-4</a></span>.<figure class="figure1" id="calibre_link-66"><div class="mediaobject" id="calibre_link-568"><img alt="" src="images/000089.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-4</span><p class="simplepara1">Finding the items for which there is no <span id="calibre_link-569" class="calibre11">data</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-570">If we look at the Wines dimension in Data view (click the button above Model on the left of the report canvas), we will see that “Lambrusco” has a WINE ID of 14. Examining the values in the WINE ID column of the Winesales table using the filter shows there is no WINE ID 14 in this column; see Figure <span><a href="#calibre_link-67" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1-5</a></span>.<figure class="figure1" id="calibre_link-67"><div class="mediaobject" id="calibre_link-571"><img alt="" src="images/000210.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-5</span><p class="simplepara1">The fact table does not contain the value from the <span id="calibre_link-572" class="calibre11">dimension</span> in the linking column</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-573">As the name of the “Show items with no data” option implies, it can be used whenever you want to see items where there is no calculation to show, for example, where a measure doesn’t return a value for an item. It doesn’t mean there is never a value to show, as in the case of “Lambrusco” wine; rather, it means that the current filters on the model result in there being no value to show.</p><p class="simplepara" id="calibre_link-574">Let’s now move on to scenario #2 where there are values in the WINE ID column of the Winesales fact table that don’t exist in the WINE ID column of the Wines dimension.</p><div class="formalpara" id="calibre_link-575"><div class="heading1">Note</div><p class="para6" id="calibre_link-576">The sample file does not contain the data described in scenario #2. However, Figure <span><a href="#calibre_link-68" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre">1-6</a></span> shows you what this data would look like.</p></div><div class="calibre4" id="calibre_link-577">You can see in Figure <span><a href="#calibre_link-68" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1-6</a></span>, we have just this scenario. The wine ID’s shown have no match in the <span id="calibre_link-578">Wines dimension</span>.<figure class="figure1" id="calibre_link-68"><div class="mediaobject" id="calibre_link-579"><img alt="" src="images/000184.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-6</span><p class="simplepara1">Values in the fact table that are not in the dimension</p></div></figcaption></figure></div><div class="para" id="calibre_link-580">When such values occur in your data, you’ll see the outcome in any visual as soon as you take a column from the dimension and analyze a column from the fact table, as shown in Figure <span><a href="#calibre_link-69" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1-7</a></span>, where we have put the data into a Table visual and also a slicer. Here, we have a “blank” wine name that represents all the WINE ID values in the fact table for which there are no matches in the dimension. You’ll <span id="calibre_link-581"></span>also see the same outcome in a slicer even though it doesn’t use the relationship and only shows values from the dimension.<figure class="figure1" id="calibre_link-69"><div class="mediaobject" id="calibre_link-582"><img alt="" src="images/000134.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 1-7</span><p class="simplepara1">The <span id="calibre_link-583" class="calibre11">“Blank</span>” entry shows there are values in the fact table that don’t match to values in the dimension</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-584">The “Blank” entry is a result of what we sometimes refer to as “dirty data.” Why are there values in the fact table for which there is no match in the dimension? How are you going to resolve this scenario? This is a question that only the data modeler can answer, and ultimately the solution lies in correcting the data at its source.</p><p class="simplepara" id="calibre_link-585">We hope you appreciate how important it is to identify nonmatching values in your data and to understand that you don’t need DAX to do this. Finding out where there’s no data can be equally as valuable as knowing where there is, and the star schema allows us to do this.</p><p class="simplepara" id="calibre_link-586">In this chapter, you have familiarized yourself with the data we will be using henceforth. You also now understand concepts that underpin the data model and how it comprises fact tables and dimensions related to many-to-one relationships. The simplest structured data model is the star schema where dimensions are related directly to the fact table. However, it is possible to have dimensions indirectly related to the fact table via other dimensions creating snowflake dimensions. This is mandatory precursor knowledge to understanding DAX because what you will learn as we progress through this book is that many DAX calculations will involve manipulating the tables in the data model, and in doing so, the way the tables are structured is paramount.</p></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-70" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-61" role="doc-footnote"><p class="para3" id="calibre_link-587">To follow along with the examples, use the Power BI Desktop file “1 DAX Sample Data.pbix”.</p></div><div class="clearboth1">&nbsp;</div></div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-71" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2</a></span><div class="calibre4" type="footnote" id="calibre_link-62" role="doc-footnote"><p class="para3" id="calibre_link-588">This is a reference to the ubiquitous sample data, “AdventureWorks” and “Contoso Corporation” used by many books on DAX</p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-72">
<div id="calibre_link-589" class="calibre2">
<div id="calibre_link-590" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-591"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_2" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_2</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">2.&nbsp;DAX Objects, Syntax, and Formatting</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-73" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-73"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-592">Now that you understand the structure of the data we’ll be using throughout this book, the next step is learning how to construct DAX expressions. In this chapter, we will compare and contrast DAX expressions to Excel formulas as this will provide context for your knowledge. You will learn to reference the objects&nbsp;used in DAX expressions, the syntax of the expressions, and how you can format your DAX code, making it easier to read and debug.</p><div class="para8" id="calibre_link-593">To follow along with the examples in this chapter, in the Data view of Power BI desktop, select the Winesales table in the Fields list, and on the <strong class="emphasistypebold">Table Tools</strong> <span id="calibre_link-594">tab</span>, click the <strong class="emphasistypebold">New Column</strong> button. This will display the DAX “formula bar” as shown in Figure <span><a href="#calibre_link-74" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2-1</a></span>.<figure class="figure1" id="calibre_link-74"><div class="mediaobject" id="calibre_link-595"><img alt="" src="images/000243.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 2-1</span><p class="simplepara1">To follow along with the examples, use the New Column button</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-596">The first similarity to Excel is the “<span id="calibre_link-597">formula bar</span>” that pops up when you create new columns or measures. We will start to type some expressions into the formula bar presently. However, at this stage, you don’t need to know what the expressions are calculating. You are just learning how to type the correct <span id="calibre_link-598">syntax</span>.</p><section class="section" id="calibre_link-150"><h2 class="booksubtitle">DAX Syntax</h2><p class="simplepara" id="calibre_link-599">Notice on the left, just like Excel, the formula bar has a Cancel button (the cross) and an Enter button (the tick). However, the formula bar is in effect a code editor and can extend to many lines if the SHIFT&nbsp;+ ENTER key combination is pressed (see the section below on Formatting). This is why, unlike the Excel formula bar, each line of the DAX code editor is numbered. You will, for instance, notice that in Figure <span><a href="#calibre_link-74" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2-1</a></span>, we are on line 1.</p><p class="simplepara" id="calibre_link-600">The next parallel with Excel is that DAX expressions are constructed in the same way as <span id="calibre_link-601">Excel formulas</span>. For example, all DAX expressions begin with an equals sign, and commas separate the arguments of functions. Also, just like Excel, DAX expressions are <em class="emphasistypeitalic">case insensitive</em>; it makes no difference in what case you type your DAX code.</p><p class="simplepara" id="calibre_link-602">However, one of the major differences between DAX and Excel is that in DAX, you can’t reference “cells.” The only two objects that are referenced in DAX expressions are tables and columns.</p><div class="para" id="calibre_link-603">You reference a table by just naming it. For example, to count the rows in the Winesales table, this would be this expression:<div class="programcode" id="calibre_link-604"><div class="calibre4"><div class="fixedline">= COUNTROWS ( Winesales )</div></div></div></div><div class="para" id="calibre_link-605">Notice that when you start to type this expression into the DAX editor, just like Excel, the DAX editor matches what you’re typing in a list of suggestions. This list is referred to as the DAX <strong class="emphasistypebold">IntelliSense</strong>; see Figure <span><a href="#calibre_link-75" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2-2</a></span>. Just click on a suggestion in the IntelliSense list to place it into your&nbsp;code.&nbsp;You can’t put anything into your expression that isn’t on the list.<figure class="figure1" id="calibre_link-75"><div class="mediaobject" id="calibre_link-606"><img alt="" src="images/000008.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 2-2</span><p class="simplepara1">The DAX <span id="calibre_link-607" class="calibre11">IntelliSense list</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-608">Also notice in the COUNTROWS&nbsp;expression&nbsp;that spaces have been used before and after the brackets. Typing spaces is arbitrary as they will be ignored by the DAX editor and can be used wherever you feel they improve the clarity of the expression (see the section below on Formatting).</p><div class="para" id="calibre_link-609">If the table name contains a space, the table name must be surrounded with single quotes:<div class="programcode" id="calibre_link-610"><div class="calibre4"><div class="fixedline">= COUNTROWS (&nbsp;&nbsp;'Wine Sales' )</div></div></div></div><div class="para" id="calibre_link-611">To reference a column, you surround the <span id="calibre_link-612">column name</span> with square brackets ( [ ] ) and <em class="emphasistypeitalic">always precede the column name with the table name</em>. For example, to sum the CASES SOLD column in the Winesales table, this would be the expression:<div class="programcode" id="calibre_link-613"><div class="calibre4"><div class="fixedline">= SUM ( Winesales[CASES SOLD] )</div></div></div></div><p class="simplepara" id="calibre_link-614">As mentioned before, in DAX, there is no such thing as a cell, only tables and columns.</p><div class="para" id="calibre_link-615">Table <span><a href="#calibre_link-76" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2-1</a></span> shows a comparison of equivalent Excel formulas and DAX expressions, and you can see how similar the syntax is between the two.<div class="table" id="calibre_link-76"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 2-1</span><p class="para6">Comparing Excel <span id="calibre_link-616">formulas</span> and DAX expressions</p></div></div><table class="calibre12"><colgroup class="calibre13"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre14"><tr class="calibre15"><th class="calibre16"><p class="simplepara2">Excel</p></th><th class="calibre16"><p class="simplepara2">DAX</p></th></tr></thead><tbody class="calibre17"><tr class="calibre15"><td class="calibre18"><p class="simplepara2">=IF ( B2 &gt; 50 , “Yes” , “No”)</p><p class="simplepara2"><em class="emphasistypeitalic">When this formula is copied down, the “B2” will change relatively to “B3, B4, B5 etc.”</em></p></td><td class="calibre18"><p class="simplepara2">=IF ( Winesales[CASES SOLD] &gt; 50 , “Yes” , “No” )</p><p class="simplepara2"><em class="emphasistypeitalic">Used in a calculated column, this expression is automatically applied to the entire column.</em></p></td></tr><tr class="calibre19"><td class="calibre18"><p class="simplepara2">= SUM ( Winesales[CASES SOLD] )</p><p class="simplepara2"><em class="emphasistypeitalic">This uses Excel Table syntax where the table is named “Winesales”&nbsp;and the column is named “CASES SOLD”.</em></p></td><td class="calibre18"><p class="simplepara2">= SUM ( Winesales[CASES SOLD] )</p><p class="simplepara2"><em class="emphasistypeitalic">Used in a measure or in a calculated column to find total cases in the CASES SOLD column in the Winesales table.</em></p></td></tr></tbody></table></div></div><p class="simplepara" id="calibre_link-617">Another contrast between Excel and DAX is the way you reference “AND” and “OR”. In Excel, you use the AND() and OR() functions. In DAX, you typically use these <em class="emphasistypeitalic"><strong class="emphasistypebold">operators</strong></em> instead; AND is <strong class="emphasistypebold">&amp;&amp;</strong> (double ampersand) and OR is <strong class="emphasistypebold">||</strong> (double pipe).</p><div class="formalpara" id="calibre_link-618"><div class="heading1">Note</div><p class="para6" id="calibre_link-619">You’ll find the pipe symbol “|” on your keyboard at the bottom left, above the backslash and to the right of SHIFT.</p></div><div class="calibre4" id="calibre_link-620">Table <span><a href="#calibre_link-77" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2-2</a></span> shows a comparison of using “AND” and “OR” in Excel formulas and DAX expressions.<div class="table" id="calibre_link-77"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 2-2</span><p class="para6">Contrasting AND and <span id="calibre_link-621">OR</span> in Excel and DAX</p></div></div><table class="calibre12"><colgroup class="calibre13"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre14"><tr class="calibre15"><th class="calibre16"><p class="simplepara2">Excel</p></th><th class="calibre16"><p class="simplepara2">DAX</p></th></tr></thead><tbody class="calibre17"><tr class="calibre15"><td class="calibre18"><p class="simplepara2">AND</p></td><td class="calibre18"><p class="simplepara2">AND</p></td></tr><tr class="calibre19"><td class="calibre18"><p class="simplepara2">= IF ( AND ( Winesales[@CASES SOLD] &gt; 50, Winesales[@CASES SOLD] &lt; 100 ), “Yes” , “No” )</p><p class="simplepara2"><em class="emphasistypeitalic">Using Excel Table syntax where the table is named “Winesales”&nbsp;and the column is&nbsp;named “CASES SOLD”</em></p><p class="simplepara2"><em class="emphasistypeitalic">Note the use of the “@” to denote “the current row.”</em></p></td><td class="calibre18"><p class="simplepara2">= IF ( Winesales[CASES SOLD] &gt; 50</p><p class="simplepara2">&amp;&amp;</p><p class="simplepara2">Winesales[CASES SOLD] &lt; 100 ,</p><p class="simplepara2">“Yes” , “No” )</p><p class="simplepara2"><em class="emphasistypeitalic">Used in a calculated column.</em></p><p class="simplepara2"><em class="emphasistypeitalic">Using the value in the current row is implicit in calculated columns.</em></p></td></tr><tr class="calibre15"><td class="calibre18"><p class="simplepara2">OR</p></td><td class="calibre18"><p class="simplepara2">OR</p></td></tr><tr class="calibre19"><td class="calibre18"><p class="simplepara2">= IF ( OR ( Winesales[@SALESPERSON ID] = 2 , Winesales[@SALESPERSON ID] = 6 ),</p><p class="simplepara2">“Yes” , “No” )</p><p class="simplepara2"><em class="emphasistypeitalic">Using Excel Table syntax where the table is named “Winesales”&nbsp;and the column is&nbsp;named “SALESPERSON&nbsp;ID”</em></p></td><td class="calibre18"><p class="simplepara2">= IF ( Winesales[SALESPERSON ID] = 2</p><p class="simplepara2">||</p><p class="simplepara2">Winesales[SALESPERSON ID] = 6 , “Yes” , “No” )</p><p class="simplepara2"><em class="emphasistypeitalic">Used in a calculated column.</em></p></td></tr></tbody></table></div></div><div class="formalpara" id="calibre_link-622"><div class="heading1">Note</div><p class="para6" id="calibre_link-623">DAX does have an AND function and an OR function, but in DAX, these functions only accept two arguments, so it’s usually better to use the operators.</p></div><p class="simplepara" id="calibre_link-624">A single ampersand (&amp;) is used in DAX as the concatenation operator, just as it is in Excel.</p></section><section class="section" id="calibre_link-151"><h2 class="booksubtitle">DAX Formatting</h2><div class="calibre4" id="calibre_link-625">Before we start authoring DAX expressions in earnest, let’s get into some good habits concerning the <span id="calibre_link-626">formatting</span> of our DAX code. Consider the two expressions in Figure <span><a href="#calibre_link-78" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2-3</a></span>. They are the same expression but with two different layouts.<figure class="figure1" id="calibre_link-78"><div class="mediaobject" id="calibre_link-627"><img alt="" src="images/000056.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 2-3</span><p class="simplepara1">Comparing unformatted and formatted expressions</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-628">Question: Which layout makes the DAX code easier to understand? I think you’ll agree that it’s the second layout where we have separated the code onto different lines. In the DAX editor, you can use the keyboard combination SHIFT +&nbsp;ENTER to move onto a new line and use the TAB key to indent lines. Spaces can be used for clarity. It’s also recommended that you start nested functions on a new line and close brackets at the same indent of the function it closes.</p><div class="para" id="calibre_link-629">To add comments to your code, use the following:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-630"><strong class="emphasistypebold">--</strong> <span class="emphasisfontcategorynonproportional">&ndash;</span> Single line comment (double dash)</p></li><li class="calibre9"><p class="para2" id="calibre_link-631"><strong class="emphasistypebold">//</strong> <span class="emphasisfontcategorynonproportional">&ndash;</span> Single line comment (double forward slash)</p></li><li class="calibre9"><p class="para2" id="calibre_link-632"><strong class="emphasistypebold">/*</strong> <span class="emphasisfontcategorynonproportional">&ndash;</span> Start a multiline comment (forward slash and asterisk)</p></li><li class="calibre9"><p class="para2" id="calibre_link-633"><strong class="emphasistypebold">*/</strong> <span class="emphasisfontcategorynonproportional">&ndash;</span> End a multiline comment (asterisk and forward slash)<span id="calibre_link-634"></span></p></li></ul></div></div><p class="simplepara" id="calibre_link-635">However, there are no hard and fast rules about how to format your DAX code. Whatever works for you.</p><p class="simplepara" id="calibre_link-636">If you want to quickly format your untidy DAX code, use the DAX formatter here:</p><p class="simplepara" id="calibre_link-637"><span><a href="https://www.daxformatter.com/" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://www.daxformatter.com/</span></span></a></span></p><p class="simplepara" id="calibre_link-638">You can also find more information and guidelines on best practices here:</p><p class="simplepara" id="calibre_link-639"><span><a href="https://www.sqlbi.com/articles/rules-for-dax-code-formatting/" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://www.sqlbi.com/articles/rules-for-dax-code-formatting/</span></span></a></span></p><p class="simplepara" id="calibre_link-640">You should now be able to type your DAX code correctly. Use square brackets to reference columns and always precede your column references with the table name where the column resides. You understand that in DAX, we often use “AND” and “OR” operators rather than the equivalent functions used in Excel. Using separate lines in the code editor will greatly improve the clarity of the expression. However, DAX doesn’t care how your code is formatted. It will execute your code however dire the layout of the expression looks!</p><p class="simplepara" id="calibre_link-641">This chapter concludes our preparatory work before we can move on to author DAX expressions and generate calculations. The next step is to understand that in DAX, we work with different types of expressions, and this will be the focus of the next chapter.</p></section></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-85">
<div id="calibre_link-642" class="calibre2">
<div id="calibre_link-643" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-644"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_3" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_3</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">3.&nbsp;Calculated Columns and Measures</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-86" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-86"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-645">In the previous chapter, you learned the syntax used by the DAX language, and now you’re ready to write your first DAX expressions. In DAX, there are three types of expression: <em class="emphasistypeitalic"><strong class="emphasistypebold">calculated columns</strong></em>, <em class="emphasistypeitalic"><strong class="emphasistypebold">measures</strong></em>, and <em class="emphasistypeitalic"><strong class="emphasistypebold">calculated tables</strong></em>. However, in this chapter, we will only be addressing the first two types (we look briefly at calculated tables in Chapter <span><a href="#calibre_link-87" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>15</span></a></span>).</p><div class="formalpara" id="calibre_link-646"><div class="heading1">Note</div><p class="para6" id="calibre_link-647">You already know that DAX is the acronym for “Data Analysis Expressions.” However, we often refer to “DAX <em class="emphasistypeitalic"><strong class="emphasistypebold">expressions</strong></em>” because it seems clearer to do so.</p></div><p class="simplepara" id="calibre_link-648">Firstly, you will learn how to write calculations using the calculated column. This will be the part of DAX that will be intuitive to you, particularly if you are an Excel user. Calculated columns will seem no different to you than using Excel formulas. When we move forward to learn how and why we need DAX measures, however, things may become a little more challenging. One of the biggest hurdles when learning DAX is understanding the difference between the calculated column and the measure, and this is something that&nbsp;we will also be exploring in this chapter. For instance, the same DAX expression that’s used in a calculated column can’t typically be used in a DAX measure, but perversely, most DAX expressions used in measures can be put into a calculated <span id="calibre_link-649">column</span>.</p><section class="section" id="calibre_link-152"><h2 class="booksubtitle">Calculated Columns</h2><p class="simplepara" id="calibre_link-650">When learning DAX, most people understand expressions that are entered into calculated columns because they are very similar to creating <span id="calibre_link-651">Excel formulas</span>, particularly if you use formulas in Excel tables. In DAX, you will find many of your favorite Excel functions, such as IF, TODAY, ROUNDUP, and SUM, that can be used in a calculated column.</p><p class="simplepara" id="calibre_link-652">This is why newbies to DAX mistakenly think that DAX is just like Excel and create a plethora of calculated columns when they really should be creating measures, which are more efficient in every way. The thing to understand about the calculated column is that, just like copying down on an Excel formula, the calculated column is evaluated for <em class="emphasistypeitalic"><strong class="emphasistypebold">every row</strong></em> in the table and therefore can be process heavy. We will see that this is very different from how measures are evaluated.</p><section class="section" id="calibre_link-153"><h3 class="booksubtitle">Creating Simple Calculated Columns</h3><div class="calibre4" id="calibre_link-653">To create our first DAX expression in a calculated column, let’s take a very simple calculation and multiply the CASES SOLD values in the Winesales table by 10 percent. In Chapter <span><a href="#calibre_link-72" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>2</span></a></span>, you learned how to create a new column. Ensuring that the Winesales table is selected in Data view, you click on the <strong class="emphasistypebold">New Column</strong> button on the <strong class="emphasistypebold">Table Tools</strong> tab. In the DAX editor, enter the following <span id="calibre_link-654">expression</span>:<div class="programcode" id="calibre_link-655"><div class="calibre4"><div class="fixedline">10 PC of Cases = Winesales[CASES SOLD] * 0.1</div></div></div></div><div class="para" id="calibre_link-656">When you’ve finished typing, you can press the enter key, or you can click on the tick to the left of the DAX editor. Your calculated column called “10 PC of Cases” is created and joins the Fields list; see Figure <span><a href="#calibre_link-88" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-1</a></span>.<figure class="figure1" id="calibre_link-88"><div class="mediaobject" id="calibre_link-657"><img alt="" src="images/000248.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-1</span><p class="simplepara1">The calculated column joins the <span id="calibre_link-658" class="calibre11">Fields list</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-659">Let’s now see how we can use the IF function in DAX in a calculated column. We could, for instance, add a column in the Winesales table that’s populated with either “Team A” or “Team B.” This column will group our salespeople as follows: Salespeople with IDs 1, 3, and 6 are in Team A, and other salespeople are in Team B. We’ll call this new column “Team”.</p><div class="para" id="calibre_link-660">In the DAX editor, enter this code noting the use of the double pipe for <span id="calibre_link-661">“OR</span>”:<div class="programcode" id="calibre_link-662"><div class="calibre4"><div class="fixedline">Team =</div><div class="fixedline">IF (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales[SALESPERSON ID] = 1</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| Winesales[SALESPERSON ID] = 3</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| Winesales[SALESPERSON ID] = 6,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Team A",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Team B"</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-663">Similarly, you could group the values in the CASES SOLD column into “High” and “Low” volume where high volume is any sales where CASES SOLD is between 50 and 400 by using this DAX expression, noting the use of the double ampersand for <span id="calibre_link-664">“AND</span>”:<div class="programcode" id="calibre_link-665"><div class="calibre4"><div class="fixedline">Volume =</div><div class="fixedline">IF (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] &gt;= 50</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; Winesales[CASES SOLD] &lt;= 400,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"High",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Low"</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-666">Creating these calculated columns has been an easy introduction to DAX because, as we’ve seen, the expressions are very similar to formulas in Excel. The reason we’ve included these calculated columns here is because they’re simple examples that teach you DAX syntax and that every Excel user can do.</p><p class="simplepara" id="calibre_link-667">However, we wouldn’t recommend you do such calculations here.<sup class="calibre7"><a type="noteref" href="#calibre_link-89" id="calibre_link-108" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup> There’s a more efficient way to create these columns, and that’s to generate them in Power Query&nbsp;using Power Query's conditional column.</p></section><section class="section" id="calibre_link-154"><h3 class="booksubtitle">Looking at the RELATED Function</h3><p class="simplepara" id="calibre_link-668">So we’ve established that there are common functions to both Excel and DAX such as the IF function. However, if using <span id="calibre_link-669"></span>calculated columns isn’t always the most efficient way to generate data, why would we need to use them? There are some functions that are specific to DAX and give us reasons to author our DAX expressions in the context of a calculated column. One of these functions is the <span id="calibre_link-670">RELATED function</span><span id="calibre_link-671"></span>.</p><div class="para" id="calibre_link-672">This function returns a value from a related table and is similar in purpose&nbsp;to the VLOOKUP function in Excel. However, RELATED will only return values from the <em class="emphasistypeitalic">one side</em> of the relationship to the many side. For example, if you want to show the customer names related to the CUSTOMER ID’s in the Winesales table, you could use this DAX expression in a calculated column in the <span id="calibre_link-673">Winesales table</span>:<div class="programcode" id="calibre_link-674"><div class="calibre4"><div class="fixedline">Customer Name from Customers Table =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RELATED ( Customers[CUSTOMER NAME] )</div></div></div></div><div class="para" id="calibre_link-675">You will now see the names associated with each <span id="calibre_link-676">CUSTOMER ID</span> in the calculated column; see Figure <span><a href="#calibre_link-90" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-2</a></span>.<figure class="figure1" id="calibre_link-90"><div class="mediaobject" id="calibre_link-677"><img alt="" src="images/000121.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-2</span><p class="simplepara1">The RELATED function returns values from related tables</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-678">Often, the generation of the calculated column using RELATED where you populate values from related tables is used solely for ad hoc reasons. Once you have the customer names alongside their transactions, you’ll find it’s often easier to cross-check your data analysis. Once the column has served its purpose, it can be removed.<span id="calibre_link-679"></span></p><div class="formalpara" id="calibre_link-680"><div class="heading1">Note</div><p class="para6" id="calibre_link-681">If these were Excel tables and we wanted to populate the Winesales Excel table with the customer names in the Customers Excel table, we would use the VLOOKUP function in the Winesales Excel table like this:</p><p class="simplepara" id="calibre_link-682">=VLOOKUP ( [@CUSTOMER ID] , Customers, 2, 0)</p><p class="simplepara" id="calibre_link-683">The “@” symbol means “use the value in the current row of the Excel table.” Using the value from the current row is implicit in DAX calculated columns.</p></div><div class="calibre4" id="calibre_link-684">You can also use RELATED <span id="calibre_link-685"></span>to pull through values from <em class="emphasistypeitalic">indirectly</em> related tables into the fact table. For example, the <span id="calibre_link-686">Regions table</span> is related to the Customers table that is in turn related to the Winesales table as shown in Figure <span><a href="#calibre_link-91" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-3</a></span>.<figure class="figure1" id="calibre_link-91"><div class="mediaobject" id="calibre_link-687"><img alt="" src="images/000178.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-3</span><p class="simplepara1">The Regions table has an indirect relationship to the Winesales table</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-688">Therefore, we could populate each REGION name alongside each sales transaction in the Winesales table by using this code (see Figure <span><a href="#calibre_link-92" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-4</a></span>):</p><div class="para" id="calibre_link-689"><span class="emphasisfontcategorynonproportional">REGION NAME = RELATED ( Regions[REGION] )</span><figure class="figure1" id="calibre_link-92"><div class="mediaobject" id="calibre_link-690"><img alt="" src="images/000153.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-4</span><p class="simplepara1">Using RELATED to return the Region <span id="calibre_link-691" class="calibre11">names</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-692">Notice that we’ve named this column REGION NAME to distinguish it from the REGION column in the Regions table.</p><div class="para" id="calibre_link-693">Let’s look more closely at the RELATED function. You should understand that you can only use this function in the following two <span id="calibre_link-694">circumstances</span>:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-695">The tables must be related.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-696">Only values from tables on the <em class="emphasistypeitalic">one</em> side of a relationship can be returned to tables on the <em class="emphasistypeitalic">many</em> side.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-697">The act of populating values from tables that sit on the one side of a relationship into tables that sit on the many is called <span id="calibre_link-698"><em class="emphasistypeitalic">denormalization</em></span><span id="calibre_link-699"></span>. For instance, in the example in Figure <span><a href="#calibre_link-92" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-4</a></span>, we’ve denormalized the Regions table by extracting the values in the REGION column into the Winesales table using RELATED. There are at least three <span id="calibre_link-700">advantages</span> in doing this:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-701">You now know in which Region each sales transaction was made.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-702">If you need to use the region names in a visual, you can use the calculated column in the Winesales table. Therefore, you no longer need to see the Regions table in Report view. If this is the case, you can hide the Regions table. To hide a table in Report view, right-click the table name in the Fields list in either <strong class="emphasistypebold">Data view</strong> or <strong class="emphasistypebold">Model view</strong>, and select <strong class="emphasistypebold">Hide in report view</strong>; see Figure <span><a href="#calibre_link-93" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-5</a></span>.<span id="calibre_link-703"></span></p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-704">You can perform a distinct count on the REGION NAME column&nbsp;in the Winesales table to calculate how many <em class="emphasistypeitalic">different</em> Regions we’ve sold our wines in. We’ll do this calculation later, but because the sales transactions must be directly associated with the regions in which they were made, this would be a difficult expression if we left the REGION values&nbsp;in the Regions table.</p></div><div class="clearboth">&nbsp;</div></li></ol></div><figure class="figure1" id="calibre_link-93"><div class="mediaobject" id="calibre_link-705"><img alt="" src="images/000128.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-5</span><p class="simplepara1"><span id="calibre_link-706" class="calibre11">Hiding tables</span> in Report view</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-707">Understanding the RELATED function allows us to do another mandatory calculation in our data model. Perhaps you’ve noticed that although we have a Winesales table, we have no sales values. However, we can now calculate them. We can multiply the CASES SOLD column in the Winesales table with the PRICE PER CASE column in the Wines table, and because the Winesales table is related to the Wines table in a many-to-one relationship, we can use RELATED to do this.</p><p class="simplepara" id="calibre_link-708">We’re going to look at two different methods of using RELATED to calculate the <span id="calibre_link-709">Sales revenue values</span>.</p><div class="para" id="calibre_link-710">For method #1, we could create two calculated columns. The first column, called “PRICE”, uses RELATED to populate the PRICE PER CASE values into the Winesales table. The second column multiplies the “PRICE” column by the CASES SOLD column and is called “Sales”:<div class="programcode" id="calibre_link-711"><div class="calibre4"><div class="fixedline">PRICE =</div><div class="fixedline">RELATED ( Wines[PRICE PER CASE] )</div></div><div class="calibre4"><div class="fixedline">SALES =</div><div class="fixedline">Winesales[CASES SOLD] * Winesales[PRICE]</div></div></div></div><div class="para" id="calibre_link-712">Method #2 requires just one calculated column. You can use RELATED to find the PRICE PER CASE values from the Wines table for each row in the Winesales table <em class="emphasistypeitalic">in memory</em>&nbsp;and then multiply by CASES SOLD. In other words, you don’t need to see the price of each wine before you multiply it by the CASES SOLD values:<div class="programcode" id="calibre_link-713"><div class="calibre4"><div class="fixedline">SALES =</div><div class="fixedline">Winesales[CASES SOLD] * RELATED ( Wines[PRICE PER CASE] )</div></div></div></div><div class="para" id="calibre_link-714">What many people who are new to DAX would now think is that the SALES calculated column has solved the problem of calculating total sales values in a visual on the report canvas. For instance, we can now use this column in the Values bucket of a visual to find the total sales for each wine; see Figure <span><a href="#calibre_link-94" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-6</a></span>.<figure class="figure1" id="calibre_link-94"><div class="mediaobject" id="calibre_link-715"><img alt="" src="images/000084.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-6</span><p class="simplepara1">Using the SALES calculated column in the Values bucket to sum the sales</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-716">However, this is probably not such a great idea. Think about it; firstly, the calculated column will be evaluated for <em class="emphasistypeitalic">every row</em> in the Winesales fact table and <em class="emphasistypeitalic">recalculated</em> whenever the data is refreshed. That’s a lot of processing if you have millions of rows in your fact table.</p><p class="simplepara" id="calibre_link-717">Secondly, when you put this column into a visual containing items from dimensions, it performs <em class="emphasistypeitalic">another</em> calculation to sum these values for each item from the dimensions. Does this sound a very efficient way of doing this calculation? Probably not. The upshot of inefficient data models is that reports built on the top of them become slow to refresh and render (refer to Footnote 1 where there is a link for more information on this topic).</p><p class="simplepara" id="calibre_link-718">Therefore, the question now is the following: If you shouldn’t use a calculated column for the sales calculation, what should you use?</p><p class="simplepara" id="calibre_link-719">This is where <em class="emphasistypeitalic">measures</em> can help us. We will revisit our sales calculation in Chapter <span><a href="#calibre_link-95" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>5</span></a></span>, and rather than using a calculated column to perform the evaluation, we will be using a measure. But for now, we’re going to leave calculated columns behind us (we will revisit the calculated column later in this book when we explore some complex expressions that require their use). If you’re an Excel user, you’ll feel quite at home creating calculated columns using the DAX functions that have a replica in Excel. Nevertheless, you probably won’t have the same comfortable feeling when you come to writing DAX measures. This is where DAX becomes a little more challenging, so let’s move forward and learn how to author DAX measures.</p></section></section><section class="section" id="calibre_link-155"><h2 class="booksubtitle">DAX Measures</h2><p class="simplepara" id="calibre_link-720">We’re now ready to look at the second type of DAX expression, the measure. There are two types of <span id="calibre_link-721">measures</span> that you can use in visuals: <em class="emphasistypeitalic">implicit</em> measures and <em class="emphasistypeitalic">explicit</em> measures (however, we don’t normally call them “explicit measures,” just “measures”&nbsp;but implicit measures are always named accordingly). What’s the difference between implicit and explicit measures? Well, let’s start with the implicit measure first.</p><section class="section" id="calibre_link-156"><h3 class="booksubtitle">Implicit Measures</h3><p class="simplepara" id="calibre_link-722">If you’ve created any Power BI visual, you’ve created an <span id="calibre_link-723">implicit measure</span><span id="calibre_link-724"></span><em class="emphasistypeitalic"><strong class="emphasistypebold">.</strong></em> Have you ever wondered what the sigma symbol ( ∑ ) beside a numeric column in the Fields list means? It has a more precise purpose than signaling a column containing numbers. The sigma indicates that when you put this column into the Values bucket of a visual, the data in this column will automatically be aggregated. This is what we mean by an implicit measure.</p><div class="para" id="calibre_link-725">The sigma normally indicates that the column will be summed, but you can perform other aggregations such as averages or find the maximum or minimum value by changing the function on an ad hoc basis. To do this, use the drop-down beside the column name in the Values bucket and, for example, change this to “Average” as shown in Figure <span><a href="#calibre_link-96" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-7</a></span> where the steps to generate an implicit measure have been numbered.<figure class="figure1" id="calibre_link-96"><div class="mediaobject" id="calibre_link-726"><img alt="" src="images/000107.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-7</span><p class="simplepara1">Creating an implicit measure</p></div></figcaption></figure></div><div class="para" id="calibre_link-727"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-728">The column CASES SOLD has a sigma beside it <span class="emphasisfontcategorynonproportional">&ndash;</span> ∑.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-729">When this column is put into the Values bucket, it defaults to SUM, but you can change the function to AVERAGE by using the drop-down.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-730">The implicit measure has calculated the average CASES SOLD for the items displayed in the visual, in this case, each wine.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-731">However, there are several drawbacks to using implicit measures. Consider these scenarios:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-732">You may want to rename the implicit measure “Average of CASES SOLD” to something more concise. You can do this by double-clicking on the entry in the Values bucket, but you would have to repeat this every time you use an implicit measure and then want to rename it.</p></li><li class="calibre9"><p class="para2" id="calibre_link-733">If you rename the implicit measure, the name of a measure in the visual won’t match the column name in the Fields list.</p></li><li class="calibre9"><p class="para2" id="calibre_link-734">Although you normally want to use the SUM function, you <em class="emphasistypeitalic">often</em> want to use AVERAGE as well. You would have to keep changing the function to AVERAGE.</p></li><li class="calibre9"><p class="para2" id="calibre_link-735">In some visuals, you might like to format an implicit measure with two decimal places and sometimes with no decimal places. You would not be able to have different numeric formatting for the implicit measure in different visuals.</p></li><li class="calibre9"><p class="para2" id="calibre_link-736">What if you want to calculate 10 percent of the sum of the CASES SOLD&nbsp;values for each wine, or indeed, any calculation on the total values?&nbsp;You can't do this using an implicit measure.</p></li></ul></div></div><p class="simplepara" id="calibre_link-737">This is the trouble with implicit measures; they just don’t make the grade. So let’s move the focus of this chapter to what we’re really here for, and that’s to learn how to create our own explicit measures using DAX.</p></section><section class="section" id="calibre_link-157"><h3 class="booksubtitle">Explicit Measures</h3><div class="calibre4" id="calibre_link-738">If you create your own measures rather than relying on implicit <span id="calibre_link-739">measures</span>, these are some of the benefits:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-740">You’ll have more control over the aggregation performed by the measure and be able to name it accordingly.</p></li><li class="calibre9"><p class="para2" id="calibre_link-741">You’ll be able to use different numeric formatting for different measures.</p></li><li class="calibre9"><p class="para2" id="calibre_link-742">Explicit measures will become a constituent part of the data model. Your measures will join the Fields list, and you, or people using your data, can use and reuse the measures whenever you need to visualize a particular calculation.</p></li><li class="calibre9"><p class="para2" id="calibre_link-743">By using DAX, you can go far beyond just simple aggregations of your data. You can perform complex calculations to get to the insights you really need.</p></li></ul></div></div><p class="simplepara" id="calibre_link-744">So let’s bite the bullet and create our first DAX measures. Once we’ve done this, we can then answer the pressing question that has yet to be answered, and that is <em class="emphasistypeitalic">what exactly is a measure</em>?</p><p class="simplepara" id="calibre_link-745">Before we start, however, we need to find a place to store our measures. Explicit measures are table agnostic and can be stored in any table. However, it makes sense to create a table that will hold only measures.</p></section><section class="section" id="calibre_link-158"><h3 class="booksubtitle">Creating a Measures Table</h3><p class="simplepara" id="calibre_link-746">To do this, on the Home tab, click on the <strong class="emphasistypebold">Enter Data</strong> button. In the Create <span id="calibre_link-747">Table</span> pane, give your table a name, for example, “Measures Table” (you can’t name the table “Measures” because this is a reserved word), and load the table.</p><div class="para" id="calibre_link-748">When you put a measure into this table and delete the column that’s there, a “measures” icon will display beside the table in the Fields list, and the table will move to the top of the list; see Figure <span><a href="#calibre_link-97" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-8</a></span>.<span id="calibre_link-749"></span><figure class="figure1" id="calibre_link-97"><div class="mediaobject" id="calibre_link-750"><img alt="" src="images/000222.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-8</span><p class="simplepara1">The Measures table will sit at the top of the Fields list</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-751">However, it’s not mandatory to store your measures in a separate table. Some data modelers prefer to store measures in the fact table or in the table from where the data is being used by the measure.</p></section><section class="section" id="calibre_link-159"><h3 class="booksubtitle">Creating Simple DAX Measures</h3><p class="simplepara" id="calibre_link-752">The first measure we’re going to construct will replace the implicit measure that calculates the sum of the CASES SOLD. To create this measure, in <strong class="emphasistypebold">Report</strong> view, right-click on your Measures table in the Fields list and select <strong class="emphasistypebold">New measure</strong> from the shortcut menu. You could instead click on the <strong class="emphasistypebold">New Measure</strong> button on the <strong class="emphasistypebold">Home</strong> tab. However, if you use this method, ensure that the table you have selected in the Fields list is the table where you want to put your measure.</p><div class="formalpara" id="calibre_link-753"><div class="heading1">Tip</div><p class="para6" id="calibre_link-754">If your measure is accidentally stored in the wrong table (or you just want to move it), use the Fields list in <strong class="emphasistypebold">Model</strong> view where you can drag and drop measures between tables.</p></div><div class="calibre4" id="calibre_link-755">Once you have selected New measure, the DAX editor will appear at the top of the screen as it did when we created calculated columns. In the DAX editor, in front of the equals sign ( = ), name your measure, for example, “Total Cases”, and type the following DAX expression:<div class="programcode" id="calibre_link-756"><div class="calibre4"><div class="fixedline">Total Cases =</div><div class="fixedline">SUM ( Winesales[CASES SOLD] )</div></div></div></div><div class="para" id="calibre_link-757">You can see this expression in the DAX <span id="calibre_link-758">editor</span> in Figure <span><a href="#calibre_link-98" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-9</a></span>.<figure class="figure1" id="calibre_link-98"><div class="mediaobject" id="calibre_link-759"><img alt="" src="images/000232.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-9</span><p class="simplepara1">Your first DAX measure in the DAX editor</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-760">Press the Enter key and your measure will display in the Measures table. You can now delete “Column1” from this table.</p><div class="formalpara" id="calibre_link-761"><div class="heading1">Note</div><p class="para6" id="calibre_link-762">DAX measure names are not case sensitive and can contain any characters. However, we would recommend restricting your measure names to containing just letters and/or numbers and spaces. We would also recommend that you keep the names of tables, columns, and measures simple and straightforward. I particularly like Chris Webb’s blog on this topic: <span><a href="https://blog.crossjoin.co.uk/2020/06/28/naming-tables-columns-and-measures-in-power-bi/" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://blog.crossjoin.co.uk/2020/06/28/naming-tables-columns-and-measures-in-power-bi/</span></span></a></span></p></div><div class="calibre4" id="calibre_link-763">DAX measures are only calculated when they are used, so you must put the measure into the Values bucket of a visual before you can see the calculation. For example, in Figure <span><a href="#calibre_link-99" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-10</a></span>, in a Table visual, we’ve used the WINE column from the Wines dimension and then dragged the “Total Cases” measure into the Values bucket of the <span id="calibre_link-764">visual</span>.<figure class="figure1" id="calibre_link-99"><div class="mediaobject" id="calibre_link-765"><img alt="" src="images/000170.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-10</span><p class="simplepara1">Measures are calculated when they are used<span id="calibre_link-766" class="calibre11"></span></p></div></figcaption></figure></div><div class="para" id="calibre_link-767">One of the great advantages of using explicit measures is that the numeric formatting is stored with the measure. To format a measure, select the measure by clicking on it in the Fields list, and the measure expression shows in the DAX editor. Then, on the <strong class="emphasistypebold">Measures tools</strong> tab, in the <strong class="emphasistypebold">Formatting</strong> group of commands, you can select the numeric formatting you require, for example, a thousands separator; see Figure <span><a href="#calibre_link-100" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-11</a></span>.<figure class="figure1" id="calibre_link-100"><div class="mediaobject" id="calibre_link-768"><img alt="" src="images/000195.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-11</span><p class="simplepara1">Use the <span id="calibre_link-769" class="calibre11">Formatting group</span> of commands on the Measures tools tab&nbsp;to format your measure</p></div></figcaption></figure></div><div class="para" id="calibre_link-770">Let’s create our second measure, this time to calculate the average cases sold as follows:<div class="programcode" id="calibre_link-771"><div class="calibre4"><div class="fixedline">Avg Cases =</div><div class="fixedline">AVERAGE ( Winesales[CASES SOLD] )</div></div></div></div><div class="para" id="calibre_link-772">Another analysis you may need to perform on your data is calculating “how many,” for example, the number of sales for each different wine. In other words, we need to count the number of rows in the Winesales table for each wine shown in the visual. The implicit measure that we could use here uses the DAX&nbsp;COUNT function that counts the <em class="emphasistypeitalic">number of values</em> in the column you reference (for more information&nbsp;on the COUNT function, visit <span><a href="https://docs.microsoft.com/en-us/dax/count-function-dax" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://docs.microsoft.com/en-us/dax/count-function-dax</span></span></a></span>). However, we want to count the <em class="emphasistypeitalic">number of rows,</em> and therefore, only an explicit measure will do the job we want<em class="emphasistypeitalic"><strong class="emphasistypebold">.</strong></em> The DAX function we need is the <span id="calibre_link-773">COUNTROWS function</span> whose name describes its purpose. This function accepts a table as its only argument which is the table whose rows you want to count, so this would be the expression:<div class="programcode" id="calibre_link-774"><div class="calibre4"><div class="fixedline">No. of Sales =</div><div class="fixedline">COUNTROWS ( Winesales )</div></div></div></div><div class="para" id="calibre_link-775">One of the <span id="calibre_link-776">benefits</span> of creating these simple measures is that you can use them to analyze any items from any dimension. As you generate visuals, taking items from different dimensions, the measures will consistently recalculate accordingly. For example, in Figure <span><a href="#calibre_link-101" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-12</a></span>, we’re using our measures in three Table visuals showing data from the following <span id="calibre_link-777">dimensions</span>:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-778">WINE from the Wines dimension</p></li><li class="calibre9"><p class="para2" id="calibre_link-779">SALESPERSON from the SalesPeople dimension</p></li><li class="calibre9"><p class="para2" id="calibre_link-780">REGION from the Regions dimension</p></li></ul></div><figure class="figure1" id="calibre_link-101"><div class="mediaobject" id="calibre_link-781"><img alt="" src="images/000204.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-12</span><p class="simplepara1">Measures are calculated according to the data comprising the visual<span id="calibre_link-782" class="calibre11"></span></p></div></figcaption></figure></div><div class="para" id="calibre_link-783">Our final example of a simple DAX measure will accomplish an insightful calculation that would be difficult to repeat in Excel, that of the distinct count. In DAX, we have an aggregate function for this job. Its name is <span id="calibre_link-784">DISTINCTCOUNT</span>, and we can simply reference the column required for the analysis. Let’s discover how many <em class="emphasistypeitalic">different</em> customers we sold our wines to by authoring this measure:<div class="programcode" id="calibre_link-785"><div class="calibre4"><div class="fixedline">Distinct Customers =</div><div class="fixedline">DISTINCTCOUNT ( Winesales[CUSTOMER ID] )</div></div></div></div><div class="para" id="calibre_link-786">While we’re focusing on the DISTINCTCOUNT function, remember that we created this <em class="emphasistypeitalic">calculated column</em> in the Winesales table:<div class="programcode" id="calibre_link-787"><div class="calibre4"><div class="fixedline">REGION NAME =</div><div class="fixedline">RELATED ( Regions[REGION NAME] )</div></div></div></div><div class="para" id="calibre_link-788">We can use this calculated column to create a measure to calculate in how many <em class="emphasistypeitalic">different</em> regions we’ve sold our wines:<div class="programcode" id="calibre_link-789"><div class="calibre4"><div class="fixedline">Distinct Regions =</div><div class="fixedline">DISTINCTCOUNT ( Winesales[REGION NAME] )</div></div></div><figure class="figure1" id="calibre_link-102"><div class="mediaobject" id="calibre_link-790"><img alt="" src="images/000146.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-13</span><p class="simplepara1">Using the <span id="calibre_link-791" class="calibre11">DISTINCTCOUNT function</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-792">You will observe in Figure <span><a href="#calibre_link-102" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-13</a></span> that we’ve sold “Bordeaux” to 57 different customers and “Champagne” to 53 different customers. We’ve sold “Rioja” in 17 different regions.</p></section><section class="section" id="calibre_link-160"><h3 class="booksubtitle">What Exactly Is a Measure?</h3><p class="simplepara" id="calibre_link-793">We’ve created a few simple explicit measures, but we still haven’t answered the following question: What is a measure? The answer, like measures themselves, is not a straightforward one. <em class="emphasistypeitalic">A measure is a DAX expression that is used in a Power BI visual to return a scalar value and is evaluated in a specific filter context.</em> In other words, DAX measures <em class="emphasistypeitalic">filter the rows of tables</em> and typically perform an <em class="emphasistypeitalic">aggregation</em> on the filtered data to return a scalar value (which is a single value) that is <span id="calibre_link-794">visualized</span> in the report.</p><div class="formalpara" id="calibre_link-795"><div class="heading1">Note</div><p class="para6" id="calibre_link-796">Not all DAX measures perform aggregations. As we will see later, some DAX measures can return text values. Nevertheless, they will be scalar in nature&nbsp;in that they will return a single value.</p></div><div class="calibre4" id="calibre_link-797">For example, a typical DAX measure might sum the values in a column containing quantities (e.g., the “Total Cases” measure)&nbsp;where the rows in the fact table are filtered for each year, and this analysis is visualized in a column chart&nbsp;where each year's totals (e.g., 2021)&nbsp;can be seen; see Figure <span><a href="#calibre_link-103" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-14</a></span>.<figure class="figure1" id="calibre_link-103"><div class="mediaobject" id="calibre_link-798"><img alt="" src="images/000100.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-14</span><p class="simplepara1">Measures typically aggregate <span id="calibre_link-799" class="calibre11">filtered data</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-800">Let’s take a closer look at these three aspects of the measure:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-801">All visuals on the report&nbsp;canvas use measures.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-802">Measures return scalar (single) values.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-803">Measures are calculated where a filter has been placed on the data&nbsp;model. This is known as the <em class="emphasistypeitalic">filter context</em> and is the subject of the next chapter.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><section class="section" id="calibre_link-804"><h4 class="heading2">All Report Visuals Use Measures</h4><p class="simplepara" id="calibre_link-805">When we authored our calculated columns, these are seen in Data view and they&nbsp;returned a value for every row in the table. A measure, on the other hand, is used in Report view and is placed in the Values bucket of a visual. <em class="emphasistypeitalic">All</em> <span id="calibre_link-806"><em class="emphasistypeitalic">visuals</em></span> <em class="emphasistypeitalic">use measures</em> in the Values bucket even if they are implicit measures (which, as already described, is a numeric column that you’ve dragged into the Values bucket).</p><div class="formalpara" id="calibre_link-807"><div class="heading1">Note</div><p class="para6" id="calibre_link-808">There is an exception to this rule. The Key Influencers visual is best used with a non-aggregated column, rather than a measure. For more information on the Key Influencers visual, visit my blog: <span><a href="http://www.burningsuit.co.uk/blog/2020/01/the-key-influencers-visual-versus-strictly-come-dancing/" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">www.burningsuit.co.uk/blog/2020/01/the-key-influencers-visual-versus-strictly-come-dancing/</span></span></a></span></p></div><p class="simplepara" id="calibre_link-809">Another way to think of measures is that they are <em class="emphasistypeitalic">report-level</em> calculations as opposed to the <em class="emphasistypeitalic">row-level</em> calculations that you create in calculated columns.</p></section><section class="section" id="calibre_link-810"><h4 class="heading2">Measures Return Scalar Values</h4><div class="calibre4" id="calibre_link-811"><span id="calibre_link-812"></span>All Power BI visuals are <span id="calibre_link-813">reporting tools</span> that group and aggregate your data, just like an Excel pivot table or pivot chart. Therefore, to understand this aspect of the measure, let’s put our Excel hats on and remind ourselves that in Power BI, Table and Matrix visuals are the equivalents of Excel pivot tables. For instance, consider the values in the Table visual in Figure <span><a href="#calibre_link-104" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-15</a></span>.<figure class="figure1" id="calibre_link-104"><div class="mediaobject" id="calibre_link-814"><img alt="" src="images/000035.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-15</span><p class="simplepara1">The value identified sits in the equivalent of the “Values” area of an Excel pivot table and would be in a “cell”</p></div></figcaption></figure></div><div class="para" id="calibre_link-815">If this were an Excel pivot table, the “Total Cases” values would be sitting in the “Values” area of the pivot table, and every value returned by the calculation would be sitting in a “cell.” We’ve identified the “cell” for “Bordeaux” wine that holds the value of <strong class="emphasistypebold">54,070</strong> being returned by this measure:<div class="programcode" id="calibre_link-816"><div class="calibre4"><div class="fixedline">Total Cases =</div><div class="fixedline">SUM ( Winesales[Cases Sold] )</div></div></div></div><p class="simplepara" id="calibre_link-817">What does this value represent? It represents the sum of the values in the CASES SOLD column for all the rows in the Winesales table that equate to “Bordeaux” wines.</p><div class="para" id="calibre_link-818">If the same data were sitting in an Excel pivot table, we could double-click on this value and drill through to display these rows on a separate sheet, as shown in Figure <span><a href="#calibre_link-105" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-16</a></span>.<figure class="figure1" id="calibre_link-105"><div class="mediaobject" id="calibre_link-819"><img alt="" src="images/000061.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-16</span><p class="simplepara1">In an <span id="calibre_link-820" class="calibre11">Excel pivot table</span>, you can drill through</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-821">We can’t drill through on the value in the Power BI Table visual, but nevertheless, the measure in memory does the same. It filters a set of <em class="emphasistypeitalic">specific rows</em> from a table. In our example, it filters the rows in the Winesales table for “Bordeaux” wines. However, the result of the measure must sit in the “cell” of the Table visual just as it sits in the cell of the pivot table. Therefore, the measure must return a <em class="emphasistypeitalic">scalar value.</em> Typically, this would mean that the measure must aggregate the data; for example, sum the cases sold for “Bordeaux” wines.</p><div class="formalpara" id="calibre_link-822"><div class="heading1">Note</div><p class="para6" id="calibre_link-823">Normally, a scalar value would be a single numeric value, but measures can return single text values as well, so here, the term “scalar” is used in a more general sense to mean a single value of any data type.</p></div><div class="calibre4" id="calibre_link-824">We’ve established that measures must return scalar or single values, a concept that we’re sure you think is straightforward and easy to understand, but at some point, you’ll attempt to create measures that return errors that look like that shown in Figure <span><a href="#calibre_link-106" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-17</a></span>.<figure class="figure1" id="calibre_link-106"><div class="mediaobject" id="calibre_link-825"><img alt="" src="images/000021.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-17</span><p class="simplepara1">This <span id="calibre_link-826" class="calibre11">error message</span> displays when there is no aggregation</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-827">The error message in Figure <span><a href="#calibre_link-106" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-17</a></span> reads:</p><p class="para9" id="calibre_link-828"><em class="emphasistypeitalic">“A single value for column ‘CASES SOLD’ in table ‘Winesales’ cannot be determined. This can happen when a measure formula refers to a column that contains many values without specifying an aggregation such as min, max, count, or sum to get a single result.”</em></p><p class="para9" id="calibre_link-829">What is the reason for this error message? There is no <em class="emphasistypeitalic">aggregation</em> in the measure; it’s just multiplying two values.</p><div class="para" id="calibre_link-830">Another example of where a measure does not return a scalar value is shown in Figure <span><a href="#calibre_link-107" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3-18</a></span>. Here, the VALUES function is being used in a Table visual (we look at the VALUES function in a later chapter). The measure should return a scalar value, which it does when evaluating individual rows in the Table visual, but when calculating the Total row of the visual, it returns multiple values, and so an error message is displayed when the measure is put into a Table&nbsp;visual&nbsp;that has the Total row turned on.<figure class="figure1" id="calibre_link-107"><div class="mediaobject" id="calibre_link-831"><img alt="" src="images/000013.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 3-18</span><p class="simplepara1">Some measures return a table of values</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-832">The error message reads:</p><p class="para9" id="calibre_link-833"><em class="emphasistypeitalic">“A table of multiple values was supplied where a single value was expected.”</em></p><p class="para9" id="calibre_link-834">Even the most hardened DAX experts can be caught out by creating measures that don’t return scalars!</p><p class="simplepara" id="calibre_link-835">In this chapter we have explored the difference between calculated columns and measures.&nbsp;You understand that calculated columns are row level calculations&nbsp;while measures are used in all visuals and are calculations that are performed at report level.&nbsp;&nbsp;However, we’re still missing an explanation of the third and most important ingredient of the DAX measure, that all measures are evaluated in a <em class="emphasistypeitalic">specific filter context</em>. To understand what is meant by this, you will need to move forward to the next chapter where we will focus on the context in which our expressions are evaluated and why this is so important in understanding DAX measures.</p></section></section></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-108" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-89" role="doc-footnote"><p class="para3" id="calibre_link-836">The reason for this is that calculated columns have to be recalculated whenever the data is refreshed. This can have a big impact on the efficiency and performance of the report. You can find more information on this topic here: <span><a href="https://docs.microsoft.com/en-us/power-bi/guidance/import-modeling-data-reduction" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://docs.microsoft.com/en-us/power-bi/guidance/import-modeling-data-reduction</span></span></a></span></p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-140">
<div id="calibre_link-837" class="calibre2">
<div id="calibre_link-838" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-839"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_4" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_4</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">4.&nbsp;Evaluation Context</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-259" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-259"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-840">You have learned to author simple calculated columns and measures, but one of the most fundamental questions for DAX users is how these two types of expression differ. At this stage, you understand that calculated columns are row-level calculations and that measures are calculations that are performed at the report level. However, we need to be more specific regarding this differentiation, and you need to understand that the definitive difference lies in the context in which the expressions are evaluated. In calculated columns, expressions are evaluated in the <em class="emphasistypeitalic">row context</em>; in measures, they are evaluated in the <em class="emphasistypeitalic">filter context</em>. It is the latter of these that will be the main focus in this chapter. Once you understand the implications of the filter context, the implications of the row context are more readily understood.</p><section class="section" id="calibre_link-161"><h2 class="booksubtitle">The Filter Context</h2><div class="calibre4" id="calibre_link-841">In the last chapter, you learned that measures are report-level calculations and that they must return a scalar value. This brings us to the third and most important aspect of the measure, and that is that all DAX measures are <em class="emphasistypeitalic">evaluated in a specific filter context</em>. To understand what is meant by a “specific <span id="calibre_link-842">filter context</span>,” let’s compare these two different measures:<div class="programcode" id="calibre_link-843"><div class="calibre4"><div class="fixedline">Total Cases =</div><div class="fixedline">SUM ( Winesales[CASES SOLD] )</div></div><div class="calibre4"><div class="fixedline">Total Stores =</div><div class="fixedline">SUM ( Customers[NO. OF STORES] )</div></div></div></div><div class="para" id="calibre_link-844">You can see the <span id="calibre_link-845">evaluation</span> of these measures in Figure <span><a href="#calibre_link-260" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-1</a></span>, but why does the first measure return different values for each wine but the second measure return the same value? The reason is the <em class="emphasistypeitalic">filter context</em> that’s active when both these measures are evaluated.<figure class="figure1" id="calibre_link-260"><div class="mediaobject" id="calibre_link-846"><img alt="" src="images/000231.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-1</span><p class="simplepara1">Measures will return different values or&nbsp;the same value because of the filter context that is active</p></div></figcaption></figure></div><div class="para" id="calibre_link-847">When a measure is placed into any visual, before the measure is evaluated, the DAX engine <em class="emphasistypeitalic">in memory</em> places filters on tables in the data model depending on three <span id="calibre_link-848">factors</span>:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-849">The column or columns placed <em class="emphasistypeitalic">in the visual</em> that group&nbsp;and categorize the data</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-850">The columns <em class="emphasistypeitalic">in slicers</em> that are filtering the data in the visual</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-851">Any columns placed in <em class="emphasistypeitalic">the Filters pane</em> that are filtering the data in the visual</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-852">These three <span id="calibre_link-853">factors</span> come together to generate the filter context for the evaluation of the measure. We can’t see these filters on the data model. We just have to imagine them.</p><div class="formalpara" id="calibre_link-854"><div class="heading1">Note</div><p class="para6" id="calibre_link-855">The filtering of the data model happens in memory and is hidden from us. Therefore, in the Figures below and throughout this book, where we’re simulating what happens in memory, the in-memory tables have a dashed border to distinguish them from the tables you can see in Data view.</p></div><p class="simplepara" id="calibre_link-856">In our Table visual in Figure <span><a href="#calibre_link-260" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-1</a></span>, only factor #1 is relevant (there are no slicers or other filters).</p><section class="section" id="calibre_link-162"><h3 class="booksubtitle">Evaluations Using a Single Filter</h3><p class="simplepara" id="calibre_link-857">The column in the visual that’s grouping the data is the WINE column from the Wines dimension. The first value in this column to be calculated is the total cases for “Bordeaux” wine.</p><div class="para" id="calibre_link-858">Before the “Total Cases” measure calculates the value for “Bordeaux,” a filter is placed in memory on the Wines dimension to filter “Bordeaux” wines. If we could see the filter on this table, it might look something like Figure <span><a href="#calibre_link-261" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-2</a></span>.<figure class="figure1" id="calibre_link-261"><div class="mediaobject" id="calibre_link-859"><img alt="" src="images/000083.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-2</span><p class="simplepara1">The in-memory Wines <span id="calibre_link-860" class="calibre11">dimension</span> that has been filtered to one row</p></div></figcaption></figure></div><div class="para" id="calibre_link-861">If we examine the data model (Figure <span><a href="#calibre_link-262" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-3</a></span>), we can see that the Wines dimension is related to the Winesales fact table in a many-to-one relationship. The arrow tells us that if the Wines dimension is filtered, this filter is <em class="emphasistypeitalic">propagated</em> onward to the Winesales fact table.<figure class="figure1" id="calibre_link-262"><div class="mediaobject" id="calibre_link-862"><img alt="" src="images/000152.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-3</span><p class="simplepara1">Filters <span id="calibre_link-863" class="calibre11">propagate</span> from the Wines dimension to the Winesales fact table</p></div></figcaption></figure></div><div class="para" id="calibre_link-864">Therefore, the Winesales fact table is now <em class="emphasistypeitalic">cross-filtered</em> to only contain sales for “Bordeaux” wine that has the WINE ID that equals 1; see Figure <span><a href="#calibre_link-263" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-4</a></span>. Notice there is no filter in the WINE ID column in the Winesales table because the filter on the Winesales table is a cross-filter that is generated only through filter propagation.<figure class="figure1" id="calibre_link-263"><div class="mediaobject" id="calibre_link-865"><img alt="" src="images/000106.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-4</span><p class="simplepara1">The <span id="calibre_link-866" class="calibre11">fact table</span> is cross-filtered via the dimension</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-867">This is the only filter affecting this visual, so the measure now sums the CASES SOLD column for “Bordeaux” wines and returns <strong class="emphasistypebold">54,070</strong>.</p><p class="simplepara" id="calibre_link-868">The evaluation of the measure then moves on to “Champagne” and repeats the process of filtering the Wines dimension and cross-filtering the Winesales fact table using a <em class="emphasistypeitalic">different filter context</em> each time. In the next evaluation, for instance, the WINE column from the Wines dimension now equals “Champagne” and so now returns <strong class="emphasistypebold">49,158.</strong></p><div class="formalpara" id="calibre_link-869"><div class="heading1">Note</div><p class="para6" id="calibre_link-870">Experienced DAX users will know that this explanation of the filter context in action is a close approximation of what happens in memory and not exactly what happens. However, this explanation is easily understood at this stage of your knowledge and will serve you well for the time being. We will reveal what really happens under the hood later in this book.</p></div><p class="simplepara" id="calibre_link-871">And so on for all the wines in the WINE column of the Table visual<em class="emphasistypeitalic">. Every evaluation of the “Total Cases” measure is evaluated in a different filter context.</em></p><div class="para" id="calibre_link-872">There is a way that we can prove that our Wines dimension, in memory, is filtered to one row on the evaluation of a measure that analyzes each wine. We can create this measure that counts the rows of the Wines dimension:<div class="programcode" id="calibre_link-873"><div class="calibre4"><div class="fixedline">No. of Wines = COUNTROWS ( Wines )</div></div></div></div><div class="para" id="calibre_link-874">If we put this measure into a Table visual containing the <span id="calibre_link-875">WINE column</span> from the Wines dimension, the measure will return <strong class="emphasistypebold">1</strong> for the evaluation of each wine; see Figure <span><a href="#calibre_link-264" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-5</a></span>.<figure class="figure1" id="calibre_link-264"><div class="mediaobject" id="calibre_link-876"><img alt="" src="images/000177.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-5</span><p class="simplepara1">The “No. of Wines” measure returns 1 because the Wines dimension has been filtered down to one row for each evaluation</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-877">Notice too how “Lambrusco” wine returns a value because this measure filters only the Wines dimension and no other tables are involved.</p></section><section class="section" id="calibre_link-163"><h3 class="booksubtitle">Calculation in the Total Row</h3><div class="calibre4" id="calibre_link-878">This now brings us to the calculation for the <span id="calibre_link-879">Total row</span> of the visual, which returns <strong class="emphasistypebold">423,224</strong>; see Figure <span><a href="#calibre_link-265" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-6</a></span>.<figure class="figure1" id="calibre_link-265"><div class="mediaobject" id="calibre_link-880"><img alt="" src="images/000044.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-6</span><p class="simplepara1">The Total row is evaluated in a different filter context</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-881">This value is <em class="emphasistypeitalic">not</em> the sum of the total values for each wine shown in the visual. When the measure is evaluated for the Total row, the filter is removed from the WINE column of the Wines dimension, so the expression is evaluated for <em class="emphasistypeitalic">all</em> wines. In other words, it’s our expression “<em class="emphasistypeitalic">= SUM ( Winesales[CASES SOLD] )”</em> calculated in yet <em class="emphasistypeitalic">another different filter context.</em></p></section><section class="section" id="calibre_link-164"><h3 class="booksubtitle">Evaluations Using Multiple Filters</h3><div class="calibre4" id="calibre_link-882"><span id="calibre_link-883"></span>Let’s create some more filters that affect the Table visual. For instance, we could include a slicer using the SALESPERSON column from the SalesPeople dimension<sup class="calibre10"><a type="noteref" href="#calibre_link-266" id="calibre_link-273" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup> and also have the REGION column from the Regions dimension in a page-level filter<sup class="calibre10"><a type="noteref" href="#calibre_link-267" id="calibre_link-274" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">2</a></sup>; see Figure <span><a href="#calibre_link-268" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-7</a></span>.<figure class="figure1" id="calibre_link-268"><div class="mediaobject" id="calibre_link-884"><img alt="" src="images/000060.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-7</span><p class="simplepara1">Filters are now placed on the Table visual from the slicer and the page-level <span id="calibre_link-885" class="calibre11">filter</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-886">We’ve filtered salesperson “Abel” and region “Argentina”. You can see that the Total Cases value for “Bordeaux” is now <strong class="emphasistypebold">265</strong> because the filter context has changed; WINE equals “Bordeaux”, SALESPERSON equals “Abel”, and REGION equals “Argentina”. Again, we can imagine how these tables might look in memory; see Figure <span><a href="#calibre_link-269" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-8</a></span>.<figure class="figure1" id="calibre_link-269"><div class="mediaobject" id="calibre_link-887"><img alt="" src="images/000127.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-8</span><p class="simplepara1">The <span id="calibre_link-888" class="calibre11">in-memory tables</span> filtering the Table visual</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-889">You will notice, however, that the Total Stores measure is still returning the same value for every wine&nbsp;(i.e.,&nbsp;79). We will explain why presently.</p><div class="para" id="calibre_link-890">Again, we can examine the data model (Figure <span><a href="#calibre_link-270" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-9</a></span>) and can see how these filters propagate through the model and always arrive at the Winesales fact table, which is then cross-filtered accordingly.<figure class="figure1" id="calibre_link-270"><div class="mediaobject" id="calibre_link-891"><img alt="" src="images/000020.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-9</span><p class="simplepara1">Filters <span id="calibre_link-892" class="calibre11">propagate</span> through the data model and always arrive on the fact table</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-893">Notice how the Regions table creates a “snowflake” in the schema because it’s <em class="emphasistypeitalic">indirectly</em> related to the fact table via the Customers dimension. You can see how this arrangement of tables works; if the Regions table is filtered, for example, for “Argentina”, this filter is propagated through to the Customers dimension, so customers in Argentina are now filtered in memory. This filter is then propagated onward to the fact table.</p><p class="simplepara" id="calibre_link-894">Depending on how the visual is constructed and what filters affect the visual will determine the outcome of the measure. This now brings us to the “Total Stores” measure shown in Figure <span><a href="#calibre_link-260" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-1</a></span>. Notice it returns the same value of <strong class="emphasistypebold">1,181</strong> for every wine and also in the Total row. This measure is summing the NO. OF STORES column in the Customers dimension. The Customers dimension has no filter on it when this measure is evaluated. The only filter is on the Wines dimension. Therefore, for the evaluation of every wine, the measure sums the values in the NO. OF STORES column in the Customers table for <em class="emphasistypeitalic"><strong class="emphasistypebold">all</strong></em> the customers.</p><div class="para" id="calibre_link-895">Looking again at the data model (Figure <span><a href="#calibre_link-271" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-10</a></span>), we can see that if the Wines dimension is filtered, this filter is propagated to the fact table (shown by the tick), but the filter is <em class="emphasistypeitalic"><strong class="emphasistypebold">not</strong></em> propagated onward to the Customers dimension (shown by the cross), as the arrow always points from the one side of the relationship into the many.<figure class="figure1" id="calibre_link-271"><div class="mediaobject" id="calibre_link-896"><img alt="" src="images/000203.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-10</span><p class="simplepara1">Filters do not flow from the <span id="calibre_link-897" class="calibre11">fact table</span> to dimensions</p></div></figcaption></figure></div><div class="formalpara" id="calibre_link-898"><div class="heading1">Note</div><p class="para6" id="calibre_link-899">Well, how do you correctly calculate the number of stores in which each wine has been sold? One thing <em class="emphasistypeitalic">not</em> to do, tempting though it is, is to edit the relationship to a “bidirectional” filter. Instead, you can use the DAX function CROSSFILTER to programmatically reverse the direction of the filter propagation. We look at the CROSSFILTER function later in this book.</p></div><div class="calibre4" id="calibre_link-900">The filter context underpins all DAX measures and is the reason why it’s so important to distinguish between the two different types of table, dimension tables and fact tables, because they play two different <span id="calibre_link-901">roles</span> in the evaluation of the measure:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-902">The role of dimension tables is to group the data and to propagate filters through the data model into the fact table.</p></li><li class="calibre9"><p class="para2" id="calibre_link-903">The role of fact tables is to summarize subsets of data that have been cross-filtered from dimensions.</p></li></ul></div></div><p class="para9" id="calibre_link-904"><em class="emphasistypeitalic">DAX measures typically summarize data in the fact table that’s been cross-filtered by dimension tables.</em></p><p class="para9" id="calibre_link-905">So next time you’re wondering “why is my measure returning incorrect values,” it’s probably not the expression that’s at fault; it’s more likely because you haven’t understood the current filter context in which the measure has been evaluated.</p></section></section><section class="section" id="calibre_link-165"><h2 class="booksubtitle">The Row Context</h2><p class="simplepara" id="calibre_link-906">The filter context is not the only evaluation context that DAX uses. There is another evaluation context called the <em class="emphasistypeitalic">row context.</em> <span id="calibre_link-907">Row context</span> is applicable in any DAX expression that <em class="emphasistypeitalic">iterates the rows of a table</em> where the expression is bound to the values in the current row. All calculated columns&nbsp;are evaluated in the row context and this is&nbsp;how they differ from measures, which are always&nbsp;evaluated in the filter context. However, just to make life difficult, some measures will use both the filter context <em class="emphasistypeitalic">and</em> the&nbsp;row context in their evaluation. Also,&nbsp;there are some calculated columns whose row context can be turned into&nbsp;a filter context. We will be exploring these ideas as we move forward in this book.</p><div class="para" id="calibre_link-908">To understand the row context, let’s again refer to what we know about Excel formulas. In an Excel table, the formula is “copied down” where it is calculated for every row in the column. An “@” character is used in the formula to denote using the values in the current row. This is essentially what the row context is in DAX. When using the row context, the DAX expression iterates over every row in the table, and the values used in the expression are <em class="emphasistypeitalic">the values sitting in the current row;</em> see Figure <span><a href="#calibre_link-272" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4-11</a></span>.<figure class="figure1" id="calibre_link-272"><div class="mediaobject" id="calibre_link-909"><img alt="" src="images/000255.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 4-11</span><p class="simplepara1">Both Excel table formulas and DAX calculated columns use values from the current row, known as the “row context” in DAX</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-910">We can understand that calculated columns would normally use the row context, but measures can also use the row context in their evaluation. But surely the nature of all DAX measures is to group and summarize data, not to perform row-level calculations. Well, measures can perform row-level calculations too, and this is where the behavior of <em class="emphasistypeitalic">iterators</em> comes in, a concept we will explore in the next chapter.</p><p class="simplepara" id="calibre_link-911">However, let’s now summarize what you have learned in this chapter, and that is that all measures use the filter context in their evaluation. The filter context refers to filters that will be placed on the data model by the evaluation of the measure and depends on the construct of the visual in which the measure will be calculated and on any filters that impact on the visual. You now know also that there is a second evaluation context, the row context, where the DAX expression scans a table and performs row-level calculations as in the case of the calculated column. Understanding the two evaluation contexts that differentiate measures from calculated columns is the first major DAX concept that you have learned. Some people who have been using DAX, perhaps for some length of time, are often not able to explain this fundamental difference between measures and calculated columns.</p></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-273" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-266" role="doc-footnote"><p class="para3" id="calibre_link-912">For information on working with slicers, visit <span><a href="https://docs.microsoft.com/en-us/power-bi/visuals/power-bi-visualization-slicers" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://docs.microsoft.com/en-us/power-bi/visuals/power-bi-visualization-slicers</span></span></a></span></p></div><div class="clearboth1">&nbsp;</div></div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-274" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2</a></span><div class="calibre4" type="footnote" id="calibre_link-267" role="doc-footnote"><p class="para3" id="calibre_link-913">For information on working with the Filters pane, visit <span><a href="https://docs.microsoft.com/en-us/power-bi/create-reports/power-bi-report-filter?tabs=powerbi-desktop" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://docs.microsoft.com/en-us/power-bi/create-reports/power-bi-report-filter?tabs=powerbi-desktop</span></span></a></span></p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-95">
<div id="calibre_link-914" class="calibre2">
<div id="calibre_link-915" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-916"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_5" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_5</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">5.&nbsp;Iterators</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-285" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-285"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-917">There is a group of functions in DAX that are referred to as <span id="calibre_link-918"><em class="emphasistypeitalic">iterators</em></span><em class="emphasistypeitalic">,</em> and from their name, we can infer that these functions iterate tables in the evaluation of a DAX expression. Any DAX function that ends in an “X” is an iterator, such as the “X” aggregators: SUMX, AVERAGEX, MAXX, MINX, COUNTAX. There are also “X” iterating functions that aren’t aggregators such as CONCATENATEX and RANKX. Just to make life even more confusing, there are iterating functions that don’t end in “X” such as FILTER and ADDCOLUMNS.</p><p class="simplepara" id="calibre_link-919">We will explore the FILTER, CONCATENATEX, and RANKX functions later. The ADDCOLUMNS function is beyond the remit of the book, but hopefully it will be something you self-explore as your knowledge of DAX increases. The focus of this chapter will be the aggregating iterators: SUMX, AVERAGEX, MAXX, MINX, and COUNTAX.</p><div class="para8" id="calibre_link-920"><span id="calibre_link-921">Aggregating iterators</span> have two arguments: the table to be iterated and the expression that is to be evaluated for each row of the table, the result of which will then be aggregated. These functions create a row context inside the measure by iterating the table referenced by the function, and each row in the table is “visited” in memory by the measure. Remember that the measure will have generated a filter context first, so the table being iterated may have a filter or cross-filter on it.<figure class="figure1" id="calibre_link-286"><div class="mediaobject" id="calibre_link-922"><img alt="" src="images/000001.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 5-1</span><p class="simplepara1">The <span id="calibre_link-923" class="calibre11">SUMX function</span> iterates the cross-filtered fact table and performs a row-level calculation that is then summed by the measure</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-924">For example, consider the <span id="calibre_link-925">measure</span> “10 PC Increase Total” being evaluated in Figure <span><a href="#calibre_link-286" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">5-1</a></span>. Here, we are using the aggregating iterator SUMX in the measure to multiply <em class="emphasistypeitalic">in memory</em> the CASES SOLD value in each row of the fact table by 1.1. The results of these row-level calculations are then aggregated to return a scalar value returned by the measure, for example, <strong class="emphasistypebold">59,477.00</strong> for “Bordeaux” wine. In a similar way, we could have used AVERAGEX or MAXX or any of the iterating aggregators.</p><p class="simplepara" id="calibre_link-926">Measures that include iterating functions use the row context in their iteration and then use the filter context to generate the scalar value.</p><p class="simplepara" id="calibre_link-927">Let’s move forward now and explore these aggregating iterators in more detail, starting with SUMX.</p><section class="section" id="calibre_link-166"><h2 class="booksubtitle">The SUMX Function (and Other “X” Functions)</h2><p class="simplepara" id="calibre_link-928">Now that you understand the purpose of DAX iterating aggregators, let’s get to know one of the major iterating functions in DAX, and that’s the SUMX function. We can then move on to explore other “X” <span id="calibre_link-929">aggregators</span>.</p><p class="simplepara" id="calibre_link-930">SUMX returns the sum of an expression evaluated for each row in a table and has the following <span id="calibre_link-931">syntax</span>:</p><p class="para9" id="calibre_link-932"><strong class="emphasistypebold">= SUMX ( table, expression )</strong></p><p class="para9" id="calibre_link-933">where:</p><p class="simplepara" id="calibre_link-934"><strong class="emphasistypebold">table</strong> is the table where you want to perform the calculation.</p><p class="simplepara" id="calibre_link-935"><strong class="emphasistypebold">expression</strong> is the calculation you want to be performed for each row in that table.</p><p class="simplepara" id="calibre_link-936">Here’s an example of the SUMX syntax:</p><p class="para9" id="calibre_link-937"><strong class="emphasistypebold">= SUMX ( Winesales, Winesales[CASES SOLD] * 0.1 )</strong></p><p class="para9" id="calibre_link-938">To illustrate the use of SUMX, let’s start with this rather unrealistic but easy-to-understand scenario. We have been asked to find any CASES SOLD value that is greater than 100 and increase this value by 20%; otherwise, we only increase the value by 10%. Perhaps this is some strange way of predicting next year’s volume of cases sold, so we’ll call this calculation “Next Yr Cases”. We then want to see what the “Next Yr Cases” value&nbsp;would be for each of our wines.<span id="calibre_link-939"></span></p><div class="para" id="calibre_link-940">If we didn’t know how to use SUMX, we would probably do this calculation in a clumsy way using both a calculated column and an implicit measure. We might create this calculated column using the IF function as shown in the following and then use an implicit measure by dragging the calculated column into the Values bucket of a Table visual; see Figure <span><a href="#calibre_link-287" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">5-2</a></span>.<figure class="figure1" id="calibre_link-287"><div class="mediaobject" id="calibre_link-941"><img alt="" src="images/000026.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 5-2</span><p class="simplepara1">Creating a <span id="calibre_link-942" class="calibre11">calculated column</span> to be used as in implicit measure isn’t efficient</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-943">But let’s think this through. We don’t need to first create a calculated column to see the increased value for each row and then in <em class="emphasistypeitalic">another step</em> sum this value for each wine, using an implicit measure. We can do it all in one go using SUMX. If we do this, the requirement for the calculated column is redundant; we can just use the measure. This is the real benefit because measures are always more efficient than calculated columns.</p><div class="para" id="calibre_link-944">This is the explicit measure using SUMX that we can use instead of the calculated column/<span id="calibre_link-945">implicit measure</span> combination:<div class="programcode" id="calibre_link-946"><div class="calibre4"><div class="fixedline">Next Yr Cases Measure =</div><div class="fixedline">SUMX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;IF ( Winesales[CASES SOLD] &gt; 100,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] * 1.2,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] * 1.1</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-947">How does the SUMX measure work?</p><p class="simplepara" id="calibre_link-948">We know that SUMX sums the expression evaluated for <em class="emphasistypeitalic">each row in the table.</em> The first argument in SUMX references the table where the calculation will be performed, in our case, Winesales. The second argument is the calculation you want to be done in memory <em class="emphasistypeitalic">for each row</em> in this table. This is our expression using IF that SUMX calculates in memory by iterating every row. It then sums the results of this calculation, in this case, for each wine (because that’s the current filter context for the evaluation of the measure).</p><div class="para" id="calibre_link-949">Now that we have discovered the SUMX function, we can revisit a calculation we learned to author in Chapter <span><a href="#calibre_link-85" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>3</span></a></span>, and that’s the “Sales” calculation that’s currently sitting in a <em class="emphasistypeitalic">calculated column</em>; see Figure <span><a href="#calibre_link-94" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>3-6</span></a></span>. Do you remember we created this <em class="emphasistypeitalic">column</em> using the <span id="calibre_link-950">RELATED function</span>?<div class="programcode" id="calibre_link-951"><div class="calibre4"><div class="fixedline">Sales =</div><div class="fixedline">Winesales[CASES SOLD] * RELATED ( Wines[PRICE PER CASE] )</div></div></div></div><div class="para" id="calibre_link-952">We then used this column in an implicit measure to find the total sales, but this wasn’t the most efficient way of accomplishing this task. Well, now we can write a <em class="emphasistypeitalic">measure</em> that will be our definitive “Total Sales” calculation using SUMX, as follows:<div class="programcode" id="calibre_link-953"><div class="calibre4"><div class="fixedline">Total Sales =</div><div class="fixedline">SUMX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] * RELATED ( Wines[PRICE PER CASE] )</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-954">This is a much cleaner way to calculate our Total Sales. The SUMX function iterates the Winesales table, and for every row in the current filter context, it multiplies the value in the CASES SOLD column with value in the PRICE PER CASE column of the Wines table (using RELATED to find the price of the wine in the current row context). It then sums the results of these row-level calculations for each wine.</p><div class="formalpara" id="calibre_link-955"><div class="heading1">Tip</div><p class="para6" id="calibre_link-956">Select a measure and use the Measure Tools tab and the Formatting group to format your measures in the currency of your choice.</p></div><div class="calibre4" id="calibre_link-957">In a similar way, if you want to find the maximum <span id="calibre_link-958">sales</span> or the average sales, the DAX measures would be these respectively:<div class="programcode" id="calibre_link-959"><div class="calibre4"><div class="fixedline">Max Sales =</div><div class="fixedline">MAXX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] * RELATED ( Wines[PRICE PER CASE] )</div><div class="fixedline">)</div></div><div class="calibre4"><div class="fixedline">Avg Sales =</div><div class="fixedline">AVERAGEX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] * RELATED ( Wines[PRICE PER CASE] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-960">You can see the results of these measures in Figure <span><a href="#calibre_link-288" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">5-3</a></span>.<figure class="figure1" id="calibre_link-288"><div class="mediaobject" id="calibre_link-961"><img alt="" src="images/000098.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 5-3</span><p class="simplepara1">Measures using <span id="calibre_link-962" class="calibre11">SUMX, AVERAGEX, and MAXX</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-963">Let’s explore another example of using AVERAGEX by calculating the average price that our customers have paid for their wines. We need to first find the price of every transaction (in the current filter context) in the Winesales table and then calculate the average of these prices, so the measure would look like this:<div class="programcode" id="calibre_link-964"><div class="calibre4"><div class="fixedline">Average Price =</div><div class="fixedline">AVERAGEX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;RELATED ( Wines[PRICE PER CASE] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-965">The “Average Price” measure uses the RELATED function to calculate the price of each transaction in memory, and AVERAGEX then averages these prices. You can see the results of this measure in Figure <span><a href="#calibre_link-289" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">5-4</a></span>.<figure class="figure1" id="calibre_link-289"><div class="mediaobject" id="calibre_link-966"><img alt="" src="images/000051.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 5-4</span><p class="simplepara1">Calculating the <span id="calibre_link-967" class="calibre11">average price</span> that customers paid for their wines</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-968">This may seem a simple measure, but even some experienced DAX users struggle to get it right, so let’s explain its evaluation. We can see in Figure <span><a href="#calibre_link-289" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">5-4</a></span> that the filter context is on the CUSTOMER NAME column of the Customers dimension and “Black River &amp; Co” is the first instance. The Winesales fact table is cross-filtered to contain only this customer’s sales. The RELATED function, nested inside AVERAGEX, in memory calculates the PRICE PER CASE value from the Wines dimension for each row in the Winesales table for “Black River &amp; Co.” The AVERAGEX function then finds the average of these prices (it sums the prices and divides by the number of rows in the Winesales table for this customer).</p></section><section class="section" id="calibre_link-167"><h2 class="booksubtitle">Total Row Grief</h2><p class="simplepara" id="calibre_link-969">This brings us to another common problem for people who are new to DAX: understanding the calculation on the <span id="calibre_link-970">Total row</span> of a Table or Matrix visual. People often complain that it’s not correct. This is probably because they’ve used the SUM function when they should have used SUMX.</p><div class="para" id="calibre_link-971">Consider the measures in Figure <span><a href="#calibre_link-290" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">5-5</a></span> that compare the “Total Sales” measure to the “Total Sales Wrong” measure. You can see that for each wine, the “Total Sales” and the “Total Sales Wrong” measures both return correct results. But when the measures evaluate the Total row, the “Total Sales Wrong” measure shows an incorrect result.<figure class="figure1" id="calibre_link-290"><div class="mediaobject" id="calibre_link-972"><img alt="" src="images/000236.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 5-5</span><p class="simplepara1">The Total row calculation is incorrect for the “Total Sales Wrong” measure</p></div></figcaption></figure></div><div class="para" id="calibre_link-973">So what is the problem with “Total Sales Wrong” when it evaluates the Total row? The problem, as is often the case, will be found within the filter context. Remember what we learned earlier; the Total row calculation is <em class="emphasistypeitalic">not</em> the sum of the total&nbsp;values you see in the visual. In the Total row, the measure is evaluated in a different filter context where the filter has been removed from the WINE column. So let’s look at how things can easily go awry. This is the measure for “Total Sales Wrong”: <span id="calibre_link-974"></span><div class="programcode" id="calibre_link-975"><div class="calibre4"><div class="fixedline">Total Sales Wrong =</div><div class="fixedline">SUM ( Winesales[CASES SOLD] ) * SUM ( Wines[PRICE PER CASE] )</div></div></div></div><div class="para" id="calibre_link-976">Let’s also extract the two <span id="calibre_link-977">constituent expressions</span> into their own separate measures:<div class="programcode" id="calibre_link-978"><div class="calibre4"><div class="fixedline">Total Cases =</div><div class="fixedline">SUM ( Winesales[CASES SOLD] )</div></div><div class="calibre4"><div class="fixedline">Sum Price =</div><div class="fixedline">SUM ( Wines[PRICE PER CASE] )</div></div></div></div><p class="simplepara" id="calibre_link-979">Our “Total Sales Wrong” measure is multiplying the results of these two&nbsp;expressions; refer to Figure <span><a href="#calibre_link-290" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">5-5</a></span>.</p><div class="para" id="calibre_link-980">You can see that the problem lies in using SUM, particularly in trying to sum the PRICE PER CASE values. What is the sum of these values? It’s the sum of the price in the current filter context. So for the evaluation of each wine, it’s simply the price of the wine, for example, <strong class="emphasistypebold">$75</strong> for “Bordeaux”; see Figure <span><a href="#calibre_link-291" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">5-6</a></span>.<figure class="figure1" id="calibre_link-291"><div class="mediaobject" id="calibre_link-981"><img alt="" src="images/000119.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 5-6</span><p class="simplepara1">The sum of the price on the <span id="calibre_link-982" class="calibre11">evaluation</span> of each wine is the price of the wine</p></div></figcaption></figure></div><div class="para" id="calibre_link-983">Multiplying this value by the sum of the cases sold for each wine gives the correct total sales value when evaluating each wine. But for the evaluation of the Total row, the filter has been released from the WINE column, so the “<em class="emphasistypeitalic">SUM ( Wines[PRICE PER CASE] )</em>” expression sums the prices for all the wines and returns <strong class="emphasistypebold">$917</strong>, see Figure <span><a href="#calibre_link-292" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">5-7</a></span>. It is this value that is multiplied by the sum of the cases sold.<figure class="figure1" id="calibre_link-292"><div class="mediaobject" id="calibre_link-984"><img alt="" src="images/000074.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 5-7</span><p class="simplepara1">The sum of the prices on the evaluation of each Total row</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-985">So in the “Total Sales Wrong” measure, the Total row calculation is the sum of the prices for all the wines multiplied by the sum of cases for all the wines: <strong class="emphasistypebold">917</strong> x <strong class="emphasistypebold">423,224</strong> = <strong class="emphasistypebold">388,096,408</strong>.</p><p class="simplepara" id="calibre_link-986">The incorrect expression using SUM <em class="emphasistypeitalic">sums and then multiplies</em>. The correct expression using SUMX <em class="emphasistypeitalic">multiplies and then sums</em>.</p><p class="simplepara" id="calibre_link-987">The <span id="calibre_link-988">SUM function</span> should only be used in the simplest of measures to sum the values in a single column and never when you want to sum the results of multiplications or other calculations. In fact, even when you use the SUM function in a DAX expression, this is converted internally by the DAX engine into SUMX.</p><p class="simplepara" id="calibre_link-989">So for instance, this expression</p><p class="simplepara" id="calibre_link-990">=SUM ( Winesales[CASES SOLD] )</p><p class="simplepara" id="calibre_link-991">is converted internally to this:</p><p class="simplepara" id="calibre_link-992">=SUMX ( Winesales, Winesales[CASES SOLD] )</p><p class="simplepara" id="calibre_link-993">In learning about iterators and how to use SUMX and the other “X” iterating functions, we’re progressing well into more difficult areas of DAX. We’ve also shed light on other challenging areas of DAX, such as the filter context and the nature of measures. You’ve learned some other important concepts too, understanding the role of fact tables&nbsp;and dimensions&nbsp;within the data model, but we’re still only starting out.</p><p class="simplepara" id="calibre_link-994">The real power behind DAX is still waiting in the wings for us to discover, and that’s the use of the function called <span id="calibre_link-995">CALCULATE</span>.</p></section></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-6">
<div id="calibre_link-996" class="calibre2">
<div id="calibre_link-997" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-998"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_6" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_6</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">6.&nbsp;The CALCULATE Function</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-304" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-304"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-999"><span id="calibre_link-1000">CALCULATE</span> is the most important function in DAX. Quite a sweeping statement you might think but as soon as you get to grips with CALCULATE, you’ll quickly realize that there won’t be many expressions you author in DAX where this function won’t be required, even though you might think we’ve done pretty well up to now. In this chapter, you will learn how to construct expressions using CALCULATE which you will find relatively straightforward. It’s understanding when and why you must use CALCULATE, and its purpose inside the measure, that will be more challenging to grasp, and so this will be the true focus of this chapter.</p><section class="section" id="calibre_link-168"><h2 class="booksubtitle">Why You Need CALCULATE</h2><div class="calibre4" id="calibre_link-1001">Let’s look at solving a scenario <span id="calibre_link-1002"></span>that will explain how CALCULATE can help us. In our data model, we have our DateTable dimension that is related to the Winesales fact table by the DateTable[DATEKEY}column and the Winesales[SALE DATE] column as shown in Figure <span><a href="#calibre_link-305" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-1</a></span>.<figure class="figure1" id="calibre_link-305"><div class="mediaobject" id="calibre_link-1003"><img alt="" src="images/000155.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-1</span><p class="simplepara1">The <span id="calibre_link-1004" class="calibre11">DateTable dimension</span> is related to the fact table</p></div></figcaption></figure></div><div class="para" id="calibre_link-1005">If we filter on the YEAR column in the <span id="calibre_link-1006">DateTable</span>, the filter will propagate to the Winesales table to filter the sales for that year. We’ve been asked to carry out a specific analysis of our data. For each of our wines, we would like to calculate what percentage the total cases sold for 2021 is of the total cases sold for all years as shown in Figure <span><a href="#calibre_link-306" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-2</a></span>.<figure class="figure1" id="calibre_link-306"><div class="mediaobject" id="calibre_link-1007"><img alt="" src="images/000006.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-2</span><p class="simplepara1">A Table visual showing what percentage the cases sold for 2021 are of the total for all <span id="calibre_link-1008" class="calibre11">years</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1009">In other words, <em class="emphasistypeitalic">in the same visual</em>, we need to have both the “Total Cases” measure for all years and the “Total Cases” measure filtered for the year 2021. We can then divide “Total Cases” for all years into “2021 Cases” and express this as a percentage.</p><div class="para" id="calibre_link-1010">If you look at the example in Figure <span><a href="#calibre_link-307" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-3</a></span>, you can see that we have copied and pasted the “<span id="calibre_link-1011">Total Cases</span>” measure and named it “2021 Cases”.<figure class="figure1" id="calibre_link-307"><div class="mediaobject" id="calibre_link-1012"><img alt="" src="images/000048.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-3</span><p class="simplepara1">We can copy a measure and attempt to apply filters to the copied <span id="calibre_link-1013" class="calibre11">measure</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-1014">We want to see if we can filter the “2021 Cases” measure to show values for 2021, <em class="emphasistypeitalic">while at the same time</em> the “Total Cases” measure shows values for all years. However, we have <span id="calibre_link-1015">a</span> problem. If we use a slicer to filter the YEAR column from the DateTable, it filters <em class="emphasistypeitalic">both</em> measures; see Figure <span><a href="#calibre_link-308" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-4</a></span>.<figure class="figure1" id="calibre_link-308"><div class="mediaobject" id="calibre_link-1016"><img alt="" src="images/000094.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-4</span><p class="simplepara1"><span id="calibre_link-1017" class="calibre11">Filters</span> are applied to all measures in the visual</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1018">It seems that we must find a way to apply different filter contexts for different measures <em class="emphasistypeitalic">in the same visual.</em> However, as yet, any filters being used by a visual, be they from the visual itself, from slicers, or from filters in the filters pane, apply the <em class="emphasistypeitalic">same</em> filter to all the measures in the visual. We can’t yet pick and choose which filters affect which measures. At the moment it’s all or nothing. This is where the CALCULATE function can help us.</p><div class="formalpara" id="calibre_link-1019"><div class="heading1">Note</div><p class="para6" id="calibre_link-1020">At this juncture, the slicer filtering the YEAR column can be removed from the canvas as it does not impact the data as required and is now redundant.</p></div><p class="simplepara" id="calibre_link-1021">CALCULATE evaluates an expression in a <em class="emphasistypeitalic">modified</em> filter context and has the following <span id="calibre_link-1022">syntax</span>:</p><p class="para9" id="calibre_link-1023"><strong class="emphasistypebold">= CALCULATE ( expression , filter1 , filter2 etc. )</strong></p><p class="para9" id="calibre_link-1024">where:</p><p class="simplepara" id="calibre_link-1025"><strong class="emphasistypebold">expression</strong> is what you want calculated. This can be a DAX <strong class="emphasistypebold">expression</strong> or a <strong class="emphasistypebold">measure</strong> that defines an expression.</p><p class="simplepara" id="calibre_link-1026"><strong class="emphasistypebold">filter1, filter2, etc.</strong> is how you want to filter the <strong class="emphasistypebold">expression</strong> or <strong class="emphasistypebold">measure</strong>. You can have multiple filters, and these are combined in an “AND” logical statement.</p><p class="simplepara" id="calibre_link-1027">Here are two examples of the CALCULATE syntax:</p><p class="para9" id="calibre_link-1028"><strong class="emphasistypebold">= CALCULATE ( SUM ( Winesales[CASES SOLD] ), Wines[WINE] = "Bordeaux" )</strong></p><p class="para9" id="calibre_link-1029"><strong class="emphasistypebold">= CALCULATE ( [Total Cases], Wines[WINE] = "Bordeaux" )</strong></p><p class="para9" id="calibre_link-1030">The first example uses an <em class="emphasistypeitalic"><strong class="emphasistypebold">expression</strong></em> in the expression argument, and the second uses a <em class="emphasistypeitalic"><strong class="emphasistypebold">measure</strong></em> in the expression argument (highlighted in gray).</p><div class="para" id="calibre_link-1031">This is the first time that we have nested a measure inside a “parent” measure. Note that when you type your expression in the DAX editor, if you type a square bracket “ [ ”, IntelliSense will list only measures; see Figure <span><a href="#calibre_link-309" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-5</a></span>.<figure class="figure1" id="calibre_link-309"><div class="mediaobject" id="calibre_link-1032"><img alt="" src="images/000140.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-5</span><p class="simplepara1">Typing a <span id="calibre_link-1033" class="calibre11">square bracket</span> “ [ ” into the DAX editor,&nbsp;lists all your measures</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1034">CALCULATE takes <em class="emphasistypeitalic">an</em> <em class="emphasistypeitalic"><strong class="emphasistypebold">expression</strong></em> or a <em class="emphasistypeitalic"><strong class="emphasistypebold">measure</strong></em> and evaluates it in a different filter context from the active filters coming through from the visual, slicers, or the filters pane. The end result of this new filter context generated by CALCULATE depends on the current state of the active filters. This is what is meant by the filter context being “modified” in the description of CALCULATE. However, rather than trying to explain what CALCULATE does, perhaps it’s easier to work through some examples.</p></section><section class="section" id="calibre_link-169"><h2 class="booksubtitle">Using Single Filters</h2><div class="calibre4" id="calibre_link-1035">Back to our scenario. In the Table <span id="calibre_link-1036">visual</span> in Figure <span><a href="#calibre_link-308" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-4</a></span>, how do we generate a measure to calculate the Total Cases for 2021 while retaining the measure that calculates Total Cases for all years? This is the measure, using CALCULATE that&nbsp;will do the job:<div class="programcode" id="calibre_link-1037"><div class="calibre4"><div class="fixedline">2021 Cases =</div><div class="fixedline">CALCULATE ( [Total Cases], DateTable[Year] = 2021)</div></div></div></div><div class="para" id="calibre_link-1038">Now we can create the final measure that will calculate the percentage that each wine’s total cases for 2021 are of the total for all years and format it as percent:<div class="programcode" id="calibre_link-1039"><div class="calibre4"><div class="fixedline">2021 Percentage =</div><div class="fixedline">&nbsp;[2021 Cases] / [Total Cases]</div></div></div></div><div class="para" id="calibre_link-1040">Or better still:<div class="programcode" id="calibre_link-1041"><div class="calibre4"><div class="fixedline">2021 Percentage =</div><div class="fixedline">DIVIDE ( [2021 Cases], [Total Cases] )</div></div></div></div><div class="formalpara" id="calibre_link-1042"><div class="heading1">Note</div><p class="para6" id="calibre_link-1043">The DIVIDE function returns a blank value&nbsp;by default if there is a divide by zero error, so using DIVIDE is the preferred method of performing divisions.</p></div><p class="simplepara" id="calibre_link-1044">When we put&nbsp;either of these <span id="calibre_link-1045"></span>measures into a Table visual, we can see that the total cases for “Bordeaux” wine in 2021 comprised <strong class="emphasistypebold">27.63%</strong> of the total cases for “Bordeaux” wine for all years (2017 to 2021).</p><div class="para" id="calibre_link-1046">Let’s look more closely at the evaluation of the “2021 Cases” measure in Figure <span><a href="#calibre_link-306" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-2</a></span>. We can see that coming through from the Table visual, we have a filter on the WINE column in the Wines dimension. However, using the “2021 Cases” measure, CALCULATE in memory <em class="emphasistypeitalic">also</em> filters the DateTable dimension so that YEAR equals 2021. This filter is then applied to the Winesales fact table alongside the filter coming through from the Wines dimension; see Figure <span><a href="#calibre_link-310" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-6</a></span>.<figure class="figure1" id="calibre_link-310"><div class="mediaobject" id="calibre_link-1047"><img alt="" src="images/000207.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-6</span><p class="simplepara1">How filters propagate for the “2021 Cases” measure:</p></div></figcaption></figure></div><div class="para" id="calibre_link-1048"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1049">The current filter context filters each WINE in the Wines dimension. This filter is propagated to the Winesales table and cross-filters each wine.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1050">The filter provided by CALCULATE programmatically filters the DateTable for the year “2021”. This filter is also propagated to the Winesales table and so applies a second cross-filter on Winesales.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-1051">The thing to note here is that the 2021 filter on the DateTable dimension only affects the evaluation of <em class="emphasistypeitalic">this</em> measure and no other measures in the visual. You can think of CALCULATE as being a way to <em class="emphasistypeitalic">programmatically</em> generate a filter context in memory that interacts with active filters coming through from the visual, slicers, and the filters pane.</p><div class="para" id="calibre_link-1052">Let’s now explore some more examples of using CALCULATE. For example, let’s calculate the total sales where the CASES SOLD value is greater than 350.<div class="programcode" id="calibre_link-1053"><div class="calibre4"><div class="fixedline">Total Sales for Cases Sold Greater than 350 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD]&nbsp;&nbsp;&gt; 350</div><div class="fixedline">)</div></div></div></div></section><section class="section" id="calibre_link-170"><h2 class="booksubtitle">Using Multiple Filters</h2><p class="simplepara" id="calibre_link-1054">CALCULATE accepts <span id="calibre_link-1055">multiple filter</span> arguments that are combined in an AND logical statement. If you require an OR statement, you can use the OR operator or the OR function within a single filter argument inside CALCULATE, and we will be exploring both of these scenarios. You can also use more complex filters that require aggregate expressions inside the filter arguments of CALCULATE, and we will be moving forward to understand these expressions too.</p><section class="section" id="calibre_link-171"><h3 class="booksubtitle">AND and OR Filters</h3><div class="calibre4" id="calibre_link-1056">The following are three more examples of measures that use CALCULATE to modify the filter context. Notice how all the filter arguments to CALCULATE are combined in an <span id="calibre_link-1057">“AND</span>”.<div class="programcode" id="calibre_link-1058"><div class="calibre4"><div class="fixedline">Total Cases in May 2021 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DateTable[YEAR] = 2021,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DateTable[MONTH] = "may"</div><div class="fixedline">)</div></div><div class="calibre4"><div class="fixedline">Total Cases for Abel in Argentina =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SalesPeople[SALESPERSON] = "abel",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Regions[REGION] = "argentina"</div><div class="fixedline">)</div></div><div class="calibre4"><div class="fixedline">Average Cases for Black Ltd in 2021 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;AVERAGE ( Winesales[CASES SOLD] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DateTable[Year] = 2021,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Customers[CUSTOMER NAME] = "black ltd"</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1059">You can see the results of these expressions using the WINE column from the Wines dimension in Figure <span><a href="#calibre_link-311" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-7</a></span>.<figure class="figure1" id="calibre_link-311"><div class="mediaobject" id="calibre_link-1060"><img alt="" src="images/000226.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-7</span><p class="simplepara1">Measures using multiple <span id="calibre_link-1061" class="calibre11">filters&nbsp;generated by CALCULATE</span><span id="calibre_link-1062" class="calibre11"></span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1063">In the preceding examples, filter arguments in CALCULATE are combined in an “AND” statement, for example, cases sold for 2021 <em class="emphasistypeitalic"><strong class="emphasistypebold">AND</strong></em> May. However, what if you require a filter that uses “OR”, for example, 2021 <em class="emphasistypeitalic"><strong class="emphasistypebold">OR</strong></em> 2020. Using CALCULATE, filtering using “OR” on the same column is straightforward. Filtering using “OR” on <em class="emphasistypeitalic">different</em> columns is a little more challenging, and this is where our calculations will get a little trickier. Let’s take the simpler calculations first.</p><div class="para" id="calibre_link-1064">To use “OR” on the same column, you can use the double pipe ( || ) operator within the same filter argument, as in these examples:<div class="programcode" id="calibre_link-1065"><div class="calibre4"><div class="fixedline">Total Cases 2020 or 2021 =</div><div class="fixedline">CALCULATE ( [Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DateTable[YEAR] = 2021</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| DateTable[YEAR] = 2020</div><div class="fixedline">)</div></div><div class="calibre4"><div class="fixedline">Average Cases Argentina or Australia =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;AVERAGE ( Winesales[CASES SOLD] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Regions[REGION] = "argentina"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| Regions[REGION] = "australia"</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1066">You can also use the OR function, but unlike Excel, you can only put two parameters into the DAX OR function as in this example:<div class="programcode" id="calibre_link-1067"><div class="calibre4"><div class="fixedline">Average Cases Argentina or Australia =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;AVERAGE ( Winesales[CASES SOLD] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;OR ( Regions[REGION] = "argentina",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Regions[REGION] = "australia")</div><div class="fixedline">)</div></div></div></div></section><section class="section" id="calibre_link-172"><h3 class="booksubtitle">Complex Filters</h3><div class="calibre4" id="calibre_link-1068"><span id="calibre_link-1069"></span>Let’s take another example of an “OR” filter. For example, we may want to find Total Sales for red wines OR French wines using the TYPE and WINECOUNTRY columns in the Wines table, respectively, and use this to analyze our salespeople’s performance of these wines. This would be the expression:<div class="programcode" id="calibre_link-1070"><div class="calibre4"><div class="fixedline">Sales for Red or French #1=</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Wines[TYPE] = "red"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| Wines[WINE COUNTRY] = "France"</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1071">This measure appears to work just fine as you can see in Figure <span><a href="#calibre_link-312" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-8</a></span>.<figure class="figure1" id="calibre_link-312"><div class="mediaobject" id="calibre_link-1072"><img alt="" src="images/000130.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-8</span><p class="simplepara1">The “Sales for Red or French #1” measure evaluated for each salesperson</p></div></figcaption></figure></div><div class="para" id="calibre_link-1073">However, experienced DAX users would be surprised that this expression was valid and would expect an error message as shown in Figure <span><a href="#calibre_link-313" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-9</a></span> that states<blockquote class="blockquote"><p class="para1" id="calibre_link-1074"><em class="emphasistypeitalic">“The expression contains multiple columns, but only a single column can be used in a True/False expression that is used as a table filter expression.”</em></p></blockquote><figure class="figure1" id="calibre_link-313"><div class="mediaobject" id="calibre_link-1075"><img alt="" src="images/000116.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-9</span><p class="simplepara1">This <span id="calibre_link-1076" class="calibre11">error message</span> was removed in the March 2021 update of Power BI</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1077">This message tells us that referencing two columns from the same table in a single filter is not allowed. In fact,&nbsp;the expression using “OR” on different columns has only become legitimate since the March 2021 update of Power BI.</p><div class="para" id="calibre_link-1078">However, although it appears to now be valid, there is still an inherent problem with it. This expression doesn’t respond correctly to specific filter selections. To show this, we have written an alternative measure, “Sales for Red or French #2”, and can now compare the two versions of this expression in a Table visual where we are filtering “Red” wines via the slicer; see Figure <span><a href="#calibre_link-314" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">6-10</a></span>.<figure class="figure1" id="calibre_link-314"><div class="mediaobject" id="calibre_link-1079"><img alt="" src="images/000164.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 6-10</span><p class="simplepara1">Using <span id="calibre_link-1080" class="calibre11">“OR</span>” on different columns from the same table doesn’t respond correctly to specific filters</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1081">You will see that the measure “Sales for Red or French #1” doesn’t respond to filters from the slicer that uses the TYPE column from the Wines dimension. It continues to calculate sales for both red or French wines disregarding the slicer. The second measure, “Sales for Red or French #2”, however, does show just sales for red wines. We will look at the details of this measure in the chapter on the FILTER function, but for the moment, we have to ask this question: Why has an expression that filters two different columns from the same table been invalid until recently, and now that we are allowed to do it, why doesn’t it calculate correctly with a filter on the TYPE column?</p><p class="simplepara" id="calibre_link-1082">Let’s look more closely at the problem. When you have a filter on just one column, the rows of the table are filtered in memory where the filter criterion on the column equates to true. But when you place filters on <em class="emphasistypeitalic">multiple</em> columns, you can only further reduce the rows. For example, once you’ve filtered out the red wines, you can only then filter the red wines that are French.</p><p class="simplepara" id="calibre_link-1083">How can we solve this predicament? One way is to ensure that there are no filters on either the Wines[TYPE] column or the Wines[WINE COUNTRY] column so that in every evaluation, values in <em class="emphasistypeitalic">both</em> columns are considered. This is the route that DAX takes in the expression “Sales for Red or French #1”.</p><div class="formalpara" id="calibre_link-1084"><div class="heading1">Note</div><p class="para6" id="calibre_link-1085">It’s beyond the scope of this chapter to elaborate on the details of the “Sales for Red or French #1” expression or why it returns errors in the presence of certain filters. However, we do uncover the problem in Chapter <span><a href="#calibre_link-0" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre"><span>18</span></a></span>. All we need to note at this stage is that the expression doesn’t always return the correct result.</p></div><p class="simplepara" id="calibre_link-1086">Is there an alternative approach? Perhaps we could try this; rather than applying filters directly to columns, we could <em class="emphasistypeitalic">filter out the rows</em> that we want to evaluate instead. For example, we could iterate the rows in the Wines dimension, and if we find a red wine, filter the row out, or if we find a French wine, filter that row out too. We could then, in memory, build a new <span id="calibre_link-1087"><em class="emphasistypeitalic">virtual table</em></span> comprising just the rows for wines that are red or French. This in-memory virtual Wines table that has been filtered to just the rows we need could then propagate that filter to the Winesales fact&nbsp;table, just like the “real” Wines dimension filtering the Winesales table. Would that work?</p><p class="simplepara" id="calibre_link-1088">Well yes, it would because in DAX, there is a group of functions called “table” functions that generate <em class="emphasistypeitalic">in-memory virtual</em> <span id="calibre_link-1089">tables</span> that, when used inside CALCULATE, will propagate filters just like “real” tables. Now that we know this, all that remains for us to discover is the name of the table function that will generate our virtual table containing just the rows for red or French wines.</p><p class="simplepara" id="calibre_link-1090">Before we find this function, however, there’s a little more learning to be done. We need to look more closely at the <em class="emphasistypeitalic">different types</em> of DAX functions and particularly to understand what we mean by “table functions.” Then we can solve our “red or French” conundrum.</p></section></section></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-4">
<div id="calibre_link-1091" class="calibre2">
<div id="calibre_link-1092" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-1093"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_7" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_7</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">7.&nbsp;DAX Table Functions</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-358" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-358"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-1094">A skill that will serve you well when working with DAX is a good imagination. You’ve already learned to construct a picture in your mind of the current filters that are propagating through the data model. The scanning of tables by iterators can only be envisaged, and designing the correct CALCULATE expression is done through inferring what filters must be changed. There is yet another aspect of DAX that is hidden from us, and that therefore must be imagined. That is the generation of virtual tables. Much of your DAX code will involve building in-memory tables that are used in the evaluation of the measure. In this chapter, we are going to explore this concept, how we create table expressions through the use of table functions, and their purpose in manipulating the data model. In doing so, we will be focusing on the most ubiquitous of the table functions, and that is the FILTER function.</p><section class="section" id="calibre_link-173"><h2 class="booksubtitle">Types of DAX Functions</h2><div class="calibre4" id="calibre_link-1095">In DAX, we can divide functions into three categories depending on the type of value the functions return; see Table <span><a href="#calibre_link-359" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-1</a></span>.<div class="table" id="calibre_link-359"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 7-1</span><p class="para6"><span id="calibre_link-1096">Types</span> of DAX <span id="calibre_link-1097">functions</span></p></div></div><table class="calibre12"><colgroup class="calibre13"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre14"><tr class="calibre15"><th class="calibre16"><p class="simplepara2">Function Type</p></th><th class="calibre16"><p class="simplepara2">Example</p></th><th class="calibre16"><p class="simplepara2">Description</p></th></tr></thead><tbody class="calibre17"><tr class="calibre15"><td class="calibre18"><p class="simplepara2"><strong class="emphasistypebold">Scalar Functions</strong></p></td><td class="calibre18"><p class="simplepara2">Return scalar values.</p><p class="simplepara2">e.g., SUM, COUNTROWS, SUMX, CALCULATE</p></td><td class="calibre18"><p class="simplepara2">These functions return a scalar or single value and are used in all measures.</p></td></tr><tr class="calibre19"><td class="calibre18"><p class="simplepara2"><strong class="emphasistypebold">Table Functions</strong></p></td><td class="calibre18"><p class="simplepara2">Return virtual tables.</p><p class="simplepara2">e.g., FILTER, VALUES, PREVIOUSMONTH, ALL</p></td><td class="calibre18"><p class="simplepara2">Table functions are used to generate “virtual” tables that propagate filters through the data model in the same way as “real” tables. The virtual tables are typically subsets of rows or subsets of columns of the original table, but they can expand the number of rows in the case of the ALL function.</p><p class="simplepara2">Because measures must always return scalar values and not tables, table functions are always nested inside scalar functions.</p></td></tr><tr class="calibre15"><td class="calibre18"><p class="simplepara2"><strong class="emphasistypebold">CALCULATE Modifiers</strong></p></td><td class="calibre18"><p class="simplepara2">Modify the filter arguments of CALCULATE.</p><p class="simplepara2">e.g., CROSSFILTER, USERELATIONSHIP, KEEPFILTERS, ALL</p></td><td class="calibre18"><p class="simplepara2">We’ll meet this type of function later. These functions change the behavior of any filters generated by CALCULATE and so are always nested inside CALCULATE. These functions don’t return any value.</p></td></tr></tbody></table></div></div><div class="formalpara" id="calibre_link-1098"><div class="heading1">Note</div><p class="para6" id="calibre_link-1099">The ALL function is both a Table function and a CALCULATE modifier. We’ll look more closely at this later.</p></div><div class="calibre4" id="calibre_link-1100">How do you know what type of function you are using? The best way is to consult the DAX Function Library here: <span><a href="https://docs.microsoft.com/en-us/dax/dax-function-reference" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://docs.microsoft.com/en-us/dax/dax-function-reference</span></span></a></span>, and it will tell you what a DAX function returns; for example, the FILTER function returns “<em class="emphasistypeitalic">a table</em> containing only the filtered rows,” see Figure <span><a href="#calibre_link-360" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-1</a></span>.<figure class="figure1" id="calibre_link-360"><div class="mediaobject" id="calibre_link-1101"><img alt="" src="images/000213.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-1</span><p class="simplepara1">Use the DAX Function Library to check the function type</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1102">We’ve already explored some <span id="calibre_link-1103">scalar functions</span>, and we’ll meet some more in later chapters such as the SELECTEDVALUE function. We will also delve into CALCULATE modifiers like CROSSFILTER, USERELATIONSHIP and ALL later on. In this chapter, we will focus only on table functions.</p></section><section class="section" id="calibre_link-174"><h2 class="booksubtitle">Table Functions</h2><div class="calibre4" id="calibre_link-1104">Table functions create <span id="calibre_link-1105"><em class="emphasistypeitalic">table expressions</em></span> and can be used for two purposes:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1106">To generate additional tables in your data model using the <strong class="emphasistypebold">New Table</strong> button. These are referred to as <em class="emphasistypeitalic">calculated tables</em>. If this is your requirement, the recommendation is that new tables are generated using Power Query, not DAX.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1107">To generate in-memory virtual tables as part of the evaluation of measures.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-1108">In this chapter, we will only be considering the latter of these, the generation of virtual tables using table expressions inside DAX measures.</p><p class="simplepara" id="calibre_link-1109">Table expressions can be used in measures wherever a function accepts a “table” as one of its arguments or as the filter argument inside CALCULATE. Up to now, we’ve always referenced an actual table inside functions like COUNTROWS or SUMX, but we can use a table expression instead. Inside CALCULATE, we’ve created Boolean expressions as column filters, but we could also use table expressions. When creating measures, table expressions are <em class="emphasistypeitalic">always</em> nested inside functions that return scalar values and are never used on their own.</p><section class="section" id="calibre_link-175"><h3 class="booksubtitle">Examples of Table Expressions</h3><div class="calibre4" id="calibre_link-1110">Consider the expressions in Figure <span><a href="#calibre_link-361" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-2</a></span> where, in place of referencing a table, we’re using a table expression instead.<figure class="figure1" id="calibre_link-361"><div class="mediaobject" id="calibre_link-1111"><img alt="" src="images/000092.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-2</span><p class="simplepara1">Examples of table expressions</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1112">These examples use a table function called <span id="calibre_link-1113">VALUES</span>. You don’t need to know at this stage what the VALUES function is doing (we’ll meet VALUES in a later chapter). You just need to understand that it’s a <em class="emphasistypeitalic">table expression</em> being used as the “table” argument or as the “filter” argument inside CALCULATE.</p></section><section class="section" id="calibre_link-176"><h3 class="booksubtitle">Why Do We Need Table Expressions?</h3><p class="simplepara" id="calibre_link-1114">There are two very different reasons why we use table expressions inside DAX measures.</p><p class="simplepara" id="calibre_link-1115">Nested inside any other function other than <span id="calibre_link-1116">CALCULATE</span>, table expressions supply the “table” argument and often create subsets of the original table, either subsets of rows or subsets of columns. For example, FILTER nested inside SUMX will normally generate a table with fewer rows for SUMX to iterate. As we will discover in later chapters, some table functions are also used to generate “hybrid” tables that comprise combinations of columns from different tables.</p><p class="simplepara" id="calibre_link-1117">On the other hand, as filter arguments inside CALCULATE, table expressions generate virtual tables that are used as <em class="emphasistypeitalic">filters</em>. Understanding the use of table expressions as <span id="calibre_link-1118">filter arguments</span> inside CALCULATE is a challenging concept to new DAX users, and we’ll be exploring this concept in detail as we move through this chapter.</p><p class="simplepara" id="calibre_link-1119">However, we will begin our journey through table functions by understanding the use of the most common table function in DAX, and that is FILTER.</p></section></section><section class="section" id="calibre_link-177"><h2 class="booksubtitle">The FILTER Function</h2><p class="simplepara" id="calibre_link-1120">The FILTER <span id="calibre_link-1121">function</span><span id="calibre_link-1122"></span> returns a <em class="emphasistypeitalic">table</em> that is a subset of another table and has the following syntax:</p><p class="simplepara" id="calibre_link-1123">= FILTER ( table , filter )</p><p class="simplepara" id="calibre_link-1124">where:</p><p class="simplepara" id="calibre_link-1125"><strong class="emphasistypebold">table</strong> is the table that you want to filter. The table can also be supplied by another table function.</p><p class="simplepara" id="calibre_link-1126"><strong class="emphasistypebold">filter</strong> is the filter you want to apply to the <strong class="emphasistypebold">table</strong> as a Boolean expression, for example, <em class="emphasistypeitalic">“Wines[TYPE]= "red".</em></p><p class="simplepara" id="calibre_link-1127">Here is an example of the FILTER function syntax:</p><p class="para9" id="calibre_link-1128"><strong class="emphasistypebold">= COUNTROWS ( FILTER ( Wines, Wines[TYPE]= "red" ) )</strong></p><p class="para9" id="calibre_link-1129">FILTER as a table function can be used to generate table expressions as explained in “Why Do We Need Table Expressions?” section. We’ve learned that these functions have different behaviors depending on whether they are used to change the shape of the data, such as reducing the rows considered by an expression, or whether they are used inside CALCULATE. The FILTER function is no exception, so let’s now consider these two behaviors.</p><section class="section" id="calibre_link-178"><h3 class="booksubtitle">FILTER Used to Reduce Rows</h3><div class="calibre4" id="calibre_link-1130">For instance, we could calculate the number of high-volume sales where high volume is any transaction where the CASES SOLD value is greater than 300. To do this, we can use FILTER nested inside COUNTROWS to count the rows of the filtered Winesales table as in the following <span id="calibre_link-1131">expression</span>:<div class="programcode" id="calibre_link-1132"><div class="calibre4"><div class="fixedline">No. of High Volume Sales =</div><div class="fixedline">COUNTROWS ( FILTER ( Winesales, Winesales[CASES SOLD] &gt; 300 ) )</div></div></div></div><div class="para" id="calibre_link-1133">You can see the result of this measure in Figure <span><a href="#calibre_link-362" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-3</a></span>. FILTER can also be nested inside SUMX, whereby the number of rows in the table iterated by SUMX will be reduced by FILTER. For example, the “Total Sales” measure that we authored in Chapter <span><a href="#calibre_link-95" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>5</span></a></span> could be extended to filter the sales where the volume of cases is greater than 300 (shown in Figure <span><a href="#calibre_link-363" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-4</a></span>):<div class="programcode" id="calibre_link-1134"><div class="calibre4"><div class="fixedline">Cases GT 300 =</div><div class="fixedline">SUMX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[CASES SOLD] &gt; 300 ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] * RELATED (Wines [PRICE PER CASE] ))</div></div></div><figure class="figure1" id="calibre_link-362"><div class="mediaobject" id="calibre_link-1135"><img alt="" src="images/000161.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-3</span><p class="simplepara1">Using FILTER nested inside <span id="calibre_link-1136" class="calibre11">COUNTROWS</span> to calculate the number of high-volume sales</p></div></figcaption></figure><figure class="figure1" id="calibre_link-363"><div class="mediaobject" id="calibre_link-1137"><img alt="" src="images/000137.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-4</span><p class="simplepara1">Using FILTER nested inside SUMX to calculate the sales value where cases sold is greater than 300</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1138">However, if you want to use this calculation, this is not the best expression for doing the job. We will be discovering that FILTER is an iterator, and in this respect, it will scan the Winesales fact table that may contain many millions of rows. We will be exploring later in this chapter more efficient ways of performing this task.</p></section><section class="section" id="calibre_link-179"><h3 class="booksubtitle">FILTER as the Filter Argument of CALCULATE</h3><p class="simplepara" id="calibre_link-1139">If FILTER is used in a filter argument of <span id="calibre_link-1140">CALCULATE</span>, FILTER generates an in-memory table that is used to filter the data model, just as dimensions filter the data model.</p><div class="para" id="calibre_link-1141">Before March 2021, <em class="emphasistypeitalic">it was a requirement</em> to use the FILTER function inside CALCULATE in the following two situations:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1142">When the filter includes <em class="emphasistypeitalic">more than one column</em> from the same table</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1143">When the filter includes <em class="emphasistypeitalic">an expression</em></p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-1144">However, it is now possible to omit the FILTER function when filtering two or more columns in the same table, but depending on slicer selections, the measure can still fail. It is also now possible to omit FILTER if the expression is a simple Boolean test using an aggregate function, such as AVERAGE, but using any other expression in the filter argument still requires the use of FILTER.</p><p class="simplepara" id="calibre_link-1145">For people new to DAX, it is very important to understand that the new syntax, where FILTER is no longer required in the situations outlined before, is a recent development (DAX was first introduced in 2009). Any DAX resources you browse or any code you copy and paste will most probably be using the old syntax using FILTER.</p><div class="para" id="calibre_link-1146">With this in mind, let’s return to our “Sales for Red or French #1” measure we authored when exploring the CALCULATE function in the previous chapter. This was the <span id="calibre_link-1147">measure</span>:<div class="programcode" id="calibre_link-1148"><div class="calibre4"><div class="fixedline">Sales for Red or French #1 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Wines[TYPE] = "red"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| Wines[WINE COUNTRY] = "France" )</div></div></div></div><div class="para" id="calibre_link-1149">This expression returns <span id="calibre_link-1150">incorrect results</span> if there is a filter on the TYPE column or the WINE COUNTRY column, assuming that if you are slicing, you now want to calculate sales only for red wines and French wines, not red <em class="emphasistypeitalic">or</em> French wines, which is the current calculation. If so, the correct values are shown in the “Total Sales” measure on the left in Figure <span><a href="#calibre_link-364" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-5</a></span> as this measure is responding to the filters in the slicers.<figure class="figure1" id="calibre_link-364"><div class="mediaobject" id="calibre_link-1151"><img alt="" src="images/000070.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-5</span><p class="simplepara1">Omitting FILTER can return incorrect results</p></div></figcaption></figure></div><div class="formalpara" id="calibre_link-1152"><div class="heading1">Note</div><p class="para6" id="calibre_link-1153">You will learn later in this book the precise details as to why the “#1” measure returns incorrect results when there is a filter on either TYPE or WINECOUNTRY.</p></div><div class="calibre4" id="calibre_link-1154">We established that the root of the problem lies in the fact that we’re using two <em class="emphasistypeitalic">different</em> columns in our filter and indeed in earlier days, we were prevented from authoring such code. To resolve this problem, we need to use the table function FILTER inside CALCULATE. So let’s now get to grips with how we can use FILTER in this context and use it to author the correct version of the measure, “Sales for Red or French #2”:<div class="programcode" id="calibre_link-1155"><div class="calibre4"><div class="fixedline">Sales for Red or French #2=</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Wines, Wines[TYPE] = "red"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;&nbsp;Wines[WINE COUNTRY] = "France" )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1156">In Figure <span><a href="#calibre_link-365" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-6</a></span>, you can see the measure evaluated when put into a Table visual. We’ve also included the “Total Sales” measure to provide context and clarity on the evaluation.<figure class="figure1" id="calibre_link-365"><div class="mediaobject" id="calibre_link-1157"><img alt="" src="images/000045.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-6</span><p class="simplepara1">The <span id="calibre_link-1158" class="calibre11">calculation</span> of the “Sales for Red or French #2” measure</p></div></figcaption></figure></div><div class="para" id="calibre_link-1159">See Figure <span><a href="#calibre_link-366" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-7</a></span> for a <span id="calibre_link-1160">step-by-step guide</span> through the evaluation of this measure. In the “Sales for Red or French #2” measure, FILTER is nested inside CALCULATE to provide the filter argument. The FILTER function is an <em class="emphasistypeitalic">iterator</em>. We met <span id="calibre_link-1161">iterators</span> when we looked at the SUMX function in Chapter <span><a href="#calibre_link-95" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>5</span></a></span>. These are functions that scan a table on a row-by-row basis and in the case of FILTER perform a test on each row. If the test applied by FILTER is true for a row, that row is extracted to a virtual table of its own. This virtual table, used as the filter argument to CALCULATE, is then used to <span id="calibre_link-1162">propagate filters</span> through the model just like a “real” table.<figure class="figure1" id="calibre_link-366"><div class="mediaobject" id="calibre_link-1163"><img alt="" src="images/000239.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-7</span><p class="simplepara1">Stepping through the “Sales for Red or French #2” measure <span id="calibre_link-1164" class="calibre11"></span></p></div></figcaption></figure></div><div class="para" id="calibre_link-1165"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1166">The FILTER function iterates the Wines table in memory and filters any rows where TYPE = “red” or WINECOUNTRY = “France”.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1167">FILTER generates an in-memory virtual table containing only those rows where the test is true.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-1168">The virtual table generated by FILTER is used as the filter argument to CALCULATE to filter the Winesales table.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-1169">We’ve been examining the use of the FILTER function to perform an “OR” test on two different columns of the same table. Let’s look at another example with the same issue.</p><div class="para" id="calibre_link-1170">Consider the scenario where you want to find the number of sales (i.e., the number of rows in the Winesales table) for high profit wines. High profit wines are where wines have a price that is three times the cost price. This test involves two columns in the Wines dimension, PRICE PER CASE and COST PRICE, and therefore, it’s recommended that you use FILTER. These are the measures you can <span id="calibre_link-1171">use:</span><div class="programcode" id="calibre_link-1172"><div class="calibre4"><div class="fixedline">No. of Sales =</div><div class="fixedline">COUNTROWS ( Winesales )</div></div><div class="calibre4"><div class="fixedline">No. of Sales of High profit Wines =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;FILTER ( Wines, Wines[PRICE PER CASE] &gt;= Wines[COST PRICE] * 3 )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1173">We’ve included the expression for “No. of Sales” that we will nest inside the “No. of Sales of High profit Wines” measure. You can see this measure calculated in Figure <span><a href="#calibre_link-367" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-8</a></span>.<figure class="figure1" id="calibre_link-367"><div class="mediaobject" id="calibre_link-1174"><img alt="" src="images/000114.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-8</span><p class="simplepara1">Finding high <span id="calibre_link-1175" class="calibre11">profit wines</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1176">You will notice again that FILTER can be omitted here because expressions using different columns from the same table are now valid. However, take note that if you had a filter on either the PRICE PER CASE column or the COST PRICE column, you would not see correct values being returned. Therefore, it is recommended that you use FILTER nested inside CALCULATE whenever more than one column is being referenced.</p><div class="para" id="calibre_link-1177">However, we also need FILTER whenever we need to use an <em class="emphasistypeitalic">expression</em> in the filter argument in CALCULATE. We’ve set out two examples of this <span id="calibre_link-1178">requirement</span> where we are calculating the following:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1179">The number of sales where the total sales values are greater than 20,000. We are using the “Total Sales” measure in the filter test.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1180">The number of sales that are greater than the average sales value. To calculate the average sales, we are using the AVERAGEX expression that you learned in Chapter <span><a href="#calibre_link-95" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>5</span></a></span>.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-1181">First, we have authored the “wrong” version of the measures that omits the FILTER function. These expressions will return <span id="calibre_link-1182">error messages</span>. We have then authored the correct expressions using FILTER. Therefore, it’s important that you understand that FILTER is required when you use any <em class="emphasistypeitalic">expression</em> in the filter test of CALCULATE. We have highlighted in gray the FILTER expressions to help clarify the <span id="calibre_link-1183">code</span> used:<div class="programcode" id="calibre_link-1184"><div class="calibre4"><div class="fixedline">Sales Greater than 20K Wrong =</div><div class="fixedline">CALCULATE ( [No. of Sales], [Total Sales] &gt; 20000 )</div></div><div class="calibre4"><div class="fixedline">Sales Greater than 20K =</div><div class="fixedline">CALCULATE ( [No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, [Total Sales] &gt; 20000 ) )</div></div><div class="calibre4"><div class="fixedline">Sales Greater than Avg Wrong =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt; AVERAGEX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] *</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RELATED ( Wines[PRICE PER CASE] )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div><div class="calibre4"><div class="fixedline">Sales Greater than Avg =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt; AVERAGEX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] *</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RELATED ( Wines[PRICE PER CASE] )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1185">However, if the requirement is to calculate the number of sales that are greater than the average cases sold, this expression does not require FILTER because it’s using the simple aggregate function AVERAGE. Since September 2021, we are now allowed to author code that uses the simple aggregate functions, such as AVERAGE or <span id="calibre_link-1186">MAX</span> in the predicate as follows:<div class="programcode" id="calibre_link-1187"><div class="calibre4"><div class="fixedline">Cases GT Avg =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] &gt; AVERAGE ( Winesales[CASES SOLD] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1188">However, experienced DAX users would probably prefer to see this measure expressed using FILTER:<div class="programcode" id="calibre_link-1189"><div class="calibre4"><div class="fixedline">Cases GT Avg =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[CASES SOLD]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt; AVERAGE ( Winesales[CASES SOLD] ) )</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-1190">In this section on the FILTER function, you have learned that FILTER generates a virtual table that can be used in the filter argument of CALCULATE. This virtual table is used to filter the data model just like “real” tables do.</p><p class="simplepara" id="calibre_link-1191">This leads us to another aspect of the FILTER function (and indeed table functions generally) that we need to explore in more detail, and that’s the difference between using a <em class="emphasistypeitalic">table expression</em> as a filter inside CALCULATE and using a simple <em class="emphasistypeitalic">column</em> filter instead.</p></section></section><section class="section" id="calibre_link-180"><h2 class="booksubtitle">Column Filters vs. Table Filters</h2><p class="simplepara" id="calibre_link-1192"><span id="calibre_link-1193">What</span> you have learned is that in the “filter” argument to CALCULATE, you can supply two types of filter: a filter using a <em class="emphasistypeitalic">column</em> and/or a filter using a <em class="emphasistypeitalic">table</em>. In short, within CALCULATE, there are two ways to modify the filter context: using columns or using tables. What you need to understand now is that there will be a considerable difference in the evaluation of a measure depending on which type of filter you choose.</p><p class="simplepara" id="calibre_link-1194">So far in this book, the only table function we’ve met is the FILTER function, so we’ll use FILTER to illustrate the difference between column filters and table filters but to appreciate that it’s relevant to all table expressions used as filters inside CALCULATE.</p><div class="formalpara" id="calibre_link-1195"><div class="heading1">Note</div><p class="para6" id="calibre_link-1196">We’ll be exploring a number of other table functions as we move through this book such as ALL, VALUES, and the functions known as “time intelligence.”</p></div><div class="calibre4" id="calibre_link-1197">Why do we need to distinguish between table filters and column filters? There are essentially two reasons why this <span id="calibre_link-1198">difference</span> is important:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1199">Because the DAX engine has to generate the virtual tables, table filters take longer to process.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1200">Your measure may return a different result depending on the filter type.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-1201">We will now explore these two scenarios. In the first example, we look at how table filters increase the processing weight of the measure. In the second example, we will see that table filters can produce different results from column filters.</p><section class="section" id="calibre_link-181"><h3 class="booksubtitle">Table Filters Are Less Efficient</h3><div class="calibre4" id="calibre_link-1202"><span id="calibre_link-1203"></span>In this example, let’s take two similar expressions using CALCULATE. The first uses a column filter and the second, a table expression as the filter argument. In both expressions, we are filtering the rows in the Winesales fact table that contain cases sold greater than 300.<div class="programcode" id="calibre_link-1204"><div class="calibre4"><div class="fixedline">Cases GT 300 #1 =</div><div class="fixedline">CALCULATE ([Total Sales], Winesales[CASES SOLD] &gt; 300 )</div></div><div class="calibre4"><div class="fixedline">Cases GT 300 #2 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[CASES SOLD] &gt; 300 )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1205">You can see in Figure <span><a href="#calibre_link-368" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-9</a></span> that both these measures return the same result, so how does the table filter differ from the column filter? To answer this question, we must look more carefully at the evaluation of each of these measures, taking the evaluation of “Grenache” wine that returns <strong class="emphasistypebold">$310,530</strong> as our example.<figure class="figure1" id="calibre_link-368"><div class="mediaobject" id="calibre_link-1206"><img alt="" src="images/000187.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-9</span><p class="simplepara1">The <span id="calibre_link-1207" class="calibre11">measures return</span> the same result</p></div></figcaption></figure></div><div class="para" id="calibre_link-1208">When measure “Cases GT 300 #1” is evaluated, a filter is placed on the CASES SOLD <em class="emphasistypeitalic">column</em> to filter values greater than 300. The Total Sales values are then calculated for the filtered rows of the Winesales table; see Figure <span><a href="#calibre_link-369" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-10</a></span>.<figure class="figure1" id="calibre_link-369"><div class="mediaobject" id="calibre_link-1209"><img alt="" src="images/000036.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-10</span><p class="simplepara1">Stepping through the “Cases GT 300 #1” measure</p></div></figcaption></figure></div><div class="para" id="calibre_link-1210"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1211">The wine “Grenache” is filtered in the WINE column of the Wines table and is cross-filtered to the Winesales table that only now contains rows for “Grenache”.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1212">The CASES SOLD column in the Winesales table is further filtered in memory to contain only the rows for this wine that are greater than 300. The “Total Sales” measure is then calculated for just these rows.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-1213">Note the filter on the CASES SOLD column.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-1214">When the measure “Cases GT 300 #2” is evaluated, the FILTER function iterates the Winesales table to extract rows where the CASES SOLD is greater than 300 into a virtual table (remembering that Winesales is filtered to just contain “Grenache” wines). The total sales for the virtual table generated by FILTER are then calculated; see Figure <span><a href="#calibre_link-370" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-11</a></span>.<figure class="figure1" id="calibre_link-370"><div class="mediaobject" id="calibre_link-1215"><img alt="" src="images/000205.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-11</span><p class="simplepara1">Stepping through the “Cases GT 300 #2” measure</p></div></figcaption></figure></div><div class="para" id="calibre_link-1216"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1217">The wine “Grenache” is filtered in the WINE column of the Wines table and is cross-filtered to the Winesales table that now only contains rows for “Grenache”.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1218">The FILTER function iterates the Winesales table to filter CASES SOLD greater than 300 and generates a virtual table.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-1219">The “Total Sales” measure is calculated for the rows in the virtual Winesales table in memory.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">4.</div><div class="itemcontent"><p class="para2" id="calibre_link-1220">Note there is no filter on the CASES SOLD column because it’s the virtual table that has generated the filtered rows.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-1221">Question: Which of these evaluations do you think is more efficient?</p><p class="simplepara" id="calibre_link-1222">If your fact table contains many millions of rows, the FILTER function must iterate these rows to build the virtual table. We’re sure you can appreciate that you pay a heavy processing price if you use table filters rather than column filters. Marco Russo and Alberto Ferrari explain this in more <span id="calibre_link-1223">technical terms</span>:</p><p class="simplepara" id="calibre_link-1224"><em class="emphasistypeitalic">“A side effect of a table filter is that it requires a large materialization to the storage engine to enable the formula engine to compute the result.”</em><sup class="calibre7"><a type="noteref" href="#calibre_link-371" id="calibre_link-376" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup></p><p class="simplepara" id="calibre_link-1225">This is why using the table function FILTER to filter the cases sold is not good practice because you should be using the column filter.</p><p class="simplepara" id="calibre_link-1226">To further make the point, in this video, Marco Russo takes you through why using the FILTER function unnecessarily is not a good idea:</p><p class="simplepara" id="calibre_link-1227"><span><a href="https://www.youtube.com/watch?v=B-h3Pohtn1Y" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>My Power BI report is slow:​ what should I do?​ by Marco Russo</span></a></span></p><div class="para" id="calibre_link-1228">Before we leave the subject of the problematic table filters, there is a third version of the “Cases GT 300” measure that “newbies” might consider authoring. The expression “Cases GT 300 #3” uses SUMX and returns the same values as the previous two versions of the measure discussed before:<div class="programcode" id="calibre_link-1229"><div class="calibre4"><div class="fixedline">Cases GT 300 #3 =</div><div class="fixedline">SUMX ( FILTER ( Winesales, Winesales[CASES SOLD] &gt; 300 ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales] )</div></div></div></div><p class="simplepara" id="calibre_link-1230">What is the problem with this expression? You of course now know. The answer is it’s inefficient. First, FILTER iterates the fact table to generate a table containing the rows to be considered. Then SUMX iterates the table generated by FILTER. That’s a lot of iterations!</p><p class="simplepara" id="calibre_link-1231">The recommended expression is always to use a simple filter on the CASES SOLD column in the filter argument of CALCULATE.</p></section><section class="section" id="calibre_link-182"><h3 class="booksubtitle">Table Filters Return Different Results</h3><div class="calibre4" id="calibre_link-1232">To understand this aspect of the table filters, let’s consider these two measures, the first using a column filter and the second using a table <span id="calibre_link-1233">filter</span>:<div class="programcode" id="calibre_link-1234"><div class="calibre4"><div class="fixedline">Bordeaux Wines #1 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Wines[WINE] = "Bordeaux" )</div></div><div class="calibre4"><div class="fixedline">Bordeaux Wines #2 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Wines, Wines[WINE] = "Bordeaux" )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1235">You might think that these two measures should return the same result. However, if we put these measures into a Table visual that contains the WINE column from the Wines dimension (Figure <span><a href="#calibre_link-372" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-12</a></span>), we get different results. The measure #1 gives the value for “Bordeaux” for every wine, but in #2, we get blanks for any wine other than Bordeaux.<figure class="figure1" id="calibre_link-372"><div class="mediaobject" id="calibre_link-1236"><img alt="" src="images/000046.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-12</span><p class="simplepara1">“Bordeaux Wines #1” and “Bordeaux Wines #2” in a Table visual with the WINE column from the Wines dimension</p></div></figcaption></figure></div><div class="para" id="calibre_link-1237">So why the <span id="calibre_link-1238">difference</span>? Let’s look more closely at the “Bordeaux Wines #1” measure. In the first evaluation of this measure, the active filter context is on the WINE column of the Wines dimension and is filtering “Bordeaux” in the first instance. This filter is now cross-filtered to the Winesales table to sum the CASES SOLD for “Bordeaux”. On the next evaluation, “Champagne” is in the filter context. But <em class="emphasistypeitalic">CALCULATE modifies the filter context</em> and <em class="emphasistypeitalic">replaces</em> the filter on the WINE column from “Champagne” to “Bordeaux”. It’s this filter that is now cross-filtered to the Winesales table to sum the CASES SOLD for “Bordeaux”. And so on for every evaluation of each wine and also the Total row evaluation; see Figure <span><a href="#calibre_link-373" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-13</a></span>.<figure class="figure1" id="calibre_link-373"><div class="mediaobject" id="calibre_link-1239"><img alt="" src="images/000069.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-13</span><p class="simplepara1">CALCULATE replaces the filter on the WINE column so it always filters “Bordeaux”</p></div></figcaption></figure></div><div class="formalpara" id="calibre_link-1240"><div class="heading1">Note</div><p class="para6" id="calibre_link-1241">As mentioned earlier, at this stage in your knowledge of DAX, this explanation of how the filters work is not yet complete, but it will stand you in good stead for the time being. We will get to a more accurate explanation later in Chapter <span><a href="#calibre_link-0" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre"><span>18</span></a></span>.</p></div><p class="simplepara" id="calibre_link-1242">This is why the total cases for “Bordeaux” are always returned because <span id="calibre_link-1243">CALCULATE</span> <em class="emphasistypeitalic">replaces</em> the filter on the WINE column to “Bordeaux” for the evaluation of each wine.</p><div class="para" id="calibre_link-1244">Let’s now look at the second measure using FILTER where we get a value returned for “Bordeaux” but not for the other wines. This measure uses a table filter:<div class="programcode" id="calibre_link-1245"><div class="calibre4"><div class="fixedline">Bordeaux Wines #2 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Wines, Wines[WINE] = "Bordeaux" )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1246">The current filter context is on the WINE column of the Wines dimension, filtering “Bordeaux” in memory in the first instance. The FILTER function inside CALCULATE scans this table looking for the value “Bordeaux” and generates a virtual table containing just the “Bordeaux” row. It’s this table filter that is now cross-filtered to the Winesales table to sum the CASES SOLD for “Bordeaux”. On the evaluation for “Champagne”, the WINE column in the Wines dimension is filtered accordingly. However, the <em class="emphasistypeitalic">FILTER function does not modify the filter context</em>, so the FILTER function inside CALCULATE scans this one-row table containing “Champagne” looking for the value “Bordeaux”. It won’t find it, and so there is nothing to filter. There is now an empty filter generated by FILTER, and an empty filter returns no value; see Figure <span><a href="#calibre_link-374" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-14</a></span>. This is why there are no values returned by the measure other than for “Bordeaux”.<figure class="figure1" id="calibre_link-374"><div class="mediaobject" id="calibre_link-1247"><img alt="" src="images/000004.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-14</span><p class="simplepara1">FILTER can’t replace the filter on the WINE column to equal “<span id="calibre_link-1248" class="calibre11">Bordeaux</span>”, so there are no rows filtered other than for “Bordeaux”</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1249">The important thing to remember about the FILTER function is that it’s a weak function. Unless you use the ALL function that we explore in the next chapter, FILTER will only filter the rows <em class="emphasistypeitalic">that are in the current filter context</em> and will therefore typically return a <em class="emphasistypeitalic">subset</em> of the original filter. Using column filters inside CALCULATE, on the other hand, will replace filters where required.</p></section><section class="section" id="calibre_link-183"><h3 class="booksubtitle">Using the KEEPFILTERS Function</h3><div class="calibre4" id="calibre_link-1250">This behavior of CALCULATE whereby a <em class="emphasistypeitalic">column</em> filter is always <em class="emphasistypeitalic">replaced</em> is, by all accounts, rather odd and unintuitive, giving you the same value for every evaluation. The filter generated by FILTER, even though it’s a table filter, looks more “normal.” As we’re learning, it’s always best to use column filters if possible, so to make the column expression behave more intuitively, we can use a function called <span id="calibre_link-1251">KEEPFILTERS</span><span id="calibre_link-1252"></span> as in this example:<div class="programcode" id="calibre_link-1253"><div class="calibre4"><div class="fixedline">Bordeaux Wines #1 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;KEEPFILTERS ( Wines[WINE] = "Bordeaux" )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1254">This function modifies the behavior of CALCULATE and prevents it from replacing filters. In Figure <span><a href="#calibre_link-375" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">7-15</a></span>, you can see that we now only get a value return for “Bordeaux” for the “Bordeaux Wines #1” measure and no value is returned for the other wines.<figure class="figure1" id="calibre_link-375"><div class="mediaobject" id="calibre_link-1255"><img alt="" src="images/000179.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 7-15</span><p class="simplepara1">The KEEPFILTERS function prevents CALCULATE replacing filters</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1256">In this chapter, you’ve learned to generate virtual tables as part of your DAX expressions. These tables are used by measures to manipulate the data model, either by returning subsets of “real” tables or to act as in-memory dimensions that propagate filters through the data model. You’ve also been warned of the different behaviors of table filters and column filters, particularly with respect to using the FILTER function. As we move forward and tackle more challenging calculations, this difference will become more important. For the moment, however, let’s just remember this:</p><p class="para9" id="calibre_link-1257"><em class="emphasistypeitalic">Always use column filters where you can. Only use table filters where necessary.</em></p></section></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-376" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-371" role="doc-footnote"><p class="para3" id="calibre_link-1258">Marco Russo and Alberto Ferrari (2020), <em class="emphasistypeitalic">The Definitive Guide to DAX</em>, 2nd ed, p. 699 [Microsoft Press]</p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-8">
<div id="calibre_link-1259" class="calibre2">
<div id="calibre_link-1260" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-1261"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_8" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_8</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">8.&nbsp;The ALL Function and All Its Variations</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-397" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-397"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-1262">In previous chapters, we have explored the filter context and how the construct of the visual, slicers, and filters all come together to filter the data model on the evaluation of a measure. You have learned that with the CALCULATE function, you can modify these filters programmatically. What you don’t yet know is how to <em class="emphasistypeitalic">remove</em> filters so you can calculate your own totals and subtotals. But better still, knowing how to remove filters means you can programmatically reapply totally different filters than those that are currently defining the filter context. Let me introduce you to the ALL function that allows you to take control of this aspect of the evaluation of your measures.</p><p class="simplepara" id="calibre_link-1263">On the face of it, the ALL <span id="calibre_link-1264">function</span> appears to be an easy function to understand. The ALL function returns all the rows of a table, or all the distinct values in a column, ignoring any filters that might have been applied. However, what you will be discovering in this chapter is that the simplicity of the ALL function belies the fact&nbsp;that it’s one of the most challenging DAX functions with which to come to terms. In this chapter, we will be delving into this “wolf in sheep’s clothing” function; the objective is to teach you every aspect of ALL and all the variations on the ALL function. This will enable you to move forward and author more complex measures.</p><div class="para8" id="calibre_link-1265">There are at least two reasons why the ALL function is challenging to understand. Firstly, there are a number of <span id="calibre_link-1266">variations</span> of the ALL function:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-1267">ALLSELECTED</p></li><li class="calibre9"><p class="para2" id="calibre_link-1268">ALLEXCEPT</p></li><li class="calibre9"><p class="para2" id="calibre_link-1269">ALLCROSSFILTERED</p></li><li class="calibre9"><p class="para2" id="calibre_link-1270">ALLNOBLANKROW</p></li></ul></div></div><p class="simplepara" id="calibre_link-1271">You need to know which of these to use and when.</p><div class="formalpara" id="calibre_link-1272"><div class="heading1">Note</div><p class="para6" id="calibre_link-1273">The ALLCROSSFILTERED and ALLNOBLANKROW functions are outside the remit of this book.</p></div><div class="calibre4" id="calibre_link-1274">Secondly, ALL (and its variations) has a dual face; it can be used either as a table function or as a <span id="calibre_link-1275">modifier</span> to CALCULATE, as described in the following:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-1276"><strong class="emphasistypebold">ALL as a table function</strong> <span class="emphasisfontcategorynonproportional">&ndash;</span> When used as a table function, ALL behaves as described before; that is, it returns all the rows of a table or all the distinct values in a column or columns.</p></li><li class="calibre9"><p class="para2" id="calibre_link-1277"><strong class="emphasistypebold">ALL as a modifier</strong> <span class="emphasisfontcategorynonproportional">&ndash;</span> When ALL is used as a top-level filter argument in CALCULATE, it acts as a modifier to CALCULATE and <em class="emphasistypeitalic">removes</em> the filters from tables or columns. In other words, it doesn’t generate a virtual table.</p></li></ul></div></div><p class="simplepara" id="calibre_link-1278">In fact, ALL is two completely different functions. This is something that many inexperienced users of DAX don’t appreciate. This is because mostly, the ALL function behaves the way you would expect, whether you use it as a top-level filter argument in CALCULATE or nested inside other functions such as FILTER or COUNTROWS. It removes filters whether by generating virtual tables containing all the rows or by removing filters from tables and columns. However, we will explore later how understanding this difference is crucial in understanding the ALL function.</p><p class="simplepara" id="calibre_link-1279">Although I’ve been referring solely to the ALL function here, we will also be exploring the ALLSELECTED and ALLEXCEPT functions.</p><section class="section" id="calibre_link-184"><h2 class="booksubtitle">The ALL Function</h2><p class="simplepara" id="calibre_link-1280">The ALL function has the following <span id="calibre_link-1281">syntaxes</span>:</p><p class="simplepara" id="calibre_link-1282">= ALL ( table )</p><p class="simplepara" id="calibre_link-1283">where:</p><p class="simplepara" id="calibre_link-1284"><strong class="emphasistypebold">table</strong> is the table from where you want to clear the filters.</p><p class="simplepara" id="calibre_link-1285">Here is an example of the ALL function syntax, referencing a table:</p><p class="para9" id="calibre_link-1286"><strong class="emphasistypebold">= ALL ( Winesales )</strong></p><p class="para9" id="calibre_link-1287">Unlike other functions that use tables as arguments, you can’t nest another table function inside the ALL function; you can only use base tables.</p><p class="simplepara" id="calibre_link-1288">Or you can reference a column.</p><p class="simplepara" id="calibre_link-1289">= ALL (column 1, column 2, etc.)</p><p class="simplepara" id="calibre_link-1290">where:</p><p class="simplepara" id="calibre_link-1291"><strong class="emphasistypebold">column(s)</strong> is the column or columns from where you want to clear the filters.</p><p class="simplepara" id="calibre_link-1292">Here is an example of the ALL function syntax referencing a column:</p><p class="para9" id="calibre_link-1293"><strong class="emphasistypebold">= ALL ( Wines[TYPE] )</strong></p><div class="table" id="calibre_link-1294">The ALL function will have a different impact on the filtering of the data model depending on the syntax you use, whether ALL is removing filters from tables or removing <span id="calibre_link-1295">filters</span> from columns. It will have a different impact yet again if you use ALL to remove filters from fact tables or dimensions. Therefore, to make it easier to understand the behavior of ALL, we’ll take these three different objects from where ALL can remove filters and explore them separately, as follows:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1296">Fact tables</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1297">Dimensions</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-1298">A column or columns</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><section class="section" id="calibre_link-185"><h3 class="booksubtitle">Applied to the Fact Table</h3><div class="calibre4" id="calibre_link-1299">Let’s <span id="calibre_link-1300">again</span> consider a scenario. In the visual in Figure <span><a href="#calibre_link-398" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-1</a></span>, we’re using this measure to calculate the number of sales:<div class="programcode" id="calibre_link-1301"><div class="calibre4"><div class="fixedline">No. of Sales =</div><div class="fixedline">COUNTROWS ( Winesales )</div></div></div><figure class="figure1" id="calibre_link-398"><div class="mediaobject" id="calibre_link-1302"><img alt="" src="images/000251.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-1</span><p class="simplepara1">Using ALL to calculate the percentage of the Grand Total</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1303">We have then calculated the “Grand Total No. of Sales” to act as a denominator to calculate the percentage shown in “No. of Sales as Percent of Grand Total”; see Figure <span><a href="#calibre_link-398" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-1</a></span>.</p><div class="para" id="calibre_link-1304">To arrive at these calculations, first, we need to author a measure that ignores the filters coming through from the Wines dimension so we can calculate the number of sales for <em class="emphasistypeitalic">all the wines</em>, <strong class="emphasistypebold">2,207</strong>. To do this, we can use ALL as a table function to generate a virtual table containing all the rows of the Winesales fact table and then use COUNTROWS to count the rows in this table. This is the expression:<div class="programcode" id="calibre_link-1305"><div class="calibre4"><div class="fixedline">Grand Total No. of Sales =</div><div class="fixedline">COUNTROWS ( ALL ( Winesales ) )</div></div></div></div><div class="para" id="calibre_link-1306">Finally, we can then divide the Grand Total into each wine’s total to find the percentage, as in the following measure:<div class="programcode" id="calibre_link-1307"><div class="calibre4"><div class="fixedline">No. of Sales as Percent of Grand Total =</div><div class="fixedline">DIVIDE ( [No. of Sales] , [Grand Total No. of Sales] )</div></div></div></div><div class="para" id="calibre_link-1308">Let’s explore the impact of adding more filters to the report. In Figure <span><a href="#calibre_link-399" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-2</a></span>, we have placed a filter on the SalesPeople dimension using a slicer, but you can see that the measure using the ALL function always returns the Grand Total regardless of the filter.<figure class="figure1" id="calibre_link-399"><div class="mediaobject" id="calibre_link-1309"><img alt="" src="images/000072.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-2</span><p class="simplepara1">The ALL function ignores filters from <span id="calibre_link-1310" class="calibre11">dimensions</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-1311">To understand the behavior of ALL in this example, we must again consider the filter context. On the evaluation for “Bordeaux” wine, there are two active filters: one on the Wines dimension filtering “Bordeaux” and one on the SalesPeople dimension filtering “Abel”. However, the ALL function always counts the rows of the virtual table containing <em class="emphasistypeitalic">all the rows</em> of the Winesales fact table ignoring any filters propagating from dimensions; see Figure <span><a href="#calibre_link-400" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-3</a></span>.<figure class="figure1" id="calibre_link-400"><div class="mediaobject" id="calibre_link-1312"><img alt="" src="images/000173.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-3</span><p class="simplepara1">The ALL function passed to the fact table generates a virtual fact table that is used for all evaluations, and any filters from dimensions are ignored</p></div></figcaption></figure></div><div class="para" id="calibre_link-1313">Let’s look at another example of using the ALL function on the fact table, but this time nesting ALL inside CALCULATE. For example, you may want to find the grand total of cases sold, again so you could use this value as a denominator to find percentages; see Figure <span><a href="#calibre_link-401" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-4</a></span>. This would be the measure:<div class="programcode" id="calibre_link-1314"><div class="calibre4"><div class="fixedline">Total Cases All Winesales =</div><div class="fixedline">CALCULATE ( [Total Cases], ALL( Winesales ) )</div></div></div><figure class="figure1" id="calibre_link-401"><div class="mediaobject" id="calibre_link-1315"><img alt="" src="images/000217.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-4</span><p class="simplepara1">The ALL function nested inside <span id="calibre_link-1316" class="calibre11">CALCULATE</span> to find the grand total of cases sold</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1317">You can see how this measure again ignores any filters on the data model.</p><div class="para" id="calibre_link-1318">However, let’s now focus on an expression that you may require that calculates the average cases sold <em class="emphasistypeitalic">for all wines</em> so you can compare this average to the average cases sold for <em class="emphasistypeitalic">each</em> wine. This would be the measure that would find this average:<div class="programcode" id="calibre_link-1319"><div class="calibre4"><div class="fixedline">Avg Cases All Winesales =</div><div class="fixedline">CALCULATE( AVERAGE ( Winesales[CASES SOLD] ), ALL ( Winesales ) )</div></div></div></div><div class="para" id="calibre_link-1320">You could then author the following measure using FILTER to calculate the number of sales where the cases sold value is greater than the average for all the wines:<div class="programcode" id="calibre_link-1321"><div class="calibre4"><div class="fixedline">No. of Sales Where Cases is GT Avg All Wines =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[CASES SOLD]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&gt;= [Avg Cases All Winesales] )</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-1322">In the code for “No. of Sales Where Cases is GT Avg All Wines” the FILTER function iterates the Winesales table to filter any rows where the value in the CASES SOLD column is greater than the value calculated by “Avg Cases All Winesales”. However, to fully appreciate the details of this expression, you need to understand the concept of context transition that we will be exploring in a later chapter.</p><div class="para" id="calibre_link-1323">You can see the results of these expressions in Figure <span><a href="#calibre_link-402" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-5</a></span>.<figure class="figure1" id="calibre_link-402"><div class="mediaobject" id="calibre_link-1324"><img alt="" src="images/000040.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-5</span><p class="simplepara1">Calculating the <span id="calibre_link-1325" class="calibre11">grand total cases</span> sold and the average cases for all wines</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1326">What you have to understand here is that when ALL is nested inside CALCULATE, it doesn’t behave as a table function. Instead, ALL is <em class="emphasistypeitalic">removing</em> all the cross-filters on the fact table and therefore evaluating all the rows of the fact table. We will be exploring this behavior in detail as we move through this chapter.</p><p class="simplepara" id="calibre_link-1327">Using ALL in this way, we’ve been able to find the percentages of the Grand Total. However, you may have a different requirement, and that is to calculate percentages across <em class="emphasistypeitalic">filtered</em> items. This brings us to the second place where we can use ALL, and that is when it’s passed onto dimensions.</p></section><section class="section" id="calibre_link-186"><h3 class="booksubtitle">Using ALL on Dimension Tables</h3><p class="simplepara" id="calibre_link-1328">For example, in Figure <span><a href="#calibre_link-399" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-2</a></span>, we’ve filtered salesperson “Abel” in the slicer and can see the total number of sales for Abel for <em class="emphasistypeitalic">all the wines</em> is <strong class="emphasistypebold">376.</strong> We want to know what the individual wine totals are for “Abel” as the percentage of <em class="emphasistypeitalic">this value</em>. In other words, we need to remove the filter on the Wines dimension while retaining the filter on the SALESPERSON column in the SalesPeople <span id="calibre_link-1329">dimension</span> that is filtering “Abel”.</p><p class="simplepara" id="calibre_link-1330">If we remove a filter from a specific dimension, filters propagating from other dimensions into the fact table will be unaffected. Therefore, if we remove the filter from the Wines dimension, the filter on the SalesPeople dimension will be preserved, therefore calculating the number of sales <em class="emphasistypeitalic">for all the wines</em> for the filtered salesperson.</p><div class="para" id="calibre_link-1331">However, this measure using ALL on the Wines dimension isn’t correct:<div class="programcode" id="calibre_link-1332"><div class="calibre4"><div class="fixedline">No. of Sales All Wines Wrong =</div><div class="fixedline">COUNTROWS ( ALL ( Wines ) )</div></div></div></div><div class="para" id="calibre_link-1333">This measure would generate a table containing <em class="emphasistypeitalic">all the rows in the Wines dimension</em> and then count the number of rows in this table, returning <strong class="emphasistypebold">14</strong> because there are 14 rows in the Wines dimension. Remember that the table whose rows we want to count is that of the Winesales fact table, filtered to show the sales of all the wines for the salesperson selected in the slicer. Therefore, we need to calculate the number of sales in the Winesales table which we’ve already done a number of times:<div class="programcode" id="calibre_link-1334"><div class="calibre4"><div class="fixedline">No. of Sales = COUNTROWS ( Winesales)</div></div></div></div><div class="para" id="calibre_link-1335">Because we want to modify the filter context to remove the filter from the Wines dimension, we can use the “No. of Sales” measure inside CALCULATE, and then using the ALL function as the filter argument in CALCULATE, we can modify the filter context as follows:<div class="programcode" id="calibre_link-1336"><div class="calibre4"><div class="fixedline">No. of Sales All Wines =</div><div class="fixedline">CALCULATE ( [No. of Sales], ALL ( Wines ) )</div></div></div></div><div class="para" id="calibre_link-1337">Finally, we can divide to arrive at the percentage:<div class="programcode" id="calibre_link-1338"><div class="calibre4"><div class="fixedline">No. of Sales as Percent of Filtered Value =</div><div class="fixedline">DIVIDE ( [No. of Sales] , [No. of Sales All Wines] )</div></div></div></div><div class="para" id="calibre_link-1339">Let’s focus on the measure “No. of Sales All Wines” shown in Figure <span><a href="#calibre_link-403" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-6</a></span>. We can see it calculates the same value that is sitting in the Total row of the “No. of Sales” measure, <strong class="emphasistypebold">376</strong>.<figure class="figure1" id="calibre_link-403"><div class="mediaobject" id="calibre_link-1340"><img alt="" src="images/000208.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-6</span><p class="simplepara1">Removing the filter from a dimension using ALL</p></div></figcaption></figure></div><div class="para" id="calibre_link-1341">In this Table visual, initially, filters are on both the Wines dimension and the SalesPeople dimension, but when the “No. of Sales All Wines” measure is evaluated for each wine, all the filters are <em class="emphasistypeitalic">removed</em> from the Wines dimension (because we are using CALCULATE), therefore always returning the value for <em class="emphasistypeitalic">all the wines</em>. Filters from any other dimensions, for example, the SalesPeople dimension, are retained; see Figure <span><a href="#calibre_link-404" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-7</a></span>.<figure class="figure1" id="calibre_link-404"><div class="mediaobject" id="calibre_link-1342"><img alt="" src="images/000049.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-7</span><p class="simplepara1">The ALL function removes filters from the Wines dimension, but other filters are preserved</p></div></figcaption></figure></div><div class="para" id="calibre_link-1343">Perhaps we’re beginning to appreciate that there’s much to understanding the ALL function! We’re getting there, but we’re not quite there yet. For instance, consider the measure we’ve just been working with:<div class="programcode" id="calibre_link-1344"><div class="calibre4"><div class="fixedline">No. of Sales All Wines =</div><div class="fixedline">CALCULATE ( [No. of Sales], ALL ( Wines ) )</div></div></div></div><p class="simplepara" id="calibre_link-1345">It may not be the calculation that you want. The problem is that it removes <em class="emphasistypeitalic">all</em> the filters in the Wines dimension. There will come a time when we need to be more specific regarding from which columns in a dimension we need to remove the filters.</p></section><section class="section" id="calibre_link-187"><h3 class="booksubtitle">Using ALL on a Column</h3><div class="calibre4" id="calibre_link-1346">Consider the example in Figure <span><a href="#calibre_link-405" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-8</a></span>. Both the SALESPERSON column from the SalesPeople dimension <em class="emphasistypeitalic">and</em> the <span id="calibre_link-1347">SUPPLIER column</span> from the Wines dimension are being filtered by slicers. We’re filtering salesperson “Abel” and supplier “Alliance”. Remember that there is also a filter on the WINE column from the Wines dimension filtering each wine. However, the “No. of Sales All Wines” is showing the total for Abel for <em class="emphasistypeitalic">all</em> suppliers, <strong class="emphasistypebold">376</strong>, because the measure removes <em class="emphasistypeitalic">all the filters</em> from the Wines table including the SUPPLIER column.<figure class="figure1" id="calibre_link-405"><div class="mediaobject" id="calibre_link-1348"><img alt="" src="images/000227.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-8</span><p class="simplepara1">ALL that references a table will remove filters from all columns in a table, which may be incorrect</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1349">Therefore, the percentage in “No. of Sales as Percent of Filtered Value” would be correct if you want to show the percentage “Abel’s” sales of “Alliance” are of “Abel’s” total sales for all suppliers (<strong class="emphasistypebold">376</strong>). However, this would be incorrect if you want to show the percentage “Abel’s” sales are of the total sales only for “Alliance” (<strong class="emphasistypebold">99</strong>). If the latter is the goal, we must calculate “Abel’s” total for all the wines that are supplied by “Alliance” (or whatever supplier has been filtered), which is <strong class="emphasistypebold">99</strong>.</p><div class="para" id="calibre_link-1350">Let’s look more closely at the problem. The current filter context uses filters on <em class="emphasistypeitalic">two</em> columns in the Wines dimension: WINE and SUPPLIER. If we could see the in-memory Wines table for the evaluation of “Chardonnay”, it might look something like Figure <span><a href="#calibre_link-406" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-9</a></span>.<figure class="figure1" id="calibre_link-406"><div class="mediaobject" id="calibre_link-1351"><img alt="" src="images/000234.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-9</span><p class="simplepara1">Filters are on both the WINE column and the SUPPLIER column</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1352">The measure “No. of Sales All Wines” removes both these filters and so calculates the number of sales for Abel for <em class="emphasistypeitalic">all</em> wines and <em class="emphasistypeitalic">all</em> suppliers. Using the ALL function with a table name as its argument, whether it’s a fact table or a dimension, will remove <em class="emphasistypeitalic">all</em> the filters from that table. We can, however, use ALL to remove filters from just <em class="emphasistypeitalic">specific columns.</em></p><div class="para" id="calibre_link-1353">To remedy the problem in Figure <span><a href="#calibre_link-405" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-8</a></span>, we need to remove the filter from the WINE column but retain the filter on the SUPPLIER column. This is the measure we can create to do this:<div class="programcode" id="calibre_link-1354"><div class="calibre4"><div class="fixedline">No. of Sales All Wines #2 =</div><div class="fixedline">CALCULATE ( [No. of Sales] , ALL ( Wines[WINE] ) )</div></div></div></div><div class="para" id="calibre_link-1355">You can see that in this measure, we’ve used a reference to the WINE column inside ALL, and so ALL removes the filter from this column only. Figure <span><a href="#calibre_link-407" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-10</a></span> shows what is happening in memory, and you can see that the filter is retained on the SUPPLIER column.<figure class="figure1" id="calibre_link-407"><div class="mediaobject" id="calibre_link-1356"><img alt="" src="images/000109.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-10</span><p class="simplepara1">Using ALL on a column removes the filter from that column only</p></div></figcaption></figure></div><div class="para" id="calibre_link-1357">We can now calculate the correct percentage and see this evaluated in Figure <span><a href="#calibre_link-408" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-11</a></span>:<div class="programcode" id="calibre_link-1358"><div class="calibre4"><div class="fixedline">No. of Sales as Percent of Filtered Value #2 =</div><div class="fixedline">DIVIDE ( [No. of Sales] , [No. of Sales All Wines #2] )</div></div></div><figure class="figure1" id="calibre_link-408"><div class="mediaobject" id="calibre_link-1359"><img alt="" src="images/000141.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-11</span><p class="simplepara1">The correct percentage for sales for “Abel” for “Alliance” supplier</p></div></figcaption></figure></div><div class="para" id="calibre_link-1360">Let’s consider another example where we must use the ALL function to remove the filter from a specific column. This is where the requirement is to calculate percentages across grouped items. For example, in the Matrix visual in Figure <span><a href="#calibre_link-409" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-12</a></span>, there are two columns from the Wines dimension in the Rows bucket of the Matrix: WINE COUNTRY and TYPE. We’ve calculated the percentage the “Total Cases” values for each TYPE are of the “Total Cases” values for each WINE COUNTRY and can see that “White” wines constitute <strong class="emphasistypebold">47.02%</strong> of “French” wines.<sup class="calibre10"><a type="noteref" href="#calibre_link-410" id="calibre_link-424" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup><figure class="figure1" id="calibre_link-409"><div class="mediaobject" id="calibre_link-1361"><img alt="" src="images/000199.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-12</span><p class="simplepara1"><span id="calibre_link-1362" class="calibre11">Calculating percentages</span> across grouped data</p></div></figcaption></figure></div><div class="para" id="calibre_link-1363">It would then be insightful to create a stacked column chart where we can show the total cases for each WINE COUNTRY and TYPE. We could then use the Tooltip, populated with our percentage measure to show the percentage breakdown across TYPE, as in Figure <span><a href="#calibre_link-411" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-13</a></span>.<figure class="figure1" id="calibre_link-411"><div class="mediaobject" id="calibre_link-1364"><img alt="" src="images/000131.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-13</span><p class="simplepara1">Stacked column chart showing the percentage breakdown across WINE COUNTRY in the Tooltip</p></div></figcaption></figure></div><div class="para" id="calibre_link-1365">These are the measures that are calculated in Figure <span><a href="#calibre_link-409" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-12</a></span>.<div class="programcode" id="calibre_link-1366"><div class="calibre4"><div class="fixedline">All Wines Type =</div><div class="fixedline">CALCULATE ( [Total Cases], ALL ( Wines[TYPE] ) )</div></div></div></div><div class="para" id="calibre_link-1367"><div class="programcode" id="calibre_link-1368"><div class="calibre4"><div class="fixedline">Percentage of Wine Country =</div><div class="fixedline">DIVIDE ( [Total Cases] , [All Wines Type] )</div></div></div></div><div class="para" id="calibre_link-1369">Let’s look more closely at how the “All Wines Type” measure is evaluated in the Matrix visual. The first evaluation starts with a filter on WINE COUNTRY of “France” and a filter on TYPE of “Red”, and this is propagated to the fact table. However, to calculate the Total Cases for “France”, the filter on TYPE must be removed so that the measure calculates Total Cases for <em class="emphasistypeitalic">both</em> “Red” and “White” types for “France”. If the filter from the TYPE column is removed using ALL, then “France” is the only filter propagated to the fact table; see Figure <span><a href="#calibre_link-412" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-14</a></span>.<figure class="figure1" id="calibre_link-412"><div class="mediaobject" id="calibre_link-1370"><img alt="" src="images/000024.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-14</span><p class="simplepara1">Using ALL on the <span id="calibre_link-1371" class="calibre11">TYPE column</span> removes the filter from only that column</p></div></figcaption></figure></div><div class="para" id="calibre_link-1372">Being able to identify which table and/or column you want to remove filters from is key to using ALL successfully. However, consider the example in Figure <span><a href="#calibre_link-413" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-15</a></span> where we have <em class="emphasistypeitalic">four</em> columns in the Rows bucket. To calculate the percentage for each WINE COUNTRY, we need to remove the filters from <em class="emphasistypeitalic">three</em> columns in the Wines dimension, that is, TYPE, SUPPLIER, and WINE.<figure class="figure1" id="calibre_link-413"><div class="mediaobject" id="calibre_link-1373"><img alt="" src="images/000016.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-15</span><p class="simplepara1">Removing filters from <span id="calibre_link-1374" class="calibre11">multiple columns</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-1375">Inside the ALL function, you can reference multiple column names, so you could write this measure:<div class="programcode" id="calibre_link-1376"><div class="calibre4"><div class="fixedline">All Wines Type, Supplier &amp; Wine =</div><div class="fixedline">CALCULATE ( [Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( Wines[TYPE], Wines[SUPPLIER], Wines[WINE] )</div><div class="fixedline">)</div></div></div></div><div class="formalpara" id="calibre_link-1377"><div class="heading1">Note</div><p class="para6" id="calibre_link-1378">Because we are removing the filter from the WINE column, “Lambrusco” wine that has no data will appear in the visual. To fix this, use a visual-level filter to filter nonblank items.</p></div><p class="simplepara" id="calibre_link-1379">However, you can appreciate how tedious this could get if you had many columns from which you must remove filters. This is where you could use the ALLEXCEPT function instead of ALL.</p></section></section><section class="section" id="calibre_link-188"><h2 class="booksubtitle">The ALLEXCEPT Function</h2><p class="simplepara" id="calibre_link-1380">ALLEXCEPT removes all filters in a table except filters that are applied to the columns you specify. This can be used for situations in which you want to remove the filters on many but not all of the columns in a table.</p><p class="simplepara" id="calibre_link-1381">The <span id="calibre_link-1382">ALLEXCEPT function</span><span id="calibre_link-1383"></span> has the following syntax:</p><p class="simplepara" id="calibre_link-1384">= ALLEXCEPT ( table, column1, colum2, etc. )</p><p class="simplepara" id="calibre_link-1385">where:</p><p class="simplepara" id="calibre_link-1386"><strong class="emphasistypebold">table</strong> is the table where you want to clear the filters from <em class="emphasistypeitalic">except</em> the filters on the columns specified in the next arguments.</p><p class="simplepara" id="calibre_link-1387"><strong class="emphasistypebold">column1, column2</strong> are the columns where you want filters preserved.</p><p class="simplepara" id="calibre_link-1388">Here is an example of the ALLEXCEPT syntax:</p><p class="para9" id="calibre_link-1389"><strong class="emphasistypebold">= ALLEXCEPT ( Wines, Wines[WINE COUNTRY] )</strong></p><p class="para9" id="calibre_link-1390">Note that in ALLEXCEPT, unlike ALL, you need to first supply the table name.</p><div class="para" id="calibre_link-1391">Therefore, in the Matrix visual in Figure <span><a href="#calibre_link-413" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-15</a></span>, you could author an alternative version of the “All Wines Type, Supplier &amp; Wine” measure as follows:<div class="programcode" id="calibre_link-1392"><div class="calibre4"><div class="fixedline">All Except Wine Country =</div><div class="fixedline">CALCULATE ( [Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALLEXCEPT ( Wines, Wines[WINE COUNTRY] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1393">So now we can calculate the percentage:<div class="programcode" id="calibre_link-1394"><div class="calibre4"><div class="fixedline">Percentage of Wine Country #2=</div><div class="fixedline">DIVIDE ( [Total Cases] , [All Except Wine Country] )</div></div></div></div><div class="para" id="calibre_link-1395">You might think that surely we’ve exhausted all possible “ALL” variations! We’ve looked at removing filters from entire tables, either fact tables or dimensions. We’ve also seen how we can remove filters from specific columns and how to remove filters from several columns while retaining filters on others. However, there is still another scenario that we need to explore. Consider Figure <span><a href="#calibre_link-414" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-16</a></span>.<figure class="figure1" id="calibre_link-414"><div class="mediaobject" id="calibre_link-1396"><img alt="" src="images/000117.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-16</span><p class="simplepara1">The “Grand Total No. of Sales” measure is not the total for the selected wines in the slicer</p></div></figcaption></figure></div><div class="para" id="calibre_link-1397">Here, we have a Table visual into which the WINE column from the Wines dimension has been placed. You can see that four wines have been filtered using the slicer. The “No. of Sales” measure calculates the number of sales for the selected wines. The “Grand Total No. of Sales” measure has also been included and has the following expression:<div class="programcode" id="calibre_link-1398"><div class="calibre4"><div class="fixedline">Grand Total No. of Sales =</div><div class="fixedline">COUNTROWS ( ALL ( Winesales ) )</div></div></div></div><p class="simplepara" id="calibre_link-1399">This measure returns the total number of sales for all wines irrespective of the slicer selection. This would also be true if the wines filter was generated from a filter placed in the Filters pane. If we want to calculate percentages of the total only for the selected wines (<strong class="emphasistypebold">699</strong> in this case), this “Grand Total No. of Sales” measure is not going to work.</p><p class="simplepara" id="calibre_link-1400">The problem is that the values selected in the slicer come from the same column that is put into the Table visual, which is the WINE column. We’re using the slicer to <em class="emphasistypeitalic">reduce</em> the wines shown in the visual. Therefore, we need to find a function that specifically finds grand totals <em class="emphasistypeitalic">for the items that have been filtered in the visual.</em> The function we need is called ALLSELECTED.</p></section><section class="section" id="calibre_link-189"><h2 class="booksubtitle">The ALLSELECTED Function</h2><p class="simplepara" id="calibre_link-1401">The syntax for the <span id="calibre_link-1402">ALLSELECTED function</span><span id="calibre_link-1403"></span> is the same as for the ALL function:</p><p class="simplepara" id="calibre_link-1404">= ALLSELECTED ( table )</p><p class="simplepara" id="calibre_link-1405">or</p><p class="simplepara" id="calibre_link-1406">= ALLSELECTED ( Column 1, Column 2, etc.)</p><div class="para" id="calibre_link-1407">However, if you were to look at the function description in the DAX Function Library, you may be a little bemused:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-1408"><em class="emphasistypeitalic">“ALLSELECTED removes context filters from columns and rows in the current query, while retaining all other context filters or explicit filters. The ALLSELECTED function gets the context that represents all rows and columns in the query, while keeping explicit filters and contexts other than row and column filters. This function can be used to obtain visual totals in queries.”</em></p></li></ul></div></div><div class="para" id="calibre_link-1409">To be fair, it is very difficult to explain what this function does. It’s much easier to look at an example of using it. Therefore, let’s return to our problem of calculating the grand total for only the wines selected in the slicer. This is the DAX expression we need:<div class="programcode" id="calibre_link-1410"><div class="calibre4"><div class="fixedline">Grand Total No. of Sales for Selected Wines =</div><div class="fixedline">CALCULATE ( [No. of Sales], ALLSELECTED ( Wines[WINE] ) )</div></div></div></div><div class="para" id="calibre_link-1411">You can see this measure and the percentage calculated from it in Figure <span><a href="#calibre_link-415" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-17</a></span>.<figure class="figure1" id="calibre_link-415"><div class="mediaobject" id="calibre_link-1412"><img alt="" src="images/000095.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-17</span><p class="simplepara1">The ALLSELECTED function calculates the correct grand total</p></div></figcaption></figure></div><div class="para" id="calibre_link-1413">How does this expression work? Well again, let’s consider the current filter context for the first evaluation of this measure, that is, “Bordeaux” in the WINE column of the Wines dimension. However, ALLSELECTED replaces the filter on the WINES column with the filter from the slicer. Therefore, the Wines dimension is filtered to reflect the slicer selection; see Figure <span><a href="#calibre_link-416" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-18</a></span>.<figure class="figure1" id="calibre_link-416"><div class="mediaobject" id="calibre_link-1414"><img alt="" src="images/000064.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-18</span><p class="simplepara1">The ALLSELECTED function replaces the filter to reflect the slicer selections</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1415">Mostly you can use ALLSELECTED in place of ALL because often you’re using slicers or the Filters pane to reduce the number of items shown in visuals. If there are no selections from slicers or from the Filters pane, ALLSELECTED will remove all filters, just like ALL.</p><p class="simplepara" id="calibre_link-1416">Up to now, we’ve been using the ALL function (and its variations) while not considering whether it’s being used as a <em class="emphasistypeitalic">table function</em> or is being used as a <em class="emphasistypeitalic">modifier</em> to CALCULATE. The “ALL” functions seem to be doing their job, and we’re thankful for that. We know that ALL removes filters whether by removing filters from tables and columns or by generating virtual tables containing all the rows. However, we are now going to focus our attention on the difference between ALL as a table function and ALL as a modifier to CALCULATE. Remember how in Chapter <span><a href="#calibre_link-59" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>1</span></a></span> we said that when working with DAX, the devil is in the detail? Understanding this difference in these two behaviors of ALL is a fine example of paying attention to this detail.</p></section><section class="section" id="calibre_link-190"><h2 class="booksubtitle">ALL as a Modifier to CALCULATE</h2><p class="simplepara" id="calibre_link-1417">To understand this aspect of ALL, let’s consider a scenario that we’ve looked at before, which is removing the filter from the WINE column in the Wines dimension while still retaining the filter on the <span id="calibre_link-1418">SUPPLIER column</span> (see Figure <span><a href="#calibre_link-408" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-11</a></span>). This was to calculate the <em class="emphasistypeitalic">number of sales</em> for the selected supplier.</p><div class="para" id="calibre_link-1419">However, this time we’re going to count the <em class="emphasistypeitalic">number of wines</em> supplied by “Alliance” by counting the rows in the Wines table that are filtered accordingly, using a slicer. To do this, we’ve created two similar measures that both use the ALL function on the WINE column in the <span id="calibre_link-1420">Wines dimension</span>:<div class="programcode" id="calibre_link-1421"><div class="calibre4"><div class="fixedline">No. of Wines #1 =</div><div class="fixedline">COUNTROWS ( ALL ( Wines[WINE] ) )</div></div></div></div><div class="para" id="calibre_link-1422"><div class="programcode" id="calibre_link-1423"><div class="calibre4"><div class="fixedline">No. of Wines #2 =</div><div class="fixedline">CALCULATE ( COUNTROWS ( Wines ), ALL ( Wines[WINE] ) )</div></div></div></div><div class="para" id="calibre_link-1424">However, only one of these measures returns the correct result; see Figure <span><a href="#calibre_link-417" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-19</a></span>.<figure class="figure1" id="calibre_link-417"><div class="mediaobject" id="calibre_link-1425"><img alt="" src="images/000165.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-19</span><p class="simplepara1">Using ALL on a column can <span id="calibre_link-1426" class="calibre11">return different results</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-1427">The “No. of Wines #1” measure uses ALL as a <em class="emphasistypeitalic">table</em> <span id="calibre_link-1428">function</span> and generates a one-column table of <em class="emphasistypeitalic">all</em> the distinct values in the WINE column. The measure then counts the number of rows in this virtual table and returns 14 rows as shown in Figure <span><a href="#calibre_link-418" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-20</a></span>.<figure class="figure1" id="calibre_link-418"><div class="mediaobject" id="calibre_link-1429"><img alt="" src="images/000191.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-20</span><p class="simplepara1">ALL as a table function generates a virtual table of distinct values</p></div></figcaption></figure></div><div class="para" id="calibre_link-1430">The “No. of Wines #2” measure uses ALL inside <span id="calibre_link-1431">CALCULATE</span><span id="calibre_link-1432"></span><span id="calibre_link-1433"></span> as a <em class="emphasistypeitalic">modifier</em> and therefore <em class="emphasistypeitalic">removes</em> the filter from the WINES column but preserves the filter on the SUPPLIER column. This measure then counts the number of rows in the Wines dimension and returns four rows; see Figure <span><a href="#calibre_link-419" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-21</a></span>.<figure class="figure1" id="calibre_link-419"><div class="mediaobject" id="calibre_link-1434"><img alt="" src="images/000087.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-21</span><p class="simplepara1">The ALL function as a CALCULATE modifier removes the filter on the <span id="calibre_link-1435" class="calibre11">WINE column</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1436">This example has been easy to explain. However, the ALL function acting as a modifier to CALCULATE can be more challenging to understand, and this is certainly the case in the next example we’re going to explore.</p><div class="para" id="calibre_link-1437">We’ve built three measures that calculate the number of sales where the cases sold is greater than 300. They’re all using the expression <em class="emphasistypeitalic">“ALL ( Winesales )”</em> (highlighted in gray), and the <span id="calibre_link-1438">expressions</span> look much the same. You might therefore expect them to return the same result:<div class="programcode" id="calibre_link-1439"><div class="calibre4"><div class="fixedline">No. of Sales Where Cases GT 300 #1 =</div><div class="fixedline">CALCULATE ( [No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( Winesales ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] &gt; 300</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1440"><div class="programcode" id="calibre_link-1441"><div class="calibre4"><div class="fixedline">No. of Sales Where Cases GT 300 #2 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( Winesales ), Winesales[CASES SOLD] &gt; 300 )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1442"><div class="programcode" id="calibre_link-1443"><div class="calibre4"><div class="fixedline">No. of Sales Where Cases GT 300 #3 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( Winesales ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[CASES SOLD] &gt;300 )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1444">However, as you can see in Figure <span><a href="#calibre_link-420" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-22</a></span>, whereas measures #1 and #2 return the same value, measure #3 returns a different value.<figure class="figure1" id="calibre_link-420"><div class="mediaobject" id="calibre_link-1445"><img alt="" src="images/000182.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-22</span><p class="simplepara1"><span id="calibre_link-1446" class="calibre11">Similar expressions</span> can return different results</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1447">These three measures all use ALL on the Winesales table so they should ignore any filters on the Winesales table. This is true for measures #1 and #2 (there are <strong class="emphasistypebold">286</strong> rows in the Winesales table where CASES SOLD is greater than 300), but what about measure #3? In this measure, the ALL function appears to be ignored, and the cross-filter propagated from the Wines dimension is retained. Therefore, this measure returns the number of sales <em class="emphasistypeitalic">for each wine</em> where CASES SOLD is greater than 300.</p><p class="simplepara" id="calibre_link-1448">Question: Which of these measures is the odd one out?</p><p class="simplepara" id="calibre_link-1449">You might think measure #3 is the odd one out because it returns a different value. However, you could argue that measure #2 is the odd one out because it’s the only measure where ALL is being used as a <em class="emphasistypeitalic">table function</em>. In the other two measures, ALL is acting as a CALCULATE <em class="emphasistypeitalic">modifier</em>.</p><p class="simplepara" id="calibre_link-1450">To understand this, let’s look at the evaluation of each of these measures in more <span id="calibre_link-1451">detail</span>.</p><div class="para" id="calibre_link-1452">In this measure<div class="programcode" id="calibre_link-1453"><div class="calibre4"><div class="fixedline">No. of Sales Where Cases GT 300 #1 =</div><div class="fixedline">CALCULATE ( [No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( Winesales ), Winesales[CASES SOLD] &gt; 350</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1454">there are two filter arguments in CALCULATE. The first one using ALL is <em class="emphasistypeitalic">modifying</em><span id="calibre_link-1455"></span> the filter to remove filters from the Winesales table. This is evaluated first and produces an empty filter. The second filter is a <em class="emphasistypeitalic">column</em> filter on the CASES SOLD column, filtering cases sold greater than 300; see Figure <span><a href="#calibre_link-421" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-23</a></span>.<figure class="figure1" id="calibre_link-421"><div class="mediaobject" id="calibre_link-1456"><img alt="" src="images/000123.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-23</span><p class="simplepara1">The <span id="calibre_link-1457" class="calibre11">evaluation</span> of “No. of Sales Where Cases GT 300 #1”</p></div></figcaption></figure></div><div class="para" id="calibre_link-1458"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1459">ALL behaves as a modifier to CALCULATE and removes any filters or cross-filters on Winesales, including the filter coming through from the Wines dimension. This results in an empty filter, and therefore, the Winesales table now has no filters on it.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1460">A new filter is then placed on the CASES SOLD column of the Winesales table to filter any cases sold that are greater than 300. This is the new filter in which the “No. of Sales” measure is evaluated and the rows of the Winesales table are counted.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-1461">In this measure<div class="programcode" id="calibre_link-1462"><div class="calibre4"><div class="fixedline">No. of Sales Where Cases GT 300 #2 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( Winesales ), Winesales[CASES SOLD] &gt;350 )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1463">there is just one filter argument in CALCULATE supplied by the FILTER function (highlighted in gray). Inside the FILTER function, the ALL function generates a virtual table of all the rows in the Winesales table, therefore removing the cross-filter from the Wines dimension. The FILTER function iterates this <em class="emphasistypeitalic">virtual table</em> to return the rows where CASES SOLD is greater than 300; see Figure <span><a href="#calibre_link-422" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-24</a></span>.<figure class="figure1" id="calibre_link-422"><div class="mediaobject" id="calibre_link-1464"><img alt="" src="images/000156.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-24</span><p class="simplepara1">The <span id="calibre_link-1465" class="calibre11">evaluation</span> of “No. of Sales Where Cases GT 300 #2”</p></div></figcaption></figure></div><div class="para" id="calibre_link-1466"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1467">The current filter context filters each WINE in the Wines dimension, and this is cross-filtered to the Winesales table.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1468">The ALL function inside FILTER generates a virtual table of all the rows of Winesales, ignoring the wine filter.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-1469">The FILTER function iterates over the virtual Winesales table to filter out the rows where CASES SOLD is greater than 300. This is the new filter in which the “No. of Sales” measure is evaluated and the rows of the virtual Winesales table are counted.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-1470">The outcome of this measure is the same as in #1 before. However, you can appreciate that the generation of a virtual table is less efficient than simply placing a filter on a column. Here is yet another example of paying a heavy processing price when using a table filter inside CALCULATE (we’ve looked at this earlier when learning about the <span id="calibre_link-1471">FILTER function</span>).</p><div class="para" id="calibre_link-1472">In this measure<div class="programcode" id="calibre_link-1473"><div class="calibre4"><div class="fixedline">No. of Sales Where Cases GT 300 #3 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( Winesales ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[CASES SOLD] &gt;300 )</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-1474">there are two filter arguments inside CALCULATE. The first, <em class="emphasistypeitalic">“ALL ( Winesales )”</em>, is a CALCULATE modifier. The second, <em class="emphasistypeitalic">“FILTER ( Winesales, Winesales[CASES SOLD] &gt; 300”</em>, is a table filter. We need to understand that CALCULATE modifiers are evaluated first before any other filter arguments. Let’s take the first argument that is <em class="emphasistypeitalic">modifying</em> the filter context to remove the filters from the Winesales table. This is evaluated first and creates an empty filter because all filters&nbsp;on the Winesales table have been removed.</p><div class="para" id="calibre_link-1475">The second filter uses the FILTER function to create a <em class="emphasistypeitalic">virtual Winesales table</em>. But which rows have been filtered in the virtual Winesales table generated by FILTER? We have asked FILTER to filter to the rows where CASES SOLD is greater than 300. However, remember what we know about the FILTER function. This function filters only the rows <em class="emphasistypeitalic">in the current filter context</em>. So the table generated by FILTER still contains the rows <em class="emphasistypeitalic">for each wine</em> (e.g., only rows for “Bordeaux” in the first evaluation), and these rows are further filtered to just rows where CASES SOLD is greater than 350; see Figure <span><a href="#calibre_link-423" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">8-25</a></span>.<figure class="figure1" id="calibre_link-423"><div class="mediaobject" id="calibre_link-1476"><img alt="" src="images/000258.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 8-25</span><p class="simplepara1">The <span id="calibre_link-1477" class="calibre11">evaluation</span> of “No. of Sales Where Cases GT 300 #3”</p></div></figcaption></figure></div><div class="para" id="calibre_link-1478"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1479">The first argument uses ALL as a modifier to remove the filters from the Winesales table. This is evaluated first, and there is now an empty filter on the Winesales table.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1480">The filter argument using FILTER is now evaluated separately. The Wines dimension is cross-filtered to the Winesales fact table filtering each wine.<span id="calibre_link-1481"></span></p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-1482">The FILTER function iterates the Winesales table in the current filter context and generates a virtual table containing the rows for, for example, “Bordeaux” wine.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">4.</div><div class="itemcontent"><p class="para2" id="calibre_link-1483">It then further filters these rows so only rows containing CASES SOLD that is greater than 300 for that wine remain in the table. Because the first argument using ALL has produced an empty filter, this is the new filter in which the “No. of Sales” measure is evaluated and the rows of the virtual Winesales table are counted.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-1484">So let’s summarize what we now know about ALL. The ALL function as a <em class="emphasistypeitalic">table</em> function generates a virtual table containing all the rows from a table or all the distinct rows of a column or columns. This virtual table containing all the rows can be <em class="emphasistypeitalic">refiltered</em> by FILTER, and this will then propagate filters through the model as in measure #2 before.</p><p class="simplepara" id="calibre_link-1485">The ALL function as a modifier to CALCULATE is evaluated first before any filter arguments inside CALCULATE. ALL as a modifier <em class="emphasistypeitalic">removes</em> any filters from a table or a column and generates an empty filter. Any other filter arguments of CALCULATE are then evaluated and generate the new filter context as in measures #1 and #3 before.</p><p class="simplepara" id="calibre_link-1486">Because ALL has a different behavior when used as a top-level argument to CALCULATE, users believed it should have a different name when used in this context. As a result, in 2019, a new function was introduced into the DAX Function Library, REMOVEFILTERS. This function is synonymous with ALL, but it can be used only as a CALCULATE modifier and not as a table expression like ALL.</p><p class="simplepara" id="calibre_link-1487">In this chapter we have explored the ALL, ALLEXCEPT and ALLSELECTED functions that are challenging functions with which to get to grips. Regardless of how long you’ve been using DAX, the examples described here will always be problematic to understand, but it’s only by thinking through the evaluation of these measures, paying close attention to the details, can we come to truly understand how DAX works.</p><p class="simplepara" id="calibre_link-1488">Having covered ALL&nbsp;and its variations, we can now move on to look at a group of functions called time intelligence functions where paradoxically, the ALL function has mostly been made redundant.</p></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-424" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-410" role="doc-footnote"><p class="para3" id="calibre_link-1489">For information on constructing Matrix visuals, visit <span><a href="https://www.burningsuit.co.uk/7-secrets-of-the-matrix-visual/" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://www.burningsuit.co.uk/7-secrets-of-the-matrix-visual/</span></span></a></span></p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-125">
<div id="calibre_link-1490" class="calibre2">
<div id="calibre_link-1491" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-1492"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_9" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_9</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">9.&nbsp;Calculations on Dates: Using DAX Time Intelligence</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-442" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-442"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-1493">Have you ever wanted to compare sales for the current month against sales for last month? Or perhaps something a little more ambitious, such as cumulative totals or even a rolling monthly average? If the answer is yes, and why wouldn’t it be, calculations using date data such as these require the use of a group of DAX functions called “time intelligence” functions. Exploring these functions will be the focus of this chapter, and you will learn how to design expressions to enable you to evaluate data across different granularities of time such as financial years, quarters, months, and even down to the day grain. In doing so, you will be able to compare and contrast calculations over those periods to build insights into the data that’s important to you, <span id="calibre_link-1494"></span>such as trends and patterns over time.</p><div class="formalpara" id="calibre_link-1495"><div class="heading1">Note</div><p class="para6" id="calibre_link-1496">The term “time intelligence” is a little misleading. These are not <em class="emphasistypeitalic">time</em> intelligence functions but <em class="emphasistypeitalic">date</em> intelligence functions, so these functions will not help you with calculations on hours, minutes, or seconds, although we can do these calculations with the help of a Time dimension.</p></div><p class="simplepara" id="calibre_link-1497">The starting point to using time intelligence functions is the creation of a date dimension. This is because most time intelligence functions are designed to work with a date table as an integral part of the data model. You may feel your data model doesn’t require a date dimension, but you’ll struggle to create the date-based calculations you need, and you certainly won’t be able to reap the benefits of time intelligence measures.</p><p class="simplepara" id="calibre_link-1498">However, people new to DAX often don’t appreciate this aspect of date calculations and therefore don’t have a date dimension in their model. If this is the case, Power BI will help you with your date analysis by generating built-in date hierarchies, and this is what we will explore first.</p><section class="section" id="calibre_link-191"><h2 class="booksubtitle">Power BI Date Hierarchies</h2><div class="calibre4" id="calibre_link-1499">In the absence of a date dimension in your model, if you have columns of a date data type in any tables, for every one of these columns, Power BI will generate an in-memory date table for you that also contains a date hierarchy. We have removed the DateTable dimension from our data model, and so the SALE DATE column is now expressed as a date <span id="calibre_link-1500">hierarchy</span> as shown in Figure <span><a href="#calibre_link-443" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-1</a></span>.<figure class="figure1" id="calibre_link-443"><div class="mediaobject" id="calibre_link-1501"><img alt="" src="images/000118.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-1</span><p class="simplepara1">A date type column with a date hierarchy generated by Power BI</p></div></figcaption></figure></div><div class="para" id="calibre_link-1502">This feature is called “Auto date/time,” but you can turn off this behavior either globally or only for the current file in the <strong class="emphasistypebold">Options</strong> pane shown in Figure <span><a href="#calibre_link-444" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-2</a></span>.<figure class="figure1" id="calibre_link-444"><div class="mediaobject" id="calibre_link-1503"><img alt="" src="images/000050.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-2</span><p class="simplepara1">You can turn off the generation of a date hierarchy using the <span id="calibre_link-1504" class="calibre11">Options pane</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-1505">If you have the “Auto date/time” feature turned on and you don’t have a date dimension in your model, any fields of a date data type will be structured into hierarchies. These built-in date hierarchies are useful for drilling into different date granularities when put into Power BI visuals and also make it possible to slice by year, quarter, month, and day. For example, in Figure <span><a href="#calibre_link-445" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-3</a></span>, we are using the SALE DATE hierarchy to drill into Month granularity in a Power BI line chart and slice by year.<figure class="figure1" id="calibre_link-445"><div class="mediaobject" id="calibre_link-1506"><img alt="" src="images/000245.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-3</span><p class="simplepara1">Using the <span id="calibre_link-1507" class="calibre11">built-in</span> date hierarchy to visualize date data</p></div></figcaption></figure></div><div class="para" id="calibre_link-1508">However, there are a number of drawbacks to using these hierarchies:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-1509">What if your financial year doesn’t start in January?</p></li><li class="calibre9"><p class="para2" id="calibre_link-1510">What if you want to analyze sales by week granularity? How would you add week numbers?</p></li><li class="calibre9"><p class="para2" id="calibre_link-1511">What if you want to compare sales in 2020 with sales in 2021 in a clustered column chart?</p></li></ul></div></div><p class="simplepara" id="calibre_link-1512">All the preceding problems present a real challenge if you’re using built-in date hierarchies, but if you have a date table dimension in your model, life becomes a lot easier as far as date calculations go. Therefore, the first step is generating your date dimension table and integrating it into your data model.</p></section><section class="section" id="calibre_link-192"><h2 class="booksubtitle">Creating a Date Table</h2><p class="simplepara" id="calibre_link-1513">To generate your date <span id="calibre_link-1514">table</span>, you can use DAX or Power Query as explained comprehensively in these two links:</p><p class="simplepara" id="calibre_link-1515"><span><a href="http://www.sqlbi.com/articles/creating-a-simple-date-table-in-dax/" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">www.sqlbi.com/articles/creating-a-simple-date-table-in-dax/</span></span></a></span></p><p class="simplepara" id="calibre_link-1516"><span><a href="https://exceleratorbi.com.au/build-reusable-calendar-table-power-query/" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://exceleratorbi.com.au/build-reusable-calendar-table-power-query/</span></span></a></span></p><p class="simplepara" id="calibre_link-1517">Failing these two suggestions, you could use Excel to create a date table.</p><p class="simplepara" id="calibre_link-1518">The only mandatory column in a date table is a column containing a list of sequential dates that includes <em class="emphasistypeitalic">all the dates</em> that cover the time span of your data. For example, our wine sales begin in January 2017 and end in December 2021; therefore, our date table has a DATEKEY column with values starting on January 1, 2017, and ending on December 31, 2021 (the end of our financial year). You must include all the dates in these years even if there is no data for specific dates. The other columns in the date table are used to group and categorize these dates and are completely arbitrary. However, it would be normal to have columns for your financial year and quarters and columns for months, including month name and month number. You could also include different financial years and week numbers. To analyze by months, you need to include both month name <em class="emphasistypeitalic">and</em> month number. This is so you can sort the month names correctly, and some measures will require referencing both month name and number.</p><div class="para" id="calibre_link-1519">We’ve now replaced our DateTable back into our data model. You can see the DateTable is related to the fact table using the SALE DATE and the DATEKEY columns as shown in Figure <span><a href="#calibre_link-446" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-4</a></span>.<figure class="figure1" id="calibre_link-446"><div class="mediaobject" id="calibre_link-1520"><img alt="" src="images/000104.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-4</span><p class="simplepara1">The DateTable is related to the Winesales fact table using the <span id="calibre_link-1521" class="calibre11">DATEKEY column</span></p></div></figcaption></figure></div><div class="formalpara" id="calibre_link-1522"><div class="heading1">Note</div><p class="para6" id="calibre_link-1523">It’s usual to use the column in your date table that contains the list of unique dates as the linking field or primary key, but it would be possible to use some other unique field in the date table as the linking field. However, you must always have a column containing a list of sequential dates in your date table even if you don’t use this field to link to the fact table.</p></div><div class="calibre4" id="calibre_link-1524">The next requirement regarding the date table is to ensure the model “knows” this is your date dimension. This is particularly true if you haven’t used the field containing the list of unique dates as the primary key of the date table. You do this by marking the date dimension as a date table by selecting <strong class="emphasistypebold">Mark as date table</strong> from the <strong class="emphasistypebold">Table Tools</strong> <span id="calibre_link-1525">tab</span>. Now, in the “Date column” drop-down, select the column in your date table that contains the list of unique dates, as shown in Figure <span><a href="#calibre_link-447" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-5</a></span>.<figure class="figure1" id="calibre_link-447"><div class="mediaobject" id="calibre_link-1526"><img alt="" src="images/000167.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-5</span><p class="simplepara1">Use the Mark as date table option to ensure the integrity of the date dimension</p></div></figcaption></figure></div><div class="formalpara" id="calibre_link-1527"><div class="heading1">Note</div><p class="para6" id="calibre_link-1528">You will find more information on the requirement to “Mark as date table” here: <span><a href="https://www.sqlbi.com/articles/mark-as-date-table/" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre"><span><em class="emphasistypeitalic1">https://www.sqlbi.com/articles/mark-as-date-table/</em></span></a></span></p></div><div class="calibre4" id="calibre_link-1529">The final step in the setup of the data dimension is to sort the month names correctly. You can see in Figure <span><a href="#calibre_link-448" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-6</a></span> that we’ve used the <strong class="emphasistypebold">Sort by column</strong> button on the <strong class="emphasistypebold">Column Tools</strong> tab to sort the Month by the Month No.<figure class="figure1" id="calibre_link-448"><div class="mediaobject" id="calibre_link-1530"><img alt="" src="images/000010.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-6</span><p class="simplepara1">Use the Sort by <span id="calibre_link-1531" class="calibre11">column option</span> to sort the month names</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1532">Now that we have generated our date dimension, we can reap the benefits of using the time intelligence functions inside DAX and analyze our data across years, quarters, months, and days in many insightful ways.</p></section><section class="section" id="calibre_link-193"><h2 class="booksubtitle">Using Time Intelligence Functions</h2><div class="calibre4" id="calibre_link-1533">Time intelligence functions use a <em class="emphasistypeitalic">base date</em> from which to perform the required calculation. This base date is supplied by the current filter context. For example, the terms “previous month” and “same period last year” are relative terms, relative, that is, to the date that is in the current filter context. Therefore, with most of these functions, you must have a specific date filtered (a year, a quarter, a month, or a day) either by using <span id="calibre_link-1534">slicers</span>, by using the Filters pane, or by having dates in the visual. For example, if you want to find the previous month’s sales, you must have a current month filtered in the visual or in a slicer; see Figure <span><a href="#calibre_link-449" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-7</a></span>.<figure class="figure1" id="calibre_link-449"><div class="mediaobject" id="calibre_link-1535"><img alt="" src="images/000025.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-7</span><p class="simplepara1">The “<span id="calibre_link-1536" class="calibre11">base date</span>” is supplied by the filter context which can be through columns in the visual or by year and month slicers</p></div></figcaption></figure></div><div class="para" id="calibre_link-1537">All time intelligence functions (except LASTNONBLANK and LASTNONBLANKVALUE) have an argument that requires specifying a column of dates to be used in the calculation. In most cases, in this argument, you supply the name of the column in your date table that holds the list of unique dates, for example, the DATEKEY column in our data; see Figure <span><a href="#calibre_link-450" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-8</a></span>.<figure class="figure1" id="calibre_link-450"><div class="mediaobject" id="calibre_link-1538"><img alt="" src="images/000219.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-8</span><p class="simplepara1">The “Dates” argument normally requires referencing the column that holds the list of <span id="calibre_link-1539" class="calibre11">unique dates</span></p></div></figcaption></figure></div><div class="formalpara" id="calibre_link-1540"><div class="heading1">Note</div><p class="para6" id="calibre_link-1541">There is an exception to this. In the LASTDATE and FIRSTDATE functions, you may need to reference the date column in your fact table.</p></div><p class="simplepara" id="calibre_link-1542">For every DAX expression you construct using time intelligence functions, you could author an equivalent expression using standard DAX functions such as CALCULATE, FILTER, MAX, and MIN. However, if this were the case, there is one function you would also need, and that’s the ALL function. For example, to find dates in May when the current filter context is filtering dates in June, you would have to use the ALL function to remove the current filter on June in the date table so that it could be refiltered for the dates in May. By using time intelligence functions and referencing the “Dates” column of the date table, the work of the ALL function is implicit. That’s why when using time intelligence functions, you don’t need to remove filters by using ALL and then reapply your specific filter.</p><div class="para" id="calibre_link-1543">The time intelligence functions we’re going to explore in this chapter are outlined in Table <span><a href="#calibre_link-451" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-1</a></span>. The return value is typically a virtual table containing a single column of dates. The dates returned into this column are also shown in Table <span><a href="#calibre_link-451" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-1</a></span>.<div class="table" id="calibre_link-451"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 9-1</span><p class="para6">Time intelligence functions and their <span id="calibre_link-1544">return value</span></p></div></div><table class="calibre12"><colgroup class="calibre13"><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre14"><tr class="calibre15"><th class="calibre16"><p class="simplepara2">Function</p></th><th class="calibre16"><p class="simplepara2">Dates Returned</p></th></tr></thead><tbody class="calibre17"><tr class="calibre15"><td class="calibre18"><p class="simplepara2">PREVIOUSMONTH</p></td><td class="calibre18"><p class="simplepara2">The previous month from the month in the current filter context.</p></td></tr><tr class="calibre19"><td class="calibre18"><p class="simplepara2">SAMEPERIODLASTYEAR</p></td><td class="calibre18"><p class="simplepara2">The same period last year from the month in the current filter context.</p></td></tr><tr class="calibre15"><td class="calibre18"><p class="simplepara2">DATEADD</p></td><td class="calibre18"><p class="simplepara2">Prior (or future) years, quarters, months, or days from the current filter context.</p></td></tr><tr class="calibre19"><td class="calibre18"><p class="simplepara2">DATESYTD</p></td><td class="calibre18"><p class="simplepara2">The year up to the date in the current filter context.</p></td></tr><tr class="calibre15"><td class="calibre18"><p class="simplepara2">DATESBETWEEN</p></td><td class="calibre18"><p class="simplepara2">Between two dates.</p></td></tr><tr class="calibre19"><td class="calibre18"><p class="simplepara2">DATESINPERIOD</p></td><td class="calibre18"><p class="simplepara2">Starting with a date and then going back (or forward) by any number of years, quarters, months, or days from the current filter context.</p></td></tr><tr class="calibre15"><td class="calibre18"><p class="simplepara2">LASTDATE</p></td><td class="calibre18"><p class="simplepara2">The last date in the current filter context.</p></td></tr><tr class="calibre19"><td class="calibre18"><p class="simplepara2">LASTNONBLANK</p></td><td class="calibre18"><p class="simplepara2">The last date in a column where the expression is nonblank in the current filter context.</p></td></tr><tr class="calibre15"><td class="calibre18"><p class="simplepara2">LASTNONBLANKVALUE</p></td><td class="calibre18"><p class="simplepara2">The last value in a column where the expression is nonblank in the current filter context.</p></td></tr></tbody></table></div></div><p class="simplepara" id="calibre_link-1545">Typically, time intelligence functions generate a virtual one-column table containing filtered dates from the DATEKEY column in the date dimension (or whatever you’ve named this column). This virtual table is used as a table filter inside CALCULATE to filter the dates in the fact table.</p><div class="para" id="calibre_link-1546">However, DAX time intelligence functions either can be <em class="emphasistypeitalic">table</em> functions that are nested inside CALCULATE as the filter argument or can return <em class="emphasistypeitalic">scalar</em> values. The reason for this is that if a table function returns a one-column, one-row table, this virtual table is converted into a <span id="calibre_link-1547">scalar value</span> by the DAX engine; see Table <span><a href="#calibre_link-452" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-2</a></span>.<div class="table" id="calibre_link-452"><div class="bookauthors" lang="en"><div class="captioncontent"><span class="captionnumber">Table 9-2</span><p class="para6">Showing “Table” or “Scalar” functions, or both</p></div></div><table class="calibre12"><colgroup class="calibre13"><col class="tcol"></col><col class="tcol"></col><col class="tcol"></col></colgroup><thead class="calibre14"><tr class="calibre15"><th class="calibre16"><p class="simplepara2">Table</p></th><th class="calibre16"><p class="simplepara2">Table or Scalar</p></th><th class="calibre16"><p class="simplepara2">Scalar</p></th></tr></thead><tbody class="calibre17"><tr class="calibre15"><td class="calibre18"><p class="simplepara2">DATEADD</p><p class="simplepara2">DATESBETWEEN</p><p class="simplepara2">DATESINPERIOD</p><p class="simplepara2">DATESYTD</p><p class="simplepara2">PREVIOUSMONTH</p><p class="simplepara2">SAMEPERIODLASTYEAR</p></td><td class="calibre18"><p class="simplepara2">LASTDATE</p><p class="simplepara2">LASTNONBLANK</p></td><td class="calibre18"><p class="simplepara2">LASTNONBLANKVALUE</p></td></tr></tbody></table></div></div><p class="simplepara" id="calibre_link-1548">For example, it would be possible to use <span id="calibre_link-1549">LASTDATE</span> as follows:</p><div class="para" id="calibre_link-1550">Used as a scalar<div class="programcode" id="calibre_link-1551"><div class="calibre4"><div class="fixedline">LastDate Example #1 =</div><div class="fixedline">LASTDATE(Winesales[SALE DATE])</div></div></div></div><div class="para" id="calibre_link-1552">Used as a table filter inside CALCULATE<div class="programcode" id="calibre_link-1553"><div class="calibre4"><div class="fixedline">LastDate Example #2 =</div><div class="fixedline">CALCULATE([Total Sales],LASTDATE(Winesales[SALE DATE]))</div></div></div></div><div class="para" id="calibre_link-1554">Used to return a scalar inside CALCULATE<div class="programcode" id="calibre_link-1555"><div class="calibre4"><div class="fixedline">LastDate Example #3 =</div><div class="fixedline">CALCULATE(LASTDATE(Winesales[SALE DATE]),DateTable[YEAR]=2020)</div></div></div></div><p class="simplepara" id="calibre_link-1556">Let’s now analyze our total cases values across different time frames. You can see the results of the following expressions in Figure <span><a href="#calibre_link-453" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-9</a></span>. Note the use of slicers to filter the base date of <strong class="emphasistypebold">December 2021</strong> from which the expressions are calculated.</p><section class="section" id="calibre_link-194"><h3 class="booksubtitle">Previous Month/Year &ndash; PREVIOUSMONTH/YEAR</h3><div class="calibre4" id="calibre_link-1557"><span id="calibre_link-1558"></span>These are the DAX expressions to calculate the previous month’s or year’s values, respectively:<div class="programcode" id="calibre_link-1559"><div class="calibre4"><div class="fixedline">Previous Month Total Cases =</div><div class="fixedline">CALCULATE ( [Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;PREVIOUSMONTH ( DateTable[DATEKEY] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1560"><div class="programcode" id="calibre_link-1561"><div class="calibre4"><div class="fixedline">Previous Year Total Cases =</div><div class="fixedline">CALCULATE ( [Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;PREVIOUSYEAR ( DateTable[DATEKEY] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1562">The PREVIOUSYEAR function assumes that your financial year ends on December 31. If you use a different financial year, you can use the second argument of this function to define your year-end date. To avoid any date locale issues, use the date format “YYYY-MM-DD” (the function ignores the year, so use any year value); for example, if your year-end date is the March 31st, this would be your measure:<div class="programcode" id="calibre_link-1563"><div class="calibre4"><div class="fixedline">Year To Date Cases =</div><div class="fixedline">CALCULATE ( [Total Cases] ,</div><div class="fixedline">PREVIOUSYEAR ( DateTable[DATEKEY], "2021-03-31"</div><div class="fixedline">&nbsp;)</div><div class="fixedline">)</div></div></div></div></section><section class="section" id="calibre_link-195"><h3 class="booksubtitle">Same Period Last Year &ndash; <span id="calibre_link-1564">SAMEPERIODLASTYEAR</span></h3><div class="calibre4" id="calibre_link-1565">This is the DAX expression to calculate values in the same period in the previous year:<div class="programcode" id="calibre_link-1566"><div class="calibre4"><div class="fixedline">Same Period Last Year Cases =</div><div class="fixedline">CALCULATE ( [Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SAMEPERIODLASTYEAR ( DateTable[DATEKEY] )</div><div class="fixedline">)</div></div></div></div></section><section class="section" id="calibre_link-196"><h3 class="booksubtitle">Values for Any Time Ago &ndash; DATEADD</h3><div class="calibre4" id="calibre_link-1567"><span id="calibre_link-1568"></span>These are the DAX expressions that calculate values for 6 months ago and 30 days ago, respectively:<div class="programcode" id="calibre_link-1569"><div class="calibre4"><div class="fixedline">6 Months Ago Cases =</div><div class="fixedline">CALCULATE ( [Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;DATEADD ( DateTable[DATEKEY], -6, MONTH )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1570"><div class="programcode" id="calibre_link-1571"><div class="calibre4"><div class="fixedline">30 Days Ago Cases =</div><div class="fixedline">CALCULATE ( [Total Cases] ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DATEADD ( DateTable[DATEKEY], -30, DAY )</div><div class="fixedline">)</div></div></div></div></section><section class="section" id="calibre_link-197"><h3 class="booksubtitle">Year to Date &ndash; DATESYTD</h3><div class="calibre4" id="calibre_link-1572">This expression will calculate year to date values for the year in the current filter context:<div class="programcode" id="calibre_link-1573"><div class="calibre4"><div class="fixedline">Year To Date Cases =</div><div class="fixedline">CALCULATE ( [Total Cases] ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DATESYTD ( DateTable[DATEKEY] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1574">The <span id="calibre_link-1575">DATESYTD function</span>, like PREVIOUSYEAR, assumes that your financial year ends in December, and just like PREVIOUSYEAR, you can use the second argument of this function to define your year-end date, using the format “YYYY-MM-DD” to avoid date locale issues, as follows:<div class="programcode" id="calibre_link-1576"><div class="calibre4"><div class="fixedline">Year To Date Cases =</div><div class="fixedline">CALCULATE ( [Total Cases] ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DATESYTD ( DateTable[DATEKEY], "2021-03-31")</div><div class="fixedline">)</div></div></div><figure class="figure1" id="calibre_link-453"><div class="mediaobject" id="calibre_link-1577"><img alt="" src="images/000097.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-9</span><p class="simplepara1">Time intelligence calculations</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1578">With the help of the time intelligence functions, these expressions have all been straightforward to write. Let’s now move forward and explore some more complex calculations.</p></section><section class="section" id="calibre_link-198"><h3 class="booksubtitle">Total to Date or Cumulative Totals</h3><div class="calibre4" id="calibre_link-1579">The DAX measure for calculating total to date or a cumulative <span id="calibre_link-1580">total</span> for the “Total Sales” measure is as follows (see Figure <span><a href="#calibre_link-394" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-10</a></span>):<div class="programcode" id="calibre_link-1581"><div class="calibre4"><div class="fixedline">Cumulative Total =</div><div class="fixedline">CALCULATE ( [Total Sales] ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DATESBETWEEN ( DateTable[DATEKEY], 0 ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LASTDATE ( DateTable[DATEKEY] )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div></div><figure class="figure1" id="calibre_link-394"><div class="mediaobject" id="calibre_link-1582"><img alt="" src="images/000192.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-10</span><p class="simplepara1">The cumulative total sales</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1583">This expression uses the DATESBETWEEN function that returns a table of dates that fall between a start date and an end date.</p><p class="simplepara" id="calibre_link-1584">Notice that the start date for the DATESBETWEEN function is zero, which means the start date will be the earliest value in the dates column, or you could use the BLANK() function (we will look at this function in the following chapter). The end date is found by the LASTDATE function, which finds the last date in the current filter context. This will be the last date of the month sitting in any row of the Table visual or the last date of a month filtered in a slicer or Filters pane.</p></section><section class="section" id="calibre_link-199"><h3 class="booksubtitle">Rolling Annual Totals and Averages</h3><div class="calibre4" id="calibre_link-1585">To calculate rolling <span id="calibre_link-1586">annual totals and averages</span>, you must use two functions: DATESINPERIOD and LASTDATE. Let’s do the rolling annual total first:<div class="programcode" id="calibre_link-1587"><div class="calibre4"><div class="fixedline">Rolling Annual Total Sales =</div><div class="fixedline">CALCULATE ( [Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DATESINPERIOD ( DateTable[DATEKEY],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LASTDATE ( DateTable[DATEKEY] ) , -1 , YEAR ) )</div></div></div></div><p class="simplepara" id="calibre_link-1588">The LASTDATE function in this measure finds the last date in the current filter context (i.e., the last date of the month sitting in any row of the Table visual, in a slicer, or in the Filters pane). The <span id="calibre_link-1589">DATESINPERIOD function</span> calculates the total sales, starting with this last date and going back by 1 year.</p><div class="para" id="calibre_link-1590">Now for the rolling annual average:<div class="programcode" id="calibre_link-1591"><div class="calibre4"><div class="fixedline">Rolling Annual Average Total Sales =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales] / COUNTROWS ( VALUES ( DateTable[MONTH] ) ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DATESINPERIOD (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateTable[DATEKEY],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LASTDATE ( DateTable[DATEKEY] ),&nbsp;&nbsp;-1,&nbsp;&nbsp;YEAR</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1592">The expression for the rolling annual average does much the same as the expression for the rolling annual total. However, we need to find the average monthly total for each rolling year. If we divided the “Total Sales” measure by 12, this would not be correct for the <em class="emphasistypeitalic">first year</em> because in January, only one month is rolling; in February, only two months are rolling; in March, only three months; etc. This is why we need to use the COUNTROWS and VALUES functions to calculate the correct number of rolling months for the denominator and not simply divide by 12. The results of these measures are shown in Figure <span><a href="#calibre_link-454" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-11</a></span>.<figure class="figure1" id="calibre_link-454"><div class="mediaobject" id="calibre_link-1593"><img alt="" src="images/000143.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-11</span><p class="simplepara1">The rolling annual and average sales</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1594">We will meet the <span id="calibre_link-1595">VALUES function</span> later in this book, so at this stage, suffice to say that this function generates a virtual table containing only the values in the MONTH column of the date dimension that are visible in the filter context generated by the DATESINPERIOD expression. The COUNTROWS function counts the rows in the virtual table, giving us the correct number of cumulative months in the first year of our data.</p></section><section class="section" id="calibre_link-200"><h3 class="booksubtitle">Calculating the Last Transaction Date and the Last Transaction Value</h3><div class="calibre4" id="calibre_link-1596">If you want to find the first or last date for which there is data, for example, the last date for which there is a value for the “Total Sales” measure, you can use the functions FIRSTNONBLANK and <span id="calibre_link-1597">LASTNONBLANK</span> as follows:<div class="programcode" id="calibre_link-1598"><div class="calibre4"><div class="fixedline">Date of Last Transaction =</div><div class="fixedline">LASTNONBLANK ( DateTable[DATEKEY], [Total Sales] )</div></div></div></div><div class="para" id="calibre_link-1599"><div class="programcode" id="calibre_link-1600"><div class="calibre4"><div class="fixedline">Date of First Transaction =</div><div class="fixedline">FIRSTNONBLANK ( DateTable[DATEKEY], [Total Sales] )</div></div></div></div><div class="para" id="calibre_link-1601">You could then find the value of the total sales on these dates by using LASTNONBLANKVALUE and FIRSTNONBLANKVALUE; see Figure <span><a href="#calibre_link-455" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-12</a></span>.<div class="programcode" id="calibre_link-1602"><div class="calibre4"><div class="fixedline">Value of First Transaction =</div><div class="fixedline">FIRSTNONBLANKVALUE ( DateTable[DATEKEY], [Total Sales] )</div></div></div><figure class="figure1" id="calibre_link-455"><div class="mediaobject" id="calibre_link-1603"><img alt="" src="images/000081.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-12</span><p class="simplepara1">Calculating first and last transaction dates and values</p></div></figcaption></figure></div><div class="para" id="calibre_link-1604"><div class="programcode" id="calibre_link-1605"><div class="calibre4"><div class="fixedline">Value of Last Transaction =</div><div class="fixedline">LASTNONBLANKVALUE ( DateTable[DATEKEY], [Total Sales] )</div></div></div></div><div class="para" id="calibre_link-1606">The functions LASTNONBLANK and LASTNONBLANKVALUE can be used in more creative ways. Perhaps you need to calculate the date of the previous transaction, and perhaps you would like to find the difference in sales values between consecutive sales, as shown in Figure <span><a href="#calibre_link-456" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-13</a></span>.<figure class="figure1" id="calibre_link-456"><div class="mediaobject" id="calibre_link-1607"><img alt="" src="images/000032.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-13</span><p class="simplepara1">Calculating the difference in values between <span id="calibre_link-1608" class="calibre11">consecutive transactions</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-1609">These are the expressions used to accomplish these tasks:<div class="programcode" id="calibre_link-1610"><div class="calibre4"><div class="fixedline">Previous Sales Date =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LASTNONBLANK ( DateTable[DATEKEY],[Total Sales] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateTable[DATEKEY] &lt; MAX (DateTable[DATEKEY] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1611"><div class="programcode" id="calibre_link-1612"><div class="calibre4"><div class="fixedline">Previous Sales Value =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;LASTNONBLANKVALUE ( DateTable[DATEKEY], [Total Sales] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DateTable[DATEKEY] &lt; MAX ( DateTable[DATEKEY] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1613"><div class="programcode" id="calibre_link-1614"><div class="calibre4"><div class="fixedline">Sales Difference =</div><div class="fixedline">[Total Sales] - [Previous Sales Value]</div></div></div></div><p class="simplepara" id="calibre_link-1615">Because we are using the DATEKEY column from the date dimension in the Table visual in Figure <span><a href="#calibre_link-456" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-13</a></span>, the expressions using LASTNONBLANK and LASTNONBLANKVALUE will be evaluated for <em class="emphasistypeitalic">every</em> date in this column, regardless of whether each date has a transaction in the Winesales table. When you then populate the “Total Sales” measure into the Table visual, you will see blank values for dates where there are no transactions. To resolve this, use a visual-level filter and filter the “Total Sales” measure to exclude blank values.</p><div class="para" id="calibre_link-1616">The important factor in the evaluation of these expressions is the use of CALCULATE to modify the filter context in which the LASTNONBLANK and LASTNONBLANKVALUE are evaluated. The expression “<em class="emphasistypeitalic">MAX (DateTable[DATEKEY])”</em> returns the date value in the current filter context, for example, <strong class="emphasistypebold">7 January 2017</strong>; see Figure <span><a href="#calibre_link-457" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-14</a></span>. The MAX function is used to return a scalar value. As there is only a single date in the current filter context, we could equally use MIN or SUM. The filter argument of CALCULATE therefore is saying “find the date in the DATEKEY column of the DateTable that is before the date returned by ‘MAX (DateTable[DATEKEY])’ but only if it has a sales value and is not blank<em class="emphasistypeitalic">.</em>” The LASTNONBLANK function returns this date, that is, <strong class="emphasistypebold">3 January 2017</strong>. The LASTNONBLANKVALUE function returns the sales value associated with this date, <strong class="emphasistypebold">$10,560</strong>.<figure class="figure1" id="calibre_link-457"><div class="mediaobject" id="calibre_link-1617"><img alt="" src="images/000073.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-14</span><p class="simplepara1">Focusing on an evaluation of the LASTNONBLANK and LASTNONBLANKVALUE <span id="calibre_link-1618" class="calibre11">expressions</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1619">We can then simply subtract the “Previous Sales Value” measure from the “Total Sales” measure.</p></section><section class="section" id="calibre_link-201"><h3 class="booksubtitle">Finding the Difference Between Two Dates</h3><div class="calibre4" id="calibre_link-1620">Finding the <span id="calibre_link-1621">difference</span> in days between two dates in DAX can be done in a similar way to Excel; simply subtract one date from another. However, in DAX, you must nest the dates in the INT function to return a value in days as opposed to returning a date:<div class="programcode" id="calibre_link-1622"><div class="calibre4"><div class="fixedline">Days Difference =</div><div class="fixedline">INT ( [Date of Last Transaction] ) - INT ( [Date of First Transaction] )</div></div></div></div><div class="para" id="calibre_link-1623">DAX also has the same function DATEDIFF that we use in Excel to find the difference between weeks, months, years, etc. (see Figure <span><a href="#calibre_link-458" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">9-15</a></span>).<div class="programcode" id="calibre_link-1624"><div class="calibre4"><div class="fixedline">Months Difference =</div><div class="fixedline">DATEDIFF ( [Date of First Transaction], [Date of Last Transaction], MONTH )</div></div></div><figure class="figure1" id="calibre_link-458"><div class="mediaobject" id="calibre_link-1625"><img alt="" src="images/000057.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 9-15</span><p class="simplepara1">Calculating days between and months between two dates</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1626">Hopefully, our foray into some of the more ubiquitous DAX time intelligence functions has whetted your appetite for performing calculations on dates. There are of course a number of other time intelligence functions that we haven’t explored here but that you might find useful in the analysis of your data, so why not self-explore more of these valuable DAX functions. You will find them all here:</p><p class="simplepara" id="calibre_link-1627"><span><a href="https://docs.microsoft.com/en-us/dax/time-intelligence-functions-dax" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://docs.microsoft.com/en-us/dax/time-intelligence-functions-dax</span></span></a></span></p></section></section></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-33">
<div id="calibre_link-1628" class="calibre2">
<div id="calibre_link-1629" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-1630"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_10" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_10</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">10.&nbsp;Empty Values vs. Zero</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-34" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-34"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-1631">In this chapter, we will look at a very specific DAX behavior, and that is how DAX treats <span id="calibre_link-1632">empty</span>, missing, and null values.<sup class="calibre7"><a type="noteref" href="#calibre_link-35" id="calibre_link-43" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup></p><div class="formalpara" id="calibre_link-1633"><div class="heading1">Note</div><p class="para6" id="calibre_link-1634">We will be examining this behavior in the context of a <em class="emphasistypeitalic">calculated column</em> and mostly creating expressions that would only be valid in this context. However, you must appreciate that the behavior of empty, missing, and null values is exactly the same in the context of DAX <em class="emphasistypeitalic">measures,</em> and the examples at the end of this chapter will illustrate this.</p></div><section class="section" id="calibre_link-202"><h2 class="booksubtitle">The BLANK( ) Function</h2><div class="calibre4" id="calibre_link-1635">In DAX, there is a special way to identify null or empty values, and that’s by using a value called “blank.” To return blank values, we can use the <span id="calibre_link-1636">BLANK() function</span><span id="calibre_link-1637"></span> as shown in a calculated column created in the Winesales table (Figure <span><a href="#calibre_link-36" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">10-1</a></span>):<div class="programcode" id="calibre_link-1638"><div class="calibre4"><div class="fixedline">10 Percent =</div><div class="fixedline">IF ( Winesales[CASES SOLD] &gt; 100,</div><div class="fixedline">Winesales[CASES SOLD] * 0.1, BLANK () )</div></div></div><figure class="figure1" id="calibre_link-36"><div class="mediaobject" id="calibre_link-1639"><img alt="" src="images/000007.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 10-1</span><p class="simplepara1">Use the BLANK() function to return blank values</p></div></figcaption></figure></div><div class="para" id="calibre_link-1640">When constructing DAX expressions using IF, if you want to return BLANK() on the “Value if false” argument, you can just close off on the bracket because BLANK() is the default if no value is supplied in the argument. So we could rewrite the previous expression like this:<div class="programcode" id="calibre_link-1641"><div class="calibre4"><div class="fixedline">10 Percent =</div><div class="fixedline">IF ( Winesales[CASES SOLD] &gt; 100,</div><div class="fixedline">Winesales[CASES SOLD] * 0.1 )</div></div></div></div><p class="simplepara" id="calibre_link-1642">We can test for null or blank values as in the following calculated column:</p><div class="formalpara" id="calibre_link-1643"><div class="heading1">Note</div><p class="para6" id="calibre_link-1644">In the sample .pbix file, sort the Winesales table by SALE DATE ascending to see the blanks and zeros in the CASES SOLD column.</p></div><div class="calibre4" id="calibre_link-1645"><div class="programcode" id="calibre_link-1646"><div class="calibre4"><div class="fixedline">Blank? =</div><div class="fixedline">IF ( Winesales[CASES SOLD] = BLANK(), "Blank", "Other")</div></div></div></div><div class="para" id="calibre_link-1647">Notice that testing for BLANK() includes <strong class="emphasistypebold">0</strong> (zero), so we never get “Other” for zero (Figure <span><a href="#calibre_link-37" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">10-2</a></span>).<figure class="figure1" id="calibre_link-37"><div class="mediaobject" id="calibre_link-1648"><img alt="" src="images/000148.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 10-2</span><p class="simplepara1">Testing for a blank includes zero values</p></div></figcaption></figure></div><div class="para" id="calibre_link-1649">What’s surprising, however, is that the reverse is true, so in the following calculated column, testing for <strong class="emphasistypebold">0</strong> includes blank values, so again we don’t get “Other” for blank values (see Figure <span><a href="#calibre_link-38" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">10-3</a></span>):<div class="programcode" id="calibre_link-1650"><div class="calibre4"><div class="fixedline">Zero? =</div><div class="fixedline">IF ( Winesales[CASES SOLD] = 0, "Zero", "Other")</div></div></div><figure class="figure1" id="calibre_link-38"><div class="mediaobject" id="calibre_link-1651"><img alt="" src="images/000079.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 10-3</span><p class="simplepara1">Testing for zero includes blanks</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1652">Therefore, we can see that DAX treats BLANK() and <strong class="emphasistypebold">0</strong> (zero) as the same value when used in the predicate of the IF function, as in the previous two examples.</p></section><section class="section" id="calibre_link-203"><h2 class="booksubtitle">The ISBLANK Function</h2><div class="calibre4" id="calibre_link-1653">So what if you want to distinguish between <strong class="emphasistypebold">0</strong> and blank values? You can use a DAX function that will “weed out” blanks as compared to <strong class="emphasistypebold">0</strong>. That function is ISBLANK as used in this following calculated column (Figure <span><a href="#calibre_link-39" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">10-4</a></span>):<div class="programcode" id="calibre_link-1654"><div class="calibre4"><div class="fixedline">Blank or Zero? =</div><div class="fixedline">IF (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ISBLANK ( Winesales[CASES SOLD] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Blank",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;IF ( Winesales[CASES SOLD] = 0, "Zero", "Other" )</div><div class="fixedline">)</div></div></div><figure class="figure1" id="calibre_link-39"><div class="mediaobject" id="calibre_link-1655"><img alt="" src="images/000102.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 10-4</span><p class="simplepara1">Use the <span id="calibre_link-1656" class="calibre11">ISBLANK function</span><span id="calibre_link-1657" class="calibre11"></span> to test for blanks and not zeros</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1658">Using ISBLANK, we now have “Zero” returned for zero values and “Blank” returned for blank values, and any other values return “Other”.</p></section><section class="section" id="calibre_link-204"><h2 class="booksubtitle">Testing for Zero</h2><div class="calibre4" id="calibre_link-1659">If you want to find just <strong class="emphasistypebold">0</strong>, you can use this calculated column (Figure <span><a href="#calibre_link-40" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">10-5</a></span>):<div class="programcode" id="calibre_link-1660"><div class="calibre4"><div class="fixedline">Zero? =</div><div class="fixedline">IF (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;NOT ( ISBLANK ( Winesales[CASES SOLD] ) )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; Winesales[CASES SOLD] = 0,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Zero",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Other"</div><div class="fixedline">)</div></div></div><figure class="figure1" id="calibre_link-40"><div class="mediaobject" id="calibre_link-1661"><img alt="" src="images/000030.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 10-5</span><p class="simplepara1"><span id="calibre_link-1662" class="calibre11">Testing</span> for zeros</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1663">Now, we only see “Zero” where applicable.</p></section><section class="section" id="calibre_link-205"><h2 class="booksubtitle">Using Measures to Find Blanks and Zero</h2><div class="calibre4" id="calibre_link-1664">You can also use a <span id="calibre_link-1665">measure</span> inside ISBLANK. For example, to find how many customers have <em class="emphasistypeitalic">no</em> sales, as opposed to <strong class="emphasistypebold">0</strong> (zero) sales, this would be the DAX expression:<div class="programcode" id="calibre_link-1666"><div class="calibre4"><div class="fixedline">No. of Customers with No Sales =</div><div class="fixedline">COUNTROWS ( FILTER ( Customers, ISBLANK ( [Total Sales] ) ) )</div></div></div></div><div class="para" id="calibre_link-1667">Whereas this expression would find the number of customers who had <em class="emphasistypeitalic">either</em> zero sales <em class="emphasistypeitalic">or</em> no sales:<div class="programcode" id="calibre_link-1668"><div class="calibre4"><div class="fixedline">No. of Customers with Zero or No Sales =</div><div class="fixedline">COUNTROWS ( FILTER ( Customers,&nbsp;&nbsp;[Total Sales] = 0 ) )</div></div></div></div><div class="para" id="calibre_link-1669">This expression would find the number of customers who had zero sales<strong class="emphasistypebold">:</strong><div class="programcode" id="calibre_link-1670"><div class="calibre4"><div class="fixedline">No. of Customers with Zero sales =</div><div class="fixedline">COUNTROWS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Customers, NOT ( ISBLANK ( [Total Sales] ) )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; [Total Sales] = 0 )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1671">You can see these measures used in Card visuals in Figure <span><a href="#calibre_link-41" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">10-6</a></span>. To see the customers with no sales in the Table visual, use the “Show items with no data” option.<figure class="figure1" id="calibre_link-41"><div class="mediaobject" id="calibre_link-1672"><img alt="" src="images/000055.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 10-6</span><p class="simplepara1">Customers with no sales and zero sales</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1673">We can conclude, therefore, that we must be careful using the following expression:</p><p class="para9" id="calibre_link-1674"><em class="emphasistypeitalic"><strong class="emphasistypebold">“= IF ( [expression] = 0 )”</strong></em></p><p class="para9" id="calibre_link-1675">because it will include blank values as well as zero values.</p></section><section class="section" id="calibre_link-206"><h2 class="booksubtitle">Using the COALESCE Function</h2><div class="calibre4" id="calibre_link-1676">There is often a requirement to substitute a blank value for another value, such as zero. This would be the expression that would achieve this outcome:<div class="programcode" id="calibre_link-1677"><div class="calibre4"><div class="fixedline">If Blank Return Zero =</div><div class="fixedline">If ( ISBLANK ( [Total Sales] ), 0, [Total Sales] )</div></div></div></div><div class="para" id="calibre_link-1678">However, in March 2020, a new function was introduced into the DAX library, and that was the <span id="calibre_link-1679">COALESCE function</span><span id="calibre_link-1680"></span> that provides us with a more succinct expression as in these two examples:<div class="programcode" id="calibre_link-1681"><div class="calibre4"><div class="fixedline">If Blank Return Zero =</div><div class="fixedline">COALESCE([Total Sales],0)</div></div></div></div><div class="para" id="calibre_link-1682"><div class="programcode" id="calibre_link-1683"><div class="calibre4"><div class="fixedline">If Blank Return No Sales =</div><div class="fixedline">COALESCE([Total Sales],"No Sales")</div></div></div></div><div class="para" id="calibre_link-1684">The first argument of this function is the expression where you are looking for blank values, for example, the “Total Sales” measure. The second argument is the value you want returned if the expression is blank, for example, 0 or “No Sales”, see Figure <span><a href="#calibre_link-42" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">10-7</a></span>.<figure class="figure1" id="calibre_link-42"><div class="mediaobject" id="calibre_link-1685"><img alt="" src="images/000242.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 10-7</span><p class="simplepara1">Use the COALESCE function to replace blanks with a value</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1686">In this chapter, you have learned that DAX treats blanks and zeros as the same value unless you specifically use the ISBLANK function in your expression to distinguish between these two values. This chapter has also been a welcome transgression from the hard work of learning how to analyze your data by using some of the more difficult aspects of DAX such as using ALL to calculate percentages and using time intelligence to calculate rolling averages.</p><p class="simplepara" id="calibre_link-1687">In the next chapter, we prepare ourselves for the more complex expressions to come. You must now learn how to use DAX variables in your code to facilitate authoring measures that require a more advanced knowledge of DAX.</p></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-43" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-35" role="doc-footnote"><p class="para3" id="calibre_link-1688">To follow along with the examples, use the Power BI Desktop file “2 DAX Blanks &amp; Zeros.pbix”.</p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-79">
<div id="calibre_link-1689" class="calibre2">
<div id="calibre_link-1690" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-1691"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_11" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_11</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">11.&nbsp;Using Variables: Making Our Code More Readable</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-80" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-80"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-1692">We’ve managed very well so far without the use of variables in our DAX code. Indeed, variables haven’t always been around in the DAX language. They came on board in 2015, five years after DAX was first developed. In this chapter, we will elaborate on why variables are so useful when writing DAX expressions, and once you’ve learned how to utilize them, we will be including them henceforth in our expression, where applicable.<sup class="calibre7"><a type="noteref" href="#calibre_link-81" id="calibre_link-84" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup></p><div class="para8" id="calibre_link-1693">Using variables in your DAX expressions can help you write the more complex calculations that we will begin to tackle as we move forward in this book. There are three major advantages gained by using <span id="calibre_link-1694">variables</span>:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1695">Improved performance</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1696">Improved readability</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-1697">Reduced complexity</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-1698">In this chapter, we will explore these three benefits of including variables when generating DAX code. We will also look at the immutable and constant nature of variables and when they may be a hindrance rather than a help.</p><div class="para" id="calibre_link-1699">To include variables in your code, use the keyword <em class="emphasistypeitalic">VAR</em> followed by the name of the variable and then the definition of the variable. The keyword <em class="emphasistypeitalic">RETURN</em><span id="calibre_link-1700"></span> is then used at the end of the code to return the expression to be evaluated. For example:<div class="programcode" id="calibre_link-1701"><div class="calibre4"><div class="fixedline">Example Measure =</div><div class="fixedline">VAR MyVariable = SUM (Winesales[CASES SOLD])</div><div class="fixedline">RETURN</div><div class="fixedline">MyVariable * 1.1</div></div></div></div><p class="simplepara" id="calibre_link-1702">Variable <span id="calibre_link-1703">declarations</span> are usually made at the beginning of the expression, and their value remains constant throughout the evaluation. However, you can declare variables within the expression to limit the scope.</p><div class="para" id="calibre_link-1704">Variables can be used in both measures and calculated columns to harvest the values generated by<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-1705">Expressions, for example, SUM ( Winesales[CASES SOLD] )</p></li><li class="calibre9"><p class="para2" id="calibre_link-1706">Measures, for example, [Total Cases]</p></li><li class="calibre9"><p class="para2" id="calibre_link-1707">Tables, for example, FILTER ( Winesales, Winesales[CASES SOLD] &gt;300 )</p></li><li class="calibre9"><p class="para2" id="calibre_link-1708">Values, for example, 0.1, 10, 20</p></li></ul></div></div><p class="simplepara" id="calibre_link-1709">When variables are used in <span id="calibre_link-1710">calculated columns</span>, they can also harvest values generated in columns.</p><p class="simplepara" id="calibre_link-1711">The name of the variable must not contain spaces, and you can’t use reserved words such as “date” or “min”. Also, it makes sense if the name of the variable isn’t the name of an existing table or column. Some people like to use the underscore to start the variable name.</p><section class="section" id="calibre_link-207"><h2 class="booksubtitle">Improved Performance</h2><div class="calibre4" id="calibre_link-1712">As an example of how variables can improve <span id="calibre_link-1713">performance</span>, let’s look at a measure to calculate 10% or 5% of the CASES SOLD based on the CASES SOLD value being greater than 20,000 and 15,000, respectively. This would be the expression you might author:<div class="programcode" id="calibre_link-1714"><div class="calibre4"><div class="fixedline">10 PC or 5 PC =</div><div class="fixedline">IF (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ) &gt; 20000,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ) * 0.1,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;IF (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ) &gt; 15000,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ) * 0.5,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1715">The problem with this expression, especially as far as performance goes, is that there are five repetitions of the SUM function, forcing the evaluation of these expressions five times. Also, the use of the nested IF is rather cumbersome. Using the SWITCH function in place of the nested IF is a small improvement:<div class="programcode" id="calibre_link-1716"><div class="calibre4"><div class="fixedline">10 PC or 5 PC #2 =</div><div class="fixedline">SWITCH (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;TRUE (),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ) &gt; 20000,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ) * 0.1,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ) &gt; 15000,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ) * 0.5,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] )</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-1717">This is the first time that we have met SWITCH, and its construct is as follows:</p><p class="simplepara" id="calibre_link-1718">=SWITCH ( expression, value1, result1, value2, result2 etc…else )</p><p class="simplepara" id="calibre_link-1719">Notice that inside SWITCH, the function TRUE() is used as the expression to be evaluated and then Boolean statements are listed, followed by the value to be returned if the statements are true. The final argument is the “else” expression.</p><p class="simplepara" id="calibre_link-1720">However, despite the fact that the measure using SWTICH is more compact to write, it doesn’t offer any great improvement in performance as the SUM function is still being evaluated multiple times.</p><div class="para" id="calibre_link-1721">Therefore, let us now introduce the use of a variable by using the keyword <em class="emphasistypeitalic">VAR</em> to define the variable and the keyword <em class="emphasistypeitalic">RETURN</em> to return the expression to be evaluated, as follows:<div class="programcode" id="calibre_link-1722"><div class="calibre4"><div class="fixedline">10 PC or 5 PC #3 =</div><div class="fixedline">VAR TotalCasesValue =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] )</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SWITCH (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TRUE (),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TotalCasesValue &gt; 20000, TotalCasesValue * 0.1,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TotalCasesValue &gt; 15000, TotalCasesValue * 0.5,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TotalCasesValue</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div></div></div></div><p class="simplepara" id="calibre_link-1723">In this expression, not only do we avoid repeating the SUM function, but also the total cases calculation is performed only <em class="emphasistypeitalic">once</em> when the variable is declared rather than being recalculated for every test.</p></section><section class="section" id="calibre_link-208"><h2 class="booksubtitle">Improved Readability</h2><div class="calibre4" id="calibre_link-1724">Variables can also help to clarify expressions that use nested measures or nested <span id="calibre_link-1725">expressions</span> where the <span id="calibre_link-1726">readability</span> of the expressions gets more convoluted. For example, consider the following expression that calculates growth percentage. Notice that the first variable defines a <em class="emphasistypeitalic">measure</em> and the second variable defines an <em class="emphasistypeitalic">expression.</em> The use of the variables and the RETURN statement result in the expression much simpler to understand:<div class="programcode" id="calibre_link-1727"><div class="calibre4"><div class="fixedline">Growth % =</div><div class="fixedline">VAR CurrentCases = [Total Cases]</div><div class="fixedline">VAR LastYrCases =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [Total Cases], PREVIOUSYEAR (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateTable[DateKey] ) )</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;DIVIDE ( CurrentCases - LastYrCases, LastYrCases )</div></div></div></div><div class="formalpara" id="calibre_link-1728"><div class="heading1">Note</div><p class="para6" id="calibre_link-1729">Because this measure uses the PREVIOUSYEAR function, you must have a year filtered (e.g., by using a slicer) in the visual that uses the measure.</p></div><div class="calibre4" id="calibre_link-1730">Not only can variables define measures and expressions, but they can also define tables. In Chapter <span><a href="#calibre_link-4" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>7</span></a></span>, we calculated the number of high profit wines as follows:<div class="programcode" id="calibre_link-1731"><div class="calibre4"><div class="fixedline">High-profit Wines =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [No Of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;FILTER ( Wines, Wines[PRICE PER CASE] &gt;=</div><div class="fixedline">&nbsp;&nbsp;&nbsp;Wines[COST PRICE] * 3 ))</div></div></div></div><div class="para" id="calibre_link-1732">However, we could use a variable to hold the table expression defined by the FILTER function and use that as the filter argument inside CALCULATE. Again, using the RETURN statement greatly streamlines the expression:<div class="programcode" id="calibre_link-1733"><div class="calibre4"><div class="fixedline">High-profit Wines #1 =</div><div class="fixedline">VAR TableOfWines =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Wines, Wines[PRICE PER CASE] &gt;=</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Wines[COST PRICE] * 3 )</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [No Of Sales], TableOfWines )</div></div></div></div><div class="para" id="calibre_link-1734">We can use variables in calculated columns too, for instance, within the arguments of IF:<div class="programcode" id="calibre_link-1735"><div class="calibre4"><div class="fixedline">Cases Sold Increase =</div><div class="fixedline">VAR CasesSold = Winesales[CASES SOLD]</div><div class="fixedline">VAR MyValue1 = 1.1</div><div class="fixedline">VAR MyValue2 = 1.2</div><div class="fixedline">RETURN</div><div class="fixedline">IF(CasesSold &gt; 100, CasesSold * MyValue1, CasesSold * MyValue2)</div></div></div></div><p class="simplepara" id="calibre_link-1736">We will look at further examples of how variables can help you when used in the context of the calculated column when we delve into more complex DAX expressions in later chapters.</p></section><section class="section" id="calibre_link-209"><h2 class="booksubtitle">Reduced Complexity</h2><div class="calibre4" id="calibre_link-1737">Our next example of the <span id="calibre_link-1738"></span>benefit to be reaped by using a variable is by revisiting a calculation we built when exploring the FILTER function in Chapter <span><a href="#calibre_link-4" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>7</span></a></span>. We calculated the number of sales where the value in the CASES SOLD column was above the average cases for all wines. This was the measure:<div class="programcode" id="calibre_link-1739"><div class="calibre4"><div class="fixedline">No. of Sales Where Cases is GT Avg All Wines =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE([No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER (Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] &gt;= [Avg Cases All Winesales] ) )</div></div></div></div><p class="simplepara" id="calibre_link-1740">The problem with this code is that because it nests the measure “Avg Cases All Winesales” within the expression, this measure must already exist in our model, as would any measures we use in this context. We may be required to continually locate such measures in the Fields list in order to edit or debug them, leading to frustration and annoyance.</p><div class="para" id="calibre_link-1741">The preferred expression would use two variables as follows:<div class="programcode" id="calibre_link-1742"><div class="calibre4"><div class="fixedline">No. of Sales Where Cases is GT Avg All Wines #2 =</div><div class="fixedline">VAR AvgAllWines =</div><div class="fixedline">CALCULATE( AVERAGE ( Winesales[CASES SOLD] ) ,ALL ( Winesales ) )</div><div class="fixedline">VAR FilterAvgAll =</div><div class="fixedline">FILTER ( Winesales, Winesales[CASES SOLD] &gt;= AvgAllWines )</div></div><div class="calibre4"><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;CALCULATE ( [No. of Sales], FilterAvgAll )</div></div></div></div></section><section class="section" id="calibre_link-210"><h2 class="booksubtitle">Variables As Constants</h2><div class="calibre4" id="calibre_link-1743"><span id="calibre_link-1744"></span><span id="calibre_link-1745"></span>There is one last important point to make regarding variables, and that is the term “variable” can be misleading. Perhaps if we called DAX variables “constants,” this might be a more accurate description because that’s what they really are. Consider the following expression:<div class="programcode" id="calibre_link-1746"><div class="calibre4"><div class="fixedline">Sales for Abel =</div><div class="fixedline">VAR MyAmount = [Total Sales]</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( MyAmount, SalesPeople[SALESPERSON] = "abel" )</div></div></div></div><div class="para" id="calibre_link-1747">We can see in Figure <span><a href="#calibre_link-82" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">11-1</a></span> that this expression does not return the sales amount for salesperson “Abel” but simply returns the total sales.<figure class="figure1" id="calibre_link-82"><div class="mediaobject" id="calibre_link-1748"><img alt="" src="images/000190.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 11-1</span><p class="simplepara1">Variables behave as constants and can’t be modified by CALCULATE</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1749">The reason for this is that the variable “MyAmount” is calculated where it is declared, in this case, before any other code. It then <em class="emphasistypeitalic">does not</em> and <em class="emphasistypeitalic">cannot</em> change by using CALCULATE to modify the filter. This is where we must use a measure such as “Total Sales” inside CALCULATE instead.</p><p class="simplepara" id="calibre_link-1750">However, the immutable nature of variables is also their strength. For instance, consider the scenario where you want to identify the months where you’ve had exceptionally high sales. You’ve identified exceptionally high sales as those transactions where the sales value is greater than 5% of the total sales for that month.</p><div class="para" id="calibre_link-1751">This is the code you would probably write:<div class="programcode" id="calibre_link-1752"><div class="calibre4"><div class="fixedline">No of Sales GT 5% Wrong =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales] &gt;&nbsp;&nbsp;[Total Sales] * 0.05</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1753">However, this measure does not return the correct result. The value of the “Total Sales” measure when used inside an iterator such as the FILTER function calculates the total sales for <em class="emphasistypeitalic">each</em> row in the Winesales table, not the total sales for each month. Therefore, the measure “Total Sales GT 5% Wrong” calculates the number of sales where the sales value is greater than 5% of the sales value on each row (i.e., each transaction) and so returns the number of sales; see Figure <span><a href="#calibre_link-83" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">11-2</a></span>.<figure class="figure1" id="calibre_link-83"><div class="mediaobject" id="calibre_link-1754"><img alt="" src="images/000216.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 11-2</span><p class="simplepara1">The “No of Sales GT 5% Wrong” measure returns the number of sales</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1755">This expression uses the concept of context transition that we will meet in a later chapter, but nevertheless, it’s intuitive to understand that if FILTER is iterating the Winesales table, it must be scanning the table row by row.</p><div class="para" id="calibre_link-1756">The correct expression must calculate the total sales in the current filter context, which is the total sales for each month, that has been lost by the iteration of FILTER. To reapply this filter, CALCULATE can use the filter that is placed on the Winesales table, the code for which would be a challenge even to experienced DAX users:<div class="programcode" id="calibre_link-1757"><div class="calibre4"><div class="fixedline">No of Sales GT 5% Difficult =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales] &gt; CALCULATE ( [Total Sales], Winesales ) * 0.05</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1758">This measure has been labelled as the “difficult” expression because it uses two challenging DAX concepts that we’ve yet to meet: context transition and table expansion. However, you may be relieved to know that you don’t need this advanced knowledge to arrive at the correct calculation. You can use variables instead, and this will render the expression very easy:<div class="programcode" id="calibre_link-1759"><div class="calibre4"><div class="fixedline">No of Sales GT 5% Easy =</div><div class="fixedline">VAR PerCentToFind = [Total Sales] * 0.05</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [No of Sales],</div><div class="fixedline">FILTER ( Winesales, [Total Sales] &gt; PerCentToFind ) )</div></div></div></div><p class="simplepara" id="calibre_link-1760">The “easy” expression uses a variable to calculate 5% of the “Total Sales” measure, and this is evaluated first and remains constant. This variable is then used to calculate the number of sales in each month that have a total sales value that is greater than the value stored by the variable.</p><p class="simplepara" id="calibre_link-1761">The moral of this story? Let’s just be grateful for variables!</p></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-84" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-81" role="doc-footnote"><p class="para3" id="calibre_link-1762">To follow along with the examples, use the Power BI Desktop file “1 DAX Sample Data.pbix”.</p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-109">
<div id="calibre_link-1763" class="calibre2">
<div id="calibre_link-1764" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-1765"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_12" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_12</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">12.&nbsp;Returning Values in the Current Filter</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-110" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-110"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><div class="para4" id="calibre_link-1766">There is often a requirement when designing reports to display the value or values selected in slicers or in the Filters pane. This might be to show these values in the title of a visual using conditional formatting or to show them in Card visuals, as shown in Figure <span><a href="#calibre_link-111" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-1</a></span>.<figure class="figure1" id="calibre_link-111"><div class="mediaobject" id="calibre_link-1767"><img alt="" src="images/000254.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-1</span><p class="simplepara1">Displaying the values in the <span id="calibre_link-1768" class="calibre11">current filter context</span></p></div></figcaption></figure></div><p class="para5" id="calibre_link-1769">If this is your goal, we have three DAX functions that do this job: SELECTEDVALUE, CONCATENATEX, and VALUES. In this chapter, we will be exploring the use of these functions to return filter selections. You will learn how to generate dynamic titles for your visuals that label the data filtered within them. However, this chapter will also introduce the concept of the <em class="emphasistypeitalic">parameter table</em>, a table that is unrelated to other tables in the model and used to capture values selected by the user. Such values can then be used dynamically within your calculations.</p><p class="simplepara" id="calibre_link-1770">The SELECTEDVALUE and CONCATENATEX <span id="calibre_link-1771">functions</span> fall into the category of functions that return scalar values and can return either a numeric or a text value. This is why it’s not a verity to say the measures only return scalar values, as that would imply that they can only return numeric values. Measures using either of these functions will often return a text value. The VALUES function is unusual in that it can return either a scalar value or a table, and therefore, we will hold off looking at this function until the end of the chapter.</p><p class="simplepara" id="calibre_link-1772">You’ve learned that a measure must return a <em class="emphasistypeitalic">single</em> value whether numeric or text and SELECTEDVALUE and CONCATENATEX are no exception. SELECTEDVALUE will return the value in the current filter context but only if there is <em class="emphasistypeitalic">one</em> value to return. However, sometimes, the filter context holds more than one value, when we make multiple selections in slicers for instance, so how can we return values in this scenario?</p><p class="simplepara" id="calibre_link-1773">If the requirement is to return multiple values that are in the filter context, we must use another function: CONCATENATEX. This function falls into the “X” group of iterating functions that you learned about in Chapter <span><a href="#calibre_link-95" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>5</span></a></span>. In order that a single value is returned, measures using CONCATENATEX will concatenate multiple values in the current filter context and so return a single text string.</p><p class="simplepara" id="calibre_link-1774">Therefore, we have two functions SELECTEDVALUE and CONCATENATEX, one of them being an iterator, that are very different from each other. However, they are used for the same purpose, and that is flagging up items that have been filtered out by slicer or filter selections. Let’s now look at the first of these: SELECTEDVALUE.</p><section class="section" id="calibre_link-211"><h2 class="booksubtitle">The SELECTEDVALUE Function</h2><p class="simplepara" id="calibre_link-1775">The SELECTEDVALUE function returns the value in the filter context when there’s only one value in the specified column, otherwise, it returns the alternate result. It has the following <span id="calibre_link-1776">syntax</span>:</p><p class="simplepara" id="calibre_link-1777">= SELECTEDVALUE( column name, alternate result )</p><p class="simplepara" id="calibre_link-1778">where:</p><p class="simplepara" id="calibre_link-1779"><strong class="emphasistypebold">column name</strong> is the column from which you want to find the value.</p><p class="simplepara" id="calibre_link-1780"><strong class="emphasistypebold">alternate result</strong> (optional) is the value returned when the column has been filtered to more than one distinct value or no value. When not provided, the default value is BLANK().</p><p class="simplepara" id="calibre_link-1781">Here is an example of the SELECTEDVALUE syntax:</p><p class="para9" id="calibre_link-1782"><strong class="emphasistypebold">= SELECTEDVALUE ( Wines[TYPE], “Many”)</strong></p><div class="table" id="calibre_link-1783">Before we look more closely at this function, it’s important that we recap on what we mean by “the current filter context” by considering the following measure:<div class="programcode" id="calibre_link-1784"><div class="calibre4"><div class="fixedline">Total Cases =</div><div class="fixedline">SUM ( Winesales[CASES SOLD] )</div></div></div><figure class="figure1" id="calibre_link-112"><div class="mediaobject" id="calibre_link-1785"><img alt="" src="images/000052.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-2</span><p class="simplepara1">The filters for the <span id="calibre_link-1786" class="calibre11">evaluation</span> of the “Total Cases” measure are placed on both the SALESPERSON and WINE columns</p></div></figcaption></figure></div><div class="para" id="calibre_link-1787">This visual in Figure <span><a href="#calibre_link-112" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-2</a></span> contains the “Total Cases” measure filtered by the SALESPERSON and WINE columns. For the first evaluation of <strong class="emphasistypebold">8,531</strong> cases, there is a filter on salesperson “Abel” and “Bordeaux” wine. However, it’s the filter on the WINE column from the slicer on which we will focus. If we could see the filter on the Wines dimension, it would look something like Figure <span><a href="#calibre_link-113" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-3</a></span> where the table has been filtered to one row.<figure class="figure1" id="calibre_link-113"><div class="mediaobject" id="calibre_link-1788"><img alt="" src="images/000202.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-3</span><p class="simplepara1">The <span id="calibre_link-1789" class="calibre11">slicer filters</span> just one row in the Wines dimension</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1790">We know that this filter is then propagated to the fact table along with the filter on the SalesPeople dimension, both these filters making up the current filter context.</p><div class="para" id="calibre_link-1791">Often, we have many slicers on the report canvas, and it’s not always apparent to users of the report which slicers they have clicked on. It would be beneficial if we could provide them with this information as in Figure <span><a href="#calibre_link-114" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-4</a></span>.<figure class="figure1" id="calibre_link-114"><div class="mediaobject" id="calibre_link-1792"><img alt="" src="images/000027.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-4</span><p class="simplepara1">Informing users of slicer <span id="calibre_link-1793" class="calibre11">selections</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-1794">This is where the SELECTEDVALUE function can help us. You can see in Figure <span><a href="#calibre_link-114" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-4</a></span> that the wine selected in the slicer is shown in both the title of the Table visual using conditional formatting and in the Card visual. This is the measure that we used in these examples:<div class="programcode" id="calibre_link-1795"><div class="calibre4"><div class="fixedline">Wine Selected =</div><div class="fixedline">"You have selected " &amp; SELECTEDVALUE ( Wines[WINE] )</div></div></div></div><p class="simplepara" id="calibre_link-1796">This example uses the SELECTEDVALUE function to return the value from the WINE column sitting in the current filter context. This is also the first time that we’ve used the ampersand (&amp;) in a DAX <span id="calibre_link-1797">expression</span>. Just like Excel, the ampersand is the DAX concatenate operator and is used to string parts of a DAX expression together.</p><div class="formalpara" id="calibre_link-1798"><div class="heading1">Note</div><p class="para6" id="calibre_link-1799">If you need help in using conditional formatting in the Title of a visuals, follow this link: <span><a href="https://docs.microsoft.com/en-us/power-bi/create-reports/desktop-conditional-format-visual-titles" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://docs.microsoft.com/en-us/power-bi/create-reports/desktop-conditional-format-visual-titles</span></span></a></span></p></div><div class="calibre4" id="calibre_link-1800">But what if there’s more than one value selected in the slicer? As we will see in the following, one option is to use CONCATENATEX, but there is another, much easier solution because the SELECTEDVALUE function allows you to supply an alternative result when <span id="calibre_link-1801">multiple items</span> have been selected, as shown here:<div class="programcode" id="calibre_link-1802"><div class="calibre4"><div class="fixedline">Wine Selected #2 =</div><div class="fixedline">"You have selected " &amp;</div><div class="fixedline">SELECTEDVALUE ( Wines[WINE],"multiple wines" )</div></div></div></div><div class="para" id="calibre_link-1803">However, because the “alternate result” argument of SELECTEDVALUE kicks in whether there are <em class="emphasistypeitalic">multiple</em> selections or <em class="emphasistypeitalic">no</em> selection, we have a problem. You’ll notice that if you have nothing selected in the slicer, the Table visual title and Card visual will still tell you that you have multiple wines selected (Figure <span><a href="#calibre_link-115" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-5</a></span>)!<figure class="figure1" id="calibre_link-115"><div class="mediaobject" id="calibre_link-1804"><img alt="" src="images/000043.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-5</span><p class="simplepara1">The “alternate <span id="calibre_link-1805" class="calibre11">result</span>” shows for no selection as well as for many selected</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1806">One way to avoid this problem is to ensure users can’t make multiple selections or no selection by turning on “Single select” on the Slicer settings formatting card. The other way is to use CONTCATENATEX as we will be discovering later in this chapter.</p><div class="para" id="calibre_link-1807">The SELECTEDVALUE function also allows you to test for specific values in the <span id="calibre_link-1808">current filter</span>. In Figure <span><a href="#calibre_link-116" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-6</a></span>, the Card visual<sup class="calibre10"><a type="noteref" href="#calibre_link-117" id="calibre_link-135" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup> shows “Expensive Wine” if the PRICE PER CASE value of the wine selected in the slicer is greater than $75.00; otherwise, it shows “Cheap Wine”.<figure class="figure1" id="calibre_link-116"><div class="mediaobject" id="calibre_link-1809"><img alt="" src="images/000211.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-6</span><p class="simplepara1">Using SELECTEDVALUE to test for values in the <span id="calibre_link-1810" class="calibre11">current filter</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-1811">This is the expression used in Figure <span><a href="#calibre_link-116" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-6</a></span>:<div class="programcode" id="calibre_link-1812"><div class="calibre4"><div class="fixedline">High Price =</div><div class="fixedline">IF (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SELECTEDVALUE ( Wines[PRICE PER CASE] ) &gt; 75,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Expensive Wine",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;"Cheap Wine"</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-1813">It’s important to note here that when using SELECTEDVALUE, you can select any value sitting in <em class="emphasistypeitalic">any</em> column of the row that has been filtered, not just the column used in the slicer.</p><p class="simplepara" id="calibre_link-1814">However, we still have a problem when a user selects multiple values in a slicer. You may not want to use “single select” in the slicer but instead be able to select multiple items and list the items in a Table or Card visual. We’ve also seen that the “alternate result” of SELECTEDVALUE displays when there is no selection as well as when there are many selected. Let’s now see how we can solve this problem by using the CONCATENATEX function.</p></section><section class="section" id="calibre_link-212"><h2 class="booksubtitle">The CONCATENATEX Function</h2><p class="simplepara" id="calibre_link-1815">We know that any function that ends in an “X” is an iterating function, and CONCATENATEX is no exception. It iterates the table referenced in its first argument and then concatenates the values in the column referenced in its second argument. Specifically, the <span id="calibre_link-1816">CONCATENATEX function</span> has the following arguments:</p><p class="simplepara" id="calibre_link-1817">= CONCATENATEX( table, expression, delimiter, order by, order )</p><p class="simplepara" id="calibre_link-1818">where:</p><p class="simplepara" id="calibre_link-1819"><strong class="emphasistypebold">table</strong> is the table to be iterated.</p><p class="simplepara" id="calibre_link-1820"><strong class="emphasistypebold">expression</strong> is the column (or expression) whose values you want concatenating for every row in <strong class="emphasistypebold">table</strong>.</p><p class="simplepara" id="calibre_link-1821"><strong class="emphasistypebold">delimiter</strong> is the character you want to separate the values, for example, a comma or an ampersand.</p><p class="simplepara" id="calibre_link-1822"><strong class="emphasistypebold">order by</strong> (optional) is usually a column by which you want to sort the values.</p><p class="simplepara" id="calibre_link-1823"><strong class="emphasistypebold">order</strong> (optional) is ASC or DESC.</p><div class="para" id="calibre_link-1824">Now let’s look at an example of an expression using CONCATENATEX:<div class="programcode" id="calibre_link-1825"><div class="calibre4"><div class="fixedline">Types of Wine =</div><div class="fixedline">CONCATENATEX ( Wines, Wines[WINE] , ", " , Wines[WINE ID], ASC )</div></div></div></div><div class="para" id="calibre_link-1826">In this measure, CONCATENATEX iterates the Wines table and, for every row in the table, returns a concatenated list of values from the WINE column, separated with a comma and sorted ascending by WINE ID. In Figure <span><a href="#calibre_link-118" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-7</a></span>, you can see the values that this expression returns when the TYPE column from the Wines tables has been placed in the Table visual. The “Types of Wine” measure displays all the wines beside their type (i.e., Red or White), separated by a comma and sorted by the WINE ID column ascending.<figure class="figure1" id="calibre_link-118"><div class="mediaobject" id="calibre_link-1827"><img alt="" src="images/000151.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-7</span><p class="simplepara1">The values <span id="calibre_link-1828" class="calibre11">returned</span> by the “Types of Wine” measure</p></div></figcaption></figure></div><div class="para" id="calibre_link-1829">We can use just the first three arguments and place this measure in a Card visual, using a slicer to filter by the <span id="calibre_link-1830">WINE column</span>:<div class="programcode" id="calibre_link-1831"><div class="calibre4"><div class="fixedline">Types of Wine #1 =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONCATENATEX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Wines, Wines[WINE] ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;", " )</div></div></div></div><div class="para" id="calibre_link-1832">Here, CONCATENATEX will simply return all the wine names in the current filter; see Figure <span><a href="#calibre_link-119" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-8</a></span>. At last, we’ve been able to solve the problem of displaying slicer selections when multiple items have been selected.<figure class="figure1" id="calibre_link-119"><div class="mediaobject" id="calibre_link-1833"><img alt="" src="images/000019.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-8</span><p class="simplepara1">The “Types of Wine #1” measure in a Card visual sliced by <span id="calibre_link-1834" class="calibre11">WINE</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1835">However, we’re not quite there yet. If there is no selection in the slicer, the Card visual returns all the wine names which probably isn’t what you want. To resolve this, we need to take our “Types of Wine #1” expression a little further.</p><div class="para" id="calibre_link-1836">In Figure <span><a href="#calibre_link-120" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-9</a></span>, we have used two similar measures in the title of a Table visual using conditional formatting: “Types of Wine #2” and “Types of Wine #3”. Both measures return the phrase “Sales by Wine, filtered by”, and the list of wines will grow as the selection grows. To avoid cluttering the visual with many wine names, the “Types of Wine #3” shows “and More” when more than three wines have been selected. When there is <em class="emphasistypeitalic">no</em> selection in the slicer, the title of the visuals shows “Sales by Wine”, rather than “you have selected multiple wines”, as in the case of the measures using SELECTEDVALUE.<figure class="figure1" id="calibre_link-120"><div class="mediaobject" id="calibre_link-1837"><img alt="" src="images/000105.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-9</span><p class="simplepara1">Using CONCATENATEX to solve the problem of <span id="calibre_link-1838" class="calibre11">multiple selections</span> and no selection</p></div></figcaption></figure></div><div class="para" id="calibre_link-1839">Therefore, using CONCATENATEX, we have solutions for all four <span id="calibre_link-1840">problem scenarios</span>:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1841">No selection in the slicer</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1842">Selections in the slicer</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-1843">Three or fewer wines selected</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">4.</div><div class="itemcontent"><p class="para2" id="calibre_link-1844">More than three wines selected</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-1845">The measure required that solves problem scenarios #1 and #2 is relatively straightforward. However, we need to extend this expression to accommodate scenarios #3 and #4, and this is where the expression will become a little more ambitious. Therefore, let’s tackle the situation where users make selections in the slicer or there is no selection.</p><div class="para" id="calibre_link-1846">To resolve this scenario, the measure we build must return <span id="calibre_link-1847">either</span><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1848">“Sales of Wines” if there are no selections in the slicer</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-1849">or<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1850">“Sales of Wines filtered by” followed by a list of wines selected in the slicer</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-1851">Therefore, we need a way to find out whether the filter on the WINES column has reduced the number of rows in the Wines dimension. If it has, there must be selections in the slicer. If it hasn’t, there must be no selection in the slicer. What we can do here is use the function named VALUES that generates a virtual one-column table that lists the values in the WINE column in the current filter context. We can then use the ALL function to return another virtual one-column table containing all the wine names. If these tables have the same number of rows in them, then there must be no selections in the slicer.</p><div class="formalpara" id="calibre_link-1852"><div class="heading1">Note</div><p class="para6" id="calibre_link-1853">We deep dive into the VALUES function later in this chapter.</p></div><div class="calibre4" id="calibre_link-1854">Here is the expression that we can build. Note the use of variables to harvest the values returned by <span id="calibre_link-1855">COUNTROWS</span>:<div class="programcode" id="calibre_link-1856"><div class="calibre4"><div class="fixedline">Types of Wine #2 =</div><div class="fixedline">VAR NoFilteredWines =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS (&nbsp;&nbsp;VALUES ( Wines[WINE] ) )</div><div class="fixedline">VAR&nbsp;&nbsp;NoAllWines=</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS ( ALL( Wines[WINE] ))</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF ( NoFilteredWines = NoAllWines ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sales by Wine",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sales by Wine, filtered by "</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONCATENATEX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Wines, Wines[WINE] ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;", " ) )</div></div></div></div><p class="simplepara" id="calibre_link-1857">Let’s now turn our attention to resolving the scenario of users selecting more than three wines in the slicer. If they select three or fewer wines or no wines, then the measure will return the same as “Types of Wine #2”. However, if they select four or more wines, we want the measure to return a list of the first three wines selected followed by “and more…”. Therefore, we need to generate a list of just the top three wine names selected in the slicer. We can use a table function named TOPN to do this job. As its name suggests, TOPN will build a virtual table containing only the top N (e.g., <strong class="emphasistypebold">3</strong>) values as in the following expression:</p><p class="para9" id="calibre_link-1858"><strong class="emphasistypebold">TOPN ( 3, VALUES ( Wines[WINE] ))</strong></p><p class="para9" id="calibre_link-1859">Notice again how the <span id="calibre_link-1860">VALUES function</span> is used to generate a one-column table listing the wine names in the current filter context. The TOPN function will extract the top three of these wine names into its own table that can then be used by CONCATENATEX to concatenate these values. We can then concatenate “and more…” using the ampersand.</p><div class="para" id="calibre_link-1861">You can see the following expression will solve our final scenario. All we need to do is add the IF function to execute the TOPN expression, followed by the <span id="calibre_link-1862">TOPN expression</span> itself, added to the bottom of the code (highlighted in gray):<div class="programcode" id="calibre_link-1863"><div class="calibre4"><div class="fixedline">Types of Wine #3 =</div><div class="fixedline">VAR NoFilteredWines =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS (&nbsp;&nbsp;VALUES ( Wines[WINE] ) )</div><div class="fixedline">VAR&nbsp;&nbsp;NoAllWines=</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS (ALL ( Wines[WINE]))</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF ( NoFilteredWines = NoAllWines ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sales by Wine",</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sales by Wine, filtered by "</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF ( NoFilteredWines &lt;=3,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONCATENATEX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Wines ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Wines[WINE] ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;", ") ,</div></div><div class="calibre4"><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CONCATENATEX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TOPN ( 3, VALUES ( Wines[WINE] )),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Wines[WINE] ,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;", ")</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp; " and more..."</div><div class="fixedline">))</div></div></div></div><p class="simplepara" id="calibre_link-1864">In building these measures, you have learned how CONCATENATEX can be used to string together slicer selections. However, it has also been a valuable exercise in the use of table functions and table expressions to generate virtual in-memory tables that are then used within the expression. This concept lies at the heart of DAX, building temporary tables that contain the values used by scalar functions. It might also be worth noting here that the measure “Types of Wine #3” is an order of magnitude more advanced than anything you have tackled so far in this book, but you now have the skills to author such complex code.</p><p class="simplepara" id="calibre_link-1865">We have also covered the details of the <span id="calibre_link-1866">SELECTEDVALUE function</span> on which we are now going to refocus. This is because we can put it to better use than alerting users to whatever has been chosen in a slicer. We understand that SELECTEDVALUE will return a single value, and in this way, we can use this function to harvest ad hoc values in columns of <em class="emphasistypeitalic">unrelated tables.</em> These unrelated tables have a name, <em class="emphasistypeitalic">parameter tables</em> whose use we are now going to explore.</p></section><section class="section" id="calibre_link-213"><h2 class="booksubtitle">Using Parameter Tables</h2><p class="simplepara" id="calibre_link-1867">You can use SELECTEDVALUE to return a user-selected parameter. This chosen <span id="calibre_link-1868">parameter</span> can then be used as a value inside a measure.</p><div class="para" id="calibre_link-1869">Consider the Table visual in Figure <span><a href="#calibre_link-121" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-10</a></span>. Here, we have a slicer that allows us to select a sales projection scenario for our “Total Sales” measure as follows:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-1870">“Best case” (increase by 20%)</p></li><li class="calibre9"><p class="para2" id="calibre_link-1871">“Probable” (increase by 10%)</p></li><li class="calibre9"><p class="para2" id="calibre_link-1872">“Worst case” (decrease by 10%)</p></li></ul></div></div><div class="para" id="calibre_link-1873">The total sales is then calculated accordingly in the “What If Scenario” measure.<figure class="figure1" id="calibre_link-121"><div class="mediaobject" id="calibre_link-1874"><img alt="" src="images/000002.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-10</span><p class="simplepara1">Using a parameter table to analyze sales projection scenarios</p></div></figcaption></figure></div><div class="para" id="calibre_link-1875">To create these scenarios, we’ve used the <strong class="emphasistypebold">Enter data</strong> button on the Home tab and created this table, called “What If”, as shown Figure <span><a href="#calibre_link-122" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-11</a></span>.<figure class="figure1" id="calibre_link-122"><div class="mediaobject" id="calibre_link-1876"><img alt="" src="images/000112.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-11</span><p class="simplepara1">The “What If” parameter table</p></div></figcaption></figure></div><div class="para" id="calibre_link-1877">Notice in Figure <span><a href="#calibre_link-122" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-11</a></span> that this table is not related to any other tables in the data model. We now need to place a slicer on the canvas populated with the “Scenario” column from the “What If” table, and we’re ready to create this measure:<div class="programcode" id="calibre_link-1878"><div class="calibre4"><div class="fixedline">What If Scenario =</div><div class="fixedline">[Total Sales] * SELECTEDVALUE ( 'What If'[Value] )</div></div></div></div><p class="simplepara" id="calibre_link-1879">When we select a value from the Scenario slicer, for example, “Probable”, this value is filtered in the “What If” table. There is only one row in the “What If” table, and the value sitting in the Value column is then used to multiply the value of the “Total Sales” measure.</p><div class="para" id="calibre_link-1880">You have learned that you can build parameter tables and by using SELECTEDVALUE can construct expressions that test for specific values selected from the parameter table. Once you know you can do this, you can use the values selected to drive specific calculations. Let’s look at an example of this. You may have found that one of the frustrations of working in Power BI is that you can only populate column values into slicers. However, this question often arises: Can I put measures into slicers? The answer is yes, you can! Consider Figure <span><a href="#calibre_link-123" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-12</a></span>.<figure class="figure1" id="calibre_link-123"><div class="mediaobject" id="calibre_link-1881"><img alt="" src="images/000230.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-12</span><p class="simplepara1">Creating slicers for measures</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1882">Here, we have a slicer that lists three measures. On selecting a measure in the slicer, the “Measure to Show” measure in the Table visual calculates the selected measure.</p><div class="para" id="calibre_link-1883">To build this example, again, we started with creating the parameter table and named it “Select Measures”. This table has two columns. The column named “Measure” lists the measures, but appreciate that these names are arbitrary; you don’t have to use the exact measure names. The second column named “Value” assigns a value to the “Measure” name. As with all parameter tables, this table is unrelated to any other tables in the model; see Figure <span><a href="#calibre_link-124" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-13</a></span>.<figure class="figure1" id="calibre_link-124"><div class="mediaobject" id="calibre_link-1884"><img alt="" src="images/000159.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-13</span><p class="simplepara1">The “Select Measures” parameter table</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1885">A slicer was then placed on the canvas containing the “Measure” column from the “Select Measures” table.</p><div class="para" id="calibre_link-1886">This is the expression for “Measure to Show”:<div class="programcode" id="calibre_link-1887"><div class="calibre4"><div class="fixedline">MEASURE toShow =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SWITCH (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTEDVALUE ( 'Select Measures'[Value] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1, [Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2, [Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3, [No. of Sales]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div></div></div></div><p class="simplepara" id="calibre_link-1888">Note the use of the SWITCH function in place of using IF, but either does the job. This measure was then placed in the Table visual alongside the WINE column from the Wines table.</p></section><section class="section" id="calibre_link-214"><h2 class="booksubtitle">The Values Function</h2><p class="simplepara" id="calibre_link-1889">It was debatable whether I would include the VALUES function in this book because in recent years, its requirement has largely been replaced by the SELECTEDVALUE function. However, the reason I changed my mind is that if you’re a DAX user, you would know and understand the VALUES function, even if you were rarely required to use it.</p><p class="simplepara" id="calibre_link-1890">Before the arrival of the SELECTEDVALUE function in 2017, the <span id="calibre_link-1891">VALUES function</span> was one of the major DAX functions. For this reason, you will meet VALUES when you browse other people’s code, and therefore, it would be a good idea if you knew the purpose of the function within an expression. Also, these two functions, SELECTEDVALUE and VALUES, are not interchangeable; sometimes, only VALUES will do. Indeed, we’ve already had cause to use the VALUES function when we were exploring CONCATENATEX.</p><p class="simplepara" id="calibre_link-1892">VALUES is particularly useful when you want to convert a <em class="emphasistypeitalic">column</em> reference into a <em class="emphasistypeitalic">table</em> reference or when you want to reapply “lost” filters.</p><p class="simplepara" id="calibre_link-1893">This function has a very simple syntax. Inside the function, you either reference a table or a column:</p><p class="simplepara" id="calibre_link-1894">=VALUES ( table name or column name )</p><p class="simplepara" id="calibre_link-1895">Here are two examples of VALUES syntax; the first <span id="calibre_link-1896">references</span> a table and the second, a column:</p><p class="para9" id="calibre_link-1897"><strong class="emphasistypebold">= VALUES ( Wines )</strong></p><p class="para9" id="calibre_link-1898"><strong class="emphasistypebold">= VALUES ( Wines[WINE] )</strong></p><div class="table" id="calibre_link-1899">This function is a <em class="emphasistypeitalic">table function</em> and returns a virtual <span id="calibre_link-1900">table</span> as follows:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-1901">When the input parameter is a column name, it returns a one-column table that contains the distinct values from the specified column <em class="emphasistypeitalic">using the current filter context</em>. Duplicate values are removed, and only unique values are returned.</p></li><li class="calibre9"><p class="para2" id="calibre_link-1902">When the input parameter is a table name, it returns a table containing the rows from the specified table <em class="emphasistypeitalic">using the current filter context</em>, and duplicate rows are preserved.</p></li></ul></div></div><p class="simplepara" id="calibre_link-1903">Although SELECTEDVALUE has largely replaced VALUES, they are two quite different functions. SELECTEDVALUE is a scalar function that will return a single value. Therefore, inside SELECTEDVALUE, you can only reference the column name where the scalar value you require is located. The VALUES function, on the other hand, is described as being a table function, and inside VALUES, you can reference either a column name or a table name. If you reference a column name inside VALUES, that column is converted to a table and so allows you to use columns as table expressions. Because this is one of the benefits of using this function, VALUES is more commonly used with a column reference, and it’s this behavior of VALUES on which we will concentrate in this section.</p><section class="section" id="calibre_link-215"><h3 class="booksubtitle">A Table or a Scalar Function?</h3><p class="simplepara" id="calibre_link-1904">However, if SELECTEDVALUE returns a scalar <span id="calibre_link-1905">value</span> and VALUES returns a table, how can VALUES be replaced by SELECTEDVALUE? This is where the VALUES function gets interesting because although it’s described as a table function, VALUES can return either a table <em class="emphasistypeitalic">or a scalar value</em>.</p><p class="simplepara" id="calibre_link-1906">The reason for this is that when a DAX table expression returns a <em class="emphasistypeitalic">one-column, one-row table</em>, it’s converted by the DAX engine from a table to a scalar value (remember that the LASTNONBLANK function also exhibited this behavior; see Chapter <span><a href="#calibre_link-125" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>9</span></a></span>). This is when VALUES changes its nature and switches from returning a table to returning a scalar value.</p><p class="simplepara" id="calibre_link-1907">We can now explore an example of this behavior.</p><div class="formalpara" id="calibre_link-1908"><div class="heading1">Note</div><p class="para6" id="calibre_link-1909">The following examples of DAX measures using the VALUES and SELECTEDVALUE functions are for explanation purposes only. We write measures that return the wine names that we’ve already put into a visual, and clearly, there’s no purpose to these calculations. The reason we’re using these particular expressions is to explain more readily how the VALUES function works. We later put the VALUES function to more realistic and beneficial use.</p></div><div class="calibre4" id="calibre_link-1910">Consider the following expression that will return a one-column table containing the name of the wine sitting in the current filter context.<div class="programcode" id="calibre_link-1911"><div class="calibre4"><div class="fixedline">Values Wine = VALUES ( Wines[Wine] )</div></div></div></div><div class="para" id="calibre_link-1912">Before we put this measure into a Table visual, we must turn off the Total row of the visual (for reasons we will explain presently).<sup class="calibre10"><a type="noteref" href="#calibre_link-126" id="calibre_link-136" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">2</a></sup> When the measure is placed into the visual, it returns the values in the WINE column in the current filter; see Figure <span><a href="#calibre_link-127" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-14</a></span>.<figure class="figure1" id="calibre_link-127"><div class="mediaobject" id="calibre_link-1913"><img alt="" src="images/000237.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-14</span><p class="simplepara1">The VALUES function returns the value in the current filter context</p></div></figcaption></figure></div><div class="para" id="calibre_link-1914">We get no error on the evaluation of the “Values Wine” measure, so it would appear that VALUES is behaving like a <span id="calibre_link-1915">scalar function</span> (remember that all measures must return scalars). We can see how this is possible. In the first evaluation for “Bordeaux” wine, the VALUES expression creates a virtual table containing a list of unique values in the WINE column that are in the current filter. It therefore generates a <em class="emphasistypeitalic">one-column, one-row table</em> containing the value “Bordeaux”. If we could see this table, it may well look like the table containing a single value as shown in Figure <span><a href="#calibre_link-128" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-15</a></span>.<figure class="figure1" id="calibre_link-128"><div class="mediaobject" id="calibre_link-1916"><img alt="" src="images/000176.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-15</span><p class="simplepara1">The one-column, one-row table generated by VALUES</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1917">This table contains a single value that can be converted to a scalar, and this is why it can be used successfully in the measure “Values Wine”.</p><div class="para" id="calibre_link-1918">However, let’s now replace the Total row in the Table visual. When we do this, the measure will now return an error as shown in Figure <span><a href="#calibre_link-129" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-16</a></span>.<figure class="figure1" id="calibre_link-129"><div class="mediaobject" id="calibre_link-1919"><img alt="" src="images/000185.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-16</span><p class="simplepara1">An error is returned when the VALUES function evaluates the Total <span id="calibre_link-1920" class="calibre11">row</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1921">The <span id="calibre_link-1922">error message</span> reads:</p><p class="simplepara" id="calibre_link-1923">“<em class="emphasistypeitalic">A table of multiple values was supplied where a single value was expected.</em>”</p><div class="para" id="calibre_link-1924">Why do we get this error when the Total row shows but not when it’s absent? When a DAX expression is evaluated for the Total row, there is no longer a single value being returned by VALUES, but now <em class="emphasistypeitalic">all</em> the wine names are in the filter context. Therefore, the VALUES function will return a virtual table containing all the values in the WINE column. This is the “table of multiple values” that the error message is referring to (Figure <span><a href="#calibre_link-130" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-17</a></span>).<figure class="figure1" id="calibre_link-130"><div class="mediaobject" id="calibre_link-1925"><img alt="" src="images/000126.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-17</span><p class="simplepara1">VALUES returns a “table of multiple values” when evaluating the Total row</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1926">Therefore, we can deduce that it’s the evaluation of the Total row that’s the problem because you can’t put multiple values into a “cell” in the Total row. This is why in the Table visual in Figure <span><a href="#calibre_link-127" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-14</a></span>, we must remove the Total row for our expression to work. However, you might think this is a bit of a workaround and at some point want to show the Total row value for your measure.</p><div class="para" id="calibre_link-1927">To remedy this, rather than removing the Total row from the visual, instead, we can get DAX to distinguish between the evaluation for each wine and the evaluation for the Total row. For this, we must use a DAX function that returns TRUE if there is just one value in the current filter context. Its name is unsurprisingly HASONEVALUE. Here is the expression we need:<div class="programcode" id="calibre_link-1928"><div class="calibre4"><div class="fixedline">Values Wine =</div><div class="fixedline">IF ( HASONEVALUE ( Wines[WINE] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;VALUES ( Wines[WINE] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;"All Wines" )</div></div></div></div><div class="para" id="calibre_link-1929">But doesn’t the preceding expression return the same values as this one?<div class="programcode" id="calibre_link-1930"><div class="calibre4"><div class="fixedline">Selected Value Wine =</div><div class="fixedline">SELECTEDVALUE ( Wines[WINE], "All Wines" )</div></div></div><figure class="figure1" id="calibre_link-131"><div class="mediaobject" id="calibre_link-1931"><img alt="" src="images/000067.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-18</span><p class="simplepara1">The VALUES function returns the same values as the <span id="calibre_link-1932" class="calibre11">SELECTEDVALUE function</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1933">Well, yes, it does (Figure <span><a href="#calibre_link-131" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-18</a></span>), and because the VALUES expression is more complex, you would probably prefer to use SELECTEDVALUE. Whenever you use VALUES to return a scalar value, you could use SELECTEDVALUE instead. What’s more, with SELECTEDVALUE, you don’t have to account for only one value in the filter context as it’s implicit in the “alternate result” argument.</p><p class="simplepara" id="calibre_link-1934">You may be wondering why you would want to return the wine names anyway, using either SELECTEDVALUE or using VALUES, when you’ve already got them as the first column in the visual!</p></section><section class="section" id="calibre_link-216"><h3 class="booksubtitle">Replacing “Lost Filters”</h3><p class="simplepara" id="calibre_link-1935">You may feel that these examples, although explaining how VALUES works, are not “real-world” calculations. However, you have now learned how the VALUES function <span id="calibre_link-1936">operates</span>, that it can return either a table or a scalar value. We need to find a better use for VALUES and also find a situation where we can’t substitute SELECTEDVALUE. A better example of the VALUES function is when we use VALUES as a table function, rather than returning a scalar. So let’s look at this next scenario.</p><div class="para" id="calibre_link-1937">One of the problems with filtering using slicers is that you lose the original unfiltered value. One way to overcome this problem is to use two visuals and then use “Edit Interactions”<sup class="calibre10"><a type="noteref" href="#calibre_link-132" id="calibre_link-137" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">3</a></sup> so that a slicer filters one of the visuals but not the other (Figure <span><a href="#calibre_link-133" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-19</a></span>).<figure class="figure1" id="calibre_link-133"><div class="mediaobject" id="calibre_link-1938"><img alt="" src="images/000090.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-19</span><p class="simplepara1">Using “<span id="calibre_link-1939" class="calibre11">Edit Interactions</span>”, you can prevent slicers from filtering a visual</p></div></figcaption></figure></div><div class="para" id="calibre_link-1940">However, we want a single visual that retains the unfiltered values alongside the filtered ones, as in Figure <span><a href="#calibre_link-134" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">12-20</a></span>. This is the DAX expression for the “Total Sales Not Filtered” measure:<div class="programcode" id="calibre_link-1941"><div class="calibre4"><div class="fixedline">Total Sales Not Filtered =</div><div class="fixedline">CALCULATE ( [Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( Winesales ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;VALUES ( Wines[WINE] )</div><div class="fixedline">)</div></div></div><figure class="figure1" id="calibre_link-134"><div class="mediaobject" id="calibre_link-1942"><img alt="" src="images/000135.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 12-20</span><p class="simplepara1">A table visual where the “Total Sales Not Filtered” measure ignores the slicer filter</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1943">Now let’s examine the “Total Sales Not Filtered” measure in more detail. The first filter argument to CALCULATE is the ALL function that acts as a modifier and removes any cross-filters on the Winesales fact table coming from both the WINE column and the SALESPERSON column. In the second filter argument, VALUES is used to build a virtual one-column, one-row table containing the wine name in the current filter context, that is, “Bordeaux” in the first evaluation. This is equivalent to “Wines[WINE] = “Bordeaux”. CALCULATE then applies this new filter to the Winesales table that is then refiltered accordingly. The end result is that there is a filter on the WINE column but no longer a filter on the SALESPERSON column, and therefore, we see sales for all salespeople for each wine. When the measure calculates the Total row, it constructs a virtual one-column table containing all the wine names to be used as the filter.</p><div class="para" id="calibre_link-1944">However, the following expression is an alternative way of achieving the same result:<div class="programcode" id="calibre_link-1945"><div class="calibre4"><div class="fixedline">Total Sales Not Filtered #2 =</div><div class="fixedline">CALCULATE ( [Total Sales], ALL ( Winesales ), Wines )</div></div></div></div><p class="simplepara" id="calibre_link-1946">In this measure, we’ve referenced the entire Wines table as the filter instead of using VALUES to generate a virtual one-column table. We can do this because the Wines table has been filtered down to one row (or all rows for the evaluation of the Total row) and the entire table can be used as a table expression.</p><p class="simplepara" id="calibre_link-1947">This is the first time we have referenced a table in the filter argument to CALCULATE rather than a table <em class="emphasistypeitalic">expression</em>, and we’re going to do this again later on. Remember that the Wines table will contain a single row containing the wine in the current filter context, or all the rows of the Wines table when evaluating the Total row. This expression is perhaps a better one because we don’t need to nest yet another function.</p></section><section class="section" id="calibre_link-217"><h3 class="booksubtitle">Converting Columns to Tables</h3><p class="simplepara" id="calibre_link-1948">We’ve already established that the VALUES function is a useful function to add to your DAX “toolbox” even though you can normally use SELECTEDVALUE instead. What you will discover as you work with DAX is that <span id="calibre_link-1949"></span>VALUES is more commonly used with a column reference because one of its major uses is to convert columns into tables. For example, this expression:</p><p class="simplepara" id="calibre_link-1950"><em class="emphasistypeitalic">“= Wines[WINE]”</em> is a <em class="emphasistypeitalic">column</em>,</p><p class="simplepara" id="calibre_link-1951">but this expression:</p><p class="simplepara" id="calibre_link-1952"><em class="emphasistypeitalic">“= VALUES ( Wines[WINE] )”</em> is a <em class="emphasistypeitalic">table</em>.</p><p class="simplepara" id="calibre_link-1953">We will look later at using VALUES in this way when we look at the TREATAS function later in this book.</p><p class="simplepara" id="calibre_link-1954">With its dual personality of returning either a table or a scalar value, and particularly how it can convert a column to a table, VALUES is a function well worth getting to know.</p><p class="simplepara" id="calibre_link-1955">In this chapter, we have explored three functions, SELECTEDVALUE, CONCATENATEX, and VALUES, that allow you to use the value or values sitting in the current filter. You have learned that by creating parameter tables, you can harvest these values to use within your DAX expressions. But more than this, when working with CONCATENATEX, you have understood how, by using variables, you can hold the values returned by these functions so they can be referenced later within the expression. You have also successfully generated a number of temporary in-memory tables to control filters placed on the data model. All these techniques are ubiquitous to writing DAX expressions and will hold you in good stead as you move forward and author more complex code.</p></section></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-135" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-117" role="doc-footnote"><p class="para3" id="calibre_link-1956">For information on formatting the Card visual, visit <span><a href="https://docs.microsoft.com/en-us/power-bi/visuals/power-bi-visualization-card" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://docs.microsoft.com/en-us/power-bi/visuals/power-bi-visualization-card</span></span></a></span></p></div><div class="clearboth1">&nbsp;</div></div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-136" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2</a></span><div class="calibre4" type="footnote" id="calibre_link-126" role="doc-footnote"><p class="para3" id="calibre_link-1957">For information on removing the Total row, visit <span><a href="https://community.powerbi.com/t5/Desktop/How-to-remove-the-quot-Total" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://community.powerbi.com/t5/Desktop/How-to-remove-the-quot-Total</span></span></a></span></p></div><div class="clearboth1">&nbsp;</div></div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-137" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3</a></span><div class="calibre4" type="footnote" id="calibre_link-132" role="doc-footnote"><p class="para3" id="calibre_link-1958">For information on how to edit the interactions of visuals, visit <span><a href="https://docs.microsoft.com/en-us/power-bi/create-reports/service-reports-visual-interactions" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">https://docs.microsoft.com/en-us/power-bi/create-reports/service-reports-visual-interactions</span></span></a></span></p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-21">
<div id="calibre_link-1959" class="calibre2">
<div id="calibre_link-1960" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-1961"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_13" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_13</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">13.&nbsp;Controlling the Direction of Filter Propagation</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-275" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-275"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><div class="para4" id="calibre_link-1962">Up to now, you have understood that filters <em class="emphasistypeitalic">only</em> flow from the one side of the relationship to the many, from dimensions into the fact table, as indicated by the arrows in the linking lines in <span id="calibre_link-1963">Model view</span>; see Figure <span><a href="#calibre_link-276" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">13-1</a></span>.<figure class="figure1" id="calibre_link-276"><div class="mediaobject" id="calibre_link-1964"><img alt="" src="images/000168.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 13-1</span><p class="simplepara1">Filters only flow from dimensions into <span id="calibre_link-1965" class="calibre11">fact tables</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-1966">However, there will be situations when you will want to author measures that require filters to propagate in the opposite direction. In this chapter, we explore these situations and learn how to reverse the direction of the filters using two methods:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-1967">The <span id="calibre_link-1968">CROSSFILTER function</span> to programmatically reverse the filters</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-1969">Editing the data model to make filter propagation flow both to and from the fact table</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="para5" id="calibre_link-1970">However, regarding method #2, we will be warning you of the downside if you change the structure of your data model. In fact, it’s important to understand that if you want filters to flow in the opposite direction, this will always be problematic whichever way you choose to work it.</p><section class="section" id="calibre_link-218"><h2 class="booksubtitle">Programming Bidirectional Filters</h2><div class="calibre4" id="calibre_link-1971"><span id="calibre_link-1972"></span>For example, let’s look at a problem we explored in Chapter <span><a href="#calibre_link-140" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>4</span></a></span> when you were learning about the filter context and which at that time, you were not able to resolve. In the Customers dimension, we have the column NO. OF STORES; see Figure <span><a href="#calibre_link-277" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">13-2</a></span>.<figure class="figure1" id="calibre_link-277"><div class="mediaobject" id="calibre_link-1973"><img alt="" src="images/000220.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 13-2</span><p class="simplepara1">The <span id="calibre_link-1974" class="calibre11">Customers table</span> and the NO. OF STORES column</p></div></figcaption></figure></div><div class="para" id="calibre_link-1975">We would like to calculate the number of stores in which we’ve sold each wine. We might create this measure:<div class="programcode" id="calibre_link-1976"><div class="calibre4"><div class="fixedline">Total Stores =</div><div class="fixedline">SUM ( Customers[ NO. OF STORES] )</div></div></div></div><div class="para" id="calibre_link-1977">However, as you can see in Figure <span><a href="#calibre_link-278" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">13-3</a></span>, this measure does not work.<figure class="figure1" id="calibre_link-278"><div class="mediaobject" id="calibre_link-1978"><img alt="" src="images/000193.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 13-3</span><p class="simplepara1">The “Total Stores” measure does not return the correct results</p></div></figcaption></figure></div><div class="para" id="calibre_link-1979">In Chapter <span><a href="#calibre_link-140" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>4</span></a></span>, we established the reason for the incorrect values. The filter on the Wines dimension only propagates to the fact table and does <em class="emphasistypeitalic">not</em> propagate onward to the Customers dimension; see Figure <span><a href="#calibre_link-279" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">13-4</a></span>.<figure class="figure1" id="calibre_link-279"><div class="mediaobject" id="calibre_link-1980"><img alt="" src="images/000082.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 13-4</span><p class="simplepara1">The filter does not propagate from Winesales to Customers</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1981">So how do we find the number of stores in which we’ve sold our wines? The answer lies in using a function called CROSSFILTER.</p><p class="simplepara" id="calibre_link-1982">The CROSSFILTER function returns no value but is used as a modifier to the CALCULATE function. It <em class="emphasistypeitalic">programmatically</em> sets the direction of the filter propagation in the execution of the measure in which it is used. It has the following syntax:</p><p class="simplepara" id="calibre_link-1983">= CROSSFILTER ( column1, column2, direction )</p><p class="simplepara" id="calibre_link-1984">where:</p><p class="simplepara" id="calibre_link-1985"><strong class="emphasistypebold">column1</strong> is the column name that represents the many side of the relationship to be used.</p><p class="simplepara" id="calibre_link-1986"><strong class="emphasistypebold">column2</strong> is the column name that represents the one side of the relationship to be used.</p><p class="simplepara" id="calibre_link-1987"><strong class="emphasistypebold">direction</strong> is the cross-filter direction to be used in the measure and can be set to “both” to generate bidirection filters.</p><p class="simplepara" id="calibre_link-1988">Here is an example of CROSSFITLER syntax:</p><p class="para9" id="calibre_link-1989"><strong class="emphasistypebold">= CROSSFILTER ( Winesales[CUSTOMERID], Customers[CUSTOMERID], both)</strong></p><p class="para9" id="calibre_link-1990">The <span id="calibre_link-1991">CROSSFILTER function</span> specifies the cross-filtering direction to be used by a measure, so we can now, in memory, <em class="emphasistypeitalic">change</em> the direction in which the filters propagate.</p><div class="para" id="calibre_link-1992">We can rewrite our original “Total Stores” measure like this:<div class="programcode" id="calibre_link-1993"><div class="calibre4"><div class="fixedline">Total Stores =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Customers[NO. OF STORES] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CROSSFILTER ( Winesales[CUSTOMER ID], Customers[CUSTOMER ID], BOTH )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-1994">This measure uses CROSSFILTER to change the direction of the relationship between Customers and Winesales. When this measure is evaluated, the Winesales table is cross-filtered by the Wines dimension, and this filter is propagated <em class="emphasistypeitalic">onward</em> to the Customers dimension; see Figure <span><a href="#calibre_link-280" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">13-5</a></span>.<figure class="figure1" id="calibre_link-280"><div class="mediaobject" id="calibre_link-1995"><img alt="" src="images/000011.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 13-5</span><p class="simplepara1">The <span id="calibre_link-1996" class="calibre11">CROSSFILTER function</span> can change the direction of the filter programmatically</p></div></figcaption></figure></div><div class="para" id="calibre_link-1997">So in the first instance for “Bordeaux” wine, the Customers table becomes cross-filtered to contain only customers who bought this wine, and we can see that there were <strong class="emphasistypebold">728</strong> stores in which we’ve sold “Bordeaux”; see Figure <span><a href="#calibre_link-281" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">13-6</a></span>.<figure class="figure1" id="calibre_link-281"><div class="mediaobject" id="calibre_link-1998"><img alt="" src="images/000033.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 13-6</span><p class="simplepara1">The “Total Stores” measure is now calculated correctly</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-1999">However, note the value in the Total row, <strong class="emphasistypebold">1,181</strong>. It is not the total of the values for all the wines in the Table visual. Changing the filter propagation to bidirectional has a side effect. Many of the same customers have bought each wine, and so their total number of stores is included in multiple evaluations. However, the Total row sums the number of stores for all customers for all wines.</p></section><section class="section" id="calibre_link-219"><h2 class="booksubtitle">Why You Should Never Use Bidirectional Relationships</h2><div class="calibre4" id="calibre_link-2000">The <span id="calibre_link-2001">CROSSFILTER function</span> allows you to <em class="emphasistypeitalic">programmatically</em> change the direction of filter propagation in the execution of a specific measure. However, you may know that there’s an easier way to change the filter direction, and that’s to change the structure of the data model. To do this, you can double-click on the linking line between two tables in Model view to edit the relationship, setting the “Cross filter direction” to “Both”; see Figure <span><a href="#calibre_link-282" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">13-7</a></span>.<figure class="figure1" id="calibre_link-282"><div class="mediaobject" id="calibre_link-2002"><img alt="" src="images/000059.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 13-7</span><p class="simplepara1">You can edit the relationship and set the <span id="calibre_link-2003" class="calibre11">cross-filter</span> to both</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2004">However, a quick fix as this is, we would never recommend that you do this for two reasons. Firstly, bidirectional relationships are much less efficient and can hinder the performance of the data model, but perhaps, more importantly, they introduce <em class="emphasistypeitalic">ambiguity</em> into the data model. It’s beyond the scope of this book to elaborate on the concept of ambiguity, but for more information on these issues, check out this link:</p><p class="simplepara" id="calibre_link-2005"><span><a href="http://www.sqlbi.com/articles/bidirectional-relationships-and-ambiguity-in-dax/" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">www.sqlbi.com/articles/bidirectional-relationships-and-ambiguity-in-dax/</span></span></a></span></p><p class="simplepara" id="calibre_link-2006">However, even at a more basic level, you will find that creating many <span id="calibre_link-2007">bidirectional relationships</span> in your model will render the data model unpredictable when filters are propagated, and you will start to lose control of what filters what. You will find it much easier if your model abides by the rule of single directional relationships, and if you must change the filter direction, use CROSSFILTER.<span id="calibre_link-2008"></span></p><div class="para" id="calibre_link-2009">There are usually three reasons why people edit a relationship to bidirectional filtering, all of which are not valid reasons:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2010">There is a lack of understanding of the subtleties of the Power BI data model and filter propagation.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2011">People don’t know enough DAX to be able to programmatically change the filter direction using CROSSFILTER.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2012">People want to cross-filter slicers when the slicers use columns from different dimensions.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-2013">Let’s take a look at the last of these reasons: wanting to cross-filter slicers when using columns from different dimensions. If this is your objective, you don’t need to use bidirectional filtering. You can do this by using a <em class="emphasistypeitalic">measure</em> in a visual-level filter on the slicer you want cross-filtered.</p><div class="para" id="calibre_link-2014">For example, in Figure <span><a href="#calibre_link-283" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">13-8</a></span>, you can see we have two slicers: one using the CUSTOMER NAME column from the Customers dimension and one using the WINE column from the Wines dimension. If we select from the CUSTOMER NAME slicer, for example, “Ballard &amp; Sons”, the WINE slicer won’t change to reflect the wines that “Ballard &amp; Sons” has bought. We always see all the wines regardless of selections made in the CUSTOMER NAME slicer.<figure class="figure1" id="calibre_link-283"><div class="mediaobject" id="calibre_link-2015"><img alt="" src="images/000246.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 13-8</span><p class="simplepara1">Slicers don’t cross-filter from one dimension to another<span id="calibre_link-2016" class="calibre11"></span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2017">You already know why this is. If the Customers table is filtered, the filter is propagated to the Winesales table but not filtered onward to the Wines table because filters don’t flow from the many side of the relationship to the one side. However, we can force the Wines table to cross-filter accordingly. We can do this by placing a visual filter on the WINE slicer using a <em class="emphasistypeitalic">measure</em>, such as “Total Sales”, and filter only Wines that have a “Total Sales” value. In fact, we can use any measure that does a calculation on the Winesales table and then set this filter to “Show items when the value is not blank” as shown in the visual filter in Figure <span><a href="#calibre_link-284" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">13-9</a></span>.<figure class="figure1" id="calibre_link-284"><div class="mediaobject" id="calibre_link-2018"><img alt="" src="images/000144.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 13-9</span><p class="simplepara1">Use a visual filter populated with a measure and set to “is not blank” to cross-filter slicers<span id="calibre_link-2019" class="calibre11"></span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2020">So there really is no excuse for editing relationships to bidirectional! Always design measures using the <span id="calibre_link-2021">CROSSFILTER function</span> to do this. However, as we have seen, the problem of measures that use bidirectional filters, whether using CROSSFILTER or editing the relationship, is that the Total row shows a misleading value. There is no real solution to this outcome; the total is correct but may not be the total you want to show. You can, of course, always turn off the display of the total row in the Table or Matrix visual.</p></section></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-141">
<div id="calibre_link-2022" class="calibre2">
<div id="calibre_link-2023" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-2024"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_14" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_14</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">14.&nbsp;Working with Multiple Relationships Between Tables</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-293" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-293"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-2025">In our data model, all our tables have <em class="emphasistypeitalic">single</em> relationships between other tables. Indeed, it’s only possible to have <em class="emphasistypeitalic">one active</em> relationship between any two tables, but you can have as many <em class="emphasistypeitalic">inactive</em> relationships as you want. In this chapter, you will learn how to use multiple relationships between tables and activate inactive relationships. This may be because you require multiple links from a dimension table into the fact table. However, there is another less obvious use of inactive relationships that we will discover in this chapter, and that is using comparison dimension tables. Here, we can use measures to force filter propagation through the comparison dimension table, therefore being able to compare a column from a default dimension with its counterpart in a comparison dimension.</p><div class="para8" id="calibre_link-2026">If you attempt to build a second relationship or subsequent relationships between any two <span id="calibre_link-2027">tables</span>, all but the first relationship will be inactive, indicated by a dotted relationship line. Consider the tables in Figure <span><a href="#calibre_link-294" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-1</a></span>. We now have two date columns in our Winesales table: SALE DATE and ORDER DATE.<sup class="calibre10"><a type="noteref" href="#calibre_link-295" id="calibre_link-303" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup> The first relationship was established between the DATEKEY column in the DateTable and the SALE DATE column in the Winesales table. When we attempt to create a second relationship between the DateTable and the Winesales table by using ORDER DATE, we get a dotted line indicating that this relationship is inactive.<figure class="figure1" id="calibre_link-294"><div class="mediaobject" id="calibre_link-2028"><img alt="" src="images/000175.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 14-1</span><p class="simplepara1">Active and inactive <span id="calibre_link-2029" class="calibre11">relationships</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2030">All measures will use the active relationship by default, so how do you use the inactive relationship? For example, if we build a Table visual containing the YEAR and MONTH columns from the DateTable (Figure <span><a href="#calibre_link-296" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-2</a></span>), we can find the number of sales in each month using this <span id="calibre_link-2031">measure</span>:<div class="programcode" id="calibre_link-2032"><div class="calibre4"><div class="fixedline">No. of Sales =</div><div class="fixedline">COUNTROWS ( Winesales )</div></div></div><figure class="figure1" id="calibre_link-296"><div class="mediaobject" id="calibre_link-2033"><img alt="" src="images/000125.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 14-2</span><p class="simplepara1">Using YEAR and MONTH from the <span id="calibre_link-2034" class="calibre11">DateTable filters</span> the SALE DATE column in the Winesales table</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2035">In this visual, the “No. of Sales” measure filters the YEAR and MONTH columns in the DateTable, which is propagated to the Winesales table using the <em class="emphasistypeitalic">active</em> relationship and therefore filters the SALE DATE column for that year and month. However, to calculate the number of orders, we will need to use the <em class="emphasistypeitalic">inactive</em> relationship so that the ORDER DATE column is filtered for that year and month instead. To do this, we can use the USERELATIONSHIP function.</p><section class="section" id="calibre_link-220"><h2 class="booksubtitle">Activating Inactive Relationships</h2><p class="simplepara" id="calibre_link-2036">The <span id="calibre_link-2037">USERELATIONSHIP function</span><span id="calibre_link-2038"></span>, like the CROSSFILTER function, returns no value but is used as a modifier to the CALCULATE function. It programmatically uses an inactive relationship to propagation filters in the execution of the measure in which it is used. It has the following syntax:</p><p class="simplepara" id="calibre_link-2039">= USERELATIONSHIP ( column1, column2 )</p><p class="simplepara" id="calibre_link-2040">where:</p><p class="simplepara" id="calibre_link-2041"><strong class="emphasistypebold">column1</strong> is the column name that represents the many side of the relationship to be used.</p><p class="simplepara" id="calibre_link-2042"><strong class="emphasistypebold">column2</strong> is the column name that represents the one side of the relationship to be used.</p><p class="simplepara" id="calibre_link-2043">Here is an example of the USERELATIONSHIP syntax:</p><p class="para9" id="calibre_link-2044"><strong class="emphasistypebold">= USERELATIONSHIP (Winesales[SALE DATE], DateTable[ORDER DATE] )</strong></p><p class="para9" id="calibre_link-2045">You must have an <em class="emphasistypeitalic">inactive</em> relationship in place in order to use the USERELATIONSHIP function.</p><div class="para" id="calibre_link-2046">This is the measure to calculate the number of orders in each month shown in Figure <span><a href="#calibre_link-297" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-3</a></span>:<div class="programcode" id="calibre_link-2047"><div class="calibre4"><div class="fixedline">No. of Orders =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS ( Winesales ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;USERELATIONSHIP ( Winesales[ORDER DATE], DateTable[DATEKEY] ))</div><div class="fixedline">.</div></div></div><figure class="figure1" id="calibre_link-297"><div class="mediaobject" id="calibre_link-2048"><img alt="" src="images/000017.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 14-3</span><p class="simplepara1">Calculating the number of sales and number of orders</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2049">When this measure is evaluated, the year and month filtered in the DateTable are propagated to the Winesales table to cross-filter the ORDER DATE column to find the orders in that month.</p></section><section class="section" id="calibre_link-221"><h2 class="booksubtitle">Comparing Values in the Same Column</h2><p class="simplepara" id="calibre_link-2050">The USERELATIONSHIP function can be used for another purpose: dynamic comparisons between values from the same column in a dimension. In other words, being able to compare a column from a default dimension with its counterpart in a <span id="calibre_link-2051">comparison dimension</span>.</p><div class="para" id="calibre_link-2052">Consider the example shown in Figure <span><a href="#calibre_link-298" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-4</a></span>. Here, we are comparing 2020 sales (the “Total Sales” measure) to 2021 sales (the “Compare Year” measure), but the benefit here is that we are making the comparison <em class="emphasistypeitalic">in the same Table visual</em>, rather than using separate visuals for each year.<figure class="figure1" id="calibre_link-298"><div class="mediaobject" id="calibre_link-2053"><img alt="" src="images/000150.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 14-4</span><p class="simplepara1">Comparing sales for two different years selected in <span id="calibre_link-2054" class="calibre11">slicers</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2055">The starting point for the “Compare Year” measure is to create a comparison DateTable in the data model by duplicating the original DateTable. We’ve named the duplicate DateTable “DateTable Compare”. This table is then related to the Winesales table using the DATEKEY column from the “DateTable Compare” table and the SALE DATE column from the Winesales table; see Figure <span><a href="#calibre_link-299" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-5</a></span>.<figure class="figure1" id="calibre_link-299"><div class="mediaobject" id="calibre_link-2056"><img alt="" src="images/000229.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 14-5</span><p class="simplepara1">Relate the comparison table to the <span id="calibre_link-2057" class="calibre11">fact table</span> but set the relationship to inactive</p></div></figcaption></figure></div><div class="para" id="calibre_link-2058">You must then edit this relationship to ensure that it’s marked as <em class="emphasistypeitalic">inactive</em> by checking off “Make this relationship active” in the <strong class="emphasistypebold">Edit Relationship</strong> <span id="calibre_link-2059">dialog</span>; see Figure <span><a href="#calibre_link-300" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-6</a></span>.<figure class="figure1" id="calibre_link-300"><div class="mediaobject" id="calibre_link-2060"><img alt="" src="images/000201.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 14-6</span><p class="simplepara1">Making a <span id="calibre_link-2061" class="calibre11"></span>relationship inactive</p></div></figcaption></figure></div><div class="para" id="calibre_link-2062">The next step is to create the two <span id="calibre_link-2063">slicers</span> as shown in Figure <span><a href="#calibre_link-298" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-4</a></span>. The slicer on the left, named “YEAR”, is created using the YEAR column from the DateTable. Selecting a year from this slicer filters the “Total Sales” measure. The slicer on the right, named “COMPARE YEAR”, uses the YEAR column from the “DateTable Compare” table. Selecting a year from this slicer filters the “Compare Year” measure as follows:<div class="programcode" id="calibre_link-2064"><div class="calibre4"><div class="fixedline">Compare Year =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( DateTable ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;USERELATIONSHIP ( Winesales[SALE DATE], 'DateTable Compare'[DATEKEY] )</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-2065">Notice the use of the ALL function to remove the filter on the YEAR column of the DateTable coming through from the YEAR slicer that is used by the active relationship.</p><p class="simplepara" id="calibre_link-2066">Using USERELATIONSHIP to make comparisons between your <span id="calibre_link-2067">data</span> is a simple strategy and doesn’t require complex DAX, so let’s take this idea a step further. Let’s see if we can answer this question: Of the customers who bought wine X, who also bought wine Y? For example, of the customers who bought “Champagne”, who also bought “Pinot Grigio”?</p><div class="para" id="calibre_link-2068">We’ve set out the solution to this question in Figure <span><a href="#calibre_link-301" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-7</a></span>. The “No. of Sales” measure is being filtered by the WINE slicer on the left and shows the number of sales of “Champagne” for each customer. The “Compare Wine” measure is being filtered by the COMPARE WINE slicer on the right and shows the number of sales of “Pinot Grigio” for each customer. Finally, we’ve created a “Both Wines” measure that shows the customers who bought both wines, showing the combined number of sales for both wines.<figure class="figure1" id="calibre_link-301"><div class="mediaobject" id="calibre_link-2069"><img alt="" src="images/000042.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 14-7</span><p class="simplepara1">Customers who bought either wines or both wines</p></div></figcaption></figure></div><div class="para" id="calibre_link-2070">You can see in Figure <span><a href="#calibre_link-301" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-7</a></span> that<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-2071">“Charleston Ltd” bought both “Champagne” and “Pinot Grigio”.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2072">“Charlottesville &amp; Co” bought “Champagne” but not “Pinot Grigio”.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2073">“Chatou &amp; Co” bought “Pinot Grigio” but not “Champagne”.</p></li></ul></div></div><div class="para" id="calibre_link-2074">If we put the “Both <span id="calibre_link-2075">Wines</span>” measure into a Table visual of its own, we see only customers who bought both wines (Figure <span><a href="#calibre_link-302" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-8</a></span>).<figure class="figure1" id="calibre_link-302"><div class="mediaobject" id="calibre_link-2076"><img alt="" src="images/000252.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 14-8</span><p class="simplepara1">Customers who bought both wines</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2077">The expressions for the measures in Figure <span><a href="#calibre_link-301" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-7</a></span> are almost the same as those we used when we were comparing years in Figure <span><a href="#calibre_link-298" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-4</a></span>. First, you need to duplicate the Wines dimension. We’ve called this duplicate table “Wines Compare” and then related this duplicate table to the fact table, remembering to set the relationship as “inactive.”</p><div class="para" id="calibre_link-2078">These are the three <span id="calibre_link-2079">measures</span> we used in Figure <span><a href="#calibre_link-301" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-7</a></span>:<div class="programcode" id="calibre_link-2080"><div class="calibre4"><div class="fixedline">No. of Sales =</div><div class="fixedline">COUNTROWS ( Winesales)</div></div></div></div><div class="para" id="calibre_link-2081"><div class="programcode" id="calibre_link-2082"><div class="calibre4"><div class="fixedline">Compare Wine =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( Wines ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;USERELATIONSHIP ( Winesales[WINE ID], 'Wines Compare'[WINE ID] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2083"><div class="programcode" id="calibre_link-2084"><div class="calibre4"><div class="fixedline">Both Wines =</div><div class="fixedline">IF (</div><div class="fixedline">SELECTEDVALUE ( Wines[WINE] ) = SELECTEDVALUE ( 'Wines Compare'[WINE] ), [No. of Sales],</div><div class="fixedline">--If the same wine is selected in both slicers, don’t add the number of sales together</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;IF (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales] &amp;&amp; [Compare Wine],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales] + [Compare Wine]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">--If customers have sales for both wines, add the number of sales together</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2085">However, those of you that are observant may notice that the value in the Total row of the “Both Wines” measure in Figure <span><a href="#calibre_link-302" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">14-8</a></span> <strong class="emphasistypebold">(298)</strong> is not correct. It totals <em class="emphasistypeitalic">all rows</em> for the selected wines not just those rows for customers who have bought both wines. To calculate the correct total if “Champagne” and “Pinot Grigio” are selected <strong class="emphasistypebold">(258),</strong> you can use SUMX (iterating the Customers table) and edit the “Both Wines” measure as follows:<div class="programcode" id="calibre_link-2086"><div class="calibre4"><div class="fixedline">Both Wines =</div><div class="fixedline">SUMX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Customers,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;IF (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SELECTEDVALUE ( Wines[WINE] ) = SELECTEDVALUE ( 'Wines Compare'[WINE] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[No. of Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;IF ( [No. of Sales] &amp;&amp; [Compare Wine], [No. of Sales] + [Compare Wine] )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-2087">We hope you feel inspired by these examples to create comparisons in your own data by using the <span id="calibre_link-2088">USERELATIONSHIP function</span>. And of course, you now know how to activate inactive relationships.</p></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-303" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-295" role="doc-footnote"><p class="para3" id="calibre_link-2089">To follow along with the examples, use the Power BI Desktop file “3 DAX USERELATIONSHIP.pbix”.</p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-87">
<div id="calibre_link-2090" class="calibre2">
<div id="calibre_link-2091" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-2092"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_15" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_15</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">15.&nbsp;Understanding Context Transition</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-315" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-315"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><div class="para4" id="calibre_link-2093"><blockquote class="blockquote"><p class="para10" id="calibre_link-2094"><em class="emphasistypeitalic">Nothing in life that’s worth anything is easy.</em></p><p class="para11" id="calibre_link-2095"><span class="emphasisfontcategorynonproportional">&mdash;</span>Barack Obama</p></blockquote></div><p class="para5" id="calibre_link-2096">You could also say that nothing in DAX that’s worth anything is easy. Certainly, the concept of <span id="calibre_link-2097">context transition</span> is one of the more challenging theories to get to grips with in DAX. It can’t be explained in a few short paragraphs, and therefore, we dedicate this entire chapter to teaching you the details of what context transition is and how it is used within DAX expressions. It’s only then can you move forward in the following chapter to explore some practical applications of this concept. Once you understand the purpose of context transition in your code, a whole range of challenging calculations becomes possible. In fact, most DAX expressions you meet will probably be using context transition, and indeed, there will come a time when most DAX expressions you write will use it.<sup class="calibre7"><a type="noteref" href="#calibre_link-316" id="calibre_link-354" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup></p><p class="simplepara" id="calibre_link-2098">To explain context transition in its simplest terms, it allows you to programmatically perform aggregations at the dimension, or group granularity, rather than the row granularity. For example, the expression <em class="emphasistypeitalic">“AVERAGE ( Winesales[CASES SOLD] )”</em> calculates the average cases sold across transactions. This expression, using context transition, <em class="emphasistypeitalic">“AVERAGEX ( Wines, [Total Cases] )</em>”, will calculate the average of the <span id="calibre_link-2099"><em class="emphasistypeitalic">aggregated values</em></span>, in this case, the average of the values returned by the “Total Cases” measure. Mostly, context transition happens in memory when an expression is being evaluated, and therefore, we can’t see it happening.</p><section class="section" id="calibre_link-222"><h2 class="booksubtitle">Overview of DAX Evaluations Contexts</h2><p class="simplepara" id="calibre_link-2100">To understand context transition, you must have a firm handle on how DAX expressions are evaluated. You must clearly understand the difference between filter context and row context and be able to use these concepts correctly in your code. Therefore, our starting point in this chapter will be to remind ourselves of the difference between these two conditions in which our <span id="calibre_link-2101">expressions</span> are evaluated.</p><section class="section" id="calibre_link-223"><h3 class="booksubtitle">Row Context Revisited</h3><div class="calibre4" id="calibre_link-2102">When using the <span id="calibre_link-2103">row context</span>, a DAX expression iterates every row in a table. The values used in the expression are <em class="emphasistypeitalic">the values sitting in the current row</em>, which may be different for every row. For example, the CASES SOLD value is mostly different for each row of the Winesales table, and so this calculated column<div class="programcode" id="calibre_link-2104"><div class="calibre4"><div class="fixedline">10 Percent of Cases Sold =</div><div class="fixedline">Winesales[CASES SOLD] * 0.1</div></div></div></div><p class="simplepara" id="calibre_link-2105">will iterate all the rows in the Winesales table, finding a different value for CASES SOLD on each row and multiplying it by 0.1.</p><div class="para" id="calibre_link-2106">We can categorically state therefore that all calculated columns are evaluated in the row context. But measures will also use the row context if they <em class="emphasistypeitalic">iterate a table</em>. For example, this measure (that we met when looking at the SUMX function in Chapter <span><a href="#calibre_link-95" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>5</span></a></span>)<div class="programcode" id="calibre_link-2107"><div class="calibre4"><div class="fixedline">Total Sales =</div><div class="fixedline">SUMX ( Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] * RELATED ( Wines[PRICE PER CASE] )</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-2108">is evaluated first in a filter context, for example, filtered for “Bordeaux” wine, but then the SUMX function iterates the Winesales table and using the row context multiplies the CASES SOLD value sitting in each row by the PRICE PER CASE value from the Wines table. This will be the price of the wine in the current row of the Winesales table. The SUMX function then sums the result of all these row-level calculations, for example, for “Bordeaux” wine.</p><p class="simplepara" id="calibre_link-2109">Therefore, what we can also state is that any DAX expression <em class="emphasistypeitalic">that iterates a table</em>, whether in a calculated column <em class="emphasistypeitalic">or</em> inside a measure, uses the row context.</p></section><section class="section" id="calibre_link-224"><h3 class="booksubtitle">Filter Context Revisited</h3><p class="simplepara" id="calibre_link-2110">All DAX measures are evaluated in a <span id="calibre_link-2111">filter context</span>. There are no exceptions to this rule. We understand that the filter context is typically generated from the current state of the Power BI report when the measure is evaluated, be it the structure of the visual, any slicers affecting the visual, or any filters in the Filters pane. But there is another way that the filter context can be generated, and this is what we’re now going to investigate.</p></section></section><section class="section" id="calibre_link-225"><h2 class="booksubtitle">How Row Context Becomes Filter Context</h2><p class="simplepara" id="calibre_link-2112">There is a specific situation when a DAX expression is evaluated that will turn the row context into a filter context. This is what we know as <em class="emphasistypeitalic">context transition</em>. To <span id="calibre_link-2113">understand</span> this specific situation, let’s consider these five DAX expressions, two calculated columns and three measures (you don’t need to know at this point what the expressions are calculating):</p><div class="para" id="calibre_link-2114"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2115"><strong class="emphasistypebold">Column 1 =</strong></p><p class="para12" id="calibre_link-2116">CALCULATE ( SUM ( Winesales[CASES SOLD ) )</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2117"><strong class="emphasistypebold">Column 2 =</strong></p><p class="para12" id="calibre_link-2118">[Total Cases]</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2119"><strong class="emphasistypebold">Measure 1 =</strong></p><p class="para12" id="calibre_link-2120">AVERAGEX ( Wines, [Total Cases] )</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">4.</div><div class="itemcontent"><p class="para2" id="calibre_link-2121"><strong class="emphasistypebold">Measure 2 =</strong></p><p class="para12" id="calibre_link-2122">AVERAGEX ( Wines, CALCULATE ( SUM ( Winesales[CASES SOLD] ) ) )</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">5.</div><div class="itemcontent"><p class="para2" id="calibre_link-2123"><strong class="emphasistypebold">Measure 3 =</strong></p><p class="para12" id="calibre_link-2124">CALCULATE ( [No. of Sales], FILTER (Winesales, [Total Cases] &gt; 350 ) )</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-2125">Question: What is common to all these expressions?</p><div class="para" id="calibre_link-2126">The answer is that all five expressions share the same three <span id="calibre_link-2127">attributes</span> as follows:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2128">They all use the <em class="emphasistypeitalic">CALCULATE</em> function.</p><p class="para2" id="calibre_link-2129">But surely <strong class="emphasistypebold">Column 2</strong> and <strong class="emphasistypebold">Measure 1</strong> don’t? At this point, there’s something more we need to teach you regarding measures. <em class="emphasistypeitalic">All measures implicitly invoke CALCULATE</em> even if they don’t call the function explicitly. Therefore, <strong class="emphasistypebold">Column 2</strong> and <strong class="emphasistypebold">Measure 1</strong>, which both reference the measure “Total Cases”, are both calling CALCULATE implicitly. The other expressions are using CALCULATE explicitly.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2130">They all <em class="emphasistypeitalic">iterate tables</em> creating a row context.</p><p class="para2" id="calibre_link-2131"><span id="calibre_link-2132"></span><strong class="emphasistypebold">Column 1</strong> and <strong class="emphasistypebold">Column 2</strong> are calculated columns, and all calculated columns iterate tables. We know that the functions AVERAGEX and FILTER are iterators too, so <strong class="emphasistypebold">Measure 1</strong>, <strong class="emphasistypebold">Measure 2</strong>, and <strong class="emphasistypebold">Measure 3</strong> all iterate tables, creating a row context. <strong class="emphasistypebold">Measure 1</strong> and <strong class="emphasistypebold">Measure 2</strong> iterate the Wines table, and <strong class="emphasistypebold">Measure 3</strong> iterates the Winesales table.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2133">They all invoke <em class="emphasistypeitalic">context transition</em>.</p><p class="para2" id="calibre_link-2134">This is where the row context, generated by an iteration of either a calculated column or inside a measure, is turned into a filter context.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-2135">Therefore, the specific situation to which we alluded is this: context transition occurs <span id="calibre_link-2136">whenever</span><div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-2137">The expression uses CALCULATE either explicitly or implicitly (because you’re using a measure)</p></li></ul></div></div><div class="para" id="calibre_link-2138">AND<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-2139">The expression (either in a column or in a measure) iterates a table using the row context</p></li></ul></div></div><div class="para" id="calibre_link-2140">You now understand <em class="emphasistypeitalic">when</em> context transition happens, but what exactly <em class="emphasistypeitalic">is</em> “context transition”? To answer this question, let’s first take this expression and use it in a calculated column:<div class="programcode" id="calibre_link-2141"><div class="calibre4"><div class="fixedline">Total Cases Column =</div><div class="fixedline">SUM ( Winesales[CASES SOLD] )</div></div></div></div><div class="para"><figure class="figure1" id="calibre_link-317"><div class="mediaobject" id="calibre_link-2142"><img alt="" src="images/000215.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-1</span><p class="simplepara1">The <span id="calibre_link-2143" class="calibre11">calculated column</span> returns the grand total on every row</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2144">You can see in Figure <span><a href="#calibre_link-317" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-1</a></span> that in every row, the expression returns the same value, the grand total of CASES SOLD. As a calculated column, the expression iterates the table using the row context, and therefore, there is no filter present. Aggregate functions such as SUM, by definition, require the rows to be aggregated to first be filtered. Because there is no filter on the table, this expression can only use the values from the entire table and so sums all the values for CASES SOLD.</p><div class="para" id="calibre_link-2145">We have just learned that context transition happens when there’s an iteration, <em class="emphasistypeitalic">and</em> we use CALCULATE. We can therefore now take our first look at context transition in action in a calculated column by editing our expression and wrapping CALCULATE around it:<div class="programcode" id="calibre_link-2146"><div class="calibre4"><div class="fixedline">Total Cases Column =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] )</div><div class="fixedline">)</div></div></div></div><div class="para"><figure class="figure1" id="calibre_link-318"><div class="mediaobject" id="calibre_link-2147"><img alt="" src="images/000189.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-2</span><p class="simplepara1">Using <span id="calibre_link-2148" class="calibre11">CALCULATE</span> evokes context transition in the calculated column</p></div></figcaption></figure></div><div class="para" id="calibre_link-2149">Figure <span><a href="#calibre_link-318" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-2</a></span> shows that the result of this expression returns the CASES SOLD value of each row. What has happened here is the expression iterates the table generating a row context, as do all calculated columns. But we’re also using CALCULATE in the iteration, and by doing so, the expression ignores the row context and replaces it with a filter context. Notice that although the expression uses CALCULATE, there are no filter arguments inside CALCULATE. Therefore, what is the filter being used by CALCULATE? The answer is rather a strange one (at least to new DAX users). A filter is placed on each value in each of the columns sitting in the current row. For example, in the first row of the table where the calculation returns <strong class="emphasistypebold">213</strong>, the filter is this:<div class="programcode" id="calibre_link-2150"><div class="calibre4"><div class="fixedline">SALE DATE = 01/01/2017</div><div class="fixedline">WINESALES NO = 2</div><div class="fixedline">SALESPERSON ID = 6</div><div class="fixedline">CUSTOMER ID = 16</div><div class="fixedline">WINE ID = 10</div><div class="fixedline">CASES SOLD&nbsp;&nbsp;= 213</div></div></div></div><p class="simplepara" id="calibre_link-2151">The calculated column, “Total Cases Column”, iterates the Winesales table, and because of the presence of <span id="calibre_link-2152">CALCULATE</span>, context transition occurs. All rows that share the same set of filters (as described before) are grouped and become filtered in their own right. The CASES SOLD values summed are the cases sold values sitting in each group. Because our rows are unique, each group comprises a single row, and therefore, the expression returns the same value as CASES SOLD. This is why, were you to have a duplicate first row in our example, you would see <strong class="emphasistypebold">426</strong> (213 x 2) in “Total Cases Column” because the duplicate rows would be grouped before CASES SOLD was summed.<sup class="calibre7"><a type="noteref" href="#calibre_link-319" id="calibre_link-355" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">2</a></sup> However, each of our rows is unique, so each filter generated by the context transition returns one row, which is the current row. This is an example of using CALCULATE in a calculated column where we have an iteration (and therefore a row context) and so CALCULATE evokes the context transition.</p><p class="simplepara" id="calibre_link-2153">However, context transition also happens whenever you use a <em class="emphasistypeitalic">measure</em> where there is a row context, for example, if you put a measure into a calculated column.</p><div class="formalpara" id="calibre_link-2154"><div class="heading1">Note</div><p class="para6" id="calibre_link-2155">It is recommended that you are in Data view to create the calculated columns as described in the following.</p></div><div class="calibre4" id="calibre_link-2156">This is because all measures call CALCULATE implicitly, and so context transition will also occur. For example, let’s take this measure:<div class="programcode" id="calibre_link-2157"><div class="calibre4"><div class="fixedline">Total Cases =</div><div class="fixedline">SUM ( Winesales[CASES SOLD] )</div></div></div></div><div class="para" id="calibre_link-2158">Now let’s edit our calculated column, “Total Cases Column”, to perform the same calculation (i.e., summing the CASES SOLD column) but this time expressed as the “Total Cases” measure:<div class="programcode" id="calibre_link-2159"><div class="calibre4"><div class="fixedline">Total Cases Column =</div><div class="fixedline">[Total Cases]</div></div></div></div><div class="para"><figure class="figure1" id="calibre_link-320"><div class="mediaobject" id="calibre_link-2160"><img alt="" src="images/000163.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-3</span><p class="simplepara1">Using a measure in a <span id="calibre_link-2161" class="calibre11">calculated column</span> evokes context transition</p></div></figcaption></figure></div><div class="para" id="calibre_link-2162">You will notice in Figure <span><a href="#calibre_link-320" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-3</a></span> that the results of this expression are the same as when we used CALCULATE explicitly. Therefore, these two <span id="calibre_link-2163">expressions</span><div class="programcode" id="calibre_link-2164"><div class="calibre4"><div class="fixedline">Total Cases Column =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ) )</div></div></div></div><div class="para" id="calibre_link-2165">and<div class="programcode" id="calibre_link-2166"><div class="calibre4"><div class="fixedline">Total Cases Column =</div><div class="fixedline">[Total Cases]</div></div></div></div><p class="simplepara" id="calibre_link-2167">are the <em class="emphasistypeitalic">same</em> expressions.</p><p class="simplepara" id="calibre_link-2168">At this stage in understanding context transition, I appreciate you’re thinking: Why would I want to create a calculated column that returns the same value as the value sitting in the current row? Also, our Winesales table, being the fact table, could potentially contain millions of rows, so any context transition occurring in a calculated column would be very slow. In short, what is the purpose of context transition?</p><p class="simplepara" id="calibre_link-2169">To answer this question, let’s see how context transition performs when invoked in dimension tables, rather than in the fact table. Let’s now repeat the same expressions we’ve been working with, but rather than placing them in the fact table, this time we will put them in the Wines dimension.</p><div class="para" id="calibre_link-2170">These are the calculated columns that we can create in the <span id="calibre_link-2171">Wines dimension</span>:<div class="programcode" id="calibre_link-2172"><div class="calibre4"><div class="fixedline">Wine Total Cases 1=</div><div class="fixedline">SUM ( Winesales[CASES SOLD] )</div></div><div class="calibre4"><div class="fixedline">Wine Total Cases 2 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ) )</div></div><div class="calibre4"><div class="fixedline">Wine Total Cases 3 =</div><div class="fixedline">[Total Cases]</div></div></div></div><div class="para" id="calibre_link-2173">Observing the behavior of these calculated columns in Figure <span><a href="#calibre_link-321" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-4</a></span>, let’s look more closely at the evaluation of each of these expressions.<figure class="figure1" id="calibre_link-321"><div class="mediaobject" id="calibre_link-2174"><img alt="" src="images/000015.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-4</span><p class="simplepara1">The three calculated columns in the <span id="calibre_link-2175" class="calibre11">Wines dimension</span></p></div></figcaption></figure></div><div class="para"><figure class="figure1" id="calibre_link-322"><div class="mediaobject" id="calibre_link-2176"><img alt="" src="images/000154.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-5</span><p class="simplepara1">The <span id="calibre_link-2177" class="calibre11">Wines dimension</span> is filtered by context transition</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2178">The first of these calculated columns, “Wine Total Cases 1”, uses the <em class="emphasistypeitalic">“SUM ( Winesales[CASES SOLD] )”</em> expression. There is no measure in this expression, and it’s not using CALCULATE, either implicitly or explicitly. The expression uses the SUM function that requires a filter context. In the absence of any filter, it sums the CASES SOLD values in all the rows of the Winesales table giving us the grand total of CASES SOLD.</p><p class="simplepara" id="calibre_link-2179">The second calculated column, “Wine Total Cases 2”, is using CALCULATE that converts the row context invoked by the iteration of the calculated column into a filter context. At this point, we need to remind ourselves that the filter context always propagates through the entire data model. The filter coming through from context transition behaves no differently from a filter coming through from a visual or a slicer on the report canvas. When the expression in the calculated column, “Wine Total Cases 2”, evaluates the first row of the Wines dimension, it turns the entire row into a filter and filters “Bordeaux” wine. We could imagine that in memory on the evaluation of the first row, our Wines dimension looks something like the table in Figure <span><a href="#calibre_link-322" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-5</a></span>.</p><p class="simplepara" id="calibre_link-2180">Does Figure <span><a href="#calibre_link-322" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-5</a></span> look familiar? The filter on the Wines dimension for “Bordeaux” is the same filter that would be applied if we had used a slicer or any other means by which we could filter “Bordeaux” in the report. We know that because the Wines dimension is related to the Winesales fact table in a many-to-one relationship, this filter, <em class="emphasistypeitalic">generated by context transition</em>, is propagated onward to the Winesales table. Therefore, our Winesales table is now cross-filtered to contain only “Bordeaux” wines, and the CASES SOLD values are summed accordingly.</p><p class="simplepara" id="calibre_link-2181">What we can conclude, therefore, is that a calculated column that uses CALCULATE where context transition occurs behaves just like a measure in a visual on the report canvas, in that it filters and then aggregates.</p><p class="simplepara" id="calibre_link-2182">Looking at the third calculated column, “Wine Total Cases 3”, here, we are using the “Total Cases” measure that defines the same expression as in “Wine Total Cases 2”. Because all measures implicitly call CALCULATE, “Wine Total Cases 2” and “Wine Total Cases 3” are the same expressions. Whenever you see a measure, even if it doesn’t use CALCULATE explicitly, you should always imagine that it’s wrapped inside CALCULATE.</p><p class="simplepara" id="calibre_link-2183">To summarize the outputs of the three calculated columns, “Wine Total Cases 2” and “Wine Total Cases 3” both use context transition in their evaluation, but “Wine Total Cases 1” does not.</p></section><section class="section" id="calibre_link-226"><h2 class="booksubtitle">How Context Transition Can Return “Surprising Results”</h2><p class="simplepara" id="calibre_link-2184">In our investigation of context transition, we’ve been using calculated columns to see context transition in action. However, we don’t need to see context transition to understand that it happens, and besides which, you’re probably not going to be creating these types of <span id="calibre_link-2185">calculated columns</span> in reality.</p><p class="simplepara" id="calibre_link-2186">Mostly, context transition happens behind the scenes, in memory, when you construct iterating measures <em class="emphasistypeitalic">that reference another measure</em> (because all measures implicitly call CALCULATE).</p><div class="para" id="calibre_link-2187">Let’s, at this point, remind ourselves of the specific situation where context transition occurs:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-2188">When the expression uses CALCULATE either explicitly or implicitly via a measure</p></li></ul></div></div><div class="para" id="calibre_link-2189">AND<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-2190">When the expression iterates a table using the row context</p></li></ul></div></div><p class="simplepara" id="calibre_link-2191">Typically, this is when we nest measures inside the iterating “X” aggregate functions like AVERAGEX or MAXX or we use measures inside the FILTER function. Because we can’t see context transition happening, being oblivious of its existence means we’ll struggle to understand how DAX works. Marco Russo and Alberto Ferrari in their <em class="emphasistypeitalic">The Definitive Guide to DAX</em> explain understanding context transition as follows:</p><p class="simplepara" id="calibre_link-2192"><em class="emphasistypeitalic">“Being ignorant of certain behaviors can ensure surprising results. Nevertheless, once you master the behavior, you start leveraging it as you see fit. The only difference between a strange behavior and a useful feature &ndash; at least in DAX &ndash; is your level of knowledge.”</em><sup class="calibre7"><a type="noteref" href="#calibre_link-323" id="calibre_link-356" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">3</a></sup></p><p class="simplepara" id="calibre_link-2193">Marco and Alberto talk about “strange behaviors” and “surprising results.” The only reason these behaviors would seem strange or surprising to you is that you don’t understand the behavior of context transition, the fact that in the evaluation of measures, there’s a world of difference between iterations referencing <em class="emphasistypeitalic">measures</em> that call CALCULATE and iterations referencing <em class="emphasistypeitalic">expressions</em> that do not. To illustrate this, we’re going to take a look at authoring expressions where getting it right, which is whether you nest a measure or whether you nest an expression, is key. In these examples, we’re going to see how DAX expressions can return “surprising results” unless, of course, you understand the behavior of context transition.</p><section class="section" id="calibre_link-227"><h3 class="booksubtitle">Filters Using AVERAGE</h3><p class="simplepara" id="calibre_link-2194"><span id="calibre_link-2195"></span>In the first example, we must reference an <em class="emphasistypeitalic">expression</em> in our measure to get the correct calculation; nesting the measure that defines the same expression won’t work.</p><p class="simplepara" id="calibre_link-2196">Consider the calculation to find the number of sales for each wine where cases sold is greater than the average cases sold for that wine. For example, the average number of cases sold for “Bordeaux” is <strong class="emphasistypebold">300</strong> and we want to calculate how many sales of “Bordeaux” have cases sold greater than this value (this is purely an intellectual exercise and not a particularly useful calculation).</p><div class="para" id="calibre_link-2197">We’ve already created these two measures:<div class="programcode" id="calibre_link-2198"><div class="calibre4"><div class="fixedline">Avg Cases =</div><div class="fixedline">AVERAGE ( Winesales[CASES SOLD] )</div></div><div class="calibre4"><div class="fixedline">No. of Sales =</div><div class="fixedline">COUNTROWS ( Winesales )</div></div></div></div><div class="para" id="calibre_link-2199">Now to calculate the number of sales where the CASES SOLD value is greater than the average cases, we could author this measure:<div class="programcode" id="calibre_link-2200"><div class="calibre4"><div class="fixedline">No. Of Sales GT Avg #1=</div><div class="fixedline">VAR AvgCasesTable =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[CASES SOLD] &gt; [Avg Cases] )</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [No. Of Sales], AvgCasesTable )</div></div></div></div><p class="simplepara" id="calibre_link-2201">Note the use of the “Avg Cases” <em class="emphasistypeitalic">measure</em> (highlighted) nested in the FILTER expression that iterates the Winesales table. We know that in the presence of a nested measure inside an iteration, context transition is invoked.</p><div class="para" id="calibre_link-2202">Unfortunately, the “No. Of Sales GT Avg #1” measure does not return the correct results; it returns blanks. This is a surprising result, I think you’ll agree; see Figure <span><a href="#calibre_link-324" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-6</a></span>.<figure class="figure1" id="calibre_link-324"><div class="mediaobject" id="calibre_link-2203"><img alt="" src="images/000038.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-6</span><p class="simplepara1">The “No. Of Sales GT Avg #1” does not return a value</p></div></figcaption></figure></div><div class="para" id="calibre_link-2204">Clearly, we must take a closer look at what’s happening here. This measure, “No. Of Sales GT Avg #1”, uses the FILTER function that iterates the Winesales table to filter rows where the CASES SOLD value is greater than the value calculated by the “Avg Cases” measure. But what is the value calculated by “Avg Cases”? If we put this measure, that is, <em class="emphasistypeitalic">“[Avg Cases]”</em>, into the Winesales table as a calculated column, we can see what the FILTER function is testing the CASES SOLD value against; see Figure <span><a href="#calibre_link-325" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-7</a></span>.<figure class="figure1" id="calibre_link-325"><div class="mediaobject" id="calibre_link-2205"><img alt="" src="images/000180.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-7</span><p class="simplepara1">The “Avg Cases” measure evaluated in a calculated column filters the Winesales table to the single row that’s being evaluated</p></div></figcaption></figure></div><div class="formalpara" id="calibre_link-2206"><div class="heading1">Note</div><p class="para6" id="calibre_link-2207">Remember that in the first evaluation in the Table visual in Figure <span><a href="#calibre_link-324" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre">15-6</a></span>, the Winesales table will be cross-filtered in memory for “Bordeaux” wine, which is WINE ID 1.</p></div><p class="simplepara" id="calibre_link-2208">What we find is that the values returned by “Avg Cases” are the same as the CASES SOLD values. This is because “Avg Cases” is a measure, and therefore, it evokes context transition as FILTER iterates the Winesales table. This creates a filter on each row of the Winesales table that’s being evaluated in memory. Because each row is unique, it calculates the average of the CASES SOLD value only for the current row, which is the same as the CASES SOLD value. Therefore, the “Avg Cases” value is never greater than the CASES SOLD value. You could test this by changing “&gt;” to “&gt;=” where instead of blanks being returned, you would get the same values as “No. of Sales”.</p><div class="para" id="calibre_link-2209">Let’s now replace the measure inside the FILTER function with an expression (highlighted) that calculates the average:<div class="programcode" id="calibre_link-2210"><div class="calibre4"><div class="fixedline">No. Of Sales GT Avg #2 =</div><div class="fixedline">VAR AvgCasesTable =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[CASES SOLD] &gt;</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AVERAGE ( Winesales[CASES SOLD] ) )</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [No. Of Sales], AvgCasesTable )</div></div></div></div><div class="para" id="calibre_link-2211">This time we get the correct results; see Figure <span><a href="#calibre_link-326" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-8</a></span>.<figure class="figure1" id="calibre_link-326"><div class="mediaobject" id="calibre_link-2212"><img alt="" src="images/000257.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-8</span><p class="simplepara1">Using a nested expression inside FILTER and not a nested measure returns the correct results</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2213">To understand why the second version of the measure using the expression works, we can again put the expression, <em class="emphasistypeitalic">“AVERAGE ( Winesales[CASES SOLD] )”</em>, into a calculated column in the Winesales table, filtered for “Bordeaux” wines (as this is the in-memory cross-filter on the Winesales table in the first evaluation).</p><p class="simplepara" id="calibre_link-2214">We can see in Figure <span><a href="#calibre_link-327" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-9</a></span> that the expression returns the average of the cases sold for the wine in the current filter context.</p><div class="formalpara" id="calibre_link-2215"><div class="heading1">Note</div><p class="para6" id="calibre_link-2216">In Figure <span><a href="#calibre_link-327" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre">15-9</a></span>, we are simulating the rows in the Winesales table that would be visible in the current filter <em class="emphasistypeitalic">in memory</em>, which you will not be able to see in Data view. Therefore, when you put <em class="emphasistypeitalic">“AVERAGE ( Winesales[CASES SOLD] )”</em> into a calculated column, you will see the average for all transactions (<strong class="emphasistypebold">192</strong>), not just those for “Bordeaux” <strong class="emphasistypebold">(300)</strong>.</p></div><div class="calibre4"><figure class="figure1" id="calibre_link-327"><div class="mediaobject" id="calibre_link-2217"><img alt="" src="images/000023.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-9</span><p class="simplepara1">The “AVERAGE ( Winesales[CASESSOLD] )” expression evaluated in a calculated column returns the average cases for each wine</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2218">We know that the average number of cases sold for “Bordeaux” is <strong class="emphasistypebold">300</strong>. So in the first evaluation for “Bordeaux”, there are <strong class="emphasistypebold">89</strong> transactions where cases sold is greater than <strong class="emphasistypebold">300</strong>.</p><p class="simplepara" id="calibre_link-2219">We can understand therefore that despite the fact that the expression and the measure both calculate the same average, we must nest the average <em class="emphasistypeitalic">expression</em> inside the measure being evaluated, not nest the <em class="emphasistypeitalic">measure</em> that calculates the average.</p></section><section class="section" id="calibre_link-228"><h3 class="booksubtitle">Filters Using MAX</h3><div class="calibre4" id="calibre_link-2220">In our second example of how DAX can return “surprising results,” we will calculate cumulative <span id="calibre_link-2221">totals</span>, as shown in Figure <span><a href="#calibre_link-328" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-10</a></span>.<figure class="figure1" id="calibre_link-328"><div class="mediaobject" id="calibre_link-2222"><img alt="" src="images/000047.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-10</span><p class="simplepara1">Calculating cumulative totals in the “Cumulative Total” measure</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2223">To generate the “Cumulative Total” measure, we must again use a nested expression in the parent measure, not a nested measure, and this time we’ll be using the aggregate function, MAX.</p><div class="formalpara" id="calibre_link-2224"><div class="heading1">Note</div><p class="para6" id="calibre_link-2225">We’ve calculated cumulative totals before using the time intelligence function, DATESBETWEEN. However, in this section, we explore an alternative method of achieving the same result.</p></div><div class="calibre4" id="calibre_link-2226">To calculate <span id="calibre_link-2227">cumulative totals</span> in the Table visual in Figure <span><a href="#calibre_link-328" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-10</a></span>, for any given date in the current filter context, we must sum a value (in our example, the total sales value) up to the latest date in the current filter context. For example, if “May 2017” is the current filter, we must sum values up to and including <strong class="emphasistypebold">31 May 2017</strong>. We might think, therefore, that we need to first construct a measure that finds the latest date in the current filter context using the MAX function like so:<div class="programcode" id="calibre_link-2228"><div class="calibre4"><div class="fixedline">Max Date =</div><div class="fixedline">MAX ( DateTable[DATEKEY] )</div></div></div></div><div class="para" id="calibre_link-2229">We could then use this “Max Date” measure (highlighted) in the following expression (note the use of ALL to remove the filter on the DateTable that is currently filtering each month):<div class="programcode" id="calibre_link-2230"><div class="calibre4"><div class="fixedline">Cumulative Total Wrong =</div><div class="fixedline">VAR FilteredDatesTable =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL ( DateTable ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateTable[DATEKEY] &lt;= [Max Date]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [Total Sales], FilteredDatesTable )</div></div></div></div><div class="para" id="calibre_link-2231">Looking at the result of this expression in the visual in Figure <span><a href="#calibre_link-329" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-11</a></span>, clearly, this hasn’t worked.<figure class="figure1" id="calibre_link-329"><div class="mediaobject" id="calibre_link-2232"><img alt="" src="images/000078.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-11</span><p class="simplepara1">The “Cumulative Total Wrong” measure returns incorrect results</p></div></figcaption></figure></div><div class="para" id="calibre_link-2233">Let’s take a look at what’s going wrong with “Cumulative Total Wrong”. Here, we’re using the measure “Max Date”, which defines the maximum date. The FILTER function with ALL generates a virtual DateTable containing all the rows in the DateTable. It then iterates this virtual table to compare each date in the DATEKEY column to the date calculated by “Max Date”. What is the value of “Max Date”? The “Max Date” measure evokes context transition and so filters each row to a single row. Therefore, when iterating the DateTable, it will always return the same date that is sitting in the current row of the DateTable. To understand this, we can put the “Max Date” measure into a calculated column in the DateTable as shown in Figure <span><a href="#calibre_link-330" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-12</a></span>.<figure class="figure1" id="calibre_link-330"><div class="mediaobject" id="calibre_link-2234"><img alt="" src="images/000250.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-12</span><p class="simplepara1">The “Max Date” measure evaluated in a calculated column filters the DateTable to the single row that’s being evaluated</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2235">Because DATEKEY is always <em class="emphasistypeitalic">equal to</em> “Max Date”, all the dates are filtered by the FILTER function, and so CALCULATE calculates the total cases for all dates (to see this in another way, try replacing the “&lt;=” with “&lt;” where you will now get blanks returned).</p><div class="para" id="calibre_link-2236">Therefore, to remedy this, we must use an expression (highlighted) to calculate the latest date in the current filter context, and this is the correct measure:<div class="programcode" id="calibre_link-2237"><div class="calibre4"><div class="fixedline">Cumulative Total =</div><div class="fixedline">VAR FilteredDatesTable =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALL ( DateTable ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateTable[DATEKEY] &lt;= MAX ( DateTable[DATEKEY] )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [Total Sales], FilteredDatesTable )</div></div></div></div><div class="para" id="calibre_link-2238">In this measure, the FILTER function with ALL iterates the virtual DateTable table to compare each date in the DATEKEY column to the date calculated by the expression <em class="emphasistypeitalic">“MAX ( DateTable[DATEKEY )”.</em> This expression will find the latest date in the current filter context; for example, it will return <strong class="emphasistypebold">31 May 2017</strong> when evaluating “May 2017”; see Figure <span><a href="#calibre_link-331" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-13</a></span>.<figure class="figure1" id="calibre_link-331"><div class="mediaobject" id="calibre_link-2239"><img alt="" src="images/000115.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-13</span><p class="simplepara1">The MAX expression evaluated in a calculated column returns the maximum date for the month in the current filter</p></div></figcaption></figure></div><div class="formalpara" id="calibre_link-2240"><div class="heading1">Note</div><p class="para6" id="calibre_link-2241">In Figure <span><a href="#calibre_link-331" class="pcalibre4 pcalibre2 calibre6 pcalibre6 pcalibre3 pcalibre">15-13</a></span>, we’re again simulating the rows in the DateTable that would be visible in memory in the current filter. You cannot see in-memory filters in Data view. Therefore, if you put the <em class="emphasistypeitalic">“MAX ( DateTable[DATEKEY )”</em> expression into a calculated column in the DateTable, you will see the last date for <em class="emphasistypeitalic">all dates</em>, that is, <strong class="emphasistypebold">31 December 2021</strong>.</p></div><p class="simplepara" id="calibre_link-2242">The FILTER function will compare every date in the DATEKEY column of the virtual DateTable to the date calculated by <em class="emphasistypeitalic">“MAX ( DateTable[DATEKEY )”</em> and therefore will filter all the dates that are before or equal to this date.</p></section><section class="section" id="calibre_link-229"><h3 class="booksubtitle">Filters Using Measures</h3><div class="calibre4" id="calibre_link-2243">In the last of our “surprising results” examples, we must use a <span id="calibre_link-2244">measure</span> and not an expression. For example, it could transpire that you want to calculate the number of transactions where the “Total Sales” value for each transaction is greater than $10,000. To remind you, this is the expression that is used in the “Total Sales” measure:<div class="programcode" id="calibre_link-2245"><div class="calibre4"><div class="fixedline">Total Sales =</div><div class="fixedline">SUMX ( Winesales, Winesales[CASES SOLD] *</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RELATED ( Wines[PRICE PER CASE] )</div></div></div></div><div class="para" id="calibre_link-2246">You may be tempted to use this expression (highlighted) to calculate the number of sales that are greater than $10,000:<div class="programcode" id="calibre_link-2247"><div class="calibre4"><div class="fixedline">No. Of Sales GT 10,000 #1=</div><div class="fixedline">VAR MySales =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUMX ( Winesales, Winesales[CASES SOLD] *</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RELATED ( Wines[PRICE PER CASE] ) )</div><div class="fixedline">VAR SalesTable =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, MySales &gt; 10000 )</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [No. Of Sales], SalesTable )</div></div></div></div><div class="para" id="calibre_link-2248">However, as you can appreciate from Figure <span><a href="#calibre_link-332" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-14</a></span>, this measure returns the number of sales, not the number greater than $10,000.<figure class="figure1" id="calibre_link-332"><div class="mediaobject" id="calibre_link-2249"><img alt="" src="images/000039.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-14</span><p class="simplepara1">The “No. Of Sales GT 10,000” measure does not return the correct result</p></div></figcaption></figure></div><div class="para" id="calibre_link-2250">In the “No. Of Sales GT $10,000 #1” measure, we are using SUMX to calculate the total sales. However, the SUMX expression would sum the total sales for all transactions in the Winesales table for each wine in the current filter context, giving us the grand total of “Total Sales” for each wine. In Figure <span><a href="#calibre_link-333" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-15</a></span>, the SUMX expression has been placed into a calculated column in the Winesales table to understand its return value in memory (only showing total sales for “Bordeaux”), which is the total sales for the wine, not the total sales for each transaction. When FILTER iterates the Winesales table, this value will always be greater than $10,000.<figure class="figure1" id="calibre_link-333"><div class="mediaobject" id="calibre_link-2251"><img alt="" src="images/000224.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-15</span><p class="simplepara1">The <span id="calibre_link-2252" class="calibre11">SUMX expression</span> evaluated in a calculated column returns the grand total sales for the wine in the current filter</p></div></figcaption></figure></div><div class="para" id="calibre_link-2253">When we write the expression to find the number of sales greater than $10,000, we must therefore use the “Total Sales” <em class="emphasistypeitalic">measure</em> (highlighted) inside FILTER as follows:<div class="programcode" id="calibre_link-2254"><div class="calibre4"><div class="fixedline">No. Of Sales GT 10,000 #2 =</div><div class="fixedline">VAR MyTable =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, [Total Sales] &gt; 10000 )</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [No. Of Sales], MyTable )</div></div></div></div><div class="para" id="calibre_link-2255">As you can now see in Figure <span><a href="#calibre_link-334" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-16</a></span>, the “No. Of Sales GT 10,000 #2” measure using the nested measure “Total Sales” returns the correct value.<figure class="figure1" id="calibre_link-334"><div class="mediaobject" id="calibre_link-2256"><img alt="" src="images/000172.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-16</span><p class="simplepara1">Using a nested measure inside FILTER and not an expression returns the correct results for the number of sales greater than $10,000</p></div></figcaption></figure></div><div class="para" id="calibre_link-2257">We must again investigate the reason why our second attempt at this calculation using the nested measure works. If we put the “Total Sales” measure into a calculated column, this will reveal what FILTER returns when it iterates the Winesales table in memory. We can see that it is the total sales for each transaction because it’s using context transition to filter each row in memory; see Figure <span><a href="#calibre_link-335" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-17</a></span>.<figure class="figure1" id="calibre_link-335"><div class="mediaobject" id="calibre_link-2258"><img alt="" src="images/000181.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-17</span><p class="simplepara1">The “<span id="calibre_link-2259" class="calibre11">Total Cases</span>” measure evaluated in a calculated column filters the Winesales table to the single row that’s being evaluated</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2260">When FILTER iterates the Winesales table, it can use this value to find values greater than $10,000.</p><p class="simplepara" id="calibre_link-2261">I think we’ve made our point regarding the “surprising results” to which Marco Russo and Alberto Ferrari alluded, and in doing so, you now understand the concept of context transition. This is where the row context is transitioned into a filter context because of the presence of CALCULATE within an iteration, and these filters propagate through the data model, just as all filters do. No matter how long you’ve been using DAX, these are challenging calculations to get your head around. In what follows in this chapter, we’ll explore why it’s so important that you take up the challenge to understand the strange behaviors and surprising results that context transition throws at you because in doing so, you will begin to reap the real benefits of using DAX.</p></section></section><section class="section" id="calibre_link-230"><h2 class="booksubtitle">Aggregating Totals Using Context Transition</h2><p class="simplepara" id="calibre_link-2262">The power of context transition comes when you use it to calculate averages, maximums, and minimums of totals as opposed to row-level values, and in this section, we will be exploring why this is mandatory knowledge in advanced calculations. This is also where the importance of having clearly defined dimension tables comes to the fore because to achieve this type of calculation, we will be passing context transition across dimension tables both real and virtual. What you will discover in the following section is that context transition can just as equally be passed into virtual tables generated by table expressions as it can be passed into actual dimensions within the data model.</p><section class="section" id="calibre_link-231"><h3 class="booksubtitle">Aggregating in Dimensions</h3><p class="simplepara" id="calibre_link-2263"><span id="calibre_link-2264">We</span> will begin by exploring how context transition works when used in expressions that reference dimension tables.</p><div class="para" id="calibre_link-2265">For example, take this simple measure:<div class="programcode" id="calibre_link-2266"><div class="calibre4"><div class="fixedline">Max Cases =</div><div class="fixedline">MAX ( Winesales[CASES SOLD] )</div></div></div></div><p class="simplepara" id="calibre_link-2267">The “Max Cases” measure can tell us the maximum number of cases in any single transaction in the Winesales table for each wine. For example, for “Bordeaux”, the maximum number of cases sold in any single transaction is <strong class="emphasistypebold">500</strong> cases. This is a row-level calculation, but this is not what we want.</p><div class="para" id="calibre_link-2268">This measure, we know, will sum the cases sold values in the Winesales table:<div class="programcode" id="calibre_link-2269"><div class="calibre4"><div class="fixedline">Total Cases =</div><div class="fixedline">SUM ( Winesales[CASES SOLD] )</div></div></div></div><div class="para" id="calibre_link-2270">Our goal here is to calculate the maximum of this “Total Cases” measure, not the maximum of the individual transactions, as shown in Figure <span><a href="#calibre_link-336" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-18</a></span>.<figure class="figure1" id="calibre_link-336"><div class="mediaobject" id="calibre_link-2271"><img alt="" src="images/000063.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-18</span><p class="simplepara1">The “Max Cases” measure is a <span id="calibre_link-2272" class="calibre11">row-level calculation</span>, but we want to calculate across totals</p></div></figcaption></figure></div><div class="para" id="calibre_link-2273">To do this, we need to use context transition. We know that context transition happens when a measure is iterated over a table. We looked earlier at creating a calculated column in the Wines dimension (“Wine Total Cases 3”) that used the measure “Total Cases” to evoke context transition and so found the total cases sold value for each wine in the Wines dimension; see Figure <span><a href="#calibre_link-337" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-19</a></span>.<figure class="figure1" id="calibre_link-337"><div class="mediaobject" id="calibre_link-2274"><img alt="" src="images/000198.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-19</span><p class="simplepara1">Creating a calculated column in the Wines dimension using the “Total Cases” measure evokes context</p></div></figcaption></figure></div><div class="para" id="calibre_link-2275">Rather than putting this measure into a calculated column to witness the context transition, we could nest this measure <em class="emphasistypeitalic">in another measure</em> using MAXX, and this will iterate the Wines dimension, just as the calculated column does. If we do this, context transition will happen in memory, and we can find the maximum of the values that you can see in the calculated column. Let’s now author this measure:<div class="programcode" id="calibre_link-2276"><div class="calibre4"><div class="fixedline">Max of Totals =</div><div class="fixedline">MAXX ( Wines, [Total Cases] )</div></div></div></div><p class="simplepara" id="calibre_link-2277">The MAXX function iterates the Wines dimension in memory to calculate the “Total Cases” <em class="emphasistypeitalic">measure</em> for every row in the dimension, just like the calculated column in Figure <span><a href="#calibre_link-337" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-19</a></span>. It then finds the maximum of these values.</p><div class="formalpara" id="calibre_link-2278"><div class="heading1">Note</div><p class="para6" id="calibre_link-2279">We are using the MAXX function here because it’s clearer to understand the evaluation &ndash; you can easily see which value is the largest. However, the AVERAGEX function would work better because you must calculate the average of the totals to know what that value is.</p></div><div class="calibre4" id="calibre_link-2280">However, when this measure is placed in the Table visual in Figure <span><a href="#calibre_link-338" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-20</a></span>, why does it return the same result as the “Total Cases” measure in all rows except in the Total row, where the value is correct?<figure class="figure1" id="calibre_link-338"><div class="mediaobject" id="calibre_link-2281"><img alt="" src="images/000108.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-20</span><p class="simplepara1">“Max of Totals” measure is correct in the Total row, which is 54,070, the cases sold for “Bordeaux”</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2282">Let’s now answer this question. In this Table visual, the first evaluation is for “Bordeaux” wine, and so in the current filter, there is only one value for “Total Cases”, and that is the value of the total cases for “Bordeaux”. The maximum of only one value is that value, and that is why we see the same value for “Total Cases” and for “Max of Totals”. It’s not until the measure reaches the evaluation of the Total row, where there is no filter on the Wines dimension, that it can then find the maximum of all the wines, which is <strong class="emphasistypebold">54,070</strong> for “Bordeaux”.</p><div class="para" id="calibre_link-2283">What is important to emphasize here is that context transition always works within filters placed on the data model. For example, if we add a Salesperson slicer to the canvas and filter “Abel”, we can now see the maximum cases for “Abel” (<strong class="emphasistypebold">10,993</strong>). Because the Winesales fact table is now filtered for “Abel’s” sales, context transition now calculates these values in the new filter context; see Figure <span><a href="#calibre_link-339" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-21</a></span>.<figure class="figure1" id="calibre_link-339"><div class="mediaobject" id="calibre_link-2284"><img alt="" src="images/000241.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-21</span><p class="simplepara1">The “Max of Totals” measure calculated in a different filter context</p></div></figcaption></figure></div><div class="para" id="calibre_link-2285">However, because the “Max of Totals” measure returns the same value as “Total Cases” for each of the wines, the “Max of Totals” measure does not really work in a visual that filters the wine names. This measure is more fitting when placed in a visual that filters a different dimension. In Figure <span><a href="#calibre_link-340" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-22</a></span>, we have used the “Max of Totals” measure in a Matrix and a Table visual that shows the maximum value for each salesperson. We have focused on the maximum cases value for “Abel”, which is <strong class="emphasistypebold">10,993</strong> for “Champagne”. We’ve also placed this measure in a Card visual to show the maximum for all wines.<figure class="figure1" id="calibre_link-340"><div class="mediaobject" id="calibre_link-2286"><img alt="" src="images/000005.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-22</span><p class="simplepara1">The “Max of Totals” measure works better if placed in visuals that filter dimensions other than the Wines dimension</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2287">Let’s now consider another scenario. Rather than calculating the maximum of the total cases, perhaps you want to programmatically identify which wine has the maximum total (“Bordeaux” in our case).</p><div class="para" id="calibre_link-2288">In this situation, for the evaluation of each wine, we must calculate the maximum of the totals for all the wines. We can then compare the maximum against each wine’s total. Therefore, we must remove the filter from the Wines dimension by using ALL or ALLSELECTED as in this example:<div class="programcode" id="calibre_link-2289"><div class="calibre4"><div class="fixedline">Max of Totals #2 =</div><div class="fixedline">MAXX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( Wines )&nbsp;, [Total Cases] )</div></div></div></div><p class="simplepara" id="calibre_link-2290">In this measure, we are using ALL to generate a virtual table containing all the rows in the Wines dimension, and therefore, MAXX will iterate all the rows in this temporary table. Context transition calculates the total cases for every row, and MAXX finds the largest of these. If you have a slicer filtering the wines, you must use ALLSELECTED which will output to a virtual table containing the wines filtered in the slicer.</p><div class="para" id="calibre_link-2291">We can now write the measure that specifically returns the name of the wine that has the maximum cases sold, using the expression in the “Max of Totals #2” measure as a variable:<div class="programcode" id="calibre_link-2292"><div class="calibre4"><div class="fixedline">Wine with Max =</div><div class="fixedline">VAR MyMax =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;MAXX ( ALL ( Wines ), [Total Cases] )</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( VALUES (Wines[WINE] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Wines, [Total Cases] = MyMax ) )</div></div></div></div><div class="para" id="calibre_link-2293">Note the use of the VALUES function to return the name of the wine that will be filtered according to the filter expression.<figure class="figure1" id="calibre_link-341"><div class="mediaobject" id="calibre_link-2294"><img alt="" src="images/000139.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-23</span><p class="simplepara1">The “Max of Totals #2” returns the maximum value for all wines. We can then use this expression to find the wine that has the maximum</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2295">You can see the results of these measures in Figure <span><a href="#calibre_link-341" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-23</a></span>. Note how we use the “Wine with Max” measure in a Card visual that displays the scalar value returned by VALUES.</p><p class="simplepara" id="calibre_link-2296">In the preceding examples, we’re using ALL to generate a virtual table containing all the rows and all the columns in the Wines dimension. We’ll see in the next section that we could equally use ALL to generate a virtual table containing only the WINE column.</p></section><section class="section" id="calibre_link-232"><h3 class="booksubtitle">Aggregating in Virtual Tables</h3><p class="simplepara" id="calibre_link-2297">So far, we’ve looked at finding the maximum of the total values using context transition with a dimension table. We then used ALL to generate a <span id="calibre_link-2298">virtual</span> Wines dimension to find the maximum of the totals of all the wines. Therefore, we know that context transition can be generated in virtual tables too. We are now ready to explore examples of using ALL to build virtual tables that contain only the columns that we require for the expression, not all the columns in the table. Because ALL will return a table containing a column or columns of distinct values, we are essentially using ALL to group our data so that context transition can calculate totals across these ad hoc groups.</p><section class="section" id="calibre_link-2299"><h4 class="heading2">Using ALL to Group Columns in the Same Table</h4><div class="calibre4" id="calibre_link-2300">For example, we’ve been asked to calculate the variance between the total sales for each wine and the average of these totals. Consider the following measure that uses context transition to find the average of “Total Sales” for our wines. However, this time we’re using the <span id="calibre_link-2301">ALL function</span><span id="calibre_link-2302"></span> on the WINE column rather than ALL on the Wines table:<div class="programcode" id="calibre_link-2303"><div class="calibre4"><div class="fixedline">Average of Totals =</div><div class="fixedline">AVERAGEX ( ALL ( Wines[WINE] ), [Total Sales] )</div></div></div></div><p class="simplepara" id="calibre_link-2304">As mentioned before, depending on the filters in your report, you may need to use ALLSELECTED in place of ALL.</p><div class="para" id="calibre_link-2305">Let’s look at the three steps in the evaluation of this measure:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2306">The ALL function creates a virtual table comprising a single column holding a list of unique values in the WINE column.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2307">AVERAGEX then iterates the virtual table and using context transition calculates the “Total Sales” measure for each of the wines in the virtual table generated by ALL.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2308">AVERAGEX finds the average of these values.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-2309">In Figure <span><a href="#calibre_link-342" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-24</a></span>, you can see the virtual table generated by ALL and how the average of the total values is calculated.<figure class="figure1" id="calibre_link-342"><div class="mediaobject" id="calibre_link-2310"><img alt="" src="images/000225.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-24</span><p class="simplepara1">The ALL function creates a virtual one-column table of the WINE column. The table is iterated by AVERAGEX, and context transition calculates the “Total Sales” for each row. AVERAGEX finds the average of these values</p></div></figcaption></figure></div><div class="para" id="calibre_link-2311">Now we can edit this measure to calculate how each wine’s total sales vary from the average and visualize the data; see Figure <span><a href="#calibre_link-343" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-25</a></span>.<div class="programcode" id="calibre_link-2312"><div class="calibre4"><div class="fixedline">Variance from Average of Totals =</div><div class="fixedline">VAR AvgOfTotals =</div><div class="fixedline">&nbsp;&nbsp;AVERAGEX ( ALL ( Wines[WINE] ), [Total Sales] )</div><div class="fixedline">RETURN</div><div class="fixedline">[Total Sales] -&nbsp;&nbsp;AvgOfTotals</div></div></div></div><div class="para"><figure class="figure1" id="calibre_link-343"><div class="mediaobject" id="calibre_link-2313"><img alt="" src="images/000129.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-25</span><p class="simplepara1">Using context transition to calculate the average of the totals and then we can find the variance</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2314">Here, we have been using ALL to group by values in the WINE column. Indeed, we could use ALL to group by salespeople, customers, or regions by generating tables containing just a list of the names of the entities in these dimensions accordingly.</p><div class="para" id="calibre_link-2315">However, if we want to pass context transition into the DateTable, it becomes a little more problematic. For example, the expression<div class="programcode" id="calibre_link-2316"><div class="calibre4"><div class="fixedline">Average Daily Sales For Dates =</div><div class="fixedline">AVERAGEX (DateTable, [Total Sales])</div></div></div></div><div class="para" id="calibre_link-2317">would pass context transition to every row in the DateTable, therefore aggregating the total sales for each day. Therefore, this measure would calculate the average daily sales. However, this may not be the date granularity in which you are interested. Perhaps you would like to calculate the average quarterly sales in each year, as shown in Figure <span><a href="#calibre_link-344" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-26</a></span>. Here, we have authored the measure “Average Quarterly for Each Year” and placed this in a Matrix visual. Note that this measure works best if the visual only shows the YEAR column from the DateTable.<figure class="figure1" id="calibre_link-344"><div class="mediaobject" id="calibre_link-2318"><img alt="" src="images/000240.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-26</span><p class="simplepara1">The “Average Quarterly for Each Year” measure works best in a Matrix visual that only shows years</p></div></figcaption></figure></div><div class="para" id="calibre_link-2319">In the <span id="calibre_link-2320">Matrix visuals</span> in Figure <span><a href="#calibre_link-344" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-26</a></span>, on the evaluation sales in “2017”, there is a filter on the YEAR column in the DateTable. We must now generate a virtual one-column table that retains the filter on the YEAR column but lists all four quarters in that year, and we can use the ALL function to do that, referencing the QTR column. AVERAGEX can then iterate this table and using context transition can calculate the total sales for each of the quarters in “2017”, finding the average of these values. This is the code we have used in the measure:<div class="programcode" id="calibre_link-2321"><div class="calibre4"><div class="fixedline">Average Quarterly for Each Year =</div><div class="fixedline">AVERAGEX ( ALL ( DateTable[QTR] ), [Total Sales] )</div></div></div></div><div class="para" id="calibre_link-2322">The virtual table generated by ALL in the evaluation of the “2017” average would look like Figure <span><a href="#calibre_link-345" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-27</a></span>.<figure class="figure1" id="calibre_link-345"><div class="mediaobject" id="calibre_link-2323"><img alt="" src="images/000085.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-27</span><p class="simplepara1">The ALL function builds a table containing all the quarters in the filtered year</p></div></figcaption></figure></div><div class="para" id="calibre_link-2324">The ALL function can also generate virtual tables comprising unique <em class="emphasistypeitalic">combinations</em> of columns from the same table to enable you to group by these combinations. For example, you could generate a virtual table using ALL containing a distinct list of years and quarters from the DateTable using this table expression:<div class="programcode" id="calibre_link-2325"><div class="calibre4"><div class="fixedline">ALL ( DateTable[YEAR], DateTable[QTR] )</div></div></div></div><div class="para" id="calibre_link-2326">Such a virtual table generated by ALL is shown in Figure <span><a href="#calibre_link-346" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-28</a></span>.<figure class="figure1" id="calibre_link-346"><div class="mediaobject" id="calibre_link-2327"><img alt="" src="images/000022.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-28</span><p class="simplepara1">Using ALL referencing multiple columns from the same table generates a table containing the distinct combination of those values</p></div></figcaption></figure></div><div class="para" id="calibre_link-2328">Using context transition and the ALL expression that generates the table in Figure <span><a href="#calibre_link-346" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-28</a></span>, you could find the average quarterly total sales across all years as in this measure:<div class="programcode" id="calibre_link-2329"><div class="calibre4"><div class="fixedline">Average Quarterly for All Years =</div><div class="fixedline">AVERAGEX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;ALL ( DateTable[YEAR], DateTable[QTR] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;[Total Sales] )</div></div></div></div><div class="para" id="calibre_link-2330">Here, the ALL function creates an in-memory table that generates a distinct list combining the YEAR column and the QTR column, and then AVERAGEX, using context transition, finds the average of the “Total Sales” values; see Figure <span><a href="#calibre_link-347" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-29</a></span>.<figure class="figure1" id="calibre_link-347"><div class="mediaobject" id="calibre_link-2331"><img alt="" src="images/000093.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-29</span><p class="simplepara1">The ALL function generates a virtual table containing the distinct combination of values from multiple columns from the same table. Context transition can be passed to this table to calculate averages</p></div></figcaption></figure></div><div class="para" id="calibre_link-2332">We can appreciate that viewing this measure in a Matrix comprising the YEAR and QTR columns, where the values returned are repeated, will not do much for people viewing your report. Just as in the “Max of Totals” measure before, the “Average Quarterly for All Years” measure works best when you have no filter on the DateTable as in Figure <span><a href="#calibre_link-348" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-30</a></span>.<figure class="figure1" id="calibre_link-348"><div class="mediaobject" id="calibre_link-2333"><img alt="" src="images/000071.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-30</span><p class="simplepara1">The “Average Quarterly for All Years” measure works well when analyzing entities other than those from the DateTable</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2334">Here, we are analyzing our salespeople’s sales performance by comparing their average quarterly total sales value.</p></section><section class="section" id="calibre_link-2335"><h4 class="heading2">Using SUMMARIZE to Group Columns from Related Tables</h4><p class="simplepara" id="calibre_link-2336">We can normally use ALL or ALLSELECTED to group columns into virtual tables so we can perform calculations across ad hoc groups using context transition. It’s only occasionally that you will require another function called <span id="calibre_link-2337">SUMMARIZE</span><span id="calibre_link-2338"></span> to do this job, and that’s when you need to group columns from <em class="emphasistypeitalic">different</em> tables.</p><p class="simplepara" id="calibre_link-2339">The SUMMARIZE function allows you to retrieve combinations of columns from the same table or from <em class="emphasistypeitalic">one or more related tables</em>. As we’ve seen before, we can usually use ALL to group columns from the same table, so SUMMARIZE normally need only be used to group columns from different related tables.</p><p class="simplepara" id="calibre_link-2340">The SUMMARIZE function has the following <span id="calibre_link-2341">syntax</span>:</p><p class="para9" id="calibre_link-2342"><strong class="emphasistypebold">= SUMMARIZE ( table, group by column1, group by column2 etc., name, expression )</strong></p><p class="para9" id="calibre_link-2343">where:</p><p class="simplepara" id="calibre_link-2344"><strong class="emphasistypebold">table</strong> is the table or table expression containing the columns you want to group by.</p><p class="simplepara" id="calibre_link-2345"><strong class="emphasistypebold">group by columns</strong> are the columns by which you want to group your data. These can be columns from the same table or from related tables.</p><p class="simplepara" id="calibre_link-2346"><strong class="emphasistypebold">name</strong> (optional) is the name of the expression you want to generate in the expression argument later. This is a nonmandatory argument.</p><p class="simplepara" id="calibre_link-2347"><strong class="emphasistypebold">expression</strong> (optional) is an expression that will be calculated for every row in the virtual table. This is a nonmandatory argument.</p><p class="simplepara" id="calibre_link-2348">Mostly you will use SUMMARIZE only with the first two arguments, specifying a table and the group by columns as follows:</p><p class="para9" id="calibre_link-2349"><strong class="emphasistypebold">=SUMMARIZE ( Winesales, Wines[WINE], DateTable[YEAR] )</strong></p><p class="para9" id="calibre_link-2350">This table expression builds a virtual table grouping by the WINE column and then by the YEAR column and can do this because the Wines table and the DateTable are related to Winesales.</p><p class="simplepara" id="calibre_link-2351">However, there is one big difference between using ALL to generate ad hoc groups of columns and using SUMMARIZE, and that is that SUMMARIZE builds a virtual table comprising the values in the current filter context. Therefore, often, the ALL function is required, nested inside SUMMARIZE, to remove these filters.</p><p class="simplepara" id="calibre_link-2352">With two of the arguments inside SUMMARIZE (i.e., “name” and “expression”), you can optionally create calculations in the virtual table, and we will look at an example of this in the next chapter<em class="emphasistypeitalic"><strong class="emphasistypebold">.</strong></em> However, usually, to create calculations for these groups using context transition, you can nest the table generated by SUMMARIZE inside functions such as MAXX and AVERAGEX that will then perform the calculations.</p><p class="simplepara" id="calibre_link-2353">Using SUMMARIZE, you can group columns from related tables. For instance, if the table you reference inside SUMMARIZE is a fact table, then you can group by any columns from the dimensions related to the fact table.</p><p class="simplepara" id="calibre_link-2354">If you use the <strong class="emphasistypebold">New Table</strong> button on the Modeling tab in Power BI, you can create <span id="calibre_link-2355"><em class="emphasistypeitalic">calculated tables</em></span> using table functions. This is a convenient way to see the output of table expressions such as those involving SUMMARIZE. You can view calculated tables in Data view just as you would any tables in your data model. However, when the SUMMARIZE expression is nested inside a measure, its output will be filtered in memory according to the filter context, and this is something that you can’t see in the calculated table in Data view.</p><div class="para" id="calibre_link-2356">We can use SUMMARIZE to group the WINE column from the Wines dimension and the YEAR column from the <span id="calibre_link-2357">DateTable</span> using this table expression:<div class="programcode" id="calibre_link-2358"><div class="calibre4"><div class="fixedline">Wine and Year Table =</div><div class="fixedline">SUMMARIZE ( Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;Wines[WINE], DateTable[YEAR] )</div></div></div></div><div class="para" id="calibre_link-2359">In Figure <span><a href="#calibre_link-349" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-31</a></span>, you can see the result of this table expression when used in a calculated table using the <strong class="emphasistypebold">New table</strong> button.<figure class="figure1" id="calibre_link-349"><div class="mediaobject" id="calibre_link-2360"><img alt="" src="images/000233.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-31</span><p class="simplepara1">Using SUMMARIZE to generate a <span id="calibre_link-2361" class="calibre11">table</span> containing the WINE and YEAR columns</p></div></figcaption></figure></div><div class="para" id="calibre_link-2362">Let’s look at a scenario where we may need to generate this virtual table using SUMMARIZE, remembering that such a table will be built in the current filter context. We want to calculate the yearly average total sales for all our wines and display this in a Card visual. This is the measure we will author using SUMMARIZE to group by both WINE and YEAR (note the use of a variable to store the virtual table).<div class="programcode" id="calibre_link-2363"><div class="calibre4"><div class="fixedline">Yearly Average =</div><div class="fixedline">VAR SummaryTable = SUMMARIZE ( ALL ( Winesales ), Wines[WINE], DateTable[YEAR] )</div><div class="fixedline">RETURN</div><div class="fixedline">AVERAGEX ( SummaryTable, [Total Sales] )</div></div></div></div><div class="para" id="calibre_link-2364">You can see in Figure <span><a href="#calibre_link-350" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-32</a></span> that on average, the yearly sales for our wines is <strong class="emphasistypebold">$457,423</strong>. To understand this average, you could create a Clustered Column chart visual plotting wines sales in each year. If you then display an average analytical line,<sup class="calibre10"><a type="noteref" href="#calibre_link-351" id="calibre_link-357" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">4</a></sup> this will show the same value that you have calculated in the measure.<figure class="figure1" id="calibre_link-350"><div class="mediaobject" id="calibre_link-2365"><img alt="" src="images/000062.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-32</span><p class="simplepara1">Using SUMMARIZE and context transition to calculate the yearly average for all wines. This would be the average calculated by the “<span id="calibre_link-2366" class="calibre11">Analytics</span>” average line</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2367">In the “Yearly Average” measure, the “Total Sales” nested measure uses context transition to calculate sales for each combination of WINE and YEAR in the virtual table generated by SUMMARIZE. The AVERAGEX function will find the average of the values returned by the context transition. Note the use of the ALL function on the Winesales table to remove the filter coming from the WINE column and the YEAR column in the Matrix visual. Remember that unless you use ALL, the SUMMARIZE function creates a summary table of values <em class="emphasistypeitalic">within the current filter context</em>.</p><div class="para" id="calibre_link-2368">Alternatively, if we put this measure into a table that didn’t use the WINE or YEAR column, we would not require the ALL function, as you can see in Figure <span><a href="#calibre_link-352" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-33</a></span> where we are using the REGION column instead. Here, we are analyzing the average of the total yearly sales of wines in each region.<div class="programcode" id="calibre_link-2369"><div class="calibre4"><div class="fixedline">Yearly Average =</div><div class="fixedline">VAR SummaryTable = SUMMARIZE (&nbsp;&nbsp;Winesales&nbsp;, Wines[WINE], DateTable[YEAR] )</div><div class="fixedline">RETURN</div><div class="fixedline">AVERAGEX ( SummaryTable, [Total Sales] )</div></div></div></div><div class="para"><figure class="figure1" id="calibre_link-352"><div class="mediaobject" id="calibre_link-2370"><img alt="" src="images/000206.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-33</span><p class="simplepara1">The “Yearly Average” measure <span id="calibre_link-2371" class="calibre11">calculated</span> for regions</p></div></figcaption></figure></div><div class="para" id="calibre_link-2372">Having calculated the average yearly sales for all wines in all the years, you may want to calculate the average yearly sales for each wine. Perhaps again, this is to calculate the variance from the average. If this is the case, this is the code you would require:<div class="programcode" id="calibre_link-2373"><div class="calibre4"><div class="fixedline">Yearly Average Each Wine =</div><div class="fixedline">VAR Summarytable =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZE ( ALLEXCEPT ( Winesales, Wines[WINE] ), DateTable[YEAR] )</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;AVERAGEX ( Summarytable, [Total Sales] )</div></div></div></div><div class="para" id="calibre_link-2374">The reason that we can use the <span id="calibre_link-2375">ALLEXEPT function</span> in this context will be explained in Chapter <span><a href="#calibre_link-0" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>18</span></a></span> when we explore the concept of table expansion. All we need to note here is that by using ALLEXCEPT, the filter has been removed from the YEAR column leaving the filter on the WINE column. Therefore, this enables us to pass the average across sales in every year for each wine. This measure would then calculate the variance, but only at the YEAR grain:<div class="programcode" id="calibre_link-2376"><div class="calibre4"><div class="fixedline">Variance from Average Each Yr =</div><div class="fixedline">IF (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;HASONEVALUE ( DateTable[YEAR] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales] - [Yearly Average Each Wine] )</div></div></div></div><div class="para" id="calibre_link-2377">You can see the outcomes of the “Yearly Average Each Wine” and “Variance from Average Each Yr” measures in Figure <span><a href="#calibre_link-353" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">15-34</a></span>.<figure class="figure1" id="calibre_link-353"><div class="mediaobject" id="calibre_link-2378"><img alt="" src="images/000086.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 15-34</span><p class="simplepara1">The “Yearly Average Each Wine” and “Variance from Average Each Yr” measures</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2379">In this chapter, you have learned to use context transition to produce aggregations on <span id="calibre_link-2380">measures</span> as opposed to aggregations on row-level values. You now also appreciate the importance of dimension tables in these calculations, that they are used to group and aggregate the data at the dimension granularity. You have also learned that virtual tables play a significant part in these calculations, enabling you to generate ad hoc summary groups over which to harness the power of context transition.</p></section></section></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-354" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-316" role="doc-footnote"><p class="para3" id="calibre_link-2381">To follow along with the examples, use the Power BI Desktop file <span class="emphasisfontcategorynonproportional">“</span>1 DAX Sample Data.pbix”.</p></div><div class="clearboth1">&nbsp;</div></div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-355" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2</a></span><div class="calibre4" type="footnote" id="calibre_link-319" role="doc-footnote"><p class="para3" id="calibre_link-2382">For information on removing duplicate rows, visit <span><a href="http://www.excelnaccess.com/removing-duplicate-rows-in-power-bi/" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>www.​excelnaccess.​com/​removing-duplicate-rows-in-power-bi/​</span></a></span></p></div><div class="clearboth1">&nbsp;</div></div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-356" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">3</a></span><div class="calibre4" type="footnote" id="calibre_link-323" role="doc-footnote"><p class="para3" id="calibre_link-2383">Marco Russo and Alberto Ferrari (2020), <em class="emphasistypeitalic">The Definitive Guide to DAX</em>, 2nd ed, p.154 [Microsoft Press]</p></div><div class="clearboth1">&nbsp;</div></div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-357" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">4</a></span><div class="calibre4" type="footnote" id="calibre_link-351" role="doc-footnote"><p class="para3" id="calibre_link-2384">For information on working with the analytical lines, visit <span><a href="https://docs.microsoft.com/en-us/power-bi/transform-model/desktop-analytics-pane" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>https://​docs.​microsoft.​com/​en-us/​power-bi/​transform-model/​desktop-analytics-pane</span></a></span></p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-143">
<div id="calibre_link-2385" class="calibre2">
<div id="calibre_link-2386" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-2387"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_16" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_16</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">16.&nbsp;Leveraging Context Transition</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-377" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-377"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-2388">In the last chapter, you learned how context transition enables you to programmatically aggregate data into dimensions and virtual tables. You could then author expressions that grouped and aggregated data at this higher granularity. Once you have learned the skill of using DAX in this way, the world of DAX opens up to you considerably. You will now be able to author more complex calculations that enable you to gain deeper data insights. In this chapter, you will be applying your knowledge of context transition to solving the following <span id="calibre_link-2389">data analysis</span> questions:</p><div class="para8" id="calibre_link-2390">How do I<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-2391">Rank entities?</p></li><li class="calibre9"><p class="para2" id="calibre_link-2392">Bin measures into numeric ranges?</p></li><li class="calibre9"><p class="para2" id="calibre_link-2393">Calculate top or bottom N percent using dynamic parameters?</p></li><li class="calibre9"><p class="para2" id="calibre_link-2394">Find like for like sales across my customer base?</p></li><li class="calibre9"><p class="para2" id="calibre_link-2395">Calculate running totals in a table using a calculated column?</p></li><li class="calibre9"><p class="para2" id="calibre_link-2396">Calculate differences in values in the previous row in a calculated column?</p></li></ul></div></div><p class="simplepara" id="calibre_link-2397">In generating these insights, you will learn transferrable skills and techniques that you can take on board, extend the ideas, and apply them to your own data.</p><section class="section" id="calibre_link-233"><h2 class="booksubtitle">Ranking Data: Looking at RANKX</h2><p class="simplepara" id="calibre_link-2398">You have learned that by combining iterating functions with measures (which implicitly call CALCULATE), you can reap the benefits of context transition. Let’s take this opportunity to look at another iterating function, RANKX.</p><p class="simplepara" id="calibre_link-2399">The <span id="calibre_link-2400">RANKX function</span><span id="calibre_link-2401"></span> has the following syntax:</p><p class="para9" id="calibre_link-2402"><strong class="emphasistypebold">= RANKX ( table, expression, value, order, ties )</strong></p><p class="para9" id="calibre_link-2403">where:</p><p class="simplepara" id="calibre_link-2404"><strong class="emphasistypebold">table</strong> is the table that you want to iterate to rank items. This table is often generated by the ALL function, so ranking is performed on all the rows of the table, not just those in the current filter.</p><p class="simplepara" id="calibre_link-2405"><strong class="emphasistypebold">expression</strong> is the measure or expression to be used to rank the items.</p><p class="simplepara" id="calibre_link-2406"><strong class="emphasistypebold">value</strong> is optional and is used to compare items to be ranked (rarely used).</p><p class="simplepara" id="calibre_link-2407"><strong class="emphasistypebold">order</strong> is optional <span class="emphasisfontcategorynonproportional">&ndash;</span> ASC (1 is the lowest rank) or DESC (1 is the highest rank). The default is DESC.</p><div class="para" id="calibre_link-2408"><strong class="emphasistypebold">ties</strong> is optional and is either Skip or Dense as follows:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-2409"><strong class="emphasistypebold">Skip</strong> where the next rank value after a tie is the rank value of the tie plus the count of tied values. For example, if 5 values are tied with a rank of 11, then the next value will receive a rank of 16 (11 + 5). This is the default value when the ties parameter is omitted.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2410"><strong class="emphasistypebold">Dense</strong> where the next rank value after a tie is the next rank value. For example, if 5 values are tied with a rank of 11, then the next value will receive a rank of 12.</p></li></ul></div></div><p class="simplepara" id="calibre_link-2411">Here is an example of RANKX syntax:</p><p class="para9" id="calibre_link-2412"><strong class="emphasistypebold">= RANKX ( ALL (Wines), [Total Sales], ASC)</strong></p><div class="table" id="calibre_link-2413">As its name suggests, we can use this function to rank our entities by a specific measure, for example, to rank our wines by the “Total Sales” measure; see Figure <span><a href="#calibre_link-378" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-1</a></span>.<figure class="figure1" id="calibre_link-378"><div class="mediaobject" id="calibre_link-2414"><img alt="" src="images/000054.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-1</span><p class="simplepara1">Ranking wines by “Total Sales”</p></div></figcaption></figure></div><div class="para" id="calibre_link-2415">This is DAX code for the “Rank Wine” measure:<div class="programcode" id="calibre_link-2416"><div class="calibre4"><div class="fixedline">Rank Wine =</div><div class="fixedline">IF ( [Total Sales],</div><div class="fixedline">RANKX ( ALL ( Wines ), [Total Sales] ) )</div></div></div></div><p class="simplepara" id="calibre_link-2417">This measure first checks that there is a value for “Total Sales”; otherwise, items with blank values will be considered in the evaluation, such as “Lambrusco” wine that has no sales. If a sales value is present, the measure builds a virtual Wines table containing all the rows from the table using ALL. It then uses context transition to calculate the “Total Sales” value, iterating every row. Finally, it ranks the sales value in the current filter against all the values in the table returned by ALL, returning their rank value.</p><div class="para" id="calibre_link-2418">Let’s take a look at another example of using RANKX. You may, for instance, want to rank your financial quarters by sales in each year as shown in Figure <span><a href="#calibre_link-379" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-2</a></span>.<figure class="figure1" id="calibre_link-379"><div class="mediaobject" id="calibre_link-2419"><img alt="" src="images/000122.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-2</span><p class="simplepara1">Using RANKX to rank financial quarters</p></div></figcaption></figure></div><div class="para" id="calibre_link-2420">In the Matrix visual in Figure <span><a href="#calibre_link-379" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-2</a></span>, the first ranking evaluation is for “Qtr 1” in “2017”, filters being applied to the DateTable accordingly. Here, you must use the ALL function to generate a virtual table containing a column of all four values in the QTR column of the DateTable (i.e., “Qtr 1”, “Qtr 2”, “Qtr 3”, “Qtr 4”) for “2017”. This is so that the sales values for all four quarters in that year can be ranked using context transition. This is the measure you can create here:<div class="programcode" id="calibre_link-2421"><div class="calibre4"><div class="fixedline">Rank by Qtr =</div><div class="fixedline">RANKX ( ALL ( DateTable[QTR] ), [Total Sales] )</div></div></div></div><div class="para" id="calibre_link-2422">However, if you put this measure into a Matrix visual, you will notice that the YEAR column is ranked as “1” as there is only one subtotal value to rank. To avoid this irrelevant value, you can use the <span id="calibre_link-2423">HASONEVALUE function</span> to return only a value for the QTR column:<div class="programcode" id="calibre_link-2424"><div class="calibre4"><div class="fixedline">Rank by Qtr #2 =</div><div class="fixedline">&nbsp;IF ( HASONEVALUE(DateTable[QTR] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RANKX ( ALL ( DateTable[QTR] ), [Total Cases] ))</div></div></div></div><div class="formalpara" id="calibre_link-2425"><div class="heading1">Note</div><p class="para6" id="calibre_link-2426">We are using the ALL function inside RANKX in our examples shown before, but remember that you may require the ALLSELECTED function instead if you have slicers on your canvas.</p></div><p class="simplepara" id="calibre_link-2427">We will be meeting the RANKX function again later in this chapter when we use it to rank our customers. However, the most important takeaway from this section is how RANKX, as an iterating function, is used with a measure and, therefore, evokes context transition.</p></section><section class="section" id="calibre_link-234"><h2 class="booksubtitle">Binning Measures into Numeric Ranges</h2><div class="calibre4" id="calibre_link-2428">A common requirement when analyzing data in Power BI is binning the results of a measure into <span id="calibre_link-2429">numeric ranges</span>. Consider the visual on the left in Figure <span><a href="#calibre_link-380" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-3</a></span>. It is telling us that we have nine customers whose “Total Sales” values are greater than 800,000. In the Table visual on the right, we can see who these customers are.<figure class="figure1" id="calibre_link-380"><div class="mediaobject" id="calibre_link-2430"><img alt="" src="images/000188.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-3</span><p class="simplepara1">Binning “Total Sales” into numeric ranges</p></div></figcaption></figure></div><div class="para" id="calibre_link-2431">The starting point for this analysis is to generate a parameter table that defines the ranges you require. You learned how to create parameter tables in Chapter <span><a href="#calibre_link-109" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>12</span></a></span> when we explored the <span id="calibre_link-2432">SELECTEDVALUE function</span>. To generate the parameter table, use the <strong class="emphasistypebold">Enter Data</strong> button on the <strong class="emphasistypebold">Home</strong> tab. We’ve called this table “Bins for Sales”, and you can see it in Figure <span><a href="#calibre_link-381" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-4</a></span>. As with all parameter tables, it’s not related to any other tables in the data model.<figure class="figure1" id="calibre_link-381"><div class="mediaobject" id="calibre_link-2433"><img alt="" src="images/000214.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-4</span><p class="simplepara1">The “Bins for Sales” <span id="calibre_link-2434" class="calibre11">parameter table</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2435">Next, as a <em class="emphasistypeitalic">calculated column</em> in Data view, in the “Bins for Sales” table, we could author this expression that will count the number of customers whose sales fall between the range values:<div class="programcode" id="calibre_link-2436"><div class="calibre4"><div class="fixedline">No. of Customers Column =</div><div class="fixedline">COUNTROWS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Customers,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales] &gt;= 'Bins for Sales'[MinValue]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; [Total Sales] &lt;= 'Bins for Sales'[MaxValue] ) )</div></div></div></div><div class="para" id="calibre_link-2437">You can see the results of this expression in Figure <span><a href="#calibre_link-382" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-5</a></span>.<figure class="figure1" id="calibre_link-382"><div class="mediaobject" id="calibre_link-2438"><img alt="" src="images/000256.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-5</span><p class="simplepara1">Start by binning the customers into a <span id="calibre_link-2439" class="calibre11">calculated column</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2440">Let’s take a closer look at the evaluation of “No. of Customers Column”. Because we are using a calculated column, the “Bins for Sales” table is iterated, and the values for “MinValue” and “MaxValue” in the current row will be used in the calculation. The “Total Sales” measure used by the <span id="calibre_link-2441">FILTER function</span> evokes context transition in the Customers table whereby it returns each customer’s total sales value in memory, and it is this value that is used to compare to the range value sitting in the current row of the “Bins for Sales” table. The <span id="calibre_link-2442">COUNTROWS function</span> then counts the number of rows in the virtual Customers table generated by FILTER. In Figure <span><a href="#calibre_link-383" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-6</a></span>, we step through the evaluation of this expression.<figure class="figure1" id="calibre_link-383"><div class="mediaobject" id="calibre_link-2443"><img alt="" src="images/000101.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-6</span><p class="simplepara1">The evaluation of the “No. of Customers Column” <span id="calibre_link-2444" class="calibre11">calculated column</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2445"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2446">The expression iterates the “Bins for Sales” table. FILTER generates a virtual Customers table that is filtered by using the range values in the current row of the “Bins for Sales” table.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2447">COUNTROWS counts the rows in the virtual Customers table.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2448">The value returned by COUNTROWS is calculated in the current row of the “Bins for Sales” table.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-2449">However, we don’t want these values sitting in a calculated column; we want them in a measure that we can put into a Table visual so we can slice and dice the data. We learned in Chapter <span><a href="#calibre_link-95" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>5</span></a></span> how we can often convert an expression evaluated in a column into an expression evaluated as a measure. There, we took this expression, <em class="emphasistypeitalic">“Winesales[CASESSOLD] * RELATED ( Wines[PRICEPERCASE] ) )”</em>, and wrapped it inside SUMX. We can do the same with our calculated column, remembering that it is the “Bins for Sales” table that must be iterated by SUMX:<div class="programcode" id="calibre_link-2450"><div class="calibre4"><div class="fixedline">No. of Customers with these Total Sales =</div><div class="fixedline">SUMX (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;'Bins for Sales',</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Customers,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales] &gt;= 'Bins for Sales'[MinValue]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp; [Total Sales] &lt;= 'Bins for Sales'[MaxValue] ) ) )</div></div></div></div><p class="simplepara" id="calibre_link-2451">You can then place a Table visual on your canvas and populate it with the “Range” column from the “Bins for Sales” table. Next, place the “No. of Customers with these Total Sales” measure into this table as in Figure <span><a href="#calibre_link-380" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-3</a></span>.</p></section><section class="section" id="calibre_link-235"><h2 class="booksubtitle">Calculating TopN Percent</h2><p class="simplepara" id="calibre_link-2452">In this example, you will put into practice all the knowledge of DAX you’ve learned so far and author a complex measure.</p><p class="simplepara" id="calibre_link-2453">The challenge is to find a way to dynamically browse your best and worst performing customers. The <span id="calibre_link-2454">requirement</span> is to do this by finding the topN and bottomN percent of customers by sales, where the “top” and “bottom” and “N” are dynamically selected via slicers. You would also like to browse customers’ sales by any entities from dimension tables such as by salespeople or by regions.</p><div class="para" id="calibre_link-2455">You can see in Figure <span><a href="#calibre_link-384" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-7</a></span> that we’ve solved this scenario. In the Table visual, you can see that we are looking at the bottom 10% of customers by sales for salesperson “Abel”.<figure class="figure1" id="calibre_link-384"><div class="mediaobject" id="calibre_link-2456"><img alt="" src="images/000147.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-7</span><p class="simplepara1">Top or bottom <span id="calibre_link-2457" class="calibre11">percent</span> of customers by sales</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2458">The measure “Top/Bottom PC Customers” is a compelling example of using context transition within a DAX expression to gain insights into your data, and you can now discover how to re-create this example for yourself.</p><div class="para" id="calibre_link-2459">There are two steps to setting up this <span id="calibre_link-2460">analysis</span>:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2461">Create the slicers to select which percentage and whether top or bottom.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2462">Create the measure to find the top or bottom percent selected in the slicers that will also respond to the Salesperson slicer.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><section class="section" id="calibre_link-236"><h3 class="booksubtitle">Create the Slicers</h3><div class="calibre4" id="calibre_link-2463">The “Top or Bottom” and “Percent” <span id="calibre_link-2464">slicers</span> use parameter tables. We’ve called these tables “Select Percent” and “Select Top or Bottom”, and both tables contain just a single column, “Top or Bottom” and “Percent”, as shown in Figure <span><a href="#calibre_link-385" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-8</a></span>.<figure class="figure1" id="calibre_link-385"><div class="mediaobject" id="calibre_link-2465"><img alt="" src="images/000037.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-8</span><p class="simplepara1">The <span id="calibre_link-2466" class="calibre11">parameter tables</span> used for top/bottom and percent</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2467">Use the columns from these two tables to populate two slicers.</p></section><section class="section" id="calibre_link-237"><h3 class="booksubtitle">Create the Measure to Find the Top or Bottom Percent Selected in Slicers</h3><p class="simplepara" id="calibre_link-2468">The measure used in the “Top/Bottom PC Customers” uses many skills you have learned so far in this book. Let’s think through what will be required of you to arrive at the correct DAX code for this <span id="calibre_link-2469">measure</span>.</p><div class="para" id="calibre_link-2470"><div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-2471">You will use variables throughout the expression to separate each part of the evaluation.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2472">You will use the <span id="calibre_link-2473">SELECTEDVALUE function</span> to harvest the values selected in the slicers, either “Top” or “Bottom”, and the percentage to be calculated.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2474">The percentage selected is used to find the base rank. For example, if 10% is chosen in the slicer and there are 84 customers who have sales, you must find customers whose rank is less than 8.4. You will rank customers descending for top ranked customers (top = 1) and ascending for bottom ranked customers (bottom = 1). Therefore, you will be finding a rank less than 8.4 in both cases.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2475">Using context transition and the RANKX function, you will rank the customers, top or bottom, according to their “Total Sales” value.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2476">Because there are customers with no sales that will be ranked by default when finding bottom percent, you must filter the Customers table so only customers who have sales are ranked.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2477">Using the FILTER function, you will filter top or bottom customers whose rank is, for example, less than 8.4, if finding 10%.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2478">Because the measure must return a scalar value, you must now calculate the “Total Sales” measure for the filtered customers.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2479">Lastly, you must write a calculation that returns “Total Sales” for either the top or the bottom ranked customers depending on the slicer selection.</p></li></ul></div></div><div class="para" id="calibre_link-2480">This is the measure that you can now author (we have added a comment under each part of the expression to explain the purpose of the code):<div class="programcode" id="calibre_link-2481"><div class="calibre4"><div class="fixedline">Top/Bottom PC Customers =</div></div><div class="calibre4"><div class="fixedline">VAR PercentToFind =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS ( ALL ( Customers ) ) * SELECTEDVALUE ( 'Select Percent'[Percent] )</div><div class="fixedline">-- Harvest the percent using the slicer selection</div></div><div class="calibre4"><div class="fixedline">VAR TopOrBottom =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SELECTEDVALUE ( 'Select Top or Bottom'[Top or Bottom] )</div><div class="fixedline">-- Harvest whether top or bottom using the slicer selection</div></div><div class="calibre4"><div class="fixedline">VAR RankCustsTop =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;RANKX ( ALL ( Customers ), [Total Sales] )</div><div class="fixedline">-- Rank the customers descending by Total Sales value (Top = 1)</div></div><div class="calibre4"><div class="fixedline">VAR RankCustsBottom =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;RANKX (FILTER( ALL ( Customers ),NOT(ISBLANK([Total Sales]))), [Total Sales], ASC )</div><div class="fixedline">-- Rank the customers ascending by Total Sales value (Bottom = 1) but only if they have sales</div></div><div class="calibre4"><div class="fixedline">VAR FindCustsTop =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Customers, RankCustsTop &lt;= PercentToFind )</div><div class="fixedline">-- Filter top customers whose rank is less than or equal to the PerCentToFind</div></div><div class="calibre4"><div class="fixedline">VAR FindCustsBottom =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Customers, RankCustsBottom &lt;= PercentToFind )</div><div class="fixedline">-- Filter bottom customers whose rank is less than or equal to the PerCentToFind</div></div><div class="calibre4"><div class="fixedline">VAR CalcSalesTop =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [Total Sales], FindCustsTop )</div><div class="fixedline">-- Calculate “Total Sales” for top ranked customers</div></div><div class="calibre4"><div class="fixedline">VAR CalcSalesBottom =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [Total Sales], FindCustsBottom )</div><div class="fixedline">-- Calculate “Total Sales” for bottom ranked customers</div></div><div class="calibre4"><div class="fixedline">RETURN</div></div><div class="calibre4"><div class="fixedline">IF ( HASONEVALUE ( Customers[CUSTOMER NAME] ),</div><div class="fixedline">-- This tests that the evaluation is <strong class="emphasistypebold">not</strong> for the Total Row.</div><div class="fixedline">IF ( TopOrBottom = "top",&nbsp;&nbsp;CalcSalesTop, CalcSalesBottom&nbsp;&nbsp;),</div><div class="fixedline">--The calculation for rows not in the Total row</div></div><div class="calibre4"><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( [Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALLSELECTED (Customers[CUSTOMER NAME] ) ) )</div><div class="fixedline">--The calculation for the Total Row</div></div></div></div><p class="simplepara" id="calibre_link-2482">Note the “RETURN” expression that executes different code if the calculation is for the Total row. This is to resolve the problem of users selecting “Bottom” percent and no value showing in the Total row. This is because the Total row is evaluated in the same way as the evaluation for each customer. Therefore, the Total row value, which is always greater than the individual sales values, is given a bottom ranking of 85 (if there are 84 customers with sales), because the bottom ranking is ascending (higher values get a larger ranked number). The Total row, therefore, fails the ranking bottom test performed by FILTER, and so there is no data to show in the Total row.</p><p class="simplepara" id="calibre_link-2483">You must, therefore, author a different expression for the Total row to ensure that the Total row sums the total sales for the customers shown in the visual. To test that the evaluation is <em class="emphasistypeitalic">not</em> for the Total row, you can use the HASONEVALUE function. You can then use the ALLSELECTED function to calculate the “Total Sales” value for just the customers shown in the visual.</p><div class="para" id="calibre_link-2484">However, we have not yet resolved the problem, because you will note that at this stage, the Total <span id="calibre_link-2485">row</span> shows the total sales for <em class="emphasistypeitalic">all</em> customers for “Abel”; see Figure <span><a href="#calibre_link-386" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-9</a></span>.<figure class="figure1" id="calibre_link-386"><div class="mediaobject" id="calibre_link-2486"><img alt="" src="images/000171.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-9</span><p class="simplepara1">The Total row is not correct</p></div></figcaption></figure></div><div class="para" id="calibre_link-2487">This is because the ALLSELECTED expression calculates the “Total Sales” measure independently of the ranking calculation, and so there is no filter on the Customers table for ALLSELECTED to remove. Therefore, to place a filter on the Customers table, you can use a visual-level filter, populate it with the “Total Sales” measure, and set the filter to “Show items when the value is not blank”; see Figure <span><a href="#calibre_link-387" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-10</a></span>.<figure class="figure1" id="calibre_link-387"><div class="mediaobject" id="calibre_link-2488"><img alt="" src="images/000138.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-10</span><p class="simplepara1">The Total <span id="calibre_link-2489" class="calibre11">row</span> is correct if you provide a visual-level filter for ALLSELECTED to remove</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2490">Finally, you can change the slicer selections, and the measure recalculates accordingly, finding your best and worst customers using our great DAX friend, context transition.</p><p class="simplepara" id="calibre_link-2491">You may feel that the <span id="calibre_link-2492">dynamic ranking</span> of customers that we have achieved here has been quite a daunting experience. It would appear that once you have “cracked” the obvious calculation of ranking the customers, there were then unexpected problems that arose, such as how the Total row must be evaluated. Let me tell you now, this is par for the course. This is true DAX in action, and you are beginning to appreciate that what you must do above all else is <em class="emphasistypeitalic">think it through</em>. Why is my expression returning correct results most of the time but then odd results only sometimes? Always think through exactly how your measure is being evaluated and, particularly, the evaluation context in which it has been placed.</p></section></section><section class="section" id="calibre_link-238"><h2 class="booksubtitle">Calculating “Like for Like” Yearly Sales Using SUMMARIZE</h2><p class="simplepara" id="calibre_link-2493"><span id="calibre_link-2494"></span>We have been analyzing our customer sales values in a variety of ways throughout this book. One of the more insightful metrics, however, we have yet to explore is calculating like for like sales to make more accurate comparisons between our customers.</p><div class="para" id="calibre_link-2495">Let’s start by setting up the scenario. We want to analyze our customers’ sales of “Chianti” wine in the years 2019, 2020, and 2021. The problem with multiselecting years in a slicer is that our “Total Sales” measure will filter customers with sales of “Chianti” in any of the selected years and not sales in all of them; see Figure <span><a href="#calibre_link-388" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-11</a></span>.<figure class="figure1" id="calibre_link-388"><div class="mediaobject" id="calibre_link-2496"><img alt="" src="images/000223.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-11</span><p class="simplepara1"><span id="calibre_link-2497" class="calibre11">Multiselecting</span> years returns customers with sales in any of the selected years, not all the selected years</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2498">However, we’d like to select a range of years in a slicer and find out which customers bought “Chianti” in <em class="emphasistypeitalic">all</em> the selected years so we can compare like for like on the total. For instance, in Figure <span><a href="#calibre_link-388" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-11</a></span>, we can see that in the years 2019, 2020, and 2021, “Burningsuit Ltd” had sales in all three years for “Chianti” but “Ballard &amp; Sons” only had sales in 2020 and “Barstow Ltd” in 2021. Therefore, the total sales for those three years would not be like for like when considering these three customers’ sales of “Chianti”.</p><div class="para" id="calibre_link-2499">The visual that provides the analysis we require is shown in Figure <span><a href="#calibre_link-389" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-12</a></span>. Here, we have selected “Chianti” wine and years 2019, 2020, and 2021 in the slicers, and the table visual shows sales for only customers who have sales of “Chianti” in all those years.<figure class="figure1" id="calibre_link-389"><div class="mediaobject" id="calibre_link-2500"><img alt="" src="images/000014.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-12</span><p class="simplepara1">Calculating like for like <span id="calibre_link-2501" class="calibre11">sales</span> in 2019 to 2021 for “Chianti” wine</p></div></figcaption></figure></div><div class="para" id="calibre_link-2502">To understand the code we must author that calculates such sales, we will pick the calculation apart into its constituent <span id="calibre_link-2503">steps</span>:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2504">Identify customers who have sales in the selected years of the selected wine.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2505">Calculate in how many of those years selected in the slicer the customer has sales.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2506">Filter customers who have sales in the same number of years as the number of years selected in the slicer.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-2507"><span id="calibre_link-2508"></span>Let’s take step #1 and explore how we identify those customers that have sales in the selected years. For this, we must digress a little and revisit the SUMMARIZE function to learn more. In the previous chapter, you learned how you can use SUMMARIZE to generate a virtual table grouping columns from different tables. However, as one of the arguments inside SUMMARIZE, you can optionally include an expression to be evaluated for the rows returned in the virtual table. Therefore, to identify in which of the selected years our customers have sales, we could write the following measure where we have highlighted the two arguments used for calculating the total sales for each customer in each year:<div class="programcode" id="calibre_link-2509"><div class="calibre4"><div class="fixedline">No. of Years that Customers have Sales =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Customers[CUSTOMER NAME],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateTable[Year],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sales", [Total Sales]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div></div></div></div><div class="para" id="calibre_link-2510">We will now work through the details of the “No. of Years that Customers have Sales” measure. We are using SUMMARIZE to create the virtual table shown in Figure <span><a href="#calibre_link-390" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-13</a></span>. We don’t see all the years for every customer because this table is evaluated in the current filter of the Matrix visual that it occupies; for instance, “Ballard &amp; Sons” only has sales in 2020; see Figure <span><a href="#calibre_link-391" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-14</a></span>.<figure class="figure1" id="calibre_link-390"><div class="mediaobject" id="calibre_link-2511"><img alt="" src="images/000196.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-13</span><p class="simplepara1">The <span id="calibre_link-2512" class="calibre11">virtual table</span> generated by SUMMARIZE in the “No. of Years that Customers have Sales” measure</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2513">You can see that the SUMMARIZE function includes an expression called “Sales” which will return the “Total Sales” measure. The name that you give to this column inside SUMMARIZE (e.g., “Sales”) is purely arbitrary.</p><div class="para" id="calibre_link-2514">We can now put this measure into a Matrix visual with CUSTOMER NAME in rows and YEAR in columns (Figure <span><a href="#calibre_link-391" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-14</a></span>). We are also slicing by “Chianti” wine and years 2019, 2020, and 2021. You can see that it returns “1” for every customer that has sales of “Chianti” in the selected years.<figure class="figure1" id="calibre_link-391"><div class="mediaobject" id="calibre_link-2515"><img alt="" src="images/000029.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-14</span><p class="simplepara1">The “No. of Years that Customers have Sales” measure in a <span id="calibre_link-2516" class="calibre11">Matrix visual</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2517">Now for step #2 where we must calculate in how many of those years selected in the slicer a customer has sales. Remembering that the columns WINE, CUSTOMER, and YEAR are providing the filter context, we must remove the filter from YEAR so we can look at our customers’ sales of “Chianti” for all the years selected in the slicer. We can use CALCULATE with ALLSELECTED on the DateTable to do this job and simply nest our SUMMARIZE expression inside CALCULATE:<div class="programcode" id="calibre_link-2518"><div class="calibre4"><div class="fixedline">No. of Years that Customers have Sales #2=</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SUMMARIZE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Customers[CUSTOMER NAME],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DateTable[Year],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;"Sales", [Total Sales]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALLSELECTED ( DateTable[Year] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2519">We can see the values this <span id="calibre_link-2520">measure returns</span> in Figure <span><a href="#calibre_link-392" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-15</a></span>.<figure class="figure1" id="calibre_link-392"><div class="mediaobject" id="calibre_link-2521"><img alt="" src="images/000249.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-15</span><p class="simplepara1">The “No. of Years that Customers have Sales #2” measure evaluated in the Matrix visual</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2522">We already know from Figure <span><a href="#calibre_link-390" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-13</a></span> that “Ballard &amp; Sons” has only bought “Chianti” in 2020 so they only have sales in one of the years selected in the slicer.</p><div class="para" id="calibre_link-2523">To complete the calculation in step #3, we can filter the Customers table to contain only those customers whose number of years returned by the “No. of Years that Customers have Sales #2” measure equals the number of years filtered in the slicer and return the “Total Sales” value for these customers. This is the “Like for Like Sales” measure that we’ve used in the visual in Figure <span><a href="#calibre_link-391" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-14</a></span> that returns the result we need:<div class="programcode" id="calibre_link-2524"><div class="calibre4"><div class="fixedline">Like for Like Sales =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Customers,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[No. of Years that Customers have Sales #2] =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS ( ALLSELECTED ( DateTable[Year] ) )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2525">Figure <span><a href="#calibre_link-393" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-16</a></span> shows this measure evaluated in a <span id="calibre_link-2526">Matrix visual</span>.<figure class="figure1" id="calibre_link-393"><div class="mediaobject" id="calibre_link-2527"><img alt="" src="images/000197.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-16</span><p class="simplepara1">The “Like for Like Sales” measure evaluated for “Chianti” wine</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2528">In the preceding scenario, where we have calculated like for like sales, you may have noticed the absence of any reference to context transition when working through the evaluation of the measures we built using SUMMARIZE. In fact, these measures do not use context transition. SUMMARIZE is not an iterating function, and in the absence of an iteration, context transition cannot occur. The method that SUMMARIZE uses to calculate its “expression” argument is complex, and its explanation is beyond the scope of this book. However, the behavior of the “Total Sales” measure in the expressions using SUMMARIZE is indistinguishable from context transition to most DAX users. That is, we have generated a summary table, and the “Total Sales” measure is calculated at that granularity. This is why I have included this example in this chapter.</p></section><section class="section" id="calibre_link-239"><h2 class="booksubtitle">Using Context Transition in Calculated Columns</h2><p class="simplepara" id="calibre_link-2529">Understanding context transition allows you to write more challenging <span id="calibre_link-2530">calculated columns</span><span id="calibre_link-2531"></span> too. What you will learn in this section is that by using CALCULATE in calculated columns, you are released from the constraints of the row context where you can only calculate values for the current row. We can now harness the power of context transition to <em class="emphasistypeitalic">programmatically create filters on tables</em> and so pass calculations across these filtered rows in calculated columns.</p><section class="section" id="calibre_link-240"><h3 class="booksubtitle">Calculating Running Totals</h3><div class="calibre4" id="calibre_link-2532">You have already learned how to calculate <span id="calibre_link-2533">cumulative totals</span> using measures in Chapter <span><a href="#calibre_link-125" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>9</span></a></span> (see Figure <span><a href="#calibre_link-394" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>9-10</span></a></span>) and Chapter <span><a href="#calibre_link-87" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>15</span></a></span> (see Figure <span><a href="#calibre_link-328" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>15-10</span></a></span>). However, we now have a different cumulative total we would like to find, and that is a running total of the quantity in the CASES SOLD column; see Figure <span><a href="#calibre_link-395" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-17</a></span>. Using variables and context transition makes this calculation straightforward. This is the DAX calculated column you can create:<div class="programcode" id="calibre_link-2534"><div class="calibre4"><div class="fixedline">CUMULATIVE TOTAL =</div><div class="fixedline">VAR MyDate = Winesales[SALE DATE]</div><div class="fixedline">VAR MyFilter =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[SALE DATE] &lt;= MyDate )</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE ( SUM ( Winesales[CASES SOLD] ), MyFilter )</div></div></div><figure class="figure1" id="calibre_link-395"><div class="mediaobject" id="calibre_link-2535"><img alt="" src="images/000077.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-17</span><p class="simplepara1">The “<span id="calibre_link-2536" class="calibre11">CUMULATIVE TOTAL</span>” in a calculated column</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2537">The variable “MyDate” finds the value in the SALE DATE column sitting in the current row. The variable “MyFilter” uses the <span id="calibre_link-2538">FILTER function</span> to create a virtual table filtering the rows where the SALE DATE is on or before this date. Using context transition, CALCULATE can use this new filter generated by the virtual table to sum the CASES SOLD for these filtered rows.</p><div class="para" id="calibre_link-2539">Notice the use of the variable “MyDate” to find the date in the current row. Before variables were introduced into DAX in 2015, we had to use a function called EARLIER to do this job, as follows:<div class="programcode" id="calibre_link-2540"><div class="calibre4"><div class="fixedline">CUMULATIVE TOTAL =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Winesales[CASES SOLD] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[SALE DATE] &lt;=</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EARLIER ( Winesales[SALE DATE] ) )</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-2541">I think you’ll agree that the calculated column using the variable is a lot easier to create and understand.</p></section><section class="section" id="calibre_link-241"><h3 class="booksubtitle">Calculating the Difference from the Value in the Previous Row</h3><div class="calibre4" id="calibre_link-2542">You have learned that calculated columns use the <span id="calibre_link-2543">row context</span> in their evaluation where the values used by the expression are the values sitting in the current row. However, a common question that is often asked is how to find values in another row. For example, you may be asked to calculate the number of days between sales transactions as in the “DAYS DIFFERENCE” calculated column in Figure <span><a href="#calibre_link-396" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">16-18</a></span>.<figure class="figure1" id="calibre_link-396"><div class="mediaobject" id="calibre_link-2544"><img alt="" src="images/000162.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 16-18</span><p class="simplepara1">The “<span id="calibre_link-2545" class="calibre11">DAYS DIFFERENCE</span>” calculated column</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2546">To do this calculation, we need to find the SALE DATE that is in the previous row.</p><div class="para" id="calibre_link-2547">This is the expression for the calculated column:<div class="programcode" id="calibre_link-2548"><div class="calibre4"><div class="fixedline">DAYS DIFFERENCE =</div><div class="fixedline">VAR MyDate = Winesales[SALE DATE]</div><div class="fixedline">VAR PreviousDate =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MAX ( Winesales[SALE DATE] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( WineSales, Winesales[SALE DATE] &lt; MyDate ) )</div><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;IF ( PreviousDate, MyDate - PreviousDate )</div></div></div></div><p class="simplepara" id="calibre_link-2549">The variable “MyDate” finds the value of SALE DATE sitting in the current row, for example, <strong class="emphasistypebold">7 January 2017</strong>. The variable “PreviousDate” uses CALCULATE and so invokes context transition that will apply a filter to the rows. Using the FILTER function, a virtual table is created filtering the rows where the SALE DATE is before “MyDate” (i.e., all the rows with dates up to and including <strong class="emphasistypebold">6 January 2017</strong>). CALCULATE then calculates the latest date (using the MAX function) in the virtual table (<strong class="emphasistypebold">6 January 2017</strong>). Therefore, this date is the date immediately before the date in the current row. The <span id="calibre_link-2550">RETURN statement</span> checks for the presence of a previous date and then subtracts the date in the current row from the date generated by “PreviousDate”. The value returned is a date, so the last step is to change the data type to a whole number.</p><p class="simplepara" id="calibre_link-2551">By working through the examples contained in this and the previous chapter, you have learned how to use context transition to author more complex and challenging expressions. However, you are still sitting on the tip of the iceberg of calculations that can be achieved using context transition. You’ll find your own reasons to benefit from using this aspect of DAX, and you will no longer find the behavior of context transition in any way “strange” or “surprising,” and that’s because you now understand it.</p></section></section></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-144">
<div id="calibre_link-2552" class="calibre2">
<div id="calibre_link-2553" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-2554"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_17" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_17</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">17.&nbsp;Virtual Relationships: The LOOKUPVALUE and TREATAS Functions</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-425" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-425"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><div class="para4" id="calibre_link-2555">Our data model comprises well-defined physical relationships between the tables, generating a star schema. However, there is another type of relationship we can create, and that’s a “virtual” relationship. A virtual <span id="calibre_link-2556">relationship</span> is a DAX expression that simulates the behavior of a physical relationship defined in the data model. In this chapter, you will learn to create virtual relationships that can resolve problems created by anomalies in the data model. Such anomalies can exist for the following reasons:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-2557">When a relationship does not exist, for example, when using a lookup table.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2558">The relationship between tables is not part of a star or snowflake schema.</p></li><li class="calibre9"><p class="para2" id="calibre_link-2559">When a relationship cannot be created because there are duplicate values in both of the columns you want to relate.</p></li></ul></div></div><p class="para5" id="calibre_link-2560">Specifically, we will delve into the outcomes of using two functions that create virtual relationships: LOOKUPVALUE and TREATAS. In fact, these two functions are very different. LOOKUPVALUE returns a value, usually from a different table, that is looked up based on search criteria that are provided by the function. TREATAS, on the other hand, is a table function that returns a virtual table that can be used to filter another table. However, they’re both used in situations where it’s not possible to use a physical relationship, and that’s why we’ve consolidated them into this chapter.</p><section class="section" id="calibre_link-242"><h2 class="booksubtitle">LOOKUPVALUE Function</h2><p class="simplepara" id="calibre_link-2561">We’ve already learned that we can use the RELATED function to pull values through from the one side of the relationship into the many, just in the same way that the <span id="calibre_link-2562">VLOOKUP function</span> works in Excel. However, RELATED only works if you have a many-to-one relationship in place. Let’s look at a situation where it would not be possible to use RELATED.<sup class="calibre7"><a type="noteref" href="#calibre_link-426" id="calibre_link-440" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup></p><div class="para" id="calibre_link-2563">The situation is this; currently, our wines have a single price per case, but we now want our wines to have different prices according to different price <span id="calibre_link-2564">bands</span>. We’ve added another table to our model that records the price bands of the wines in a table called “Prices”, shown in Figure <span><a href="#calibre_link-427" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-1</a></span>.<figure class="figure1" id="calibre_link-427"><div class="mediaobject" id="calibre_link-2565"><img alt="" src="images/000003.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-1</span><p class="simplepara1">The Prices <span id="calibre_link-2566" class="calibre11">table records</span> the price band and price per case for each wine</p></div></figcaption></figure></div><div class="para" id="calibre_link-2567">Now, when we make a sale of any wine, the price band is also recorded in the transaction in the Winesales fact table; see Figure <span><a href="#calibre_link-428" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-2</a></span>.<figure class="figure1" id="calibre_link-428"><div class="mediaobject" id="calibre_link-2568"><img alt="" src="images/000212.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-2</span><p class="simplepara1">Each <span id="calibre_link-2569" class="calibre11">transaction records</span> the price band</p></div></figcaption></figure></div><div class="para" id="calibre_link-2570">In Figure <span><a href="#calibre_link-429" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-3</a></span>, you can see that relating wines to their prices in a many-to-one relationship using the WINE ID column is straightforward.<figure class="figure1" id="calibre_link-429"><div class="mediaobject" id="calibre_link-2571"><img alt="" src="images/000160.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-3</span><p class="simplepara1">The Prices table can be related to the Wines table in a <span id="calibre_link-2572" class="calibre11">many-to-one relationship</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2573">However, how would you find the price of each transaction in the Winesales table? You can’t use RELATED because this function can only populate values from the “one” side of the relationship into the “many” side and the Prices table sits on the “many” side. But more importantly, the price depends on <em class="emphasistypeitalic">two</em> criteria: the wine and the price band. In this scenario, the relationship between the tables isn’t going to help you. In fact, you don’t need the relationship between Wines and Prices at all. What you can do here is create a “virtual” relationship using LOOKUPVALUE in a calculated column.</p><p class="simplepara" id="calibre_link-2574">The LOOKUPVALUE function has the following <span id="calibre_link-2575">syntax</span>:</p><p class="para9" id="calibre_link-2576"><strong class="emphasistypebold">= LOOKUPVALUE( result column name, search column name1, search value1, search column name2, search value2 etc. )</strong></p><p class="para9" id="calibre_link-2577"><strong class="emphasistypebold">result column name</strong> is the column whose value you want to be returned.</p><p class="simplepara" id="calibre_link-2578"><strong class="emphasistypebold">search column name</strong> is the column where you want to match the first “search value.” Usually, this is a column from a different table, but it can be in the same table.</p><p class="simplepara" id="calibre_link-2579"><strong class="emphasistypebold">search value</strong> is the value to search for in “search column name.” This can be a value in a column or any single value.</p><p class="simplepara" id="calibre_link-2580">The “search column name” and “search value” can be repeated for as many pairs of matching values as you need.</p><div class="para" id="calibre_link-2581">This is the <span id="calibre_link-2582">calculated column</span> we need and you can see the result in Figure <span><a href="#calibre_link-430" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-4</a></span>:<div class="programcode" id="calibre_link-2583"><div class="calibre4"><div class="fixedline">WINE PRICE =</div><div class="fixedline">LOOKUPVALUE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Prices[PRICE PER CASE],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Prices[WINE ID], Winesales[WINE ID],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Prices[PRICE BAND], Winesales[PRICE BAND]</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2584">This is the same calculated column with comments:<div class="programcode" id="calibre_link-2585"><div class="calibre4"><div class="fixedline">WINE PRICE =</div><div class="fixedline">LOOKUPVALUE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Prices[PRICE PER CASE],</div><div class="fixedline">--the price to return into the Winesales table from the prices table</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Prices[WINE ID], Winesales[WINE ID],</div><div class="fixedline">--look in the WINE ID column of the Prices table to match the WINE ID in the current row of the Winesales table</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Prices[PRICE BAND], Winesales[PRICE BAND]</div><div class="fixedline">-- AND look in the PRICE BAND column of the Prices table to match the PRICE BAND in the current row of the Winesales table</div><div class="fixedline">)</div></div></div></div><div class="para"><figure class="figure1" id="calibre_link-430"><div class="mediaobject" id="calibre_link-2586"><img alt="" src="images/000091.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-4</span><p class="simplepara1">The WINE PRICE <span id="calibre_link-2587" class="calibre11">calculated column</span> using LOOKUPVALUE</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2588">Notice in the calculated column, we need to match both the WINE ID and the PRICE BAND, and this is where LOOKUPVALUE becomes particularly useful. The LOOKUPVALUE function allows you to find values in unrelated tables by matching values in any number of columns.</p><div class="para" id="calibre_link-2589">At this juncture, we must let you know that the code you have just written using the LOOKUPVALUE function is now a little outdated. Prior to the introduction of variables, it was the simplest way to achieve this outcome. However, the following code using variables and CALCULATE is an alternative <span id="calibre_link-2590">approach</span>:<div class="programcode" id="calibre_link-2591"><div class="calibre4"><div class="fixedline">WINE PRICE #2 =</div><div class="fixedline">VAR currentwine = Winesales[WINE ID]</div><div class="fixedline">VAR priceband = Winesales[PRICE BAND]</div><div class="fixedline">RETURN</div><div class="fixedline">CALCULATE ( VALUES ( Prices[PRICE PER CASE] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Prices[PRICE BAND] = priceband,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Prices[WINE ID] = currentwine )</div></div></div></div><p class="simplepara" id="calibre_link-2592">There is no discernable difference in the performance of “WINE PRICE #2”, so it is a personal choice as to which expression you prefer to use.</p><p class="simplepara" id="calibre_link-2593">Finally, let’s give the last word to Alberto Ferrari in his blog on the <span id="calibre_link-2594">LOOKUPVALUE function</span> here: <span><a href="http://www.sqlbi.com/articles/introducing-lookupvalue/" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">www.sqlbi.com/articles/introducing-lookupvalue/</span></span></a></span></p><p class="para9" id="calibre_link-2595"><em class="emphasistypeitalic">“If your search list is made up of only one-column, then LOOKUPVALUE is pretty much never your best option. Indeed, when searching for a single column, a relationship is always better: it is faster and provides a clearer structure to the model. When on the other hand you search for multiple columns, then LOOKUPVALUE comes in handy.</em></p><p class="para9" id="calibre_link-2596"><em class="emphasistypeitalic">Another scenario where LOOKUPVALUE is preferable over a relationship in the model is when the condition you set is not a single column, but instead a more complex condition based on multiple columns. In that case, LOOKUPVALUE provides greater flexibility than a relationship.”</em></p></section><section class="section" id="calibre_link-243"><h2 class="booksubtitle">The TREATAS Function</h2><div class="calibre4" id="calibre_link-2597">To understand the requirement for the <span id="calibre_link-2598">TREATAS function</span>, we must consider the following problem that has now arisen in our data model.<sup class="calibre10"><a type="noteref" href="#calibre_link-431" id="calibre_link-441" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">2</a></sup> We have added a Targets table to our model that records each salesperson’s yearly targets; see Figure <span><a href="#calibre_link-432" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-5</a></span>.<figure class="figure1" id="calibre_link-432"><div class="mediaobject" id="calibre_link-2599"><img alt="" src="images/000068.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-5</span><p class="simplepara1">The <span id="calibre_link-2600" class="calibre11">Targets table</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2601">We would like to compare our salespeople’s yearly sales with their targets, as in Figure <span><a href="#calibre_link-433" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-6</a></span> where we are looking at sales in 2021.<figure class="figure1" id="calibre_link-433"><div class="mediaobject" id="calibre_link-2602"><img alt="" src="images/000053.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-6</span><p class="simplepara1"><span id="calibre_link-2603" class="calibre11">Reporting</span> on salespeople’s yearly targets</p></div></figcaption></figure></div><div class="para" id="calibre_link-2604">The Targets table is related to the SalesPeople table (using the SALESPERSON ID column from both tables) in a many-to-one relationship as shown in Figure <span><a href="#calibre_link-434" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-7</a></span>. Because we will be using the Winesales table and the DateTable, we’ve also shown how these are related in the model.<figure class="figure1" id="calibre_link-434"><div class="mediaobject" id="calibre_link-2605"><img alt="" src="images/000113.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-7</span><p class="simplepara1">The Targets table is related to the <span id="calibre_link-2606" class="calibre11">SalesPeople table</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2607">We could create a measure to calculate the target values:<div class="programcode" id="calibre_link-2608"><div class="calibre4"><div class="fixedline">Target =</div><div class="fixedline">SUM ( Targets[TARGET] )</div></div></div></div><div class="para" id="calibre_link-2609">and then show the “Target” and “Total Sales” measure in a visual that includes the SALESPERSON column from the SalesPeople table and the YEAR column. However, from which table will we take the YEAR column, from the DateTable or from the Targets table? It’s here that we meet the problem of how to get both the “Target” value and the “Total Sales” value in the same visual against each year. We get different calculations depending on which table the YEAR comes from, as shown in Figure <span><a href="#calibre_link-435" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-8</a></span>.<figure class="figure1" id="calibre_link-435"><div class="mediaobject" id="calibre_link-2610"><img alt="" src="images/000076.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-8</span><p class="simplepara1">Taking the YEAR column from either the DateTable or the Targets <span id="calibre_link-2611" class="calibre11">table</span> won’t work</p></div></figcaption></figure></div><div class="para" id="calibre_link-2612">If the YEAR column comes from the DateTable, the “Total Sales” measure is correct but not the “Target” measure. If the YEAR column comes from the Target table, the targets are correct but not the total sales. If we now consider our data model in Figure <span><a href="#calibre_link-436" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-9</a></span>, we can identify the problem.<figure class="figure1" id="calibre_link-436"><div class="mediaobject" id="calibre_link-2613"><img alt="" src="images/000136.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-9</span><p class="simplepara1">Filtering YEAR in the DateTable filters the <span id="calibre_link-2614" class="calibre11">fact table</span>, but filtering YEAR in the Targets table does not filter any other tables</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2615">If we take YEAR from the DateTable, the YEAR filter is propagated to the Winesales fact table filtering “Total Sales” for each year (shown by the tick), but this filter is not propagated onward to the Targets table via the SalesPeople table (shown by the crosses) to filter the targets in each year. If we take YEAR from the Targets table, this filters the YEAR in the Targets table but won’t propagate to the Winesales table to filter sales (shown by the crosses).</p><p class="simplepara" id="calibre_link-2616">One solution would be to create a relationship between the YEAR field in the Targets table and the YEAR field in the DateTable. If we do this, filtering the YEAR in the Targets table would filter the YEAR in the DateTable, and this would propagate to the fact table.</p><div class="para" id="calibre_link-2617">The issue, however, is that in both the DateTable and the Targets table, values in the YEAR column are duplicated, so if we attempt to make this relationship, we will generate a many-to-many relationship prompting this warning message, as shown in Figure <span><a href="#calibre_link-437" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-10</a></span>.<figure class="figure1" id="calibre_link-437"><div class="mediaobject" id="calibre_link-2618"><img alt="" src="images/000028.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-10</span><p class="simplepara1">You will get a warning if you attempt to create a <span id="calibre_link-2619" class="calibre11">many-to-many relationship</span></p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2620">We are told that such a relationship will have a “significantly different behavior” and it should not be used unless you understand the consequences of your actions. Be that as it may, this would resolve the problem because it would set a bidirectional filter. However, now is the time to take on board the conclusions at which we arrived in Chapter <span><a href="#calibre_link-21" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>13</span></a></span> regarding bidirectional filtering. Any changes to your data model that push it further away from the star schema structure are never to be recommended. Besides, there is another, much simpler approach, and that is to resolve the problem using DAX and the TREATAS function. This function will take the result of a table expression and use it to filter a column (or columns) from an unrelated table and this filter expression can be used in the filter argument of CALCULATE.</p><p class="simplepara" id="calibre_link-2621">TREATAS has the following <span id="calibre_link-2622">syntax</span>:</p><p class="para9" id="calibre_link-2623"><strong class="emphasistypebold">= TREATAS ( table expression, column1, column2 etc. )</strong></p><p class="para9" id="calibre_link-2624"><strong class="emphasistypebold">table expression</strong> is any expression that returns a table.</p><p class="simplepara" id="calibre_link-2625"><strong class="emphasistypebold">column1, column2 etc.</strong> is one or more existing columns that must match the columns in the table expression that will receive the filter from the table expression.</p><div class="para" id="calibre_link-2626">We can now create this measure:<div class="programcode" id="calibre_link-2627"><div class="calibre4"><div class="fixedline">Target #2 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Targets[TARGET] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;TREATAS ( VALUES ( DateTable[YEAR] ), Targets[YEAR] )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2628">Notice the <span id="calibre_link-2629">VALUES function</span> used as a table expression to create a one-column table (often with only one row) containing the YEAR value from the DateTable in the current filter context, which is “2017” in the first evaluation. This one-row, one-column table is used to filter the YEAR column in the Targets table to equal “2017” and this is the filter used by CALCULATE. In Figure <span><a href="#calibre_link-438" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-11</a></span>, you can see how this plays out in memory. The virtual one-column, one-row table (or multirow table in the evaluation of the Total row) containing the YEAR from the DateTable in the current filter context is used to filter the YEAR column in the Targets table. It’s important therefore that we use the YEAR column from the DateTable in the visual.<figure class="figure1" id="calibre_link-438"><div class="mediaobject" id="calibre_link-2630"><img alt="" src="images/000238.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-11</span><p class="simplepara1">The <span id="calibre_link-2631" class="calibre11">evaluation</span> of the TREATAS function</p></div></figcaption></figure></div><div class="para" id="calibre_link-2632"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2633">The first argument in TREATAS uses the VALUES function to create a virtual table containing the YEAR column from the DateTable in the current filter context, for example, “2017”.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2634">The second argument in TREATAS defines the YEAR column in the Targets table as the column to receive the filter from the virtual table generated by VALUES.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-2635">When putting the “Target #2” measure into a table visual, alongside the YEAR column from the DateTable, we get the <span id="calibre_link-2636">result</span> we’ve been looking for; see Figure <span><a href="#calibre_link-439" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">17-12</a></span>.<figure class="figure1" id="calibre_link-439"><div class="mediaobject" id="calibre_link-2637"><img alt="" src="images/000186.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 17-12</span><p class="simplepara1">Using TREATAS returns the correct result for the target value</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2638">In this chapter, you have learned to manage anomalies in the data model by implementing virtual relationships using DAX. This is always a better strategy than using bidirectional filtering and many-to-many relationships. Therefore, you need no longer be daunted by the fact that you can’t create the recommended many-to-one relationships in your model. Be aware, however, that virtual relationships using DAX are never better than “real” many-to-one relationships and should only be used where no other option is possible.</p></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-440" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-426" role="doc-footnote"><p class="para3" id="calibre_link-2639">To follow along with the examples, use the Power BI Desktop file <span class="emphasisfontcategorynonproportional">“</span>4 DAX LOOKUPVALUE.pbix”.</p></div><div class="clearboth1">&nbsp;</div></div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-441" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2</a></span><div class="calibre4" type="footnote" id="calibre_link-431" role="doc-footnote"><p class="para3" id="calibre_link-2640">To follow along with the examples, use the Power BI Desktop file “5 DAX TREATAS.pbix”.</p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-0">
<div id="calibre_link-2641" class="calibre2">
<div id="calibre_link-2642" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-2643"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_18" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_18</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">18.&nbsp;Table Expansion</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-1" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-1"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-2644">In this chapter, you will learn how to reference expanded tables in your DAX code and explore how this knowledge can help you manage the limitations imposed on you by the structure of your tables within the star schema. The concept of table expansion is the final piece in the jigsaw of understanding how DAX works.<sup class="calibre7"><a type="noteref" href="#calibre_link-2" id="calibre_link-31" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup> This implies there is some precedence in the importance of DAX concepts. However, just as in a jigsaw, it’s only when all the pieces have been fitted do you see the whole picture, and we can at last reveal to you the truth about how DAX works, and any misconceptions you currently hold can now be dispelled.</p><p class="simplepara" id="calibre_link-2645">The starting point in understanding <span id="calibre_link-2646">table expansion</span> is to remind you of the DAX verity; filters only propagate from the one side of a relationship to the many, unless you use the <span id="calibre_link-2647">CROSSFILTER function</span> to programmatically change the filter direction. Within this verity, you have also probably assumed, although it has never been stated unequivocally, that relationships between tables use a “primary” and a “foreign” key to perform a “lookup” from the dimension table to the fact table to enable filtering. For example, a filter on the Wines dimension will use the WINE ID column in the Wines table to “lookup” the same value in the WINE ID column of the Winesales table. This is probably how you think filter propagation works. It’s not that this theory is wrong; it’s just that it’s not complete, and it’s this misunderstanding that we will resolve in this chapter.</p><div class="para8" id="calibre_link-2648">Before we move forward, however, we must take a closer look at the data model in the companion file for this chapter, “6 DAX Expanded Tables.pbix”. You will notice there is an additional table related to the Regions table called Region Group, and this table will become important in the following sections; see Figure <span><a href="#calibre_link-3" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-1</a></span>.<figure class="figure1" id="calibre_link-3"><div class="mediaobject" id="calibre_link-2649"><img alt="" src="images/000174.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-1</span><p class="simplepara1">Please note there is an additional table, Region Group, in the <span id="calibre_link-2650" class="calibre11">data model</span> that is related to Regions</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2651">The importance of understanding table expansion lies in the fact that we can, at last, explain to you how filters in a data model <em class="emphasistypeitalic">really</em> work and not an approximation of how they work. Armed with this knowledge, you will learn how to leverage table expansion to resolve the inherent problem in the data model of how to “reach” dimension and snowflake tables to perform aggregations at the larger grain. We will also be explaining why using functions such as RELATED and CROSSFILTER that can do a similar job is not always fit for purpose.</p><p class="simplepara" id="calibre_link-2652">However, prior to tackling the challenging ideas behind table expansion, we must first revisit the knowledge already gained regarding the context in which filters are evaluated. If we do this, you will discover that there are some details behind filter propagation that may currently be eluding you.</p><section class="section" id="calibre_link-244"><h2 class="booksubtitle">Revisiting Filters</h2><div class="calibre4" id="calibre_link-2653">Despite rigorous explanations in this book, there remain some aspects of <span id="calibre_link-2654">filters</span> generated by DAX that remain nonsensical. Consider these two questions:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2655">How is it possible that you can filter the fact table by using values in dimensions that don’t exist in the fact table?</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2656">How can the ALL function inside CALCULATE when it’s applied to the fact table remove filters that aren’t placed on the fact table?</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-2657">Let’s start by considering the first of these incongruities; we place filters on columns in dimensions that don’t exist in the fact table. For this, we need to revisit what we already know regarding column filters.</p><section class="section" id="calibre_link-245"><h3 class="booksubtitle">Column Filters Revisited</h3><div class="calibre4" id="calibre_link-2658">Throughout this book, you have authored measures using CALCULATE similar to this:<div class="programcode" id="calibre_link-2659"><div class="calibre4"><div class="fixedline">Abel's Cases =</div><div class="fixedline">CALCULATE ( [Total Cases],&nbsp;&nbsp;Salespeople[SALESPERSON] = "abel"</div><div class="fixedline">&nbsp;)</div></div></div></div><p class="simplepara" id="calibre_link-2660">Did you ever stop to ask: How can this measure cross-filter the Winesales table using the SALESPERSON <span id="calibre_link-2661">column</span> in the SalesPeople dimension, when Winesales only contains the SALESPERSON ID? To answer this question, we must delve deeper into the nature of column filters.</p><p class="simplepara" id="calibre_link-2662">In Chapter <span><a href="#calibre_link-4" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>7</span></a></span>, you learned that column filters are more efficient than table filters and should always be used in preference where possible. However, at that stage in your knowledge of DAX, we weren’t able to tell you the complete story of column filters and therefore gave you only an approximation of how column filters work.</p><p class="simplepara" id="calibre_link-2663">Now in this chapter, we do not hide anything from you and state this fact: in DAX, <em class="emphasistypeitalic">all filters are table filters</em>. This statement may come as a surprise to you considering that we took such pains to distinguish between column filters and table filters in that earlier chapter. Now we are saying that column filters are table filters too!</p><p class="simplepara" id="calibre_link-2664">The complete explanation as to why column filters are more efficient than table filters is not that you are placing a filter directly on a column, but that the virtual table generated by a column filter is more efficient than the virtual table generated by an explicit filter expression. This is quite a challenging concept, and so we must again dig more deeply.</p><div class="para" id="calibre_link-2665">Let’s start by considering this measure that generates a filter on the SALESPERSON column of the SalesPeople table:<div class="programcode" id="calibre_link-2666"><div class="calibre4"><div class="fixedline">Abel's Cases =</div><div class="fixedline">CALCULATE ( [Total Cases], SalesPeople[SALESPERSON] = "abel" )</div></div></div></div><div class="para" id="calibre_link-2667">In the evaluation of this measure, the DAX engine in memory converts this column filter to this expression:<div class="programcode" id="calibre_link-2668"><div class="calibre4"><div class="fixedline">Abel's Cases Real =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( ALL ( SalesPeople[SALESPERSON] ),&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SalesPeople[SALESPERSON] = "abel" )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2669">If we look at this code, we can see that DAX, using the ALL function, generates a one-column table comprising a distinct list of salespeople’s names. This table is then iterated by FILTER to find the value that equates to “Abel”, and this filtered table is then used to filter the Winesales table accordingly; see Figure <span><a href="#calibre_link-5" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-2</a></span>.<figure class="figure1" id="calibre_link-5"><div class="mediaobject" id="calibre_link-2670"><img alt="" src="images/000000.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-2</span><p class="simplepara1">The “real” <span id="calibre_link-2671" class="calibre11">evaluation</span> of the “Abel’s Cases Real” measure</p></div></figcaption></figure></div><div class="para" id="calibre_link-2672"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2673">The DAX engine uses FILTER to generate a one-column table containing the distinct values in the SALESPERSON column. FILTER iterates this table to filter “Abel”.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2674">The filtered virtual table generated by FILTER is used to filter the Winesales table.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-2675">Let’s look at another example of a column filter by exploring the evaluation of this measure:<div class="programcode" id="calibre_link-2676"><div class="calibre4"><div class="fixedline">Cases GT 350 =</div><div class="fixedline">CALCULATE ( [Total Cases],&nbsp;&nbsp;Winesales[CASES SOLD] &gt; 350 )</div></div></div></div><div class="para" id="calibre_link-2677">DAX converts this filter to the following:<div class="programcode" id="calibre_link-2678"><div class="calibre4"><div class="fixedline">Cases GT 350 Real =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( ALL ( Winesales[CASES SOLD] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales[CASES SOLD] &gt; 350 )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2679">This code <span id="calibre_link-2680">generates</span> a virtual table containing a distinct list of the cases sold values in the Winesales table. In our data, this table will therefore contain <strong class="emphasistypebold">409</strong> rows for FILTER to iterate. We can see how this expression is always going to produce a more efficient evaluation than using a table filter as in this measure:<div class="programcode" id="calibre_link-2681"><div class="calibre4"><div class="fixedline">Cases GT 350&nbsp;&nbsp;=</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Cases],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[CASES SOLD] &gt; 350 )</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-2682">Here, FILTER must iterate all the rows in the fact table, which will be <strong class="emphasistypebold">2,207</strong> iterations of our Winesales fact table (the fact table often contains millions of rows).</p><div class="para" id="calibre_link-2683">At this juncture, we can also revisit the “Sales for Red or French #1” measure that we authored in Chapters <span><a href="#calibre_link-6" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>6</span></a></span> and <span><a href="#calibre_link-4" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>7</span></a></span>:<div class="programcode" id="calibre_link-2684"><div class="calibre4"><div class="fixedline">Sales for Red or French #1=</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Wines[TYPE] = "red"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| Wines[WINE COUNTRY] = "France"</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2685">We noticed that the problem with this measure was that if there were filters on either the TYPE or the <span id="calibre_link-2686">WINECOUNTRY column</span>, the filter didn’t work (refer to Figure 6-10). We can, at last, explain why. It’s because DAX converts the measure internally to this:<div class="programcode" id="calibre_link-2687"><div class="calibre4"><div class="fixedline">Sales for Red or French #1=</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales],</div><div class="fixedline">ALL ( Wines[TYPE], Wines[WINE COUNTRY]),</div><div class="fixedline">FILTER( Wines,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Wines[TYPE] = "red"</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;|| Wines[WINE COUNTRY] = "France"</div><div class="fixedline">)</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-2688">Therefore, filters are always removed from the TYPE or WINECOUNTRY column because of the presence of ALL.</p><p class="simplepara" id="calibre_link-2689">Now that you understand that column filters are converted to table filters and that all filters are table filters, we seem no further on in answering the question we posed before. In the “Abel’s Cases Real” measure, we are filtering the SALESPERSON column in the SalesPeople table, but the Winesales table only contains the SALESPERSON ID column, so how can the filter propagate from the SalesPeople table to the Winesales table? We’ll leave you hanging onto this thought while we explore the second example of nonsensical filters. How can the ALL function applied to the fact table remove filters that aren’t placed on the fact table?</p></section><section class="section" id="calibre_link-246"><h3 class="booksubtitle">The ALL Function Revisited</h3><div class="calibre4" id="calibre_link-2690">In Figure <span><a href="#calibre_link-7" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-3</a></span>, on the evaluation of the “Total Cases” measure, we know filters have been placed on the WINE and SALESPERSON columns, propagating filters from the Wines and the SalesPeople dimensions to the Winesales fact table, respectively. We’ve then used the “All Winesales” measure to remove these filters:<div class="programcode" id="calibre_link-2691"><div class="calibre4"><div class="fixedline">All Winesales =</div><div class="fixedline">CALCULATE ( [Total Cases], ALL ( Winesales ) )</div></div></div><figure class="figure1" id="calibre_link-7"><div class="mediaobject" id="calibre_link-2692"><img alt="" src="images/000031.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-3</span><p class="simplepara1">Filters have been placed on the WINE and SALESPERSON columns, not on the fact table. The <span id="calibre_link-2693" class="calibre11">ALL function</span><span id="calibre_link-2694" class="calibre11"></span> removes filters from the fact table</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2695">We learned in Chapter <span><a href="#calibre_link-8" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>8</span></a></span> that the ALL function, when nested inside CALCULATE, <em class="emphasistypeitalic">removes</em> filters. But there are no filters on the Winesales fact table to remove, only cross-filters. The filters have been placed on columns in the dimensions, so how can ALL remove filters from the Winesales table when there are no filters to remove?</p></section></section><section class="section" id="calibre_link-247"><h2 class="booksubtitle">Expanded Tables Explained</h2><p class="simplepara" id="calibre_link-2696">To answer these probing questions and to truly grasp the behaviors of DAX filters, you must understand table expansion<strong class="emphasistypebold">.</strong> When a measure is evaluated, many-to-one relationships allow table expansion to take place. Table <span id="calibre_link-2697">expansion results</span> in the creation of virtual tables by the DAX engine that include the columns of the base table and then expand into all the columns from related tables on the one side of the relationship. The DAX engine then uses the expanded table to group by values in the expanded table’s columns and apply filters accordingly. Therefore, every table has a matching expanded version of itself that is generated in memory that contains all its <em class="emphasistypeitalic">own columns plus any columns from tables that are related to it</em>, which are on the one side of the relationship either directly or indirectly. Relationships only exist to generate expanded tables.</p><div class="para" id="calibre_link-2698">Therefore, we can now talk about both <em class="emphasistypeitalic">base</em> tables and <em class="emphasistypeitalic">expanded</em> tables in our data model. <span id="calibre_link-2699">Base tables</span> are just our tables. <span id="calibre_link-2700">Expanded tables</span> are our base tables that also contain all the columns from tables that are related to them. In our model, for example, we have three tables that will expand: Winesales, Customers, and Regions. The Winesales expanded table will contain all the columns from all the tables in the model. The Customers expanded table will include all the columns from the Regions dimension and the Region Groups dimension. The Regions expanded table will include all the columns from the Region Groups dimension. In Figure <span><a href="#calibre_link-9" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-4</a></span>, we have redesigned our data model to show what it might look like in memory on the evaluation of a measure. Notice there are no relationships between the tables because relationships only exist to generate expanded tables.<figure class="figure1" id="calibre_link-9"><div class="mediaobject" id="calibre_link-2701"><img alt="" src="images/000200.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-4</span><p class="simplepara1">The Winesales, Customers, and Regions tables all expand on the evaluation of measures<span id="calibre_link-2702" class="calibre11"></span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2703">Once a filter is applied to a column, all the expanded tables containing that column are also filtered. Consider Figure <span><a href="#calibre_link-10" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-5</a></span>, which shows the virtual expanded tables and base tables in Model view. We’re looking at what happens when we filter the SALESPERSON column from the SalesPeople base table or the REGION GROUP column from the Region Groups base table.<span id="calibre_link-2704"></span><figure class="figure1" id="calibre_link-10"><div class="mediaobject" id="calibre_link-2705"><img alt="" src="images/000235.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-5</span><p class="simplepara1">How tables are expanded in the <span id="calibre_link-2706" class="calibre11">data model</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2707"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2708">Filtering SALESPERSON from the SalesPeople base table filters the Winesales expanded table.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2709">Filtering REGION GROUP from the Region Groups base table filters the Regions expanded table, the Customers expanded table, and the Winesales expanded table.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-2710">So now we can answer the first of the questions we posed. How can a value in the SALESPERSON column in the SalesPeople dimension filter the Winesales fact table when that value doesn’t exist in the Winesales table? Now you understand that it does exist in the Winesales table. It exists in the Winesales <em class="emphasistypeitalic">expanded</em> table. When we place a filter on the SALESPERSON column, both the SalesPeople base table and the Winesales expanded table are filtered accordingly. Another example would be a filter on the REGION GROUP column in the Region Groups base table. Notice that this filters the REGION GROUP column in the Regions, the Customers, and the Winesales expanded tables.</p><p class="simplepara" id="calibre_link-2711">Relationships only exist to expand tables; they are not used to filter tables. Any reference to a table in a DAX expression is always a reference to the expanded table, where applicable.</p><p class="simplepara" id="calibre_link-2712">Now let’s answer the second question. How can filters be removed from the Winesales table when it has no direct filters on it? When we use ALL inside CALCULATE to remove filters from a table, it removes filters from the <em class="emphasistypeitalic">expanded table</em><em class="emphasistypeitalic"><strong class="emphasistypebold">,</strong></em> if applicable. This includes any columns from dimensions related to the expanded table and therefore includes columns where the filter was originally generated. So the expression <em class="emphasistypeitalic">“ALL ( Winesales )”</em> will remove any filters from any of the base tables related to Winesales, which includes the entire data model.</p><p class="simplepara" id="calibre_link-2713">Understanding table expansion means we can now clarify certain behaviors in DAX that we’ve explored but at the time have not been able to fully explain. For example, we can now truly describe how the <span id="calibre_link-2714">RELATED function</span> works.</p><div class="para" id="calibre_link-2715">RELATED doesn’t “lookup” values in related tables but instead allows you to find columns that already exist in the expanded table. When you use RELATED on the fact table, for instance, you are shown all the columns from the expanded fact table in the IntelliSense list; see Figure <span><a href="#calibre_link-11" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-6</a></span>.<figure class="figure1" id="calibre_link-11"><div class="mediaobject" id="calibre_link-2716"><img alt="" src="images/000110.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-6</span><p class="simplepara1">The <span id="calibre_link-2717" class="calibre11">RELATED function</span> allows you to reference columns from expanded tables</p></div></figcaption></figure></div><div class="para" id="calibre_link-2718">Like RELATED, the ALLEXCEPT and SUMMARIZE <span id="calibre_link-2719">functions</span> also allow you to use the columns in expanded tables. When constructing an expression using these functions, if you reference a fact table or a snowflake dimension, you are again presented with all the columns from the expanded table in the IntelliSense list; see Figure <span><a href="#calibre_link-12" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-7</a></span>.<figure class="figure1" id="calibre_link-12"><div class="mediaobject" id="calibre_link-2720"><img alt="" src="images/000103.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-7</span><p class="simplepara1">SUMMARIZE will also reference expanded tables</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2721">You may be thinking that knowledge of table expansion is purely theoretical. It explains certain behaviors regarding filter propagation but doesn’t lead you forward in constructing more complex DAX expressions. Now is the time to change that perception of table expansion and to learn how to put your knowledge of expanded tables to beneficial use.</p></section><section class="section" id="calibre_link-248"><h2 class="booksubtitle">Leveraging Expanded Tables</h2><p class="simplepara" id="calibre_link-2722"><span id="calibre_link-2723">For</span> the most part, the reason you will use table expansion in your expressions is to “reach” dimensions to perform aggregations on columns within them. You may think that we’ve already covered this scenario when we looked at the CROSSFILTER function that enabled you to reverse the direction of filter propagation. The RELATED function also allows you to pull values from dimensions and snowflake tables into the fact table to enable such aggregations. However, both these approaches are not best practices for reasons we will elucidate as you read on.</p><section class="section" id="calibre_link-249"><h3 class="booksubtitle">“Reaching” Dimensions</h3><p class="simplepara" id="calibre_link-2724">Let’s see how table expansion can allow you to break free from the limitations imposed on you by star and snowflake schemas. For this, as we’ve often done before, we’ll work through a scenario.</p><div class="para" id="calibre_link-2725">You have been asked to calculate in how many different regions you’ve sold each wine. The Regions table is a snowflake <span id="calibre_link-2726">dimension</span>. It is related to the Customers table that’s in turn related to Winesales. Currently, the only way you can deduce in which region a transaction was made is through the Customers table; see Figure <span><a href="#calibre_link-13" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-8</a></span>.<figure class="figure1" id="calibre_link-13"><div class="mediaobject" id="calibre_link-2727"><img alt="" src="images/000183.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-8</span><p class="simplepara1">The region in which a transaction was made can only be found through the <span id="calibre_link-2728" class="calibre11">Customers table</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2729">You now know, however, that all the columns in the Regions table are in the expanded Winesales table. Therefore, one approach would be to create a calculated column in the Winesales base table using RELATED to find the REGION column from the expanded Winesales table as shown in Figure <span><a href="#calibre_link-14" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-9</a></span>.<figure class="figure1" id="calibre_link-14"><div class="mediaobject" id="calibre_link-2730"><img alt="" src="images/000088.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-9</span><p class="simplepara1">You can use <span id="calibre_link-2731" class="calibre11">RELATED</span> in the fact table to show the region name</p></div></figcaption></figure></div><div class="para" id="calibre_link-2732">You could then write the measure “Distinct Regions” using DISTINCTCOUNT on this calculated column, as shown in the following:<div class="programcode" id="calibre_link-2733"><div class="calibre4"><div class="fixedline">Distinct Regions =</div><div class="fixedline">DISTINCTCOUNT ( Winesales[REGION] )</div></div></div></div><p class="simplepara" id="calibre_link-2734">However, all that’s happening here is that you are accessing the REGION column in the expanded Winesales table. You also know that calculated columns should be avoided if possible. There is a better way to calculate the distinct number of regions, and that is to use CALCULATE with a table filter that will filter the Regions table. To do this, we first must remind ourselves how we construct the filter arguments in <span id="calibre_link-2735">CALCULATE</span>.</p><p class="simplepara" id="calibre_link-2736">You’ve learned that the filter arguments inside CALCULATE can contain a table expression. But the filter argument doesn’t have to be a table expression; it can just be a reference to a table<em class="emphasistypeitalic"><strong class="emphasistypebold">.</strong></em> If you reference a table in the filter argument of CALCULATE, this will always be the <em class="emphasistypeitalic">expanded table</em>, where applicable<em class="emphasistypeitalic"><strong class="emphasistypebold">.</strong></em></p><div class="para" id="calibre_link-2737">Returning to calculating the number of different regions in which you’ve sold your wines, you can use the expanded Winesales table that contains the REGION column as the filter for <span id="calibre_link-2738">CALCULATE</span>. If you do this, you can then use a measure to count the rows of the Regions table that have been filtered via the Winesales expanded table. This would be the measure:<div class="programcode" id="calibre_link-2739"><div class="calibre4"><div class="fixedline">Distinct Regions =</div><div class="fixedline">CALCULATE ( COUNTROWS ( Regions ), Winesales )</div></div></div></div><p class="simplepara" id="calibre_link-2740">You must note the simplicity of this expression but the complexity of the concept that lies behind it and also remember something we stated earlier; with DAX, the devil is in the detail.</p><div class="para" id="calibre_link-2741">We can see the evaluation of this measure in Figure <span><a href="#calibre_link-15" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-10</a></span>.<figure class="figure1" id="calibre_link-15"><div class="mediaobject" id="calibre_link-2742"><img alt="" src="images/000080.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-10</span><p class="simplepara1">The evaluation of “<span id="calibre_link-2743" class="calibre11">Distinct Regions</span>” using the expanded Winesales table</p></div></figcaption></figure></div><div class="para" id="calibre_link-2744">The “<span id="calibre_link-2745">Distinct Regions</span>” measure uses the expanded Winesales table in the filter argument of CALCULATE to filter the Regions base table. In the evaluation of this measure, we know that the filter on the WINE column in the Wines table will filter the WINE column in the expanded Winesales table. We also know that the expanded Winesales table contains all the columns in the Regions table. Therefore, the regions where we’ve sold each wine in the current filter context will also be filtered. The expanded Winesales table, filtered for each wine in the current filter context, is used to filter the Regions table accordingly. The Regions table now contains only regions where the wine in the current filter context was sold and the rows of the filtered Regions dimension are counted; see Figure <span><a href="#calibre_link-16" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-11</a></span>.<figure class="figure1" id="calibre_link-16"><div class="mediaobject" id="calibre_link-2746"><img alt="" src="images/000018.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-11</span><p class="simplepara1">Base tables and expanded <span id="calibre_link-2747" class="calibre11">tables</span> used in filter propagation</p></div></figcaption></figure></div><div class="para" id="calibre_link-2748"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2749">The WINE column in the Wines table filters the WINE column in the expanded Winesales table.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2750">The expanded Winesales table contains all the columns in the Regions table. The filter in the expanded Winesales fact table is used to filter the Regions table whose rows are then counted.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-2751">What we can conclude from this measure is that with CALCULATE, you can use an expanded table to filter a base table.</p><div class="para" id="calibre_link-2752">Let’s look at another example of using expanded tables in our code but this time to author a more challenging calculation. We are going to repeat the scenario before, in that you’ve been asked to find the number of different regions where you’ve sold wines, but this time, you must consider only high-volume regions. You’ve identified that high-volume regions are any regions where transactions of CASES SOLD are greater than 325. To do this calculation, rather than using the entire expanded Winesales table as in the “Distinct Regions” expression, you can use FILTER to filter the expanded Winesales table (highlighted):<div class="programcode" id="calibre_link-2753"><div class="calibre4"><div class="fixedline">Distinct High Volume Regions=</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS ( Regions ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[CASES SOLD] &gt;325 )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2754">When you put this measure into a Table visual, you will find that for “Bordeaux”, there are <strong class="emphasistypebold">18</strong> regions where there are transactions of CASES SOLD greater than 325 but when selling “Grenache”, there are only <strong class="emphasistypebold">7</strong> regions; see Figure <span><a href="#calibre_link-17" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-12</a></span>.<figure class="figure1" id="calibre_link-17"><div class="mediaobject" id="calibre_link-2755"><img alt="" src="images/000244.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-12</span><p class="simplepara1">The “Distinct High Volume Regions” measure evaluated in a Table <span id="calibre_link-2756" class="calibre11">visual</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2757">If we examine the evaluation of the “Distinct High Volume Regions” measure, in Figure <span><a href="#calibre_link-18" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-13</a></span>, you can see that it varies from the “Distinct Regions” measure only in the additional step where the Winesales base table is filtered. The measure filters the WINE column in the Wines dimension and also filters the expanded Winesales table. The FILTER function further filters the Winesales base table to rows where CASES SOLD is greater than 325. The columns from the Regions table are in the expanded Winesales table and so are also filtered. Counting the number of rows in the Regions table reflects only the regions filtered in the expanded Winesales table.<figure class="figure1" id="calibre_link-18"><div class="mediaobject" id="calibre_link-2758"><img alt="" src="images/000253.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-13</span><p class="simplepara1">Base tables and expanded <span id="calibre_link-2759" class="calibre11">tables</span> used in filter propagation</p></div></figcaption></figure></div><div class="para" id="calibre_link-2760"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2761">The WINE column filters the WINE column in the expanded Winesales table.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2762">The CASES SOLD column in the Winesales base table is filtered for greater than 325.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2763">The expanded Winesales table contains all the columns in the Regions table. The filter in the expanded Winesales fact table is used to filter the Regions table.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-2764">Knowledge of table expansion also helps to clarify a premise that we have explored a number of times throughout this book, and that is the difference between table filters and column filters. Now that we know that table filters will often involve expanded tables, let’s take the measure we have just authored and compare it with another measure that looks almost identical. However, one uses a table filter, using an expanded table, and the other uses a column filter, as shown in the following:<div class="programcode" id="calibre_link-2765"><div class="calibre4"><div class="fixedline">Distinct High Volume Regions Table Filter =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS ( Regions ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( Winesales, Winesales[CASES SOLD] &gt; 325 )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2766"><div class="programcode" id="calibre_link-2767"><div class="calibre4"><div class="fixedline">Distinct High Volume Regions Column Filter =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS ( Regions ), Winesales[CASES SOLD] &gt; 325 )</div></div></div></div><div class="para" id="calibre_link-2768">You can see in Figure <span><a href="#calibre_link-19" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-14</a></span> that we get different values being returned by similar measures. The reason for this is that the first measure filters the Winesales expanded table and the second measure filters only the CASES SOLD column in the Winesales <em class="emphasistypeitalic">base</em> table.<figure class="figure1" id="calibre_link-19"><div class="mediaobject" id="calibre_link-2769"><img alt="" src="images/000124.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-14</span><p class="simplepara1">Similar <span id="calibre_link-2770" class="calibre11">measures</span> can return different results</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2771">The correct calculation, “Distinct High Volume Regions Table Filter”, uses the table filter generated by the FILTER function that filters the expanded Winesales table, filtering the CASES SOLD column. This also filters the regions in the expanded table, and this is used to filter the Regions dimension. This measure then counts the rows in the Regions base table that have been filtered by the Winesales expanded table; see Figure <span><a href="#calibre_link-18" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-13</a></span>.</p><div class="para" id="calibre_link-2772">The measure “Distinct High Volume Regions Column Filter” generates a filter only on the CASES SOLD column in the Winesales <em class="emphasistypeitalic">base</em> table, and no filters are propagated in the model. It, therefore, counts <em class="emphasistypeitalic">all</em> the rows in the Regions table irrespective of any filters in the Winesales table; see Figure <span><a href="#calibre_link-20" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-15</a></span>.<figure class="figure1" id="calibre_link-20"><div class="mediaobject" id="calibre_link-2773"><img alt="" src="images/000228.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-15</span><p class="simplepara1">Base tables and expanded tables used in filter <span id="calibre_link-2774" class="calibre11">propagation</span></p></div></figcaption></figure></div><div class="para" id="calibre_link-2775"><div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2776">The WINE column is filtered in both the expanded and base Wines table.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2777">Filtering a column in the Winesales base table does not propagate filters to dimension tables.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-2778">The takeaway from these examples is that using an expanded table in the filter argument of CALCULATE enables you to pass filters into dimension and snowflake tables, in effect reversing the direction of filter propagation. This is because the expanded table contains the columns from these dimensions that can then be grouped and filtered. However, a question that must now be answered is the following: What is the difference between using expanded tables and using CROSSFILTER. Isn’t the end result of using these different methods the same? For instance, we can author this expression using an expanded table:<div class="programcode" id="calibre_link-2779"><div class="calibre4"><div class="fixedline">Distinct Regions #1 =</div><div class="fixedline">CALCULATE ( COUNTROWS ( Regions ), Winesales )</div></div></div></div><div class="para" id="calibre_link-2780">Or we can author this measure using <span id="calibre_link-2781">CROSSFILTER</span> that we might assume would return the same result:<div class="programcode" id="calibre_link-2782"><div class="calibre4"><div class="fixedline">Distinct Regions #2 =</div><div class="fixedline">CALCULATE(COUNTROWS(Regions),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CROSSFILTER(Winesales[CUSTOMER ID],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Customers[CUSTOMER ID],both),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CROSSFILTER(Customers[REGION ID],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Regions[REGION ID],both))</div></div></div></div><p class="simplepara" id="calibre_link-2783">Both these measures will “reach” the Regions table. Clearly, the second measure is a great deal clumsier than the first, but is there a difference in the evaluation? The answer is yes, there is, and we will now explain why.</p></section><section class="section" id="calibre_link-250"><h3 class="booksubtitle">Table Expansion vs. CROSSFILTER</h3><div class="calibre4" id="calibre_link-2784">In Chapter <span><a href="#calibre_link-21" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>13</span></a></span>, when we explored the <span id="calibre_link-2785">CROSSFILTER function</span><span id="calibre_link-2786"></span>, we authored a measure to sum the NO. OF STORES column in the Customers table to calculate the number of stores in which we’d sold our wines. Just to remind you, the problem was that filters don’t flow from the Wines dimension through to the Customers dimension so we used the CROSSFILTER function to programmatically change the direction of the filter propagation to a bidirectional filter:<div class="programcode" id="calibre_link-2787"><div class="calibre4"><div class="fixedline">Total Stores =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Customers[NO. OF STORES] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CROSSFILTER ( Winesales[CUSTOMER ID],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Customers[CUSTOMER ID], BOTH )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2788">However, we didn’t tell you at the time, and neither would you have noticed, but this measure returns an incorrect value on the Total row; see Figure <span><a href="#calibre_link-22" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-16</a></span>.<figure class="figure1" id="calibre_link-22"><div class="mediaobject" id="calibre_link-2789"><img alt="" src="images/000157.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-16</span><p class="simplepara1">The “Total Stores” measure is not correct in the Total row</p></div></figcaption></figure></div><div class="para" id="calibre_link-2790">Many of the same customers will have bought each wine, so we know that the total of <strong class="emphasistypebold">1,181</strong> will not be the sum of the total values for each wine. However, you might think this value looks about right and so believe it. The value in the Total row should be the total number of stores in which we’ve sold all our wines. This value is not correct because in the Customers table, we have five customers to whom we’ve sold no wines. If we “show items with no data” in a Table visual where we calculate the “Total Sales” measure, we can see who they are; see Figure <span><a href="#calibre_link-23" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-17</a></span>.<figure class="figure1" id="calibre_link-23"><div class="mediaobject" id="calibre_link-2791"><img alt="" src="images/000009.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-17</span><p class="simplepara1">There are five customers that have no sales</p></div></figcaption></figure></div><div class="para" id="calibre_link-2792">The value of <strong class="emphasistypebold">1,181</strong> shown in the Total row includes the stores for these customers. We can see these values in the Customers table in the NO. OF STORES column; see Figure <span><a href="#calibre_link-24" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-18</a></span>.<figure class="figure1" id="calibre_link-24"><div class="mediaobject" id="calibre_link-2793"><img alt="" src="images/000149.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-18</span><p class="simplepara1">Customers with no sales have values in the NO. OF STORES column</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2794">We haven’t sold any wine to these customers, so clearly their stores shouldn’t be included in the total number of stores in which we’ve sold our wines. Our total is out by <strong class="emphasistypebold">69</strong>.</p><p class="simplepara" id="calibre_link-2795">What’s happening here is that the “Total Stores” measure uses a bidirectional filter. When it arrives at the evaluation of the Total row, the filters are removed from the WINE column of the Wines dimension, and therefore, there is no filter to propagate to the Customers dimension. With no filters propagated, it sums all the values in the NO. OF STORES column. In other words, bidirectional filters are only active if filters are active.</p><p class="simplepara" id="calibre_link-2796">So how do you calculate the correct value of <strong class="emphasistypebold">1,112</strong> in the Total row?</p><p class="simplepara" id="calibre_link-2797">What you must do here is use the expanded Winesales fact table as the filter for the Customers table. This is because, unlike bidirectional filtering, filters from expanded tables are always active. When the Total row is evaluated, the expanded Winesales fact table contains only those customers who have bought wines, and so this will filter the Customers dimension accordingly.</p><div class="para" id="calibre_link-2798">This is the measure that will give you the correct total:<div class="programcode" id="calibre_link-2799"><div class="calibre4"><div class="fixedline">Total Stores #2 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;SUM ( Customers[NO. OF STORES] ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;Winesales</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2800">You can now see in Figure <span><a href="#calibre_link-25" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-19</a></span> that the Total row now shows <strong class="emphasistypebold">1,112</strong>.<figure class="figure1" id="calibre_link-25"><div class="mediaobject" id="calibre_link-2801"><img alt="" src="images/000041.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-19</span><p class="simplepara1">Using table expansion returns the correct value in the Total row</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2802">When working with DAX, not only must you have to have an eye for detail and a suspicious mind, but you must also understand table expansion.</p></section><section class="section" id="calibre_link-251"><h3 class="booksubtitle">Using Snowflake Schemas</h3><div class="calibre4" id="calibre_link-2803">Understanding table expansion also explains how we can have problems with <span id="calibre_link-2804">“snowflake</span>”-type schemas. This is where there may be a chain of several tables all related in one-to-many relationships through to the fact table. In our data model, we’ve extended our Regions snowflake by adding another table, Region Groups, which is related to Regions via the REGION GROUP ID. We can see in Figure <span><a href="#calibre_link-26" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-20</a></span> how the Region Groups table is related to the Regions table through the REGION GROUP ID,&nbsp;the Regions table is related to the Customers table through the REGION ID, and the Customers table is related to Winesales through the CUSTOMER ID.<figure class="figure1" id="calibre_link-26"><div class="mediaobject" id="calibre_link-2805"><img alt="" src="images/000209.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-20</span><p class="simplepara1">A snowflake schema comprising Region Groups, Regions, and Customers</p></div></figcaption></figure></div><div class="para" id="calibre_link-2806">In Figure <span><a href="#calibre_link-27" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-21</a></span>, we’ve filtered “South West” Region Group in a slicer and are showing customers in that Region Group in the Table visual. We’ve attempted to calculate the total sales for these customers (<strong class="emphasistypebold">3,512,539</strong>) so that we can use this value as a denominator to calculate the percentage each customer’s sales are of the total for the “South West” region group. This is the measure we have authored using ALL on the Customers table:<div class="programcode" id="calibre_link-2807"><div class="calibre4"><div class="fixedline">Total Sales for All Customers in Region Group wrong =</div><div class="fixedline">CALCULATE ( [Total Sales], ALL ( Customers ) )</div></div></div><figure class="figure1" id="calibre_link-27"><div class="mediaobject" id="calibre_link-2808"><img alt="" src="images/000065.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-21</span><p class="simplepara1">Calculation of the the total sales for all customers in the region group is not correct</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2809">As you can see in Figure <span><a href="#calibre_link-27" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-21</a></span>, it does not return the correct result, which should be <strong class="emphasistypebold">$3,512,539</strong>. You will also notice that because we are removing all the filters from the Customers table, the Table visual now shows all our customers, not just those in the “South West” region group.</p><p class="simplepara" id="calibre_link-2810">Let’s now explain why we get the wrong calculation. When we use ALL inside CALCULATE to remove filters from a table, it removes filters from the expanded table, if applicable. This measure, therefore, removes filters from the expanded Customers table and so also removes filters from both the Regions table and the Region Groups table. It, therefore, calculates a total for <em class="emphasistypeitalic">all</em> region groups. The Region Groups table is at the end of the snowflake of tables, so this is the same value as the grand total sales.</p><div class="para" id="calibre_link-2811">Figure <span><a href="#calibre_link-28" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-22</a></span> shows how removing filters from the expanded Customers table will also remove filters from Regions and Region Groups.<figure class="figure1" id="calibre_link-28"><div class="mediaobject" id="calibre_link-2812"><img alt="" src="images/000133.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-22</span><p class="simplepara1">Removing filters from the Customers expanded table <span id="calibre_link-2813" class="calibre11">removes filters</span> from Regions and Region Groups</p></div></figcaption></figure></div><div class="para" id="calibre_link-2814">To calculate the correct denominator, there are several ways to modify the original measure to reapply the filter “lost” on the Customers table. We could, for example, use ALLEXCEPT to remove the filter on the expanded Customers table except for the filter on the REGION GROUP column (because REGION GROUP is contained in the Customers expanded table):<div class="programcode" id="calibre_link-2815"><div class="calibre4"><div class="fixedline">Total Sales for All Customers in Region Group #1=</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALLEXCEPT ( Customers, 'Region Groups'[REGION GROUP]))</div></div></div></div><div class="para" id="calibre_link-2816">Another approach is to use the filter currently on the Region Groups table that has been generated by the slicer, which currently is “South West”. This measure will also give us the denominator we require:<div class="programcode" id="calibre_link-2817"><div class="calibre4"><div class="fixedline">Total Sales for All Customers in Region Group #2 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;[Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;ALL ( Customers ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;'Region Groups')</div></div></div></div><p class="simplepara" id="calibre_link-2818">In the “Total Sales for All Customers in Region Group #2” measure, the ALL function removes all the filters from the expanded Customers table, but by using Region Groups as a table filter in the second filter argument in CALCULATE, this reapplies the “South West” filter on the expanded Customers table and therefore also filters the Regions table and the Region Groups table.</p><div class="formalpara" id="calibre_link-2819"><div class="heading1">Note</div><p class="para6" id="calibre_link-2820">To remove the customers with no “Total Sales” value from the Table visual, use a visual-level filter, filtering “Total Sales” is not blank.</p></div><div class="calibre4" id="calibre_link-2821">We now get the correct denominator; see Figure <span><a href="#calibre_link-29" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">18-23</a></span>.<figure class="figure1" id="calibre_link-29"><div class="mediaobject" id="calibre_link-2822"><img alt="" src="images/000058.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 18-23</span><p class="simplepara1">You need to reapply “lost” filters when removing filters from expanded tables</p></div></figcaption></figure></div><div class="para" id="calibre_link-2823">It would also be possible to use this simpler measure using <span id="calibre_link-2824">ALLSELECTED</span>.<div class="programcode" id="calibre_link-2825"><div class="calibre4"><div class="fixedline">Total Sales for All Customers in Region Group #3 =</div><div class="fixedline">CALCULATE ( [Total Sales], ALLSELECTED ( Customers ) )</div></div></div></div><p class="simplepara" id="calibre_link-2826">What you are seeing in these examples is the perennial problem with “snowflake”-type schemas. Where you have a chain of tables in many-to-one relationships outward from the fact table, when you remove filters from tables nearer the fact table by using ALL inside CALCULATE, you will also remove all the filters up the chain.</p><p class="simplepara" id="calibre_link-2827">In this chapter, we have delved into the final major concept that underpins DAX, that of table expansion. You have learned that relationships in the data model only serve to generate expanded tables and that filter propagation works by filtering columns inside expanded tables, not by performing lookups from dimensions into the fact table. Knowing about table expansion enables you to author expressions that can use the filter currently placed on the expanded table and therefore pass filters back to dimension tables, in effect reversing the direction of filter propagation.</p><div class="para" id="calibre_link-2828">You are now about to move on to the last chapter in this book. Congratulations on getting this far! It hasn’t always been an easy journey, and some DAX expressions we have investigated together would be demanding to any DAX user. However, you now understand the four major concepts that underpin DAX:<div class="calibre4"><ul class="unorderedlistmarknone"><li class="calibre9"><p class="para2" id="calibre_link-2829">Evaluation context</p></li><li class="calibre9"><p class="para2" id="calibre_link-2830">Iterators</p></li><li class="calibre9"><p class="para2" id="calibre_link-2831">Context transition</p></li><li class="calibre9"><p class="para2" id="calibre_link-2832">Table expansion</p></li></ul></div></div><p class="simplepara" id="calibre_link-2833">According to Alberto Ferrari in his blog “7 reasons DAX is not easy,” you are now a DAX guru!<sup class="calibre7"><a type="noteref" href="#calibre_link-30" id="calibre_link-32" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">2</a></sup></p><p class="simplepara" id="calibre_link-2834">However, regarding these concepts, Alberto goes on to say <em class="emphasistypeitalic">“The thing is: you need to master them, not only have some basic knowledge of what they are. Moreover, these are foundational concepts: they have nothing to do with specific functions.”</em></p><p class="simplepara" id="calibre_link-2835">Let this be the best advice. On the completion of this book, you will not be at the end of your journey through learning DAX, but only at the end of the beginning. You must now assimilate your knowledge, work with it, and have the confidence to tackle challenging calculations that will furnish you with the insights into your data that truly inform.</p><p class="simplepara" id="calibre_link-2836">However, you still have one chapter to go. In the next chapter, we will be taking your expert knowledge of DAX to the next level. You will be learning the purpose of the function CALCULATETABLE.</p></section></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-31" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-2" role="doc-footnote"><p class="para3" id="calibre_link-2837">To follow along with the examples, use the Power BI Desktop file “6 DAX Expanded Tables.pbix”.</p></div><div class="clearboth1">&nbsp;</div></div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-32" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">2</a></span><div class="calibre4" type="footnote" id="calibre_link-30" role="doc-footnote"><p class="para3" id="calibre_link-2838"><span><a href="http://sqlbi.com" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span>SQLBI.​com</span></a></span>. 7 reasons DAX is not easy, June 2020. [Online]. Available from <span><a href="http://www.sqlbi.com/blog/alberto/2020/06/20/7-reasons-dax-is-not-easy/" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre"><span><span class="emphasisfontcategorynonproportional">www.sqlbi.com/blog/alberto/2020/06/20/7-reasons-dax-is-not-easy/</span></span></a></span></p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-44">
<div id="calibre_link-2839" class="calibre2">
<div id="calibre_link-2840" class="calibre3"><div type="chapter" role="doc-chapter" class="calibre4"><div class="chaptercontextinformation"><div class="contextinformation" id="calibre_link-2841"><div class="calibre4">©&nbsp;The Author(s), under exclusive license to APress Media, LLC, part of Springer Nature&nbsp;2022</div><span class="pcalibre5">A. Box</span><span><span class="booktitle1">Up and Running with DAX for Power BI </span></span><span class="calibre3"><a href="https://doi.org/10.1007/978-1-4842-8188-8_19" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">https://doi.org/10.1007/978-1-4842-8188-8_19</a></span></div></div><div class="maintitlesection"><h1 class="booktitle" lang="en">19.&nbsp;The CALCULATETABLE Function</h1></div><div class="calibre4"><div class="authornames"><span><span>Alison&nbsp;Box</span><sup class="calibre10"><a href="#calibre_link-45" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a>&nbsp;<span class="contacticon">&nbsp;</span></sup></span></div><div class="calibre4"><div class="calibre4" id="calibre_link-45"><span class="footnotenumber">(1)</span><div class="calibre4">Billingshurst, West Sussex, UK</div></div><div class="clearboth">&nbsp;</div></div></div><div class="calibre4"><p class="para7" id="calibre_link-2842">Now that you are officially a DAX expert, you are ready to confront DAX expressions that will truly test your knowledge and understanding of DAX. One of the DAX functions that can only be understood with a clear grasp of how DAX works is CALCULATETABLE, and this rather obscure function is the last function we will investigate in this book.</p><p class="simplepara" id="calibre_link-2843"><span id="calibre_link-2844">CALCULATETABLE</span> operates in all the same ways as CALCULATE except that it returns a table rather than a scalar value. In other words, it returns a table or table expression where the filter on the table has been modified in some way. On the face of it, therefore, CALCULATETABLE should be straightforward to understand. However, because it returns a table, the question that is often asked is the following: How would it be used inside measures? The reason we’ve left this function till last is because inside measures, it becomes particularly useful when used in conjunction with expanded tables.<sup class="calibre7"><a type="noteref" href="#calibre_link-46" id="calibre_link-57" role="doc-noteref" class="calibre8 pcalibre4 pcalibre2 pcalibre1 pcalibre3 pcalibre">1</a></sup></p><p class="simplepara" id="calibre_link-2845">The syntax for CALCULATETABLE is</p><p class="para9" id="calibre_link-2846"><strong class="emphasistypebold">= CALCULATETABLE (table or table expression, filter1, filter2 etc.)</strong></p><p class="para9" id="calibre_link-2847">where:</p><p class="simplepara" id="calibre_link-2848"><strong class="emphasistypebold">table</strong> or table expression is the table you want to be returned by CALCULATETABLE.</p><p class="simplepara" id="calibre_link-2849"><strong class="emphasistypebold">filter1, 2</strong> etc. provides the filter for the table returned by <strong class="emphasistypebold">table</strong>.</p><p class="simplepara" id="calibre_link-2850">You may think that this function seems remarkably similar to the FILTER function, and indeed, you can often use CALCULATETABLE in place of FILTER.</p><section class="section" id="calibre_link-252"><h2 class="booksubtitle">CALCULATETABLE vs. FILTER</h2><div class="calibre4" id="calibre_link-2851">However, CALCULATETABLE, unlike <span id="calibre_link-2852">FILTER</span>, <em class="emphasistypeitalic">modifies</em> the filter context, and this is the first behavior of this function that we will explore. Let’s compare these two measures:<div class="programcode" id="calibre_link-2853"><div class="calibre4"><div class="fixedline">Sales of Red Wines Filter =</div><div class="fixedline">&nbsp;CALCULATE ( [Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;FILTER ( Wines, Wines[TYPE] = "red" )</div><div class="fixedline">)</div></div><div class="calibre4"><div class="fixedline">Sales of Red Wines CalculateTable =</div><div class="fixedline">CALCULATE ( [Total Sales],</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE ( Wines, Wines[TYPE] = "red" )</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2854">Both these expressions are building a table filter for CALCULATE. The first uses FILTER to build the table containing red wines, and the second uses CALCULATE to build a similar table. These two measures return the same values. However, CALCULATETABLE will modify the filter context. Therefore, if the TYPE column from the Wines dimension is providing the filter context, it will <em class="emphasistypeitalic">replace</em> the filter on TYPE. Therefore, if “White” is the filter, it will be replaced with “Red”. FILTER can only filter what’s already in the filter context and so returns no value if “White” is the current filter; see Figure <span><a href="#calibre_link-47" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">19-1</a></span>.<figure class="figure1" id="calibre_link-47"><div class="mediaobject" id="calibre_link-2855"><img alt="" src="images/000075.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 19-1</span><p class="simplepara1">CALCULATETABLE will modify the <span id="calibre_link-2856" class="calibre11">filter context</span>, but FILTER can only filter within the current filter context</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2857">The CALCULATETABLE function, therefore, becomes useful when you must generate an in-memory table where the filter context must be modified. In reality, FILTER and CALCULATETABLE are very different functions even if their output is sometimes the same. The former creates a virtual table by iterating another table within the current filter context. The latter also generates a virtual table but uses a <em class="emphasistypeitalic">new filter context</em> to build the <span id="calibre_link-2858">virtual table</span>.</p><div class="para" id="calibre_link-2859">To illustrate this, let’s build a measure named “Current No. of Sales” that will calculate the number of sales generated in each region up to the end of the prior month, the year and month being selected in a slicer; see Figure <span><a href="#calibre_link-48" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">19-2</a></span>.<figure class="figure1" id="calibre_link-48"><div class="mediaobject" id="calibre_link-2860"><img alt="" src="images/000012.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 19-2</span><p class="simplepara1">Calculating the number of sales up to the end of the prior month</p></div></figcaption></figure></div><div class="para" id="calibre_link-2861">There are three steps to this <span id="calibre_link-2862">calculation</span>:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2863">First, we must filter the DateTable for all the dates up to the end of the prior month selected in the slicer e.g., up to but not including the 1st May 2021.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2864">The filtered DateTable can then be used to filter the Winesales table to contain only the sales up to the end of the prior month.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2865">We can then use COUNTROWS to count how many sales there are in the filtered Winesales table.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-2866">The question will be the following: Which filter function are we going to use for step 2 that will generate the DateTable that will filter the Winesales table for the dates we need? Are we going to use FILTER or CALCULATETABLE? We’ve constructed two versions of the measure, the first using CALCULATETABLE and the second using FILTER (highlighted) where we will then have a second inner FILTER function:<div class="programcode" id="calibre_link-2867"><div class="calibre4"><div class="fixedline">Current No. of Sales CalculateTable =</div><div class="fixedline">COUNTROWS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( ALL ( DateTable ), DateTable[DATEKEY] &lt; MIN ( DateTable[DATEKEY] ) )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div><div class="calibre4"><div class="fixedline">Current No. of Sales Filter =</div><div class="fixedline">COUNTROWS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( ALL ( DateTable ), DateTable[DATEKEY] &lt; MIN ( DateTable[DATEKEY] ) )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div></div></div><div class="para" id="calibre_link-2868">The measure using CALCULATETABLE would be the correct measure because if you attempt to use the measure using FILTER, you get an error, as shown in Figure <span><a href="#calibre_link-49" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">19-3</a></span>.<figure class="figure1" id="calibre_link-49"><div class="mediaobject" id="calibre_link-2869"><img alt="" src="images/000247.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 19-3</span><p class="simplepara1">Using FILTER to filter the <span id="calibre_link-2870" class="calibre11">DateTable returns</span> an error</p></div></figcaption></figure></div><div class="para" id="calibre_link-2871">If we consider that these functions are interchangeable, why does CALCULATETABLE work, but FILTER does not? To understand the error when using FILTER, we must look more closely at what the inner FILTER <span id="calibre_link-2872">expression</span> is generating in memory.<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2873">The inner FILTER iterates over the DateTable to find all dates up to the end of the prior month.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2874">The inner FILTER creates a new virtual DateTable containing just these dates.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2875">The outer FILTER then uses the virtual DateTable to filter the rows of the Winesales table, iterating each row in the Winesales table accordingly.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-2876">What is the criterion by which each row in the Winesales table will be filtered in step 3? You can’t filter a row by values in an entire table, and so we get this error:</p><p class="para9" id="calibre_link-2877"><em class="emphasistypeitalic">“The expression refers to multiple columns. Multiple columns cannot be converted to a scalar value.”</em></p><p class="para9" id="calibre_link-2878">The table generated by FILTER is the “multiple columns” alluded to in the <span id="calibre_link-2879">error message</span>, and it tells us that if using FILTER, we can only return scalar values for the criterion to filter rows. It’s not possible to use a table expression in the filter expression of FILTER, only predicates.</p><div class="para" id="calibre_link-2880">How does the CALCULATETABLE measure differ? In the correct measure:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2881">The inner FILTER iterates over the DateTable to find all dates up to the end of the prior month.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2882">The inner FILTER then generates a virtual DateTable containing just these dates.</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2883">CALCULATETABLE generates a virtual Winesales table that can be filtered by the virtual DateTable generated by FILTER. This is simply a table filter and therefore is used in the same way as any table filter that would normally be placed inside CALCULATE.</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><p class="simplepara" id="calibre_link-2884">In other words, the virtual table generated by FILTER provides the <em class="emphasistypeitalic">new filter context</em> for CALCULATETABLE by which the virtual Winesales table can be filtered. The rows of the virtual Winesales table can then be counted.</p><div class="para" id="calibre_link-2885">At this stage of exploring CALCULATETABLE, hopefully, you have worked out that if you want to calculate the “Current No. of Sales”, the following measure, using CALCULATE, would be much simpler to write and not return an error:<div class="programcode" id="calibre_link-2886"><div class="calibre4"><div class="fixedline">Current No. of Sales =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS ( Winesales ),</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( ALL ( DateTable ), DateTable[DATEKEY]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&lt; MIN ( DateTable[DATEKEY] ) ) )</div></div></div></div><div class="para" id="calibre_link-2887"><span id="calibre_link-2888"></span>However, we are exploring the difference between CALCULATETABLE and FILTER, and this measure does not illustrate this. But more than this, make a mental note of the expression using CALCULATETABLE as it will be a “building block” in more complex expressions that follow later in this chapter. Here is the expression again that calculates how many sales in each region there have been up to the end of the prior month:<div class="programcode" id="calibre_link-2889"><div class="calibre4"><div class="fixedline">Current No. of Sales CalculateTable =</div><div class="fixedline">COUNTROWS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( ALL ( DateTable ), DateTable[DATEKEY] &lt; MIN ( DateTable[DATEKEY] ) )</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;)</div><div class="fixedline">)</div></div></div></div><p class="simplepara" id="calibre_link-2890">Specifically, we will be using this expression as a constituent part of the calculations for “New Regions” and “Returning Regions” later.</p><p class="simplepara" id="calibre_link-2891">We’ve established that CALCULATETABLE will modify the filter context when generating a virtual table, but we haven’t yet found a useful application for this function. Where CALCULATETABLE really comes into its own is when you reference an <em class="emphasistypeitalic">expanded</em> table in this function’s filter argument so that it can then be used as a table filter.</p></section><section class="section" id="calibre_link-253"><h2 class="booksubtitle">CALCULATETABLE and Table Expansion</h2><p class="simplepara" id="calibre_link-2892">Just as with CALCULATE, you can use expanded tables as filter expressions to modify the filter context inside CALCULATETABLE. So, for instance, the following table <span id="calibre_link-2893">expression</span></p><p class="simplepara" id="calibre_link-2894">=CALCULATETABLE ( Regions, Winesales )</p><div class="para" id="calibre_link-2895"><span id="calibre_link-2896"></span>will return a virtual Regions table containing only the rows of this table that are in the current filter in the expanded Winesales table. If we count the rows of the Regions table generated by CALCULATETABLE, this would be an alternative way of finding how many distinct regions we have sales within the current filter context. So these two measures, both using the expanded Winesales table, return the same values:<div class="programcode" id="calibre_link-2897"><div class="calibre4"><div class="fixedline">Distinct Regions #1 =</div><div class="fixedline">CALCULATE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS ( Regions ), Winesales )</div></div><div class="calibre4"><div class="fixedline">Distinct Regions #2=</div><div class="fixedline">&nbsp;COUNTROWS (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE ( Regions, Winesales )</div></div></div></div><p class="simplepara" id="calibre_link-2898">By understanding that a table filter inside CALCULATETABLE will use an expanded table where applicable, we can now use this knowledge to resolve more challenging calculations. One of these more challenging calculations is finding “new” and/or “returning” entities, such as new and returning customers or new and returning sales regions.</p><section class="section" id="calibre_link-254"><h3 class="booksubtitle">Calculating “New” Entities</h3><p class="simplepara" id="calibre_link-2899"><span id="calibre_link-2900">Typically</span>, this would involve discovering how many new customers or new sales regions there are within a specific month, quarter, or year, perhaps further refined by considering only sales for a specific salesperson.</p><div class="para" id="calibre_link-2901">For example, you have been asked to show in how many <em class="emphasistypeitalic">new</em> regions your salespeople have made sales in any given month. You do this by using the following “New Regions” measure that uses CALCULATETABLE:<div class="programcode" id="calibre_link-2902"><div class="calibre4"><div class="fixedline">New Regions =</div><div class="fixedline">VAR CurrentRegions =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE ( Regions, Winesales )</div></div><div class="calibre4"><div class="fixedline">VAR PreviousRegions =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Regions,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE ( Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( ALL ( DateTable ), DateTable[DATEKEY]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&lt; MIN ( DateTable[DATEKEY] ) ) ) )</div></div><div class="calibre4"><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS ( EXCEPT ( CurrentRegions, PreviousRegions ) )</div></div></div></div><p class="simplepara" id="calibre_link-2903">You can see the result of this measure in the Table visual in Figure <span><a href="#calibre_link-50" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">19-4</a></span>.</p><div class="formalpara" id="calibre_link-2904"><div class="heading1">Note</div><p class="para6" id="calibre_link-2905">You could substitute “Customers” for “Regions” if you want to find new customers.</p></div><div class="calibre4"><figure class="figure1" id="calibre_link-50"><div class="mediaobject" id="calibre_link-2906"><img alt="" src="images/000120.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 19-4</span><p class="simplepara1">Calculating the number of new regions for each salesperson in each month</p></div></figcaption></figure></div><div class="para" id="calibre_link-2907">We can appreciate that the “New Regions” measure is quite a challenge to understand, so let’s separate the three <span id="calibre_link-2908">component expressions</span> within the measure as follows:<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2909">The “CurrentRegions” variable</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2910">The “PreviousRegions variable</p></div><div class="clearboth">&nbsp;</div></li><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2911">The Return statement</p></div><div class="clearboth">&nbsp;</div></li></ol></div></div><div class="para" id="calibre_link-2912">By taking the measure apart, piece by piece like this, we can now explain each component.<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">1.</div><div class="itemcontent"><p class="para2" id="calibre_link-2913"><strong class="emphasistypebold">The “CurrentRegions” variable</strong></p><p class="para12" id="calibre_link-2914">This variable uses this expression:</p><p class="para12" id="calibre_link-2915"><em class="emphasistypeitalic">CALCULATETABLE ( Regions, Winesales )</em></p><p class="para12" id="calibre_link-2916">Here, CALCULATETABLE uses the expanded Winesales table as the filter for Regions, therefore generating a Regions table that contains only the regions in which the salesperson (in the current filter context) has made sales <em class="emphasistypeitalic">in the current month</em> (the month in the current filter context). Let’s take the evaluation for salesperson “Abel” in “February 2017”, which returns <strong class="emphasistypebold">2</strong>, as our example; see Figure <span><a href="#calibre_link-51" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">19-5</a></span>.</p></div><div class="clearboth">&nbsp;</div></li></ol></div><figure class="figure1" id="calibre_link-51"><div class="mediaobject" id="calibre_link-2917"><img alt="" src="images/000145.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 19-5</span><p class="simplepara1">The <span id="calibre_link-2918" class="calibre11">evaluation</span> of the “CurrentRegions” variable for “Abel” in “February 2017”.</p><p class="simplepara3">1. The expanded Winesales table contains columns from the Regions table.</p><p class="simplepara3">2. The Winesales table is filtered for “Abel”.</p><p class="simplepara3">3. The Winesales table is filtered for “February 2017”.</p><p class="simplepara3">4. The expanded Winesales table is used to filter the Regions table that now only contains regions where “Abel” has made sales in “February 2017.”</p><p class="simplepara3">5. CALCULATETABLE generates a virtual table from the filtered Regions table</p></div></figcaption></figure></div><div class="para" id="calibre_link-2919">Let’s now move on to look at the second component.<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">2.</div><div class="itemcontent"><p class="para2" id="calibre_link-2920"><strong class="emphasistypebold">The “PreviousRegions” variable</strong></p><div class="table" id="calibre_link-2921">This variable uses this expression:<div class="programcode" id="calibre_link-2922"><div class="calibre4"><div class="fixedline"><em class="emphasistypeitalic">CALCULATETABLE ( Regions,</em></div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="emphasistypeitalic">CALCULATETABLE ( Winesales,</em></div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="emphasistypeitalic">FILTER ( ALL ( DateTable ), DateTable[DATEKEY]</em></div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<em class="emphasistypeitalic">&lt; MIN ( DateTable[DATEKEY] ) ) ) )</em></div></div></div></div><p class="para2" id="calibre_link-2923">Remember that we used the nested CALCULATETABLE expression (highlighted) when we calculated the “Current No. of Sales” measure (see Figure <span><a href="#calibre_link-48" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">19-2</a></span>).</p><p class="para2" id="calibre_link-2924">Here, CALCULATETABLE also uses the expanded Winesales table as the filter for Regions, but this time the expanded Winesales table has been filtered (using FILTER) to contain only sales up to the last date of the prior month. This filter is applied on top of the filters from the SalesPeople table. <span id="calibre_link-2925"></span>CALCULATETABLE uses the filtered expanded Winesales table to generate a Regions table that contains the regions in which the salesperson has made sales <em class="emphasistypeitalic">up to the end of the prior month</em>; see Figure <span><a href="#calibre_link-52" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">19-6</a></span>.</p></div><div class="clearboth">&nbsp;</div></li></ol></div><figure class="figure1" id="calibre_link-52"><div class="mediaobject" id="calibre_link-2926"><img alt="" src="images/000099.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 19-6</span><p class="simplepara1">The <span id="calibre_link-2927" class="calibre11">evaluation</span> of the “PreviousRegions” variable for “Abel” in “February 2017”.</p><p class="simplepara3">1. The expanded Winesales table contains columns from the Regions table.</p><p class="simplepara3">2. The Winesales table is filtered for “Abel”.</p><p class="simplepara3">3. FILTER inside CALCULATETABLE generates a filtered DateTable containing dates up to and including “31 January 2017”.</p><p class="simplepara3">4. The DateTable table generated by FILTER is used to filter the expanded Winesales table.</p><p class="simplepara3">5. The expanded Winesales table is used to filter the Regions table that now only contains regions where “Abel” has made sales up to “31 January 2017”.</p><p class="simplepara3">6. CALCULATETABLE generates a virtual table from the filtered Regions table</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2928">So the variables have generated two in-memory tables using CALCULATETABLE as follows: <span id="calibre_link-2929"></span></p><p class="simplepara" id="calibre_link-2930"><strong class="emphasistypebold">CurrentRegions</strong> <span class="emphasisfontcategorynonproportional">&ndash;</span> Holds the regions in which the salesperson has made sales in the month in the current filter context</p><div class="para" id="calibre_link-2931"><strong class="emphasistypebold">PreviousRegions</strong> &ndash; Holds the regions in which the salesperson has made sales up to the last date of the prior month in the current filter context<div class="orderedlist"><ol class="unorderedlistmarknone"><li class="listitem"><div class="itemnumber">3.</div><div class="itemcontent"><p class="para2" id="calibre_link-2932"><strong class="emphasistypebold">The RETURN statement</strong></p><p class="para12" id="calibre_link-2933">The RETURN statement uses the EXCEPT function to return a table that contains only the rows of the table in the first argument that are not in the table of the second argument; see Figure <span><a href="#calibre_link-53" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">19-7</a></span>.</p></div><div class="clearboth">&nbsp;</div></li></ol></div><figure class="figure1" id="calibre_link-53"><div class="mediaobject" id="calibre_link-2934"><img alt="" src="images/000194.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 19-7</span><p class="simplepara1">The <span id="calibre_link-2935" class="calibre11">EXCEPT function</span> returns all the rows in the first table that are not in the second table</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2936">COUNTROWS then counts the rows in the virtual table generated by EXCEPT and returns <strong class="emphasistypebold">2</strong> rows for “Abel” in “February 2017”.</p></section><section class="section" id="calibre_link-255"><h3 class="booksubtitle">Calculating “Returning” Entities</h3><div class="calibre4" id="calibre_link-2937">To find “Returning Regions”, which is the regions where salespeople have previously made sales in any month, we can use the function <span id="calibre_link-2938">INTERSECT</span> in place of EXCEPT as follows:<div class="programcode" id="calibre_link-2939"><div class="calibre4"><div class="fixedline">Returning Regions =</div><div class="fixedline">VAR CurrentRegions =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE ( Regions, Winesales )</div></div><div class="calibre4"><div class="fixedline">VAR PreviousRegions =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Regions,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE ( Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILTER ( ALL ( DateTable ), DateTable[DATEKEY]</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&lt; MIN ( DateTable[DATEKEY] ) ) ) )</div></div><div class="calibre4"><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;COUNTROWS ( INTERSECT ( CurrentRegions, PreviousRegions ) )</div></div></div></div><p class="simplepara" id="calibre_link-2940">The table generated by INTERSECT contains all the rows in the first table that are also in the second table.</p><div class="para" id="calibre_link-2941">You can see the output of the two measures in Figure <span><a href="#calibre_link-54" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">19-8</a></span>. Note how the Total row has been removed from the Table visual. The Total values calculated (or the absence of a value) are correct, but ambiguous. Remember that on the evaluation of the Total row, filters on YEAR, MONTH, and SALESPERSON will have been removed so the “New Regions” measure, for example, would calculate how many new regions there were for all salespeople in all months of all years, which is the same as the total number of regions.<figure class="figure1" id="calibre_link-54"><div class="mediaobject" id="calibre_link-2942"><img alt="" src="images/000221.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 19-8</span><p class="simplepara1">The “New Regions” and “Returning Regions” measures in a Table visual. Note the absence of the Total row</p></div></figcaption></figure></div><div class="para" id="calibre_link-2943">What lies at the root of these expressions is using CALCULATETABLE to create two sets of data for comparisons. You can then use EXCEPT and INTERSECT to find either values that are the same or values that are different respectively; see Figure <span><a href="#calibre_link-55" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">19-9</a></span>.<figure class="figure1" id="calibre_link-55"><div class="mediaobject" id="calibre_link-2944"><img alt="" src="images/000034.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 19-9</span><p class="simplepara1">You can use the INTERSECT and EXCEPT functions to return sets of values</p></div></figcaption></figure></div><div class="para" id="calibre_link-2945">The benefit of understanding these expressions using CALCULATETABLE is that they can be repurposed for many different scenarios. For example, rather than finding new regions in the current month for each salesperson, you could analyze the number of new customers there are for each wine compared to the previous month, as follows:<div class="programcode" id="calibre_link-2946"><div class="calibre4"><div class="fixedline">New Customers from Previous Month =</div><div class="fixedline">VAR CurrentCustomers =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE ( Customers, Winesales )</div><div class="fixedline">VAR PreviousMthsCustomers =</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE (</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Customers,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CALCULATETABLE ( Winesales,</div><div class="fixedline">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PREVIOUSMONTH(DateTable[DATEKEY])) )</div></div><div class="calibre4"><div class="fixedline">RETURN</div><div class="fixedline">&nbsp;&nbsp;COUNTROWS ( EXCEPT ( CurrentCustomers, PreviousMthsCustomers ) )</div></div></div></div><div class="para" id="calibre_link-2947">This measure tells us that for “Bordeaux” wine, in “December 2021”, there were <strong class="emphasistypebold">4</strong> new customers compared to the customers in “November 2021”; see Figure <span><a href="#calibre_link-56" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">19-10</a></span>. Again, note the evaluation of the Total row, which, although not summing the values for each wine, is correct because it tells us that there were 13 new customers for <em class="emphasistypeitalic">all wines</em> in “December 2021” compared to the previous month. Renaming the Total may make this value less ambiguous.<figure class="figure1" id="calibre_link-56"><div class="mediaobject" id="calibre_link-2948"><img alt="" src="images/000169.jpg" class="calibre5" /></div><figcaption class="caption" lang="en"><div class="captioncontent"><span class="captionnumber">Figure 19-10</span><p class="simplepara1">The evaluation of the “New Customers from Previous Month” measure, repurposing the “New Regions” measure</p></div></figcaption></figure></div><p class="simplepara" id="calibre_link-2949">I think you’ll agree that the DAX expressions you’ve authored in this chapter using CALCULATETABLE and expanded tables bear no comparison in their complexity to the simple measures using SUM and AVERAGE with which you started out. Throughout this book, we’ve paid particular attention to how the DAX expressions work, understanding the detail beneath and getting to grips with the difficult concepts that underpin the DAX language.</p><p class="simplepara" id="calibre_link-2950">Now all that remains is for you to put your newfound knowledge to good use. Spend your day finding data to analyze using DAX. Don’t give up if at first things don’t go your way. Persevere and keep with it. There is no silver bullet; everyone who has ever mastered DAX has worked hard to get where they are.</p><p class="simplepara" id="calibre_link-2951">But nothing replaces that glowing feeling of finding a solution to a calculation that you initially thought was impossible to solve.</p><p class="simplepara" id="calibre_link-2952">Happy DAXing!</p></section></section><aside aria-label="Footnotes" class="footnotesection" type="footnotes"><div class="heading">Footnotes</div><div class="footnote"><span class="footnotenumber"><a href="#calibre_link-57" class="pcalibre4 pcalibre2 calibre6 pcalibre1 pcalibre3 pcalibre">1</a></span><div class="calibre4" type="footnote" id="calibre_link-46" role="doc-footnote"><p class="para3" id="calibre_link-2953">To follow along with the examples, use the Power BI Desktop file “6 DAX Expanded Tables.pbix”.</p></div><div class="clearboth1">&nbsp;</div></div></aside></div></div></div>
</div>
</div>


<div class="calibre1" id="calibre_link-58">
<div id="calibre_link-2954" class="calibre2">
<div id="calibre_link-2955" class="calibre3"><div type="backmatter" class="calibre4"><div class="calibre4"><div class="index" type="index" id="calibre_link-256" role="doc-index"><div class="calibre4"><div class="heading">Index</div></div><div class="calibre4"><div class="calibre4"><div class="heading">A</div></div><div class="calibre4"><div class="calibre4">Active/inactive relationships</div><div class="calibre4">comparison dimension</div><div class="calibre4">data table</div><div class="calibre4">edit relationship dialog</div><div class="calibre4">fact table</div><div class="calibre4">measures</div><div class="calibre4">slicers</div><div class="calibre4">USERELATIONSHIP function</div><div class="calibre4">wines dimension</div><div class="calibre4">DateTable filters</div><div class="calibre4">measures</div><div class="calibre4">table relationship</div><div class="calibre4">USERELATIONSHIP function</div></div><div class="calibre4"><div class="calibre4">ALLEXCEPT function</div></div><div class="calibre4"><div class="calibre4">ALL function</div><div class="calibre4">aggregating totals</div><div class="calibre4">table expansion</div></div><div class="calibre4"><div class="calibre4">ALL function/variations</div><div class="calibre4">ALLEXCEPT function</div><div class="calibre4">ALLSELECTED function</div><div class="calibre4">CALCULATE</div><div class="calibre4">calculating percentages</div><div class="calibre4">data modifier</div><div class="calibre4">description</div><div class="calibre4">dimensions</div><div class="calibre4">dimension table</div><div class="calibre4">fact tables</div><div class="calibre4">grand total cases</div><div class="calibre4">multiple columns</div><div class="calibre4">SUPPLIER column</div><div class="calibre4">syntaxes</div><div class="calibre4">tables/remove filters</div><div class="calibre4">TYPE column</div></div><div class="calibre4"><div class="calibre4">ALLSELECTED function</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">B</div></div><div class="calibre4"><div class="calibre4">Bidirectional relationships</div></div><div class="calibre4"><div class="calibre4">BLANK() function</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">C</div></div><div class="calibre4"><div class="calibre4">Calculated columns</div><div class="calibre4">AND (&amp;)</div><div class="calibre4">context transition</div><div class="calibre4">Excel formulas</div><div class="calibre4">expression</div><div class="calibre4">fields list</div><div class="calibre4">OR (||)</div><div class="calibre4">RELATED function</div><div class="calibre4"><span class="indexentryseelabel">See</span>RELATED function</div></div><div class="calibre4"><div class="calibre4">CALCULATE function</div><div class="calibre4">AND/OR filters</div><div class="calibre4">complex filters</div><div class="calibre4">DateTable dimension</div><div class="calibre4">details</div><div class="calibre4">DIVIDE function</div><div class="calibre4">error message</div><div class="calibre4">evaluation</div><div class="calibre4">expressions</div><div class="calibre4">FILTER function</div><div class="calibre4">filters</div><div class="calibre4">in-memory virtual tables</div><div class="calibre4">measures</div><div class="calibre4">modification</div><div class="calibre4">multiple filter</div><div class="calibre4">OR expression</div><div class="calibre4">return different results</div><div class="calibre4">similar expressions</div><div class="calibre4">single filters</div><div class="calibre4">square bracket</div><div class="calibre4">SUPPLIER column</div><div class="calibre4">syntax</div><div class="calibre4">table function</div><div class="calibre4">total cases</div><div class="calibre4">virtual table</div><div class="calibre4">WINE column</div><div class="calibre4">Wines dimension</div></div><div class="calibre4"><div class="calibre4">CALCULATETABLE function</div><div class="calibre4">FILTER function</div><div class="calibre4">calculation</div><div class="calibre4">DateTable returns</div><div class="calibre4">error message</div><div class="calibre4">expression</div><div class="calibre4">filter context</div><div class="calibre4">modification</div><div class="calibre4">virtual table</div><div class="calibre4">syntax</div><div class="calibre4">table expansion</div><div class="calibre4">component expressions</div><div class="calibre4">entities</div><div class="calibre4">evaluation</div><div class="calibre4">EXCEPT function</div><div class="calibre4">expression</div><div class="calibre4">INTERSECT/EXCEPT expressions</div></div><div class="calibre4"><div class="calibre4">COALESCE function</div></div><div class="calibre4"><div class="calibre4">CONCATENATEX function</div><div class="calibre4">arguments</div><div class="calibre4">COUNTROWS function</div><div class="calibre4">multiple selections</div><div class="calibre4">parameter tables</div><div class="calibre4">problem scenarios</div><div class="calibre4">SELECTEDVALUE function</div><div class="calibre4">TOPN expression</div><div class="calibre4">value returns</div><div class="calibre4">VALUES function</div><div class="calibre4">WINE column</div></div><div class="calibre4"><div class="calibre4">Constants</div></div><div class="calibre4"><div class="calibre4">Context transition</div><div class="calibre4">aggregated values</div><div class="calibre4">aggregating totals</div><div class="calibre4">ALL function</div><div class="calibre4">dimensions</div><div class="calibre4">matrix visuals</div><div class="calibre4">row-level calculation</div><div class="calibre4">SUMMARIZE function</div><div class="calibre4">virtual tables</div><div class="calibre4">attributes</div><div class="calibre4">calculated columns</div><div class="calibre4">CUMULATIVE TOTAL</div><div class="calibre4">cumulative totals</div><div class="calibre4">DAYS DIFFERENCE</div><div class="calibre4">FILTER function</div><div class="calibre4">RETURN statement</div><div class="calibre4">row context</div><div class="calibre4">CALCULATE function</div><div class="calibre4">data analysis</div><div class="calibre4">definition</div><div class="calibre4">description</div><div class="calibre4">expressions</div><div class="calibre4">filter context</div><div class="calibre4">numeric ranges</div><div class="calibre4">parameter table</div><div class="calibre4">RANKX function</div><div class="calibre4">row context</div><div class="calibre4">SUMMARIZE</div><div class="calibre4">surprising results</div><div class="calibre4">AVERAGE function</div><div class="calibre4">calculated columns</div><div class="calibre4">cumulative totals</div><div class="calibre4">MAX function</div><div class="calibre4">measures</div><div class="calibre4">SUMX expression</div><div class="calibre4">total cases</div><div class="calibre4">TopN percent</div><div class="calibre4">analysis</div><div class="calibre4">dynamic ranking</div><div class="calibre4">parameter tables</div><div class="calibre4">requirements</div><div class="calibre4">row selection</div><div class="calibre4">slicers</div><div class="calibre4">top/bottom percent selection</div><div class="calibre4">Wines dimension</div></div><div class="calibre4"><div class="calibre4">COUNTROWS function</div></div><div class="calibre4"><div class="calibre4">CROSSFILTER function</div><div class="calibre4">table expansion</div></div><div class="calibre4"><div class="calibre4">Current filter context</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">D</div></div><div class="calibre4"><div class="calibre4">Data analysis expression (DAX)</div><div class="calibre4">concepts</div><div class="calibre4">data model</div><div class="calibre4">expression</div><div class="calibre4">formula bar</div><div class="calibre4">functions</div><div class="calibre4">many-to-one relationships</div><div class="calibre4">table tools tab</div></div><div class="calibre4"><div class="calibre4">Denormalization</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">E</div></div><div class="calibre4"><div class="calibre4">Empty values <em class="emphasistypeitalic">vs.</em> Zero</div><div class="calibre4">BLANK() function</div><div class="calibre4">COALESCE function</div><div class="calibre4">ISBLANK function</div><div class="calibre4">measures</div><div class="calibre4">testing</div></div><div class="calibre4"><div class="calibre4">Excel formulas, calculated columns</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">F, G</div></div><div class="calibre4"><div class="calibre4">Filter context</div><div class="calibre4">evaluation</div><div class="calibre4">factors</div><div class="calibre4">fact table</div><div class="calibre4">in-memory dimension</div><div class="calibre4">measures</div><div class="calibre4">multiple filters</div><div class="calibre4">fact table</div><div class="calibre4">in-memory tables</div><div class="calibre4">propagation</div><div class="calibre4">roles</div><div class="calibre4">slicer/page-level filter</div><div class="calibre4">propagation</div><div class="calibre4">total row</div><div class="calibre4">WINE column</div></div><div class="calibre4"><div class="calibre4">FILTER function</div><div class="calibre4">CALCULATE</div><div class="calibre4">AVERAGE/MAX</div><div class="calibre4">calculation</div><div class="calibre4">error messages</div><div class="calibre4">incorrect results</div><div class="calibre4">iterators</div><div class="calibre4">measure</div><div class="calibre4">profit wines</div><div class="calibre4">propagate filters</div><div class="calibre4">requirement</div><div class="calibre4">requirements</div><div class="calibre4">scenario</div><div class="calibre4">source code</div><div class="calibre4">step-by-step guide</div><div class="calibre4">COUNTROWS</div><div class="calibre4">row expression</div><div class="calibre4">syntax</div></div><div class="calibre4"><div class="calibre4">Filter propagation</div><div class="calibre4">bidirectional filters</div><div class="calibre4">cross filter</div><div class="calibre4">CROSSFILTER function</div><div class="calibre4">customers table</div><div class="calibre4">fact tables</div><div class="calibre4">model view</div></div><div class="calibre4"><div class="calibre4">Formatting/unformatting expression</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">H</div></div><div class="calibre4"><div class="calibre4">HASONEVALUE function</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">I, J</div></div><div class="calibre4"><div class="calibre4">Implicit measures</div></div><div class="calibre4"><div class="calibre4">ISBLANK function</div></div><div class="calibre4"><div class="calibre4">Iterators</div><div class="calibre4">aggregating iterators</div><div class="calibre4">SUMX function</div><div class="calibre4"><span class="indexentryseelabel">See</span>SUMX function</div><div class="calibre4">total row</div><div class="calibre4">constituent expressions</div><div class="calibre4">evaluation</div><div class="calibre4">incorrect result</div><div class="calibre4">SUM function</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">K</div></div><div class="calibre4"><div class="calibre4">KEEPFILTERS function</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">L</div></div><div class="calibre4"><div class="calibre4">LOOKUPVALUE function</div><div class="calibre4">approaches</div><div class="calibre4">calculated column</div><div class="calibre4">definition</div><div class="calibre4">many-to-one relationship</div><div class="calibre4">syntax</div><div class="calibre4">table records</div><div class="calibre4">transaction records</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">M</div></div><div class="calibre4"><div class="calibre4">Measures</div><div class="calibre4">benefits</div><div class="calibre4">CALCULATE function</div><div class="calibre4">COUNTROWS function</div><div class="calibre4">definition</div><div class="calibre4">dimensions</div><div class="calibre4">DISTINCTCOUNT function</div><div class="calibre4">editor</div><div class="calibre4">error message</div><div class="calibre4">Excel pivot table</div><div class="calibre4">explicit measure</div><div class="calibre4">filtered data</div><div class="calibre4">formatting group</div><div class="calibre4">implicit measure</div><div class="calibre4">reporting tools</div><div class="calibre4">return scalar values</div><div class="calibre4">table creation</div><div class="calibre4">visuals</div><div class="calibre4">visual table</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">N, O</div></div><div class="calibre4"><div class="calibre4">Non matching values</div><div class="calibre4">blank entry</div><div class="calibre4">linking columns</div><div class="calibre4">scenarios</div><div class="calibre4">visualisations pane</div><div class="calibre4">Wines dimension</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">P, Q</div></div><div class="calibre4"><div class="calibre4">Power BI Desktop</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">R</div></div><div class="calibre4"><div class="calibre4">RANKX function</div></div><div class="calibre4"><div class="calibre4">RELATED function</div><div class="calibre4">advantages</div><div class="calibre4">CUSTOMER ID</div><div class="calibre4">denormalization</div><div class="calibre4">description</div><div class="calibre4">hiding tables</div><div class="calibre4">regions table</div><div class="calibre4">Sales revenue values</div><div class="calibre4">VLOOKUP function</div><div class="calibre4">Winesales table</div></div><div class="calibre4"><div class="calibre4">Row context</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">S</div></div><div class="calibre4"><div class="calibre4">SELECTEDVALUE function</div><div class="calibre4">current filter</div><div class="calibre4">evaluation</div><div class="calibre4">expression</div><div class="calibre4">multiple items</div><div class="calibre4">parameter table</div><div class="calibre4">results</div><div class="calibre4">slicer filters</div><div class="calibre4">syntax</div><div class="calibre4">user selections</div><div class="calibre4">VALUES function</div></div><div class="calibre4"><div class="calibre4">Start/snowflakes</div><div class="calibre4">data model</div><div class="calibre4">dimensions</div><div class="calibre4">fact tables</div><div class="calibre4">inactive relationship</div><div class="calibre4">star schema</div></div><div class="calibre4"><div class="calibre4">SUMMARIZE function</div><div class="calibre4">calculation steps</div><div class="calibre4">context transition</div><div class="calibre4">ALLEXEPT function</div><div class="calibre4">analytics</div><div class="calibre4">calculated column</div><div class="calibre4">calculated tables</div><div class="calibre4">DateTable</div><div class="calibre4">description</div><div class="calibre4">measures</div><div class="calibre4">syntax</div><div class="calibre4">table creation</div><div class="calibre4">like/like sales calculation</div><div class="calibre4">matrix visual</div><div class="calibre4">measure returns</div><div class="calibre4">multiselection</div><div class="calibre4">virtual table</div></div><div class="calibre4"><div class="calibre4">SUMX function</div><div class="calibre4">average price</div><div class="calibre4">calculated column</div><div class="calibre4">implicit measure</div><div class="calibre4">maximum/average sales</div><div class="calibre4">RELATED function</div><div class="calibre4">row-level calculation</div><div class="calibre4">SUMX, AVERAGEX, and MAXX</div><div class="calibre4">syntax</div><div class="calibre4">X aggregators</div></div><div class="calibre4"><div class="calibre4">Syntax</div><div class="calibre4">AND/OR expression</div><div class="calibre4">column name</div><div class="calibre4">Excel formulas</div><div class="calibre4">Excel formulas/DAX expressions</div><div class="calibre4">formula bar</div><div class="calibre4">IntelliSense list</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">T</div></div><div class="calibre4"><div class="calibre4">Table expansion</div><div class="calibre4">ALLEXCEPT/SUMMARIZE functions</div><div class="calibre4">ALL function</div><div class="calibre4">ALLSELECTED</div><div class="calibre4">base tables</div><div class="calibre4">CROSSFILTER function</div><div class="calibre4">data model</div><div class="calibre4">description</div><div class="calibre4">expanded tables</div><div class="calibre4">expansion results</div><div class="calibre4">filters</div><div class="calibre4">code generation</div><div class="calibre4">column information</div><div class="calibre4">description</div><div class="calibre4">real evaluation</div><div class="calibre4">WINECOUNTRY column</div><div class="calibre4">leverage tables</div><div class="calibre4">approaches</div><div class="calibre4">base/expanded tables</div><div class="calibre4">CALCULATE</div><div class="calibre4">CROSSFILTER function</div><div class="calibre4">customers table</div><div class="calibre4">distinct regions</div><div class="calibre4">measures</div><div class="calibre4">RELATED function</div><div class="calibre4">snowflake dimensions</div><div class="calibre4">table visuals</div><div class="calibre4">RELATED function</div><div class="calibre4">removes filters</div><div class="calibre4">snowflake schemas</div></div><div class="calibre4"><div class="calibre4">Table functions</div><div class="calibre4">column filters</div><div class="calibre4">Bordeaux</div><div class="calibre4">CALCULATE</div><div class="calibre4">description</div><div class="calibre4">difference</div><div class="calibre4">difference results</div><div class="calibre4">less efficient</div><div class="calibre4">measures return</div><div class="calibre4">table filters</div><div class="calibre4">technical terms</div><div class="calibre4">FILTER</div><div class="calibre4"><span class="indexentryseelabel">See</span>FILTER function</div><div class="calibre4">KEEPFILTERS</div><div class="calibre4">scalar functions</div><div class="calibre4">table expressions</div><div class="calibre4">CALCULATE</div><div class="calibre4">calculated tables</div><div class="calibre4">filter arguments</div><div class="calibre4">VALUES</div><div class="calibre4">types</div></div><div class="calibre4"><div class="calibre4">Tables</div><div class="calibre4"><span class="indexentryseelabel">See</span>Active/inactive relationships</div></div><div class="calibre4"><div class="calibre4">Time intelligence functions</div><div class="calibre4">annual totals and averages</div><div class="calibre4">base date</div><div class="calibre4">consecutive transactions</div><div class="calibre4">cumulative totals</div><div class="calibre4">DATEADD</div><div class="calibre4">date dimension</div><div class="calibre4">built-in option</div><div class="calibre4">column option</div><div class="calibre4">DATEKEY column</div><div class="calibre4">hierarchies</div><div class="calibre4">options pane</div><div class="calibre4">table creation</div><div class="calibre4">table tools tab</div><div class="calibre4">DATESINPERIOD function</div><div class="calibre4">DATESYTD function</div><div class="calibre4">description</div><div class="calibre4">differences (dates)</div><div class="calibre4">FIRSTNONBLANK/LASTNONBLANK functions</div><div class="calibre4">LASTDATE option</div><div class="calibre4">LASTNONBLANK/LASTNONBLANKVALUE expressions</div><div class="calibre4">PREVIOUSMONTH/YEAR</div><div class="calibre4">return value</div><div class="calibre4">SAMEPERIODLASTYEAR</div><div class="calibre4">scalar value</div><div class="calibre4">unique dates</div><div class="calibre4">VALUES function</div></div><div class="calibre4"><div class="calibre4">TREATAS function</div><div class="calibre4">DateTable/Targets table</div><div class="calibre4">evaluation</div><div class="calibre4">fact table</div><div class="calibre4">many-to-many relationship</div><div class="calibre4">reporting targets</div><div class="calibre4">results</div><div class="calibre4">SalesPeople table</div><div class="calibre4">syntax</div><div class="calibre4">targets table</div><div class="calibre4">VALUES function</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">U</div></div><div class="calibre4"><div class="calibre4">USERELATIONSHIP function</div></div></div><div class="calibre4"><div class="calibre4"><div class="heading">V, W, X, Y, Z</div></div><div class="calibre4"><div class="calibre4">VALUES function</div><div class="calibre4">converting columns</div><div class="calibre4">edit interactions</div><div class="calibre4">error message</div><div class="calibre4">lost filters</div><div class="calibre4">references</div><div class="calibre4">requirements</div><div class="calibre4">scalar function</div><div class="calibre4">table function/virtual table</div><div class="calibre4">table/scalar function</div><div class="calibre4">total row selection</div></div><div class="calibre4"><div class="calibre4">Variables</div><div class="calibre4">advantages</div><div class="calibre4">calculated columns</div><div class="calibre4">constants</div><div class="calibre4">declarations</div><div class="calibre4">nested measures/expressions</div><div class="calibre4">performance</div><div class="calibre4">readability</div><div class="calibre4">reduce complexity</div><div class="calibre4">VAR/RETURN keywords</div></div><div class="calibre4"><div class="calibre4">Virtual relationships</div></div><div class="calibre4"><div class="calibre4">VLOOKUP function</div></div></div></div></div></div></div>
</div>
</div>


</body></html>